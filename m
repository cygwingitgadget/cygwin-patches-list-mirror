Return-Path: <cygwin-patches-return-8317-listarch-cygwin-patches=sources.redhat.com@cygwin.com>
Received: (qmail 67888 invoked by alias); 14 Feb 2016 08:12:58 -0000
Mailing-List: contact cygwin-patches-help@cygwin.com; run by ezmlm
Precedence: bulk
List-Id: <cygwin-patches.cygwin.com>
List-Subscribe: <mailto:cygwin-patches-subscribe@cygwin.com>
List-Post: <mailto:cygwin-patches@cygwin.com>
List-Archive: <http://sourceware.org/ml/cygwin-patches/>
List-Help: <mailto:cygwin-patches-help@cygwin.com>, <http://sourceware.org/ml/#faqs>
Sender: cygwin-patches-owner@cygwin.com
Mail-Followup-To: cygwin-patches@cygwin.com
Received: (qmail 60007 invoked by uid 89); 14 Feb 2016 08:12:24 -0000
Authentication-Results: sourceware.org; auth=none
X-Virus-Found: No
X-Spam-SWARE-Status: No, score=0.2 required=5.0 tests=BAYES_40,KAM_LOTSOFHASH,SPF_HELO_PASS,SPF_PASS,TVD_RCVD_IP autolearn=no version=3.3.2 spammy=movements, sk:notific, peek, 593
X-HELO: glup.org
Received: from 216-15-121-172.c3-0.smr-ubr2.sbo-smr.ma.static.cable.rcn.com (HELO glup.org) (216.15.121.172) by sourceware.org (qpsmtpd/0.93/v0.84-503-g423c35a) with (AES256-SHA encrypted) ESMTPS; Sun, 14 Feb 2016 08:09:11 +0000
Received: from minipixel.local (unknown [IPv6:2001:4830:1141:1:ae87:a3ff:fe0b:f9a8])	by glup.org (Postfix) with ESMTPSA id 930ED854C4;	Sun, 14 Feb 2016 03:09:08 -0500 (EST)
Authentication-Results: glup.org; dmarc=none header.from=glup.org
From: john hood <cgull@glup.org>
Subject: Cygwin select() issues and improvements
To: cygwin-patches@cygwin.com
Message-ID: <56C03624.1030703@glup.org>
Date: Sun, 14 Feb 2016 08:12:00 -0000
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:38.0) Gecko/20100101 Thunderbird/38.5.1
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="------------000600060401050706060206"
X-SW-Source: 2016-q1/txt/msg00023.txt.bz2

This is a multi-part message in MIME format.
--------------000600060401050706060206
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: 7bit
Content-length: 2829

[I Originally sent this last week, but it bounced.]

Various issues with Cygwin's select() annoyed me, and I've spent some
time gnawing on them.

* With 1-byte reads, select() on Windows Console input would forget
about unread input data stored in the fhandler's readahead buffer.
Hitting F1 would send only the first ESC character, until you released
the key and another Windows event was generated.  (one-line fix, though
I'm not sure it's appropriate/correct)

* On Windows, select() timeouts have coarse 10-16ms granularity (not
fixed-- must use clock_setres(), which has its own issues)

This issue hurts Mosh pretty badly, since it often uses select() with
1-20ms timeouts. Running Mosh on localhost on Cygwin has around 80ms of
extra latency for typing, which is pretty noticeable. Using
clock_setres() mostly cures this.

Older Unix systems used to have this issue too, but modern OS X, FreeBSD
and Linux all do much better.

* select() uses old millisecond-granularity Windows timeouts-- I changed
this to microsecond granularity.  Any actual improvement from this is
small, since Windows doesn't seem to handle timers on a less than 500us
granularity, even when you do use clock_setres().  One thing this does
fix is that selects > 43 days now work, though this is not a big issue
in actual practice, or a POSIX requirement.

* Newer versions of Windows may return early on timers, causing select()
to return early. (fixed, but other timers in Cygwin still have this problem)

* The main loop in select() has some pretty tangled logic.  I improved
that some.  There's room for more improvement but that would need
changing fhandlers and related functions.

* During testing, I discovered that if the system is at 100% CPU load
from other processes, select() will wait exactly 10 seconds on its first
invocation even though your timeout is much shorter.  But curiously,
this doesn't happen with usleep(), even though Cygwin's internal code is
very similar.  This is not a new bug; my best guess is that it's an, um,
feature of the Windows process/thread scheduler-- possibly it adjusts
priorities at that 10 second mark.  It'd be nice to figure this out, I
think it may be affecting the Mosh test suite.

Windows scheduling in general seems to be rather poor for Cygwin
processes, and there are scheduling differences between processes run in
Windows console (which are seen as interactive by the scheduler) and
processes run in mintty (which are not).  There doesn't seem to be any
priority promotion for I/O as you see on most Unix schedulers.

I've attached plausible patches; they're also available on
<https://github.com/cgull/newlib-cygwin>, branch 'microsecond-select'.
I think it's all Windows XP compatible.  I've put some test programs up
at <https://github.com/cgull/cygwin-timeouts> too.

regards,

  --jh



--------------000600060401050706060206
Content-Type: text/plain; charset=UTF-8; x-mac-type="0"; x-mac-creator="0";
 name="0001-Make-buffered-console-characters-visible-to-select.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
 filename*0="0001-Make-buffered-console-characters-visible-to-select.patc";
 filename*1="h"
Content-length: 952

RnJvbSAxMGE4OWFhYjhhODcwNzJlZDQ5MDhkMjc0Y2Q5M2RjOWEyZTIxNGY2
IE1vbiBTZXAgMTcgMDA6MDA6MDAgMjAwMQpGcm9tOiBKb2huIEhvb2QgPGNn
dWxsQGdsdXAub3JnPgpEYXRlOiBTYXQsIDMwIEphbiAyMDE2IDE3OjM2OjQz
IC0wNTAwClN1YmplY3Q6IFtQQVRDSCAxLzZdIE1ha2UgYnVmZmVyZWQgY29u
c29sZSBjaGFyYWN0ZXJzIHZpc2libGUgdG8gc2VsZWN0KCkuCgotLS0KIHdp
bnN1cC9jeWd3aW4vc2VsZWN0LmNjIHwgMiArLQogMSBmaWxlIGNoYW5nZWQs
IDEgaW5zZXJ0aW9uKCspLCAxIGRlbGV0aW9uKC0pCgpkaWZmIC0tZ2l0IGEv
d2luc3VwL2N5Z3dpbi9zZWxlY3QuY2MgYi93aW5zdXAvY3lnd2luL3NlbGVj
dC5jYwppbmRleCA5NzliMGIwLi5lMWQ0OGEzIDEwMDY0NAotLS0gYS93aW5z
dXAvY3lnd2luL3NlbGVjdC5jYworKysgYi93aW5zdXAvY3lnd2luL3NlbGVj
dC5jYwpAQCAtOTE2LDcgKzkxNiw3IEBAIGZoYW5kbGVyX2NvbnNvbGU6OnNl
bGVjdF9yZWFkIChzZWxlY3Rfc3R1ZmYgKnNzKQogICBzLT5wZWVrID0gcGVl
a19jb25zb2xlOwogICBzLT5oID0gZ2V0X2hhbmRsZSAoKTsKICAgcy0+cmVh
ZF9zZWxlY3RlZCA9IHRydWU7Ci0gIHMtPnJlYWRfcmVhZHkgPSBmYWxzZTsK
KyAgcy0+cmVhZF9yZWFkeSA9IGdldF9yZWFkYWhlYWRfdmFsaWQoKTsKICAg
cmV0dXJuIHM7CiB9CiAKLS0gCjIuNi4zCgo=

--------------000600060401050706060206
Content-Type: text/plain; charset=UTF-8; x-mac-type="0"; x-mac-creator="0";
 name="0002-Use-high-resolution-timebases-for-select.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
 filename="0002-Use-high-resolution-timebases-for-select.patch"
Content-length: 15230

RnJvbSA1YmU0YmVmZGRhN2M4ZTYxNDYwMDFjZWVlZjQ2NWY4ZGNhNjk3NzA2
IE1vbiBTZXAgMTcgMDA6MDA6MDAgMjAwMQpGcm9tOiBKb2huIEhvb2QgPGNn
dWxsQGdsdXAub3JnPgpEYXRlOiBUaHUsIDI4IEphbiAyMDE2IDE3OjA4OjM5
IC0wNTAwClN1YmplY3Q6IFtQQVRDSCAyLzZdIFVzZSBoaWdoLXJlc29sdXRp
b24gdGltZWJhc2VzIGZvciBzZWxlY3QoKS4KCkFsc28gbWFrZSBjeWd3aW5f
c2VsZWN0KCkgYSB3cmFwcGVyIG9uIHBzZWxlY3QoKS4KLS0tCiB3aW5zdXAv
Y3lnd2luL2N5Z3dhaXQuaCAgICB8ICAyNyArKysrKysrCiB3aW5zdXAvY3ln
d2luL3NlbGVjdC5jYyAgICB8IDE4NCArKysrKysrKysrKysrKysrKysrKysr
KysrKysrLS0tLS0tLS0tLS0tLS0tLS0KIHdpbnN1cC9jeWd3aW4vc2VsZWN0
LmggICAgIHwgICAyICstCiB3aW5zdXAvdGVzdHN1aXRlL2NvbmZpZ3VyZSB8
ICAgMAogNCBmaWxlcyBjaGFuZ2VkLCAxNDMgaW5zZXJ0aW9ucygrKSwgNzAg
ZGVsZXRpb25zKC0pCiBtb2RlIGNoYW5nZSAxMDA2NDQgPT4gMTAwNzU1IHdp
bnN1cC90ZXN0c3VpdGUvY29uZmlndXJlCgpkaWZmIC0tZ2l0IGEvd2luc3Vw
L2N5Z3dpbi9jeWd3YWl0LmggYi93aW5zdXAvY3lnd2luL2N5Z3dhaXQuaApp
bmRleCAxMjQwZjU0Li4zZTAyY2RkIDEwMDY0NAotLS0gYS93aW5zdXAvY3ln
d2luL2N5Z3dhaXQuaAorKysgYi93aW5zdXAvY3lnd2luL2N5Z3dhaXQuaApA
QCAtNTksMyArNTksMzAgQEAgY3lnd2FpdCAoRFdPUkQgaG93bG9uZykKIHsK
ICAgcmV0dXJuIGN5Z3dhaXQgKE5VTEwsIGhvd2xvbmcpOwogfQorCitleHRl
cm4gaW5saW5lIERXT1JEIF9fYXR0cmlidXRlX18gKChhbHdheXNfaW5saW5l
KSkKK2N5Z3dhaXRfdXMgKEhBTkRMRSBoLCBMT05HTE9ORyBob3dsb25nLCB1
bnNpZ25lZCBtYXNrKQoreworICBMQVJHRV9JTlRFR0VSIGxpX2hvd2xvbmc7
CisgIFBMQVJHRV9JTlRFR0VSIHBsaV9ob3dsb25nOworICBpZiAoaG93bG9u
ZyA8IDBMTCkKKyAgICBwbGlfaG93bG9uZyA9IE5VTEw7CisgIGVsc2UKKyAg
ICB7CisgICAgICBsaV9ob3dsb25nLlF1YWRQYXJ0ID0gLSgxMExMICogaG93
bG9uZyk7CisgICAgICBwbGlfaG93bG9uZyA9ICZsaV9ob3dsb25nOworICAg
IH0KKyAgcmV0dXJuIGN5Z3dhaXQgKGgsIHBsaV9ob3dsb25nLCBtYXNrKTsK
K30KKworc3RhdGljIGlubGluZSBEV09SRCBfX2F0dHJpYnV0ZV9fICgoYWx3
YXlzX2lubGluZSkpCitjeWd3YWl0X3VzIChIQU5ETEUgaCwgTE9OR0xPTkcg
aG93bG9uZyA9IC0xKQoreworICByZXR1cm4gY3lnd2FpdF91cyAoaCwgaG93
bG9uZywgY3dfY2FuY2VsIHwgY3dfc2lnKTsKK30KKworc3RhdGljIGlubGlu
ZSBEV09SRCBfX2F0dHJpYnV0ZV9fICgoYWx3YXlzX2lubGluZSkpCitjeWd3
YWl0X3VzIChMT05HTE9ORyBob3dsb25nKQoreworICByZXR1cm4gY3lnd2Fp
dF91cyAoTlVMTCwgaG93bG9uZyk7Cit9CmRpZmYgLS1naXQgYS93aW5zdXAv
Y3lnd2luL3NlbGVjdC5jYyBiL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmNjCmlu
ZGV4IGUxZDQ4YTMuLjRmMjJkOTIgMTAwNjQ0Ci0tLSBhL3dpbnN1cC9jeWd3
aW4vc2VsZWN0LmNjCisrKyBiL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmNjCkBA
IC04NSw0MSArODUsNjggQEAgZGV0YWlscy4gKi8KICAgICAgIHJldHVybiAt
MTsgXAogICAgIH0KIAotc3RhdGljIGludCBzZWxlY3QgKGludCwgZmRfc2V0
ICosIGZkX3NldCAqLCBmZF9zZXQgKiwgRFdPUkQpOworc3RhdGljIGludCBz
ZWxlY3QgKGludCwgZmRfc2V0ICosIGZkX3NldCAqLCBmZF9zZXQgKiwgTE9O
R0xPTkcpOwogCiAvKiBUaGUgbWFpbiBzZWxlY3QgY29kZS4gICovCiBleHRl
cm4gIkMiIGludAotY3lnd2luX3NlbGVjdCAoaW50IG1heGZkcywgZmRfc2V0
ICpyZWFkZmRzLCBmZF9zZXQgKndyaXRlZmRzLCBmZF9zZXQgKmV4Y2VwdGZk
cywKLQkgICAgICAgc3RydWN0IHRpbWV2YWwgKnRvKQorcHNlbGVjdChpbnQg
bWF4ZmRzLCBmZF9zZXQgKnJlYWRmZHMsIGZkX3NldCAqd3JpdGVmZHMsIGZk
X3NldCAqZXhjZXB0ZmRzLAorCWNvbnN0IHN0cnVjdCB0aW1lc3BlYyAqdG8s
IGNvbnN0IHNpZ3NldF90ICpzZXQpCiB7Ci0gIHNlbGVjdF9wcmludGYgKCJz
ZWxlY3QoJWQsICVwLCAlcCwgJXAsICVwKSIsIG1heGZkcywgcmVhZGZkcywg
d3JpdGVmZHMsIGV4Y2VwdGZkcywgdG8pOworICBzaWdzZXRfdCBvbGRzZXQg
PSBfbXlfdGxzLnNpZ21hc2s7CiAKLSAgcHRocmVhZF90ZXN0Y2FuY2VsICgp
OwotICBpbnQgcmVzOwotICBpZiAobWF4ZmRzIDwgMCkKLSAgICB7Ci0gICAg
ICBzZXRfZXJybm8gKEVJTlZBTCk7Ci0gICAgICByZXMgPSAtMTsKLSAgICB9
Ci0gIGVsc2UKKyAgX190cnkKICAgICB7Ci0gICAgICAvKiBDb252ZXJ0IHRv
IG1pbGxpc2Vjb25kcyBvciBJTkZJTklURSBpZiB0byA9PSBOVUxMICovCi0g
ICAgICBEV09SRCBtcyA9IHRvID8gKHRvLT50dl9zZWMgKiAxMDAwKSArICh0
by0+dHZfdXNlYyAvIDEwMDApIDogSU5GSU5JVEU7Ci0gICAgICBpZiAobXMg
PT0gMCAmJiB0by0+dHZfdXNlYykKLQltcyA9IDE7CQkJLyogQXQgbGVhc3Qg
MSBtcyBncmFudWxhcml0eSAqLworICAgICAgaWYgKHNldCkKKwlzZXRfc2ln
bmFsX21hc2sgKF9teV90bHMuc2lnbWFzaywgKnNldCk7CiAKLSAgICAgIGlm
ICh0bykKLQlzZWxlY3RfcHJpbnRmICgidG8tPnR2X3NlYyAlbGQsIHRvLT50
dl91c2VjICVsZCwgbXMgJWQiLCB0by0+dHZfc2VjLCB0by0+dHZfdXNlYywg
bXMpOworICAgICAgc2VsZWN0X3ByaW50ZiAoInBzZWxlY3QoJWQsICVwLCAl
cCwgJXAsICVwLCAlcCkiLCBtYXhmZHMsIHJlYWRmZHMsIHdyaXRlZmRzLCBl
eGNlcHRmZHMsIHRvLCBzZXQpOworCisgICAgICBwdGhyZWFkX3Rlc3RjYW5j
ZWwgKCk7CisgICAgICBpbnQgcmVzOworICAgICAgaWYgKG1heGZkcyA8IDAp
CisJeworCSAgc2V0X2Vycm5vIChFSU5WQUwpOworCSAgcmVzID0gLTE7CisJ
fQogICAgICAgZWxzZQotCXNlbGVjdF9wcmludGYgKCJ0byBOVUxMLCBtcyAl
eCIsIG1zKTsKKwl7CisJICAvKiBDb252ZXJ0IHRvIG1pY3Jvc2Vjb25kcyBv
ciAtMSBpZiB0byA9PSBOVUxMICovCisJICBMT05HTE9ORyB1cyA9IHRvID8g
dG8tPnR2X3NlYyAqIDEwMDAwMDBMTCArICh0by0+dHZfbnNlYyArIDk5OSkg
LyAxMDAwIDogLTFMTDsKIAotICAgICAgcmVzID0gc2VsZWN0IChtYXhmZHMs
IHJlYWRmZHMgPzogYWxsb2NmZF9zZXQgKG1heGZkcyksCi0JCSAgICB3cml0
ZWZkcyA/OiBhbGxvY2ZkX3NldCAobWF4ZmRzKSwKLQkJICAgIGV4Y2VwdGZk
cyA/OiBhbGxvY2ZkX3NldCAobWF4ZmRzKSwgbXMpOworCSAgaWYgKHRvKQor
CSAgICBzZWxlY3RfcHJpbnRmICgidG8tPnR2X3NlYyAlbGQsIHRvLT50dl9u
c2VjICVsZCwgdXMgJWxsZCIsIHRvLT50dl9zZWMsIHRvLT50dl9uc2VjLCB1
cyk7CisJICBlbHNlCisJICAgIHNlbGVjdF9wcmludGYgKCJ0byBOVUxMLCB1
cyAlbGxkIiwgdXMpOworCisJICByZXMgPSBzZWxlY3QgKG1heGZkcywgcmVh
ZGZkcyA/OiBhbGxvY2ZkX3NldCAobWF4ZmRzKSwKKwkJCXdyaXRlZmRzID86
IGFsbG9jZmRfc2V0IChtYXhmZHMpLAorCQkJZXhjZXB0ZmRzID86IGFsbG9j
ZmRfc2V0IChtYXhmZHMpLCB1cyk7CisJfQorICAgICAgc3lzY2FsbF9wcmlu
dGYgKCIlUiA9IHNlbGVjdCglZCwgJXAsICVwLCAlcCwgJXApIiwgcmVzLCBt
YXhmZHMsIHJlYWRmZHMsCisJCSAgICAgIHdyaXRlZmRzLCBleGNlcHRmZHMs
IHRvKTsKKworICAgICAgaWYgKHNldCkKKwlzZXRfc2lnbmFsX21hc2sgKF9t
eV90bHMuc2lnbWFzaywgb2xkc2V0KTsKKyAgICAgIHJldHVybiByZXM7CiAg
ICAgfQotICBzeXNjYWxsX3ByaW50ZiAoIiVSID0gc2VsZWN0KCVkLCAlcCwg
JXAsICVwLCAlcCkiLCByZXMsIG1heGZkcywgcmVhZGZkcywKLQkJICB3cml0
ZWZkcywgZXhjZXB0ZmRzLCB0byk7Ci0gIHJldHVybiByZXM7CisgIF9fZXhj
ZXB0IChFRkFVTFQpIHt9CisgIF9fZW5kdHJ5CisgIHJldHVybiAtMTsKK30K
KworLyogc2VsZWN0KCkgaXMganVzdCBhIHdyYXBwZXIgb24gcHNlbGVjdCgp
LiAqLworZXh0ZXJuICJDIiBpbnQKK2N5Z3dpbl9zZWxlY3QgKGludCBtYXhm
ZHMsIGZkX3NldCAqcmVhZGZkcywgZmRfc2V0ICp3cml0ZWZkcywgZmRfc2V0
ICpleGNlcHRmZHMsCisJICAgICAgIHN0cnVjdCB0aW1ldmFsICp0bykKK3sK
KyAgc3RydWN0IHRpbWVzcGVjIHRzOworICBpZiAodG8pCisgICAgeworICAg
ICAgdHMudHZfc2VjID0gdG8tPnR2X3NlYzsKKyAgICAgIHRzLnR2X25zZWMg
PSB0by0+dHZfdXNlYyAqIDEwMDA7CisgICAgfQorICByZXR1cm4gcHNlbGVj
dCAobWF4ZmRzLCByZWFkZmRzLCB3cml0ZWZkcywgZXhjZXB0ZmRzLAorCQkg
IHRvID8gJnRzIDogTlVMTCwgTlVMTCk7CiB9CiAKIC8qIFRoaXMgZnVuY3Rp
b24gaXMgYXJiaXRyYXJpbHkgc3BsaXQgb3V0IGZyb20gY3lnd2luX3NlbGVj
dCB0byBhdm9pZCBvZGQKQEAgLTEyNywxMyArMTU0LDEzIEBAIGN5Z3dpbl9z
ZWxlY3QgKGludCBtYXhmZHMsIGZkX3NldCAqcmVhZGZkcywgZmRfc2V0ICp3
cml0ZWZkcywgZmRfc2V0ICpleGNlcHRmZHMsCiAgICBmb3IgdGhlIHNlbCB2
YXJpYWJsZS4gICovCiBzdGF0aWMgaW50CiBzZWxlY3QgKGludCBtYXhmZHMs
IGZkX3NldCAqcmVhZGZkcywgZmRfc2V0ICp3cml0ZWZkcywgZmRfc2V0ICpl
eGNlcHRmZHMsCi0JRFdPUkQgbXMpCisJTE9OR0xPTkcgdXMpCiB7CiAgIHNl
bGVjdF9zdHVmZjo6d2FpdF9zdGF0ZXMgd2FpdF9zdGF0ZSA9IHNlbGVjdF9z
dHVmZjo6c2VsZWN0X2xvb3A7CiAgIGludCByZXQgPSAwOwogCiAgIC8qIFJl
Y29yZCB0aGUgY3VycmVudCB0aW1lIGZvciBsYXRlciB1c2UuICovCi0gIExP
TkdMT05HIHN0YXJ0X3RpbWUgPSBndG9kLm1zZWNzICgpOworICBMT05HTE9O
RyBzdGFydF90aW1lID0gZ3RvZC51c2VjcyAoKTsKIAogICBzZWxlY3Rfc3R1
ZmYgc2VsOwogICBzZWwucmV0dXJuX29uX3NpZ25hbCA9IDA7CkBAIC0xNTgs
NyArMTg1LDcgQEAgc2VsZWN0IChpbnQgbWF4ZmRzLCBmZF9zZXQgKnJlYWRm
ZHMsIGZkX3NldCAqd3JpdGVmZHMsIGZkX3NldCAqZXhjZXB0ZmRzLAogICAg
ICAgLyogRGVnZW5lcmF0ZSBjYXNlLiAgTm8gZmRzIHRvIHdhaXQgZm9yLiAg
SnVzdCB3YWl0IGZvciB0aW1lIHRvIHJ1biBvdXQKIAkgb3Igc2lnbmFsIHRv
IGFycml2ZS4gKi8KICAgICAgIGlmIChzZWwuc3RhcnQubmV4dCA9PSBOVUxM
KQotCXN3aXRjaCAoY3lnd2FpdCAobXMpKQorCXN3aXRjaCAoY3lnd2FpdF91
cyAodXMpKQogCSAgewogCSAgY2FzZSBXQUlUX1NJR05BTEVEOgogCSAgICBz
ZWxlY3RfcHJpbnRmICgic2lnbmFsIHJlY2VpdmVkIik7CkBAIC0xNzgsMTIg
KzIwNSwxMiBAQCBzZWxlY3QgKGludCBtYXhmZHMsIGZkX3NldCAqcmVhZGZk
cywgZmRfc2V0ICp3cml0ZWZkcywgZmRfc2V0ICpleGNlcHRmZHMsCiAJICAg
IHdhaXRfc3RhdGUgPSBzZWxlY3Rfc3R1ZmY6OnNlbGVjdF9zZXRfemVybzsK
IAkgICAgYnJlYWs7CiAJICB9Ci0gICAgICBlbHNlIGlmIChzZWwuYWx3YXlz
X3JlYWR5IHx8IG1zID09IDApCisgICAgICBlbHNlIGlmIChzZWwuYWx3YXlz
X3JlYWR5IHx8IHVzID09IDApCiAJLyogQ2F0Y2ggYW55IGFjdGl2ZSBmZHMg
dmlhIHNlbC5wb2xsKCkgYmVsb3cgKi8KIAl3YWl0X3N0YXRlID0gc2VsZWN0
X3N0dWZmOjpzZWxlY3Rfb2s7CiAgICAgICBlbHNlCiAJLyogd2FpdCBmb3Ig
YW4gZmQgdG8gYmVjb21lIGFjdGl2ZSBvciB0aW1lIG91dCAqLwotCXdhaXRf
c3RhdGUgPSBzZWwud2FpdCAociwgdywgZSwgbXMpOworCXdhaXRfc3RhdGUg
PSBzZWwud2FpdCAociwgdywgZSwgdXMpOwogCiAgICAgICBzZWxlY3RfcHJp
bnRmICgic2VsLndhaXQgcmV0dXJucyAlZCIsIHdhaXRfc3RhdGUpOwogCkBA
IC0yMDksMTEgKzIzNiwxMSBAQCBzZWxlY3QgKGludCBtYXhmZHMsIGZkX3Nl
dCAqcmVhZGZkcywgZmRfc2V0ICp3cml0ZWZkcywgZmRfc2V0ICpleGNlcHRm
ZHMsCiAgICAgICBzZWwuY2xlYW51cCAoKTsKICAgICAgIHNlbC5kZXN0cm95
ICgpOwogICAgICAgLyogUmVjYWxjdWxhdGUgdGltZSByZW1haW5pbmcgdG8g
d2FpdCBpZiB3ZSBhcmUgZ29pbmcgdG8gYmUgbG9vcGluZy4gKi8KLSAgICAg
IGlmICh3YWl0X3N0YXRlID09IHNlbGVjdF9zdHVmZjo6c2VsZWN0X2xvb3Ag
JiYgbXMgIT0gSU5GSU5JVEUpCisgICAgICBpZiAod2FpdF9zdGF0ZSA9PSBz
ZWxlY3Rfc3R1ZmY6OnNlbGVjdF9sb29wICYmIHVzICE9IC0xKQogCXsKLQkg
IHNlbGVjdF9wcmludGYgKCJyZWNhbGN1bGF0aW5nIG1zIik7Ci0JICBMT05H
TE9ORyBub3cgPSBndG9kLm1zZWNzICgpOwotCSAgaWYgKG5vdyA+IChzdGFy
dF90aW1lICsgbXMpKQorCSAgc2VsZWN0X3ByaW50ZiAoInJlY2FsY3VsYXRp
bmcgdXMiKTsKKwkgIExPTkdMT05HIG5vdyA9IGd0b2QudXNlY3MgKCk7CisJ
ICBpZiAobm93ID4gKHN0YXJ0X3RpbWUgKyB1cykpCiAJICAgIHsKIAkgICAg
ICBzZWxlY3RfcHJpbnRmICgidGltZWQgb3V0IGFmdGVyIHZlcmlmaWNhdGlv
biIpOwogCSAgICAgIC8qIFNldCBkZXNjcmlwdG9yIGJpdHMgdG8gemVybyBw
ZXIgUE9TSVguICovCkBAIC0yMjUsOSArMjUyLDkgQEAgc2VsZWN0IChpbnQg
bWF4ZmRzLCBmZF9zZXQgKnJlYWRmZHMsIGZkX3NldCAqd3JpdGVmZHMsIGZk
X3NldCAqZXhjZXB0ZmRzLAogCSAgICB9CiAJICBlbHNlCiAJICAgIHsKLQkg
ICAgICBtcyAtPSAobm93IC0gc3RhcnRfdGltZSk7CisJICAgICAgdXMgLT0g
KG5vdyAtIHN0YXJ0X3RpbWUpOwogCSAgICAgIHN0YXJ0X3RpbWUgPSBub3c7
Ci0JICAgICAgc2VsZWN0X3ByaW50ZiAoIm1zIG5vdyAldSIsIG1zKTsKKwkg
ICAgICBzZWxlY3RfcHJpbnRmICgidXMgbm93ICVsbGQiLCB1cyk7CiAJICAg
IH0KIAl9CiAgICAgfQpAQCAtMjM4LDMzICsyNjUsNiBAQCBzZWxlY3QgKGlu
dCBtYXhmZHMsIGZkX3NldCAqcmVhZGZkcywgZmRfc2V0ICp3cml0ZWZkcywg
ZmRfc2V0ICpleGNlcHRmZHMsCiAgIHJldHVybiByZXQ7CiB9CiAKLWV4dGVy
biAiQyIgaW50Ci1wc2VsZWN0KGludCBtYXhmZHMsIGZkX3NldCAqcmVhZGZk
cywgZmRfc2V0ICp3cml0ZWZkcywgZmRfc2V0ICpleGNlcHRmZHMsCi0JY29u
c3Qgc3RydWN0IHRpbWVzcGVjICp0cywgY29uc3Qgc2lnc2V0X3QgKnNldCkK
LXsKLSAgc3RydWN0IHRpbWV2YWwgdHY7Ci0gIHNpZ3NldF90IG9sZHNldCA9
IF9teV90bHMuc2lnbWFzazsKLQotICBfX3RyeQotICAgIHsKLSAgICAgIGlm
ICh0cykKLQl7Ci0JICB0di50dl9zZWMgPSB0cy0+dHZfc2VjOwotCSAgdHYu
dHZfdXNlYyA9IHRzLT50dl9uc2VjIC8gMTAwMDsKLQl9Ci0gICAgICBpZiAo
c2V0KQotCXNldF9zaWduYWxfbWFzayAoX215X3Rscy5zaWdtYXNrLCAqc2V0
KTsKLSAgICAgIGludCByZXQgPSBjeWd3aW5fc2VsZWN0IChtYXhmZHMsIHJl
YWRmZHMsIHdyaXRlZmRzLCBleGNlcHRmZHMsCi0JCQkgICAgICAgdHMgPyAm
dHYgOiBOVUxMKTsKLSAgICAgIGlmIChzZXQpCi0Jc2V0X3NpZ25hbF9tYXNr
IChfbXlfdGxzLnNpZ21hc2ssIG9sZHNldCk7Ci0gICAgICByZXR1cm4gcmV0
OwotICAgIH0KLSAgX19leGNlcHQgKEVGQVVMVCkge30KLSAgX19lbmR0cnkK
LSAgcmV0dXJuIC0xOwotfQotCiAvKiBDYWxsIGNsZWFudXAgZnVuY3Rpb25z
IGZvciBhbGwgaW5zcGVjdGVkIGZkcy4gIEdldHMgcmlkIG9mIGFueQogICAg
ZXhlY3V0aW5nIHRocmVhZHMuICovCiB2b2lkCkBAIC0zNjIsMTMgKzM2Miw1
MiBAQCBlcnI6CiAvKiBUaGUgaGVhcnQgb2Ygc2VsZWN0LiAgV2FpdHMgZm9y
IGFuIGZkIHRvIGRvIHNvbWV0aGluZyBpbnRlcmVzdGluZy4gKi8KIHNlbGVj
dF9zdHVmZjo6d2FpdF9zdGF0ZXMKIHNlbGVjdF9zdHVmZjo6d2FpdCAoZmRf
c2V0ICpyZWFkZmRzLCBmZF9zZXQgKndyaXRlZmRzLCBmZF9zZXQgKmV4Y2Vw
dGZkcywKLQkJICAgIERXT1JEIG1zKQorCQkgICAgTE9OR0xPTkcgdXMpCiB7
CiAgIEhBTkRMRSB3NFtNQVhJTVVNX1dBSVRfT0JKRUNUU107CiAgIHNlbGVj
dF9yZWNvcmQgKnMgPSAmc3RhcnQ7CiAgIERXT1JEIG0gPSAwOwogCisgIC8q
IEFsd2F5cyB3YWl0IGZvciBzaWduYWxzLiAqLwogICB3YWl0X3NpZ25hbF9h
cnJpdmVkIGhlcmUgKHc0W20rK10pOworCisgIC8qIFNldCBhIGZhbGxiYWNr
IG1pbGxpc2Vjb25kIHRpbWVvdXQgZm9yIFdNRk8uICovCisgIERXT1JEIGRU
aW1lb3V0TXM7CisgIGlmICh1cyA+PSBJTkZJTklURSAqIDEwMDApCisgICAg
eworICAgICAgZFRpbWVvdXRNcyA9IElORklOSVRFIC0gMTsKKyAgICB9Cisg
IGVsc2UgaWYgKHVzIDwgMCkKKyAgICB7CisgICAgICBkVGltZW91dE1zID0g
SU5GSU5JVEU7CisgICAgfQorICBlbHNlCisgICAgeworICAgICAgZFRpbWVv
dXRNcyA9ICh1cyArIDk5OSkgLyAxMDAwOworICAgIH0KKyAgLyogVHJ5IHRv
IGNyZWF0ZSBhbmQgc2V0IGEgd2FpdGFibGUgdGltZXIsIGlmIGEgZmluaXRl
IHRpbWVvdXQgaGFzCisgICAgIGJlZW4gcmVxdWVzdGVkLiAgSWYgc3VjY2Vz
c2Z1bCwgZGlzYWJsZSB0aGUgZmFsbGJhY2sgdGltZW91dC4gKi8KKyAgTEFS
R0VfSU5URUdFUiBsaVRpbWVvdXQ7CisgIEhBTkRMRSBoVGltZW91dCA9IENy
ZWF0ZVdhaXRhYmxlVGltZXIgKE5VTEwsIFRSVUUsIE5VTEwpOworICBpZiAo
TlVMTCA9PSBoVGltZW91dCkKKyAgICB7CisgICAgICBzZWxlY3RfcHJpbnRm
KCJDcmVhdGVXYWl0YWJsZVRpbWVyIGZhaWxlZCAoJWQpXG4iLCBHZXRMYXN0
RXJyb3IoKSk7CisgICAgfQorICB3NFttKytdID0gaFRpbWVvdXQ7CisgIGlm
IChOVUxMICE9IGhUaW1lb3V0ICYmIHVzID49IDApCisgICAgeworICAgICAg
bGlUaW1lb3V0LlF1YWRQYXJ0ID0gLXVzICogMTA7CisgICAgICBpbnQgc2V0
cmV0OworICAgICAgaWYgKChzZXRyZXQgPSBTZXRXYWl0YWJsZVRpbWVyICho
VGltZW91dCwgJmxpVGltZW91dCwgMCwgTlVMTCwgTlVMTCwgMCkpKQorCXsK
KwkgIGRUaW1lb3V0TXMgPSBJTkZJTklURTsKKwl9CisgICAgICBlbHNlCisJ
eworCSAgc2VsZWN0X3ByaW50ZiAoIlNldFdhaXRhYmxlVGltZXIgZmFpbGVk
OiAlZCAoJTA4eClcbiIsIHNldHJldCwgR2V0TGFzdEVycm9yKCkpOworCX0K
KyAgICB9CisgIC8qIE9wdGlvbmFsbHkgd2FpdCBmb3IgcHRocmVhZCBjYW5j
ZWxsYXRpb24uICovCiAgIGlmICgodzRbbV0gPSBwdGhyZWFkOjpnZXRfY2Fu
Y2VsX2V2ZW50ICgpKSAhPSBOVUxMKQogICAgIG0rKzsKIApAQCAtMzk3LDIx
ICs0MzYsMjcgQEAgc2VsZWN0X3N0dWZmOjp3YWl0IChmZF9zZXQgKnJlYWRm
ZHMsIGZkX3NldCAqd3JpdGVmZHMsIGZkX3NldCAqZXhjZXB0ZmRzLAogbmV4
dF93aGlsZTo7CiAgICAgfQogCi0gIGRlYnVnX3ByaW50ZiAoIm0gJWQsIG1z
ICV1IiwgbSwgbXMpOworICBkZWJ1Z19wcmludGYgKCJtICVkLCB1cyAlbGx1
LCBkVGltZW91dE1zICVkIiwgbSwgdXMsIGRUaW1lb3V0TXMpOwogCiAgIERX
T1JEIHdhaXRfcmV0OwogICBpZiAoIXdpbmRvd3NfdXNlZCkKLSAgICB3YWl0
X3JldCA9IFdhaXRGb3JNdWx0aXBsZU9iamVjdHMgKG0sIHc0LCBGQUxTRSwg
bXMpOworICAgIHdhaXRfcmV0ID0gV2FpdEZvck11bHRpcGxlT2JqZWN0cyAo
bSwgdzQsIEZBTFNFLCBkVGltZW91dE1zKTsKICAgZWxzZQogICAgIC8qIFVz
aW5nIE1XTU9fSU5QVVRBVkFJTEFCTEUgaXMgdGhlIG9mZmljaWFsbHkgc3Vw
cG9ydGVkIHNvbHV0aW9uIGZvcgogICAgICAgIHRoZSBwcm9ibGVtIHRoYXQg
dGhlIGNhbGwgdG8gUGVla01lc3NhZ2UgZGlzYXJtcyB0aGUgcXVldWUgc3Rh
dGUKICAgICAgICBzbyB0aGF0IGEgc3Vic2VxdWVudCBNV0ZNTyBoYW5ncywg
ZXZlbiBpZiB0aGVyZSBhcmUgc3RpbGwgbWVzc2FnZXMKICAgICAgICBpbiB0
aGUgcXVldWUuICovCi0gICAgd2FpdF9yZXQgPSBNc2dXYWl0Rm9yTXVsdGlw
bGVPYmplY3RzRXggKG0sIHc0LCBtcywKKyAgICB3YWl0X3JldCA9IE1zZ1dh
aXRGb3JNdWx0aXBsZU9iamVjdHNFeCAobSwgdzQsIGRUaW1lb3V0TXMsCiAJ
CQkJCSAgICBRU19BTExJTlBVVCB8IFFTX0FMTFBPU1RNRVNTQUdFLAogCQkJ
CQkgICAgTVdNT19JTlBVVEFWQUlMQUJMRSk7CiAgIHNlbGVjdF9wcmludGYg
KCJ3YWl0X3JldCAlZCwgbSA9ICVkLiAgdmVyaWZ5aW5nIiwgd2FpdF9yZXQs
IG0pOwogCisgIGlmIChkVGltZW91dE1zID09IElORklOSVRFKQorICAgIHsK
KyAgICAgIENhbmNlbFdhaXRhYmxlVGltZXIgKGhUaW1lb3V0KTsKKyAgICAg
IENsb3NlSGFuZGxlIChoVGltZW91dCk7CisgICAgfQorCiAgIHdhaXRfc3Rh
dGVzIHJlczsKICAgc3dpdGNoICh3YWl0X3JldCkKICAgICB7CkBAIC00MzQs
MTIgKzQ3OSwxMyBAQCBuZXh0X3doaWxlOjsKICAgICAgIHMtPnNldF9zZWxl
Y3RfZXJybm8gKCk7CiAgICAgICByZXMgPSBzZWxlY3RfZXJyb3I7CiAgICAg
ICBicmVhazsKKyAgICBjYXNlIFdBSVRfT0JKRUNUXzAgKyAxOgogICAgIGNh
c2UgV0FJVF9USU1FT1VUOgogICAgICAgc2VsZWN0X3ByaW50ZiAoInRpbWVk
IG91dCIpOwogICAgICAgcmVzID0gc2VsZWN0X3NldF96ZXJvOwogICAgICAg
YnJlYWs7Ci0gICAgY2FzZSBXQUlUX09CSkVDVF8wICsgMToKLSAgICAgIGlm
IChzdGFydGZkcyA+IDEpCisgICAgY2FzZSBXQUlUX09CSkVDVF8wICsgMjoK
KyAgICAgIGlmIChzdGFydGZkcyA+IDIpCiAJewogCSAgY2xlYW51cCAoKTsK
IAkgIGRlc3Ryb3kgKCk7CmRpZmYgLS1naXQgYS93aW5zdXAvY3lnd2luL3Nl
bGVjdC5oIGIvd2luc3VwL2N5Z3dpbi9zZWxlY3QuaAppbmRleCAwMDM1ODIw
Li41ODFlZTRlIDEwMDY0NAotLS0gYS93aW5zdXAvY3lnd2luL3NlbGVjdC5o
CisrKyBiL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmgKQEAgLTk2LDcgKzk2LDcg
QEAgcHVibGljOgogCiAgIGJvb2wgdGVzdF9hbmRfc2V0IChpbnQsIGZkX3Nl
dCAqLCBmZF9zZXQgKiwgZmRfc2V0ICopOwogICBpbnQgcG9sbCAoZmRfc2V0
ICosIGZkX3NldCAqLCBmZF9zZXQgKik7Ci0gIHdhaXRfc3RhdGVzIHdhaXQg
KGZkX3NldCAqLCBmZF9zZXQgKiwgZmRfc2V0ICosIERXT1JEKTsKKyAgd2Fp
dF9zdGF0ZXMgd2FpdCAoZmRfc2V0ICosIGZkX3NldCAqLCBmZF9zZXQgKiwg
TE9OR0xPTkcpOwogICB2b2lkIGNsZWFudXAgKCk7CiAgIHZvaWQgZGVzdHJv
eSAoKTsKIApkaWZmIC0tZ2l0IGEvd2luc3VwL3Rlc3RzdWl0ZS9jb25maWd1
cmUgYi93aW5zdXAvdGVzdHN1aXRlL2NvbmZpZ3VyZQpvbGQgbW9kZSAxMDA2
NDQKbmV3IG1vZGUgMTAwNzU1Ci0tIAoyLjYuMwoK

--------------000600060401050706060206
Content-Type: text/plain; charset=UTF-8; x-mac-type="0"; x-mac-creator="0";
 name="0003-Move-get_nonascii_key-into-fhandler_console.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
 filename="0003-Move-get_nonascii_key-into-fhandler_console.patch"
Content-length: 3209

RnJvbSBkYzQ3NWFkNTRhYmNmMTY5MGUxZGZjNTFjMGY0YTkzMTliNjY0ZDZi
IE1vbiBTZXAgMTcgMDA6MDA6MDAgMjAwMQpGcm9tOiBKb2huIEhvb2QgPGNn
dWxsQGdsdXAub3JnPgpEYXRlOiBTYXQsIDMwIEphbiAyMDE2IDE3OjMzOjM2
IC0wNTAwClN1YmplY3Q6IFtQQVRDSCAzLzZdIE1vdmUgZ2V0X25vbmFzY2lp
X2tleSBpbnRvIGZoYW5kbGVyX2NvbnNvbGUuCgotLS0KIHdpbnN1cC9jeWd3
aW4vZmhhbmRsZXIuaCAgICAgICAgICB8IDEgKwogd2luc3VwL2N5Z3dpbi9m
aGFuZGxlcl9jb25zb2xlLmNjIHwgNCArLS0tCiB3aW5zdXAvY3lnd2luL3Nl
bGVjdC5jYyAgICAgICAgICAgfCAzICstLQogMyBmaWxlcyBjaGFuZ2VkLCAz
IGluc2VydGlvbnMoKyksIDUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEv
d2luc3VwL2N5Z3dpbi9maGFuZGxlci5oIGIvd2luc3VwL2N5Z3dpbi9maGFu
ZGxlci5oCmluZGV4IGQ5NGYzOGQuLmFkODYzMzAgMTAwNjQ0Ci0tLSBhL3dp
bnN1cC9jeWd3aW4vZmhhbmRsZXIuaAorKysgYi93aW5zdXAvY3lnd2luL2Zo
YW5kbGVyLmgKQEAgLTE0NTgsNiArMTQ1OCw3IEBAIHByaXZhdGU6CiAgIGJv
b2wgc2V0X3VuaXQgKCk7CiAgIHN0YXRpYyBib29sIG5lZWRfaW52aXNpYmxl
ICgpOwogICBzdGF0aWMgdm9pZCBmcmVlX2NvbnNvbGUgKCk7CisgIHN0YXRp
YyBjb25zdCBjaGFyICpnZXRfbm9uYXNjaWlfa2V5IChJTlBVVF9SRUNPUkQm
IGlucHV0X3JlYywgY2hhciAqKTsKIAogICBmaGFuZGxlcl9jb25zb2xlICh2
b2lkICopIHt9CiAKZGlmZiAtLWdpdCBhL3dpbnN1cC9jeWd3aW4vZmhhbmRs
ZXJfY29uc29sZS5jYyBiL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXJfY29uc29s
ZS5jYwppbmRleCBhNTI0NDllLi4zZWQxZmU4IDEwMDY0NAotLS0gYS93aW5z
dXAvY3lnd2luL2ZoYW5kbGVyX2NvbnNvbGUuY2MKKysrIGIvd2luc3VwL2N5
Z3dpbi9maGFuZGxlcl9jb25zb2xlLmNjCkBAIC00Niw4ICs0Niw2IEBAIGRl
dGFpbHMuICovCiAjZGVmaW5lIHNyVG9wIChjb24uYi5zcldpbmRvdy5Ub3Ag
KyBjb24uc2Nyb2xsX3JlZ2lvbi5Ub3ApCiAjZGVmaW5lIHNyQm90dG9tICgo
Y29uLnNjcm9sbF9yZWdpb24uQm90dG9tIDwgMCkgPyBjb24uYi5zcldpbmRv
dy5Cb3R0b20gOiBjb24uYi5zcldpbmRvdy5Ub3AgKyBjb24uc2Nyb2xsX3Jl
Z2lvbi5Cb3R0b20pCiAKLWNvbnN0IGNoYXIgKmdldF9ub25hc2NpaV9rZXkg
KElOUFVUX1JFQ09SRCYsIGNoYXIgKik7Ci0KIGNvbnN0IHVuc2lnbmVkIGZo
YW5kbGVyX2NvbnNvbGU6Ok1BWF9XUklURV9DSEFSUyA9IDE2Mzg0OwogCiBm
aGFuZGxlcl9jb25zb2xlOjpjb25zb2xlX3N0YXRlIE5PX0NPUFkgKmZoYW5k
bGVyX2NvbnNvbGU6OnNoYXJlZF9jb25zb2xlX2luZm87CkBAIC0yMzc3LDcg
KzIzNzUsNyBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IHsKIH07CiAKIGNvbnN0
IGNoYXIgKgotZ2V0X25vbmFzY2lpX2tleSAoSU5QVVRfUkVDT1JEJiBpbnB1
dF9yZWMsIGNoYXIgKnRtcCkKK2ZoYW5kbGVyX2NvbnNvbGU6OmdldF9ub25h
c2NpaV9rZXkgKElOUFVUX1JFQ09SRCYgaW5wdXRfcmVjLCBjaGFyICp0bXAp
CiB7CiAjZGVmaW5lIE5PUk1BTCAgMAogI2RlZmluZSBTSElGVAkxCmRpZmYg
LS1naXQgYS93aW5zdXAvY3lnd2luL3NlbGVjdC5jYyBiL3dpbnN1cC9jeWd3
aW4vc2VsZWN0LmNjCmluZGV4IDRmMjJkOTIuLjA4ZjZmYzIgMTAwNjQ0Ci0t
LSBhL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmNjCisrKyBiL3dpbnN1cC9jeWd3
aW4vc2VsZWN0LmNjCkBAIC04ODUsNyArODg1LDYgQEAgZmhhbmRsZXJfZmlm
bzo6c2VsZWN0X2V4Y2VwdCAoc2VsZWN0X3N0dWZmICpzcykKIHN0YXRpYyBp
bnQKIHBlZWtfY29uc29sZSAoc2VsZWN0X3JlY29yZCAqbWUsIGJvb2wpCiB7
Ci0gIGV4dGVybiBjb25zdCBjaGFyICogZ2V0X25vbmFzY2lpX2tleSAoSU5Q
VVRfUkVDT1JEJiBpbnB1dF9yZWMsIGNoYXIgKik7CiAgIGZoYW5kbGVyX2Nv
bnNvbGUgKmZoID0gKGZoYW5kbGVyX2NvbnNvbGUgKikgbWUtPmZoOwogCiAg
IGlmICghbWUtPnJlYWRfc2VsZWN0ZWQpCkBAIC05MjEsNyArOTIwLDcgQEAg
cGVla19jb25zb2xlIChzZWxlY3RfcmVjb3JkICptZSwgYm9vbCkKIAkgIHsK
IAkgICAgaWYgKGlyZWMuRXZlbnQuS2V5RXZlbnQuYktleURvd24KIAkJJiYg
KGlyZWMuRXZlbnQuS2V5RXZlbnQudUNoYXIuQXNjaWlDaGFyCi0JCSAgICB8
fCBnZXRfbm9uYXNjaWlfa2V5IChpcmVjLCB0bXBidWYpKSkKKwkJICAgIHx8
IGZoYW5kbGVyX2NvbnNvbGU6OmdldF9ub25hc2NpaV9rZXkgKGlyZWMsIHRt
cGJ1ZikpKQogCSAgICAgIHJldHVybiBtZS0+cmVhZF9yZWFkeSA9IHRydWU7
CiAJICB9CiAJZWxzZQotLSAKMi42LjMKCg==

--------------000600060401050706060206
Content-Type: text/plain; charset=UTF-8; x-mac-type="0"; x-mac-creator="0";
 name="0004-Debug-printfs.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
 filename="0004-Debug-printfs.patch"
Content-length: 4144

RnJvbSAxNmMxY2RlZDAxZWZhOWIxNWNjNWIxMjdkOTQ4OTgxYmYzMTlkYmYz
IE1vbiBTZXAgMTcgMDA6MDA6MDAgMjAwMQpGcm9tOiBKb2huIEhvb2QgPGNn
dWxsQGdsdXAub3JnPgpEYXRlOiBTYXQsIDMwIEphbiAyMDE2IDE3OjM3OjMz
IC0wNTAwClN1YmplY3Q6IFtQQVRDSCA0LzZdIERlYnVnIHByaW50ZnMKCi0t
LQogd2luc3VwL2N5Z3dpbi9maGFuZGxlci5jYyAgICAgICAgIHwgIDEgKwog
d2luc3VwL2N5Z3dpbi9maGFuZGxlcl9jb25zb2xlLmNjIHwgIDkgKysrKysr
KystCiB3aW5zdXAvY3lnd2luL3NlbGVjdC5jYyAgICAgICAgICAgfCAxMiAr
KysrKysrKysrKy0KIDMgZmlsZXMgY2hhbmdlZCwgMjAgaW5zZXJ0aW9ucygr
KSwgMiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS93aW5zdXAvY3lnd2lu
L2ZoYW5kbGVyLmNjIGIvd2luc3VwL2N5Z3dpbi9maGFuZGxlci5jYwppbmRl
eCA3ZTRkOTk2Li40YzlkZjczIDEwMDY0NAotLS0gYS93aW5zdXAvY3lnd2lu
L2ZoYW5kbGVyLmNjCisrKyBiL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXIuY2MK
QEAgLTkwLDYgKzkwLDcgQEAgZmhhbmRsZXJfYmFzZTo6Z2V0X3JlYWRhaGVh
ZCAoKQogICAvKiBGSVhNRSAtIG5vdCB0aHJlYWQgc2FmZSAqLwogICBpZiAo
cmFpeGdldCA+PSByYWxlbikKICAgICByYWl4Z2V0ID0gcmFpeHB1dCA9IHJh
bGVuID0gMDsKKyAgZGVidWdfcHJpbnRmKCJhdmFpbGFibGU6ICVkIiwgY2hy
ZXQgPiAtMSk7CiAgIHJldHVybiBjaHJldDsKIH0KIApkaWZmIC0tZ2l0IGEv
d2luc3VwL2N5Z3dpbi9maGFuZGxlcl9jb25zb2xlLmNjIGIvd2luc3VwL2N5
Z3dpbi9maGFuZGxlcl9jb25zb2xlLmNjCmluZGV4IDNlZDFmZTguLjNjZjJm
NDEgMTAwNjQ0Ci0tLSBhL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXJfY29uc29s
ZS5jYworKysgYi93aW5zdXAvY3lnd2luL2ZoYW5kbGVyX2NvbnNvbGUuY2MK
QEAgLTMwOCw3ICszMDgsOSBAQCBmaGFuZGxlcl9jb25zb2xlOjpyZWFkICh2
b2lkICpwdiwgc2l6ZV90JiBidWZsZW4pCiAgIGludCBjaDsKICAgc2V0X2lu
cHV0X3N0YXRlICgpOwogCisgIGRlYnVnX3ByaW50ZigicmVxdWVzdGVkIGJ1
ZmxlbiAlZCIsIGJ1Zmxlbik7CiAgIGludCBjb3BpZWRfY2hhcnMgPSBnZXRf
cmVhZGFoZWFkX2ludG9fYnVmZmVyIChidWYsIGJ1Zmxlbik7CisgIGRlYnVn
X3ByaW50ZigiY29waWVkX2NoYXJzICVkIiwgY29waWVkX2NoYXJzKTsKIAog
ICBpZiAoY29waWVkX2NoYXJzKQogICAgIHsKQEAgLTY4Niw5ICs2ODgsMTEg
QEAgZmhhbmRsZXJfY29uc29sZTo6cmVhZCAodm9pZCAqcHYsIHNpemVfdCYg
YnVmbGVuKQogCSAgY29udGludWU7CiAJfQogCisgICAgICBkZWJ1Z19wcmlu
dGYoInRvYWRkID0gJXAsIG5yZWFkID0gJWQiLCB0b2FkZCwgbnJlYWQpOwog
ICAgICAgaWYgKHRvYWRkKQogCXsKLQkgIGxpbmVfZWRpdF9zdGF0dXMgcmVz
ID0gbGluZV9lZGl0ICh0b2FkZCwgbnJlYWQsIHRpKTsKKwkgIHNzaXplX3Qg
Ynl0ZXNfcmVhZDsKKwkgIGxpbmVfZWRpdF9zdGF0dXMgcmVzID0gbGluZV9l
ZGl0ICh0b2FkZCwgbnJlYWQsIHRpLCAmYnl0ZXNfcmVhZCk7CiAJICBpZiAo
cmVzID09IGxpbmVfZWRpdF9zaWduYWxsZWQpCiAJICAgIGdvdG8gc2lnX2V4
aXQ7CiAJICBlbHNlIGlmIChyZXMgPT0gbGluZV9lZGl0X2lucHV0X2RvbmUp
CkBAIC02OTYsNiArNzAwLDggQEAgZmhhbmRsZXJfY29uc29sZTo6cmVhZCAo
dm9pZCAqcHYsIHNpemVfdCYgYnVmbGVuKQogCX0KICAgICB9CiAKKyAgZGVi
dWdfcHJpbnRmKCJyYWxlbiA9ICVkLCBieXRlcyA9ICVkIiwgcmFsZW4sIHJh
bGVuIC0gcmFpeGdldCk7CisKICAgd2hpbGUgKGJ1ZmxlbikKICAgICBpZiAo
KGNoID0gZ2V0X3JlYWRhaGVhZCAoKSkgPCAwKQogICAgICAgYnJlYWs7CkBA
IC03MDcsNiArNzEzLDcgQEAgZmhhbmRsZXJfY29uc29sZTo6cmVhZCAodm9p
ZCAqcHYsIHNpemVfdCYgYnVmbGVuKQogI3VuZGVmIGJ1ZgogCiAgIGJ1Zmxl
biA9IGNvcGllZF9jaGFyczsKKyAgZGVidWdfcHJpbnRmKCJidWZsZW4gc2V0
IHRvICVkIiwgYnVmbGVuKTsKICAgcmV0dXJuOwogCiBlcnI6CmRpZmYgLS1n
aXQgYS93aW5zdXAvY3lnd2luL3NlbGVjdC5jYyBiL3dpbnN1cC9jeWd3aW4v
c2VsZWN0LmNjCmluZGV4IDA4ZjZmYzIuLjgzOTYyMmYgMTAwNjQ0Ci0tLSBh
L3dpbnN1cC9jeWd3aW4vc2VsZWN0LmNjCisrKyBiL3dpbnN1cC9jeWd3aW4v
c2VsZWN0LmNjCkBAIC05MjEsMTggKzkyMSwyOCBAQCBwZWVrX2NvbnNvbGUg
KHNlbGVjdF9yZWNvcmQgKm1lLCBib29sKQogCSAgICBpZiAoaXJlYy5FdmVu
dC5LZXlFdmVudC5iS2V5RG93bgogCQkmJiAoaXJlYy5FdmVudC5LZXlFdmVu
dC51Q2hhci5Bc2NpaUNoYXIKIAkJICAgIHx8IGZoYW5kbGVyX2NvbnNvbGU6
OmdldF9ub25hc2NpaV9rZXkgKGlyZWMsIHRtcGJ1ZikpKQotCSAgICAgIHJl
dHVybiBtZS0+cmVhZF9yZWFkeSA9IHRydWU7CisJICAgICAgeworCQlkZWJ1
Z19wcmludGYoInBlZWtlZCBLRVlfRVZFTlQiKTsKKwkJcmV0dXJuIG1lLT5y
ZWFkX3JlYWR5ID0gdHJ1ZTsKKwkgICAgICB9CiAJICB9CiAJZWxzZQogCSAg
ewogCSAgICBpZiAoaXJlYy5FdmVudFR5cGUgPT0gTU9VU0VfRVZFTlQKIAkJ
JiYgZmgtPm1vdXNlX2F3YXJlIChpcmVjLkV2ZW50Lk1vdXNlRXZlbnQpKQor
CSAgICAgIHsKKwkJZGVidWdfcHJpbnRmKCJwZWVrZWQgTU9VU0VfRVZFTlQi
KTsKIAkJcmV0dXJuIG1lLT5yZWFkX3JlYWR5ID0gdHJ1ZTsKKwkgICAgICB9
CiAJICAgIGlmIChpcmVjLkV2ZW50VHlwZSA9PSBGT0NVU19FVkVOVCAmJiBm
aC0+Zm9jdXNfYXdhcmUgKCkpCisJICAgICAgeworCQlkZWJ1Z19wcmludGYo
InBlZWtlZCBGT0NVU19FVkVOVCIpOwogCQlyZXR1cm4gbWUtPnJlYWRfcmVh
ZHkgPSB0cnVlOworCSAgICAgIH0KIAkgIH0KIAogCS8qIFJlYWQgYW5kIGRp
c2NhcmQgdGhlIGV2ZW50ICovCisJZGVidWdfcHJpbnRmKCJkaXNjYXJkZWQg
b3RoZXIgZXZlbnQiKTsKIAlSZWFkQ29uc29sZUlucHV0IChoLCAmaXJlYywg
MSwgJmV2ZW50c19yZWFkKTsKICAgICAgIH0KIAotLSAKMi42LjMKCg==

--------------000600060401050706060206
Content-Type: text/plain; charset=UTF-8; x-mac-type="0"; x-mac-creator="0";
 name="0005-Improve-select-implementation.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
 filename="0005-Improve-select-implementation.patch"
Content-length: 8455

RnJvbSBlNWMxMjliNzNmZGE5Yzk2YjNjMTRmZGNhYzgyY2IxNWNhNjk1ZTRk
IE1vbiBTZXAgMTcgMDA6MDA6MDAgMjAwMQpGcm9tOiBKb2huIEhvb2QgPGNn
dWxsQGdsdXAub3JnPgpEYXRlOiBUaHUsIDQgRmViIDIwMTYgMDA6NDQ6NTYg
LTA1MDAKU3ViamVjdDogW1BBVENIIDUvNl0gSW1wcm92ZSBzZWxlY3QgaW1w
bGVtZW50YXRpb24uCgpUaGlzIHNpbXBsaWZpZXMgdGltZW91dCBoYW5kbGlu
ZyBhbmQgbWFrZXMgaXQgc2xpZ2h0bHkgbW9yZSBjb3JyZWN0LgpJdCBlbnN1
cmVzIHRoYXQgc2VsZWN0KCkgbmV2ZXIgcmV0dXJucyBlYXJseSwgZXZlbiB3
aXRoIHNsb3BweSB0aW1lcnMKb24gbmV3ZXIgdmVyc2lvbnMgb2YgV2luZG93
cywgYW5kIGhhbmRsZXMgdW5pbnRlcmVzdGluZyBXaW5kb3dzIGV2ZW50cwpj
bGVhbmx5LgotLS0KIHdpbnN1cC9jeWd3aW4vY3lnd2FpdC5oIHwgMjcgLS0t
LS0tLS0tLS0tLS0tLS0tLS0tCiB3aW5zdXAvY3lnd2luL3NlbGVjdC5jYyB8
IDYzICsrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0KIHdpbnN1cC9jeWd3aW4vc2VsZWN0LmggIHwgIDEgLQogMyBm
aWxlcyBjaGFuZ2VkLCAxNSBpbnNlcnRpb25zKCspLCA3NiBkZWxldGlvbnMo
LSkKCmRpZmYgLS1naXQgYS93aW5zdXAvY3lnd2luL2N5Z3dhaXQuaCBiL3dp
bnN1cC9jeWd3aW4vY3lnd2FpdC5oCmluZGV4IDNlMDJjZGQuLjEyNDBmNTQg
MTAwNjQ0Ci0tLSBhL3dpbnN1cC9jeWd3aW4vY3lnd2FpdC5oCisrKyBiL3dp
bnN1cC9jeWd3aW4vY3lnd2FpdC5oCkBAIC01OSwzMCArNTksMyBAQCBjeWd3
YWl0IChEV09SRCBob3dsb25nKQogewogICByZXR1cm4gY3lnd2FpdCAoTlVM
TCwgaG93bG9uZyk7CiB9Ci0KLWV4dGVybiBpbmxpbmUgRFdPUkQgX19hdHRy
aWJ1dGVfXyAoKGFsd2F5c19pbmxpbmUpKQotY3lnd2FpdF91cyAoSEFORExF
IGgsIExPTkdMT05HIGhvd2xvbmcsIHVuc2lnbmVkIG1hc2spCi17Ci0gIExB
UkdFX0lOVEVHRVIgbGlfaG93bG9uZzsKLSAgUExBUkdFX0lOVEVHRVIgcGxp
X2hvd2xvbmc7Ci0gIGlmIChob3dsb25nIDwgMExMKQotICAgIHBsaV9ob3ds
b25nID0gTlVMTDsKLSAgZWxzZQotICAgIHsKLSAgICAgIGxpX2hvd2xvbmcu
UXVhZFBhcnQgPSAtKDEwTEwgKiBob3dsb25nKTsKLSAgICAgIHBsaV9ob3ds
b25nID0gJmxpX2hvd2xvbmc7Ci0gICAgfQotICByZXR1cm4gY3lnd2FpdCAo
aCwgcGxpX2hvd2xvbmcsIG1hc2spOwotfQotCi1zdGF0aWMgaW5saW5lIERX
T1JEIF9fYXR0cmlidXRlX18gKChhbHdheXNfaW5saW5lKSkKLWN5Z3dhaXRf
dXMgKEhBTkRMRSBoLCBMT05HTE9ORyBob3dsb25nID0gLTEpCi17Ci0gIHJl
dHVybiBjeWd3YWl0X3VzIChoLCBob3dsb25nLCBjd19jYW5jZWwgfCBjd19z
aWcpOwotfQotCi1zdGF0aWMgaW5saW5lIERXT1JEIF9fYXR0cmlidXRlX18g
KChhbHdheXNfaW5saW5lKSkKLWN5Z3dhaXRfdXMgKExPTkdMT05HIGhvd2xv
bmcpCi17Ci0gIHJldHVybiBjeWd3YWl0X3VzIChOVUxMLCBob3dsb25nKTsK
LX0KZGlmZiAtLWdpdCBhL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmNjIGIvd2lu
c3VwL2N5Z3dpbi9zZWxlY3QuY2MKaW5kZXggODM5NjIyZi4uODcyZmM4NSAx
MDA2NDQKLS0tIGEvd2luc3VwL2N5Z3dpbi9zZWxlY3QuY2MKKysrIGIvd2lu
c3VwL2N5Z3dpbi9zZWxlY3QuY2MKQEAgLTMyLDcgKzMyLDYgQEAgZGV0YWls
cy4gKi8KICNpbmNsdWRlICJwaW5mby5oIgogI2luY2x1ZGUgInNpZ3Byb2Mu
aCIKICNpbmNsdWRlICJjeWd0bHMuaCIKLSNpbmNsdWRlICJjeWd3YWl0Lmgi
CiAKIC8qCiAgKiBBbGwgdGhlc2UgZGVmaW5lcyBiZWxvdyBzaG91bGQgYmUg
aW4gc3lzL3R5cGVzLmgKQEAgLTE1Niw3ICsxNTUsNyBAQCBzdGF0aWMgaW50
CiBzZWxlY3QgKGludCBtYXhmZHMsIGZkX3NldCAqcmVhZGZkcywgZmRfc2V0
ICp3cml0ZWZkcywgZmRfc2V0ICpleGNlcHRmZHMsCiAJTE9OR0xPTkcgdXMp
CiB7Ci0gIHNlbGVjdF9zdHVmZjo6d2FpdF9zdGF0ZXMgd2FpdF9zdGF0ZSA9
IHNlbGVjdF9zdHVmZjo6c2VsZWN0X2xvb3A7CisgIHNlbGVjdF9zdHVmZjo6
d2FpdF9zdGF0ZXMgd2FpdF9zdGF0ZSA9IHNlbGVjdF9zdHVmZjo6c2VsZWN0
X3NldF96ZXJvOwogICBpbnQgcmV0ID0gMDsKIAogICAvKiBSZWNvcmQgdGhl
IGN1cnJlbnQgdGltZSBmb3IgbGF0ZXIgdXNlLiAqLwpAQCAtMTgyLDMwICsx
ODEsNyBAQCBzZWxlY3QgKGludCBtYXhmZHMsIGZkX3NldCAqcmVhZGZkcywg
ZmRfc2V0ICp3cml0ZWZkcywgZmRfc2V0ICpleGNlcHRmZHMsCiAJICB9CiAg
ICAgICBzZWxlY3RfcHJpbnRmICgic2VsLmFsd2F5c19yZWFkeSAlZCIsIHNl
bC5hbHdheXNfcmVhZHkpOwogCi0gICAgICAvKiBEZWdlbmVyYXRlIGNhc2Uu
ICBObyBmZHMgdG8gd2FpdCBmb3IuICBKdXN0IHdhaXQgZm9yIHRpbWUgdG8g
cnVuIG91dAotCSBvciBzaWduYWwgdG8gYXJyaXZlLiAqLwotICAgICAgaWYg
KHNlbC5zdGFydC5uZXh0ID09IE5VTEwpCi0Jc3dpdGNoIChjeWd3YWl0X3Vz
ICh1cykpCi0JICB7Ci0JICBjYXNlIFdBSVRfU0lHTkFMRUQ6Ci0JICAgIHNl
bGVjdF9wcmludGYgKCJzaWduYWwgcmVjZWl2ZWQiKTsKLQkgICAgLyogc2Vs
ZWN0KCkgaXMgYWx3YXlzIGludGVycnVwdGVkIGJ5IGEgc2lnbmFsIHNvIHNl
dCBFSU5UUiwKLQkgICAgICAgdW5jb25kaXRpb25hbGx5LCBpZ25vcmluZyBh
bnkgU0FfUkVTVEFSVCBkZXRlY3Rpb24gYnkKLQkgICAgICAgY2FsbF9zaWdu
YWxfaGFuZGxlcigpLiAgKi8KLQkgICAgX215X3Rscy5jYWxsX3NpZ25hbF9o
YW5kbGVyICgpOwotCSAgICBzZXRfc2lnX2Vycm5vIChFSU5UUik7Ci0JICAg
IHdhaXRfc3RhdGUgPSBzZWxlY3Rfc3R1ZmY6OnNlbGVjdF9zaWduYWxsZWQ7
Ci0JICAgIGJyZWFrOwotCSAgY2FzZSBXQUlUX0NBTkNFTEVEOgotCSAgICBz
ZWwuZGVzdHJveSAoKTsKLQkgICAgcHRocmVhZDo6c3RhdGljX2NhbmNlbF9z
ZWxmICgpOwotCSAgICAvKk5PVFJFQUNIRUQqLwotCSAgZGVmYXVsdDoKLQkg
ICAgLyogU2V0IHdhaXRfc3RhdGUgdG8gemVybyBiZWxvdy4gKi8KLQkgICAg
d2FpdF9zdGF0ZSA9IHNlbGVjdF9zdHVmZjo6c2VsZWN0X3NldF96ZXJvOwot
CSAgICBicmVhazsKLQkgIH0KLSAgICAgIGVsc2UgaWYgKHNlbC5hbHdheXNf
cmVhZHkgfHwgdXMgPT0gMCkKKyAgICAgIGlmIChzZWwuYWx3YXlzX3JlYWR5
IHx8IHVzID09IDApCiAJLyogQ2F0Y2ggYW55IGFjdGl2ZSBmZHMgdmlhIHNl
bC5wb2xsKCkgYmVsb3cgKi8KIAl3YWl0X3N0YXRlID0gc2VsZWN0X3N0dWZm
OjpzZWxlY3Rfb2s7CiAgICAgICBlbHNlCkBAIC0yMTQsMjkgKzE5MCwyNCBA
QCBzZWxlY3QgKGludCBtYXhmZHMsIGZkX3NldCAqcmVhZGZkcywgZmRfc2V0
ICp3cml0ZWZkcywgZmRfc2V0ICpleGNlcHRmZHMsCiAKICAgICAgIHNlbGVj
dF9wcmludGYgKCJzZWwud2FpdCByZXR1cm5zICVkIiwgd2FpdF9zdGF0ZSk7
CiAKLSAgICAgIGlmICh3YWl0X3N0YXRlID49IHNlbGVjdF9zdHVmZjo6c2Vs
ZWN0X29rKQorICAgICAgaWYgKHdhaXRfc3RhdGUgPT0gc2VsZWN0X3N0dWZm
OjpzZWxlY3Rfb2spCiAJewogCSAgVU5JWF9GRF9aRVJPIChyZWFkZmRzLCBt
YXhmZHMpOwogCSAgVU5JWF9GRF9aRVJPICh3cml0ZWZkcywgbWF4ZmRzKTsK
IAkgIFVOSVhfRkRfWkVSTyAoZXhjZXB0ZmRzLCBtYXhmZHMpOwotCSAgaWYg
KHdhaXRfc3RhdGUgPT0gc2VsZWN0X3N0dWZmOjpzZWxlY3Rfc2V0X3plcm8p
Ci0JICAgIHJldCA9IDA7Ci0JICBlbHNlCi0JICAgIHsKLQkgICAgICAvKiBT
ZXQgYml0IG1hc2sgZnJvbSBzZWwgcmVjb3Jkcy4gIFRoaXMgYWxzbyBzZXRz
IHJldCB0byB0aGUKLQkJIHJpZ2h0IHZhbHVlID49IDAsIG1hdGNoaW5nIHRo
ZSBudW1iZXIgb2YgYml0cyBzZXQgaW4gdGhlCi0JCSBmZHMgcmVjb3Jkcy4g
IGlmIHJldCBpcyAwLCBjb250aW51ZSB0byBsb29wLiAqLwotCSAgICAgIHJl
dCA9IHNlbC5wb2xsIChyZWFkZmRzLCB3cml0ZWZkcywgZXhjZXB0ZmRzKTsK
LQkgICAgICBpZiAoIXJldCkKLQkJd2FpdF9zdGF0ZSA9IHNlbGVjdF9zdHVm
Zjo6c2VsZWN0X2xvb3A7Ci0JICAgIH0KKwkgIC8qIFNldCBiaXQgbWFzayBm
cm9tIHNlbCByZWNvcmRzLiAgVGhpcyBhbHNvIHNldHMgcmV0IHRvIHRoZQor
CSAgICAgcmlnaHQgdmFsdWUgPj0gMCwgbWF0Y2hpbmcgdGhlIG51bWJlciBv
ZiBiaXRzIHNldCBpbiB0aGUKKwkgICAgIGZkcyByZWNvcmRzLiAgaWYgcmV0
IGlzIDAsIGNvbnRpbnVlIHRvIGxvb3AuICovCisJICByZXQgPSBzZWwucG9s
bCAocmVhZGZkcywgd3JpdGVmZHMsIGV4Y2VwdGZkcyk7CisJICBpZiAoIXJl
dCkKKwkgICAgd2FpdF9zdGF0ZSA9IHNlbGVjdF9zdHVmZjo6c2VsZWN0X3Nl
dF96ZXJvOwogCX0KICAgICAgIC8qIEFsd2F5cyBjbGVhbiB1cCBldmVyeXRo
aW5nIGhlcmUuICBJZiB3ZSdyZSBsb29waW5nIHRoZW4gYnVpbGQgaXQKIAkg
YWxsIHVwIGFnYWluLiAgKi8KICAgICAgIHNlbC5jbGVhbnVwICgpOwogICAg
ICAgc2VsLmRlc3Ryb3kgKCk7Ci0gICAgICAvKiBSZWNhbGN1bGF0ZSB0aW1l
IHJlbWFpbmluZyB0byB3YWl0IGlmIHdlIGFyZSBnb2luZyB0byBiZSBsb29w
aW5nLiAqLwotICAgICAgaWYgKHdhaXRfc3RhdGUgPT0gc2VsZWN0X3N0dWZm
OjpzZWxlY3RfbG9vcCAmJiB1cyAhPSAtMSkKKyAgICAgIC8qIENoZWNrIGFu
ZCByZWNhbGN1bGF0ZSB0aW1lb3V0LiAqLworICAgICAgaWYgKHVzICE9IC0x
TEwgJiYgd2FpdF9zdGF0ZSA9PSBzZWxlY3Rfc3R1ZmY6OnNlbGVjdF9zZXRf
emVybykKIAl7CiAJICBzZWxlY3RfcHJpbnRmICgicmVjYWxjdWxhdGluZyB1
cyIpOwogCSAgTE9OR0xPTkcgbm93ID0gZ3RvZC51c2VjcyAoKTsKQEAgLTI1
OCw3ICsyMjksNyBAQCBzZWxlY3QgKGludCBtYXhmZHMsIGZkX3NldCAqcmVh
ZGZkcywgZmRfc2V0ICp3cml0ZWZkcywgZmRfc2V0ICpleGNlcHRmZHMsCiAJ
ICAgIH0KIAl9CiAgICAgfQotICB3aGlsZSAod2FpdF9zdGF0ZSA9PSBzZWxl
Y3Rfc3R1ZmY6OnNlbGVjdF9sb29wKTsKKyAgd2hpbGUgKHdhaXRfc3RhdGUg
PT0gc2VsZWN0X3N0dWZmOjpzZWxlY3Rfc2V0X3plcm8pOwogCiAgIGlmICh3
YWl0X3N0YXRlIDwgc2VsZWN0X3N0dWZmOjpzZWxlY3Rfb2spCiAgICAgcmV0
ID0gLTE7CkBAIC00OTYsNyArNDY3LDcgQEAgbmV4dF93aGlsZTo7CiAJIHRv
IHdhaXQgZm9yLiAgKi8KICAgICBkZWZhdWx0OgogICAgICAgcyA9ICZzdGFy
dDsKLSAgICAgIGJvb2wgZ290b25lID0gZmFsc2U7CisgICAgICByZXMgPSBz
ZWxlY3Rfc2V0X3plcm87CiAgICAgICAvKiBTb21lIHR5cGVzIG9mIG9iamVj
dHMgKGUuZy4sIGNvbnNvbGVzKSB3YWtlIHVwIG9uICJpbmFwcHJvcHJpYXRl
IgogCSBldmVudHMgbGlrZSBtb3VzZSBtb3ZlbWVudHMuICBUaGUgdmVyaWZ5
IGZ1bmN0aW9uIHdpbGwgZGV0ZWN0IHRoZXNlCiAJIHNpdHVhdGlvbnMuICBJ
ZiBpdCByZXR1cm5zIGZhbHNlLCB0aGVuIHRoaXMgd2FrZXVwIHdhcyBhIGZh
bHNlIGFsYXJtCkBAIC01MTAsMTMgKzQ4MSw5IEBAIG5leHRfd2hpbGU6Owog
CSAgfQogCWVsc2UgaWYgKCgoKHdhaXRfcmV0ID49IG0gJiYgcy0+d2luZG93
c19oYW5kbGUpIHx8IHMtPmggPT0gdzRbd2FpdF9yZXRdKSkKIAkJICYmIHMt
PnZlcmlmeSAocywgcmVhZGZkcywgd3JpdGVmZHMsIGV4Y2VwdGZkcykpCi0J
ICBnb3RvbmUgPSB0cnVlOworCSAgcmVzID0gc2VsZWN0X29rOwogCi0gICAg
ICBpZiAoIWdvdG9uZSkKLQlyZXMgPSBzZWxlY3RfbG9vcDsKLSAgICAgIGVs
c2UKLQlyZXMgPSBzZWxlY3Rfb2s7Ci0gICAgICBzZWxlY3RfcHJpbnRmICgi
Z290b25lICVkIiwgZ290b25lKTsKKyAgICAgIHNlbGVjdF9wcmludGYgKCJy
ZXMgYWZ0ZXIgdmVyaWZ5ICVkIiwgcmVzKTsKICAgICAgIGJyZWFrOwogICAg
IH0KIG91dDoKZGlmZiAtLWdpdCBhL3dpbnN1cC9jeWd3aW4vc2VsZWN0Lmgg
Yi93aW5zdXAvY3lnd2luL3NlbGVjdC5oCmluZGV4IDU4MWVlNGUuLjNjNzQ5
YWQgMTAwNjQ0Ci0tLSBhL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmgKKysrIGIv
d2luc3VwL2N5Z3dpbi9zZWxlY3QuaApAQCAtNzgsNyArNzgsNiBAQCBwdWJs
aWM6CiAgIGVudW0gd2FpdF9zdGF0ZXMKICAgewogICAgIHNlbGVjdF9zaWdu
YWxsZWQgPSAtMywKLSAgICBzZWxlY3RfbG9vcCA9IC0yLAogICAgIHNlbGVj
dF9lcnJvciA9IC0xLAogICAgIHNlbGVjdF9vayA9IDAsCiAgICAgc2VsZWN0
X3NldF96ZXJvID0gMQotLSAKMi42LjMKCg==

--------------000600060401050706060206
Content-Type: text/plain; charset=UTF-8; x-mac-type="0"; x-mac-creator="0";
 name="0006-Regress-to-undocumented-Nt-Timer-calls.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
 filename="0006-Regress-to-undocumented-Nt-Timer-calls.patch"
Content-length: 3294

RnJvbSA5NWNlNzllZDVhMDcyNzgzOTkwMDhkMjI3NDdhNjYyYjA5ZDNjM2Fl
IE1vbiBTZXAgMTcgMDA6MDA6MDAgMjAwMQpGcm9tOiBKb2huIEhvb2QgPGNn
dWxsQGdsdXAub3JnPgpEYXRlOiBUaHUsIDQgRmViIDIwMTYgMDM6NDY6MzQg
LTA1MDAKU3ViamVjdDogW1BBVENIIDYvNl0gUmVncmVzcyB0byB1bmRvY3Vt
ZW50ZWQgTnQqVGltZXIgY2FsbHMuCgotLS0KIHdpbnN1cC9jeWd3aW4vc2Vs
ZWN0LmNjIHwgMzggKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0t
LS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAxOCBpbnNlcnRpb25zKCspLCAyMCBk
ZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS93aW5zdXAvY3lnd2luL3NlbGVj
dC5jYyBiL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmNjCmluZGV4IDg3MmZjODUu
LjRiZmM0ODQgMTAwNjQ0Ci0tLSBhL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmNj
CisrKyBiL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmNjCkBAIC0zNDIsNDIgKzM0
Miw0MCBAQCBzZWxlY3Rfc3R1ZmY6OndhaXQgKGZkX3NldCAqcmVhZGZkcywg
ZmRfc2V0ICp3cml0ZWZkcywgZmRfc2V0ICpleGNlcHRmZHMsCiAgIC8qIEFs
d2F5cyB3YWl0IGZvciBzaWduYWxzLiAqLwogICB3YWl0X3NpZ25hbF9hcnJp
dmVkIGhlcmUgKHc0W20rK10pOwogCi0gIC8qIFNldCBhIGZhbGxiYWNrIG1p
bGxpc2Vjb25kIHRpbWVvdXQgZm9yIFdNRk8uICovCisgIC8qIFNldCBhIHRp
bWVvdXQsIG9yIG5vdCwgZm9yIFdNRk8uICovCiAgIERXT1JEIGRUaW1lb3V0
TXM7Ci0gIGlmICh1cyA+PSBJTkZJTklURSAqIDEwMDApCisgIGlmICh1cyA9
PSAwKQogICAgIHsKLSAgICAgIGRUaW1lb3V0TXMgPSBJTkZJTklURSAtIDE7
Ci0gICAgfQotICBlbHNlIGlmICh1cyA8IDApCi0gICAgewotICAgICAgZFRp
bWVvdXRNcyA9IElORklOSVRFOworICAgICAgZFRpbWVvdXRNcyA9IDA7CiAg
ICAgfQogICBlbHNlCiAgICAgewotICAgICAgZFRpbWVvdXRNcyA9ICh1cyAr
IDk5OSkgLyAxMDAwOworICAgICAgZFRpbWVvdXRNcyA9IElORklOSVRFOwog
ICAgIH0KLSAgLyogVHJ5IHRvIGNyZWF0ZSBhbmQgc2V0IGEgd2FpdGFibGUg
dGltZXIsIGlmIGEgZmluaXRlIHRpbWVvdXQgaGFzCi0gICAgIGJlZW4gcmVx
dWVzdGVkLiAgSWYgc3VjY2Vzc2Z1bCwgZGlzYWJsZSB0aGUgZmFsbGJhY2sg
dGltZW91dC4gKi8KKyAgLyogQ3JlYXRlIGFuZCBzZXQgYSB3YWl0YWJsZSB0
aW1lciwgaWYgYSBmaW5pdGUgdGltZW91dCBoYXMgYmVlbgorICAgICByZXF1
ZXN0ZWQuICovCiAgIExBUkdFX0lOVEVHRVIgbGlUaW1lb3V0OwotICBIQU5E
TEUgaFRpbWVvdXQgPSBDcmVhdGVXYWl0YWJsZVRpbWVyIChOVUxMLCBUUlVF
LCBOVUxMKTsKLSAgaWYgKE5VTEwgPT0gaFRpbWVvdXQpCisgIEhBTkRMRSBo
VGltZW91dDsKKyAgTlRTVEFUVVMgc3RhdHVzOworICBzdGF0dXMgPSBOdENy
ZWF0ZVRpbWVyKCZoVGltZW91dCwgVElNRVJfQUxMX0FDQ0VTUywgTlVMTCwg
Tm90aWZpY2F0aW9uVGltZXIpOworICBpZiAoIU5UX1NVQ0NFU1MgKHN0YXR1
cykpCiAgICAgewotICAgICAgc2VsZWN0X3ByaW50ZigiQ3JlYXRlV2FpdGFi
bGVUaW1lciBmYWlsZWQgKCVkKVxuIiwgR2V0TGFzdEVycm9yKCkpOworICAg
ICAgc2VsZWN0X3ByaW50ZigiTnRDcmVhdGVUaW1lciBmYWlsZWQgKCVkKVxu
IiwgR2V0TGFzdEVycm9yKCkpOworICAgICAgcmV0dXJuIHNlbGVjdF9lcnJv
cjsKICAgICB9CiAgIHc0W20rK10gPSBoVGltZW91dDsKLSAgaWYgKE5VTEwg
IT0gaFRpbWVvdXQgJiYgdXMgPj0gMCkKKyAgaWYgKHVzID49IDApCiAgICAg
ewogICAgICAgbGlUaW1lb3V0LlF1YWRQYXJ0ID0gLXVzICogMTA7CiAgICAg
ICBpbnQgc2V0cmV0OwotICAgICAgaWYgKChzZXRyZXQgPSBTZXRXYWl0YWJs
ZVRpbWVyIChoVGltZW91dCwgJmxpVGltZW91dCwgMCwgTlVMTCwgTlVMTCwg
MCkpKQorICAgICAgc3RhdHVzID0gTnRTZXRUaW1lciAoaFRpbWVvdXQsICZs
aVRpbWVvdXQsIE5VTEwsIE5VTEwsIEZBTFNFLCAwLCBOVUxMKTsKKyAgICAg
IGlmICghTlRfU1VDQ0VTUyhzdGF0dXMpKQogCXsKLQkgIGRUaW1lb3V0TXMg
PSBJTkZJTklURTsKLQl9Ci0gICAgICBlbHNlCi0JewotCSAgc2VsZWN0X3By
aW50ZiAoIlNldFdhaXRhYmxlVGltZXIgZmFpbGVkOiAlZCAoJTA4eClcbiIs
IHNldHJldCwgR2V0TGFzdEVycm9yKCkpOworCSAgc2VsZWN0X3ByaW50ZiAo
Ik50U2V0VGltZXIgZmFpbGVkOiAlZCAoJTA4eClcbiIsIHNldHJldCwgR2V0
TGFzdEVycm9yKCkpOworCSAgcmV0dXJuIHNlbGVjdF9lcnJvcjsKIAl9CiAg
ICAgfQorCiAgIC8qIE9wdGlvbmFsbHkgd2FpdCBmb3IgcHRocmVhZCBjYW5j
ZWxsYXRpb24uICovCiAgIGlmICgodzRbbV0gPSBwdGhyZWFkOjpnZXRfY2Fu
Y2VsX2V2ZW50ICgpKSAhPSBOVUxMKQogICAgIG0rKzsKLS0gCjIuNi4zCgo=

--------------000600060401050706060206--
