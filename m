Return-Path: <cygwin-patches-return-9352-listarch-cygwin-patches=sources.redhat.com@cygwin.com>
Received: (qmail 1155 invoked by alias); 14 Apr 2019 19:16:19 -0000
Mailing-List: contact cygwin-patches-help@cygwin.com; run by ezmlm
Precedence: bulk
List-Id: <cygwin-patches.cygwin.com>
List-Subscribe: <mailto:cygwin-patches-subscribe@cygwin.com>
List-Post: <mailto:cygwin-patches@cygwin.com>
List-Archive: <http://sourceware.org/ml/cygwin-patches/>
List-Help: <mailto:cygwin-patches-help@cygwin.com>, <http://sourceware.org/ml/#faqs>
Sender: cygwin-patches-owner@cygwin.com
Mail-Followup-To: cygwin-patches@cygwin.com
Received: (qmail 682 invoked by uid 89); 14 Apr 2019 19:16:15 -0000
Authentication-Results: sourceware.org; auth=none
X-Spam-SWARE-Status: No, score=-23.0 required=5.0 tests=AWL,BAYES_00,GIT_PATCH_0,GIT_PATCH_1,GIT_PATCH_2,GIT_PATCH_3,MIME_BASE64_BLANKS,RCVD_IN_DNSWL_NONE,SPF_HELO_PASS,SPF_PASS autolearn=ham version=3.3.1 spammy=maintain
X-HELO: NAM05-DM3-obe.outbound.protection.outlook.com
Received: from mail-eopbgr730131.outbound.protection.outlook.com (HELO NAM05-DM3-obe.outbound.protection.outlook.com) (40.107.73.131) by sourceware.org (qpsmtpd/0.93/v0.84-503-g423c35a) with ESMTP; Sun, 14 Apr 2019 19:16:12 +0000
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=cornell.edu; s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=YQaoHi26oMPPjyr2HAX+mSj3eMDTPHk6fio06Dlpz0M=; b=o0VdmyN7TrGWwTCsl9YVxjZ9hLZw8zojZumVB5rJRmmcvm64VaHPhgSNIFFlTrOzI10Oc0yerU8/DZvlYvQANRlXtMaWcgToZAK9tUf4JHC6vpX3tqG9m2HcXj3fYQfHXIurkWcNNM2tNkAvVQptpwjedR8gSZ1wb/wWhy0uItA=
Received: from DM6PR04MB5211.namprd04.prod.outlook.com (20.178.24.208) by DM6PR04MB3963.namprd04.prod.outlook.com (20.176.87.20) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.1792.19; Sun, 14 Apr 2019 19:16:05 +0000
Received: from DM6PR04MB5211.namprd04.prod.outlook.com ([fe80::21bb:c809:f459:845c]) by DM6PR04MB5211.namprd04.prod.outlook.com ([fe80::21bb:c809:f459:845c%2]) with mapi id 15.20.1792.018; Sun, 14 Apr 2019 19:16:05 +0000
From: Ken Brown <kbrown@cornell.edu>
To: "cygwin-patches@cygwin.com" <cygwin-patches@cygwin.com>
Subject: [PATCH 14/14] Cygwin: FIFO: fix and simplify listen_client_thread
Date: Sun, 14 Apr 2019 19:16:00 -0000
Message-ID: <20190414191543.3218-15-kbrown@cornell.edu>
References: <20190414191543.3218-1-kbrown@cornell.edu>
In-Reply-To: <20190414191543.3218-1-kbrown@cornell.edu>
authentication-results: spf=none (sender IP is ) smtp.mailfrom=kbrown@cornell.edu;
received-spf: None (protection.outlook.com: cornell.edu does not designate permitted sender hosts)
x-ms-exchange-senderadcheck: 1
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-IsSubscribed: yes
X-SW-Source: 2019-q2/txt/msg00058.txt.bz2

UmVtb3ZlIGZpZm9fY2xpZW50X2hhbmRsZXI6OmNvbm5lY3QgYW5kIG1vdmUg
aXRzIGNvZGUgaW50bw0KbGlzdGVuX2NsaWVudF90aHJlYWQuICBUaGF0IHdh
eSB3ZSBjYW4gY2hlY2sgdGhlIHJldHVybiBzdGF0dXMgd2hlbiBhDQpjbGll
bnQgaGFuZGxlcidzIGNvbm5lY3RfZXZ0IGlzIHNpZ25hbGVkLiAgUHJldmlv
dXNseSB3ZSBpbmNvcnJlY3RseQ0KYXNzdW1lZCB0aGVyZSB3YXMgYSBzdWNj
ZXNzZnVsIGNvbm5lY3Rpb24uDQoNCkFsc28gc2ltcGxpZnkgbGlzdGVuX2Ns
aWVudF90aHJlYWQgaW4gdGhlIGZvbGxvd2luZyB3YXlzOg0KDQotIFJlcGxh
Y2UgZmhhbmRsZXJfZmlmbzo6ZGlzY29ubmVjdF9hbmRfcmVjb25uZWN0IGJ5
IGEgbmV3DQogIGRlbGV0ZV9jbGllbnRfaGFuZGxlciBtZXRob2QuICBOb3cg
d2UganVzdCBkZWxldGUgaW52YWxpZCBjbGllbnQNCiAgaGFuZGxlcnMgcmF0
aGVyIHRoYW4gdHJ5aW5nIHRvIHJlLXVzZSB0aGVtLg0KDQotIFRyeSB0byBt
YWludGFpbiBhIGNsaWVudCBoYW5kbGVyIGxpc3QgdGhhdCBjb25zaXN0cyBv
ZiBjb25uZWN0ZWQNCiAgY2xpZW50IGhhbmRsZXJzIGFuZCBleGFjdGx5IG9u
ZSB0aGF0IGlzIGxpc3RlbmluZyBmb3IgYSBjb25uZWN0aW9uLg0KICBUaGlz
IGFsbG93cyB1cyB0byBjYWxsIFdhaXRGb3JNdWx0aXBsZU9iamVjdHMgd2l0
aCBvbmx5IHR3byB3YWl0DQogIG9iamVjdHMuDQoNCi0gUmVtb3ZlICdkdW1t
eV9ldnQnIGZyb20gdGhlIGZpZm9fY2xpZW50X2hhbmRsZXIgc3RydWN0OyBp
dCBpcyBubw0KICBsb25nZXIgbmVlZGVkLg0KDQotIE9uIGV4aXQgZnJvbSBs
aXN0ZW5fY2xpZW50X3RocmVhZCwgZGVsZXRlIHRoZSAiZXh0cmEiIChsaXN0
ZW5pbmcpDQogIGNsaWVudCBoYW5kbGVyLiAgT3RoZXJ3aXNlIHRoZXJlIGNv
dWxkIGJlIGEgY29ubmVjdGlvbiB0aGF0IGRvZXNuJ3QNCiAgZ2V0IHJlY29y
ZGVkIGluIHRoZSBjbGllbnQgaGFuZGxlciBsaXN0LiAgVGhpcyBjb3VsZCBo
YXBwZW4gd2hlbiBhDQogIGZpbGUgZGVzY3JpcHRvciBpcyBiZWluZyBkdXBs
aWNhdGVkLg0KLS0tDQogd2luc3VwL2N5Z3dpbi9maGFuZGxlci5oICAgICAg
IHwgIDExICstDQogd2luc3VwL2N5Z3dpbi9maGFuZGxlcl9maWZvLmNjIHwg
MjUxICsrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0tLQ0KIDIgZmls
ZXMgY2hhbmdlZCwgMTA5IGluc2VydGlvbnMoKyksIDE1MyBkZWxldGlvbnMo
LSkNCg0KZGlmZiAtLWdpdCBhL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXIuaCBi
L3dpbnN1cC9jeWd3aW4vZmhhbmRsZXIuaA0KaW5kZXggZmQyMDVhNmRiLi44
ZmIxNzZiMjQgMTAwNjQ0DQotLS0gYS93aW5zdXAvY3lnd2luL2ZoYW5kbGVy
LmgNCisrKyBiL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXIuaA0KQEAgLTEyNTAs
MTMgKzEyNTAsMTAgQEAgc3RydWN0IGZpZm9fY2xpZW50X2hhbmRsZXINCiAg
IGZoYW5kbGVyX2Jhc2UgKmZoOw0KICAgZmlmb19jbGllbnRfY29ubmVjdF9z
dGF0ZSBzdGF0ZTsNCiAgIEhBTkRMRSBjb25uZWN0X2V2dDsNCi0gIEhBTkRM
RSBkdW1teV9ldnQ7CQkvKiBOZXZlciBzaWduYWxlZC4gKi8NCi0gIGZpZm9f
Y2xpZW50X2hhbmRsZXIgKCkgOiBmaCAoTlVMTCksIHN0YXRlIChmY191bmtu
b3duKSwgY29ubmVjdF9ldnQgKE5VTEwpLA0KLQkJCSAgIGR1bW15X2V2dCAo
TlVMTCkge30NCisgIGZpZm9fY2xpZW50X2hhbmRsZXIgKCkgOiBmaCAoTlVM
TCksIHN0YXRlIChmY191bmtub3duKSwgY29ubmVjdF9ldnQgKE5VTEwpIHt9
DQogICBmaWZvX2NsaWVudF9oYW5kbGVyIChmaGFuZGxlcl9iYXNlICpfZmgs
IGZpZm9fY2xpZW50X2Nvbm5lY3Rfc3RhdGUgX3N0YXRlLA0KLQkJICAgICAg
IEhBTkRMRSBfY29ubmVjdF9ldnQsIEhBTkRMRSBfZHVtbXlfZXZ0KQ0KLSAg
ICA6IGZoIChfZmgpLCBzdGF0ZSAoX3N0YXRlKSwgY29ubmVjdF9ldnQgKF9j
b25uZWN0X2V2dCksDQotICAgICAgZHVtbXlfZXZ0IChfZHVtbXlfZXZ0KSB7
fQ0KKwkJICAgICAgIEhBTkRMRSBfY29ubmVjdF9ldnQpDQorICAgIDogZmgg
KF9maCksIHN0YXRlIChfc3RhdGUpLCBjb25uZWN0X2V2dCAoX2Nvbm5lY3Rf
ZXZ0KSB7fQ0KICAgaW50IGNvbm5lY3QgKCk7DQogICBpbnQgY2xvc2UgKCk7
DQogfTsNCkBAIC0xMjc4LDggKzEyNzUsOCBAQCBjbGFzcyBmaGFuZGxlcl9m
aWZvOiBwdWJsaWMgZmhhbmRsZXJfYmFzZQ0KICAgTlRTVEFUVVMgbnBmc19o
YW5kbGUgKEhBTkRMRSAmKTsNCiAgIEhBTkRMRSBjcmVhdGVfcGlwZV9pbnN0
YW5jZSAoYm9vbCk7DQogICBOVFNUQVRVUyBvcGVuX3BpcGUgKCk7DQotICBp
bnQgZGlzY29ubmVjdF9hbmRfcmVjb25uZWN0IChpbnQpOw0KICAgaW50IGFk
ZF9jbGllbnRfaGFuZGxlciAoKTsNCisgIHZvaWQgZGVsZXRlX2NsaWVudF9o
YW5kbGVyIChpbnQpOw0KICAgYm9vbCBsaXN0ZW5fY2xpZW50ICgpOw0KICAg
aW50IHN0b3BfbGlzdGVuX2NsaWVudCAoKTsNCiBwdWJsaWM6DQpkaWZmIC0t
Z2l0IGEvd2luc3VwL2N5Z3dpbi9maGFuZGxlcl9maWZvLmNjIGIvd2luc3Vw
L2N5Z3dpbi9maGFuZGxlcl9maWZvLmNjDQppbmRleCBjZTA3OGQ3NGQuLmFi
YmIyOWE2MSAxMDA2NDQNCi0tLSBhL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXJf
Zmlmby5jYw0KKysrIGIvd2luc3VwL2N5Z3dpbi9maGFuZGxlcl9maWZvLmNj
DQpAQCAtMTIxLDYyICsxMjEsNiBAQCBzZXRfcGlwZV9ub25fYmxvY2tpbmcg
KEhBTkRMRSBwaCwgYm9vbCBub25ibG9ja2luZykNCiAgICAgZGVidWdfcHJp
bnRmICgiTnRTZXRJbmZvcm1hdGlvbkZpbGUoRmlsZVBpcGVJbmZvcm1hdGlv
bik6ICV5Iiwgc3RhdHVzKTsNCiB9DQogDQotLyogVGhlIHBpcGUgaW5zdGFu
Y2UgaXMgYWx3YXlzIGluIGJsb2NraW5nIG1vZGUgd2hlbiB0aGlzIGlzIGNh
bGxlZC4gKi8NCi1pbnQNCi1maWZvX2NsaWVudF9oYW5kbGVyOjpjb25uZWN0
ICgpDQotew0KLSAgTlRTVEFUVVMgc3RhdHVzOw0KLSAgSU9fU1RBVFVTX0JM
T0NLIGlvOw0KLQ0KLSAgaWYgKGNvbm5lY3RfZXZ0KQ0KLSAgICBSZXNldEV2
ZW50IChjb25uZWN0X2V2dCk7DQotICBlbHNlIGlmICghKGNvbm5lY3RfZXZ0
ID0gY3JlYXRlX2V2ZW50ICgpKSkNCi0gICAgcmV0dXJuIC0xOw0KLSAgc3Rh
dHVzID0gTnRGc0NvbnRyb2xGaWxlIChmaC0+Z2V0X2hhbmRsZSAoKSwgY29u
bmVjdF9ldnQsIE5VTEwsIE5VTEwsICZpbywNCi0JCQkgICAgRlNDVExfUElQ
RV9MSVNURU4sIE5VTEwsIDAsIE5VTEwsIDApOw0KLSAgc3dpdGNoIChzdGF0
dXMpDQotICAgIHsNCi0gICAgY2FzZSBTVEFUVVNfUEVORElORzoNCi0gICAg
Y2FzZSBTVEFUVVNfUElQRV9MSVNURU5JTkc6DQotICAgICAgc3RhdGUgPSBm
Y19jb25uZWN0aW5nOw0KLSAgICAgIGJyZWFrOw0KLSAgICBjYXNlIFNUQVRV
U19QSVBFX0NPTk5FQ1RFRDoNCi0gICAgICBzdGF0ZSA9IGZjX2Nvbm5lY3Rl
ZDsNCi0gICAgICBzZXRfcGlwZV9ub25fYmxvY2tpbmcgKGZoLT5nZXRfaGFu
ZGxlICgpLCB0cnVlKTsNCi0gICAgICBicmVhazsNCi0gICAgZGVmYXVsdDoN
Ci0gICAgICBfX3NldGVycm5vX2Zyb21fbnRfc3RhdHVzIChzdGF0dXMpOw0K
LSAgICAgIHJldHVybiAtMTsNCi0gICAgfQ0KLSAgcmV0dXJuIDA7DQotfQ0K
LQ0KLWludA0KLWZoYW5kbGVyX2ZpZm86OmRpc2Nvbm5lY3RfYW5kX3JlY29u
bmVjdCAoaW50IGkpDQotew0KLSAgTlRTVEFUVVMgc3RhdHVzOw0KLSAgSU9f
U1RBVFVTX0JMT0NLIGlvOw0KLSAgSEFORExFIHBoID0gZmNfaGFuZGxlcltp
XS5maC0+Z2V0X2hhbmRsZSAoKTsNCi0NCi0gIHN0YXR1cyA9IE50RnNDb250
cm9sRmlsZSAocGgsIE5VTEwsIE5VTEwsIE5VTEwsICZpbywgRlNDVExfUElQ
RV9ESVNDT05ORUNULA0KLQkJCSAgICBOVUxMLCAwLCBOVUxMLCAwKTsNCi0g
IC8qIFNob3J0LWxpdmVkLiAgRG9uJ3QgdXNlIGN5Z3dhaXQuICBXZSBkb24n
dCB3YW50IHRvIGJlIGludGVycnVwdGVkLiAqLw0KLSAgaWYgKHN0YXR1cyA9
PSBTVEFUVVNfUEVORElORw0KLSAgICAgICYmIE50V2FpdEZvclNpbmdsZU9i
amVjdCAocGgsIEZBTFNFLCBOVUxMKSA9PSBXQUlUX09CSkVDVF8wKQ0KLSAg
ICBzdGF0dXMgPSBpby5TdGF0dXM7DQotICBpZiAoIU5UX1NVQ0NFU1MgKHN0
YXR1cykpDQotICAgIHsNCi0gICAgICBfX3NldGVycm5vX2Zyb21fbnRfc3Rh
dHVzIChzdGF0dXMpOw0KLSAgICAgIHJldHVybiAtMTsNCi0gICAgfQ0KLSAg
c2V0X3BpcGVfbm9uX2Jsb2NraW5nIChmY19oYW5kbGVyW2ldLmZoLT5nZXRf
aGFuZGxlICgpLCBmYWxzZSk7DQotICBpZiAoZmNfaGFuZGxlcltpXS5jb25u
ZWN0ICgpIDwgMCkNCi0gICAgcmV0dXJuIC0xOw0KLSAgaWYgKGZjX2hhbmRs
ZXJbaV0uc3RhdGUgPT0gZmNfY29ubmVjdGVkKQ0KLSAgICBuY29ubmVjdGVk
Kys7DQotICByZXR1cm4gMDsNCi19DQotDQogTlRTVEFUVVMNCiBmaGFuZGxl
cl9maWZvOjpucGZzX2hhbmRsZSAoSEFORExFICZucGgpDQogew0KQEAgLTI4
Myw0MSArMjI3LDQ5IEBAIGZoYW5kbGVyX2ZpZm86Om9wZW5fcGlwZSAoKQ0K
IGludA0KIGZoYW5kbGVyX2ZpZm86OmFkZF9jbGllbnRfaGFuZGxlciAoKQ0K
IHsNCisgIGludCByZXQgPSAtMTsNCiAgIGZpZm9fY2xpZW50X2hhbmRsZXIg
ZmM7DQogICBmaGFuZGxlcl9iYXNlICpmaDsNCisgIEhBTkRMRSBwaCA9IE5V
TEw7DQogICBib29sIGZpcnN0ID0gKG5oYW5kbGVycyA9PSAwKTsNCiANCiAg
IGlmIChuaGFuZGxlcnMgPT0gTUFYX0NMSUVOVFMpDQogICAgIHsNCiAgICAg
ICBzZXRfZXJybm8gKEVNRklMRSk7DQotICAgICAgcmV0dXJuIC0xOw0KKyAg
ICAgIGdvdG8gb3V0Ow0KICAgICB9DQotICBpZiAoIShmYy5kdW1teV9ldnQg
PSBjcmVhdGVfZXZlbnQgKCkpKQ0KLSAgICByZXR1cm4gLTE7DQorICBpZiAo
IShmYy5jb25uZWN0X2V2dCA9IGNyZWF0ZV9ldmVudCAoKSkpDQorICAgIGdv
dG8gb3V0Ow0KICAgaWYgKCEoZmggPSBidWlsZF9maF9kZXYgKGRldiAoKSkp
KQ0KICAgICB7DQogICAgICAgc2V0X2Vycm5vIChFTUZJTEUpOw0KLSAgICAg
IHJldHVybiAtMTsNCisgICAgICBnb3RvIG91dDsNCiAgICAgfQ0KLSAgZmMu
ZmggPSBmaDsNCi0gIEhBTkRMRSBwaCA9IGNyZWF0ZV9waXBlX2luc3RhbmNl
IChmaXJzdCk7DQorICBwaCA9IGNyZWF0ZV9waXBlX2luc3RhbmNlIChmaXJz
dCk7DQogICBpZiAoIXBoKQ0KLSAgICBnb3RvIGVycm91dDsNCi0gIGZoLT5z
ZXRfaGFuZGxlIChwaCk7DQotICBmaC0+c2V0X2ZsYWdzIChnZXRfZmxhZ3Mg
KCkpOw0KLSAgaWYgKGZjLmNvbm5lY3QgKCkgPCAwKQ0KICAgICB7DQotICAg
ICAgZmMuY2xvc2UgKCk7DQotICAgICAgZ290byBlcnJvdXQ7DQorICAgICAg
ZGVsZXRlIGZoOw0KKyAgICAgIGdvdG8gb3V0Ow0KICAgICB9DQotICBpZiAo
ZmMuc3RhdGUgPT0gZmNfY29ubmVjdGVkKQ0KLSAgICBuY29ubmVjdGVkKys7
DQotICBmY19oYW5kbGVyW25oYW5kbGVycysrXSA9IGZjOw0KLSAgcmV0dXJu
IDA7DQotZXJyb3V0Og0KLSAgZGVsZXRlIGZoOw0KLSAgcmV0dXJuIC0xOw0K
KyAgZWxzZQ0KKyAgICB7DQorICAgICAgZmgtPnNldF9oYW5kbGUgKHBoKTsN
CisgICAgICBmaC0+c2V0X2ZsYWdzIChnZXRfZmxhZ3MgKCkpOw0KKyAgICAg
IHJldCA9IDA7DQorICAgICAgZmMuZmggPSBmaDsNCisgICAgICBmY19oYW5k
bGVyW25oYW5kbGVycysrXSA9IGZjOw0KKyAgICB9DQorb3V0Og0KKyAgcmV0
dXJuIHJldDsNCit9DQogDQordm9pZA0KK2ZoYW5kbGVyX2ZpZm86OmRlbGV0
ZV9jbGllbnRfaGFuZGxlciAoaW50IGkpDQorew0KKyAgZmNfaGFuZGxlcltp
XS5jbG9zZSAoKTsNCisgIGlmIChpIDwgLS1uaGFuZGxlcnMpDQorICAgIG1l
bW1vdmUgKGZjX2hhbmRsZXIgKyBpLCBmY19oYW5kbGVyICsgaSArIDEsDQor
CSAgICAgKG5oYW5kbGVycyAtIGkpICogc2l6ZW9mIChmY19oYW5kbGVyW2ld
KSk7DQogfQ0KIA0KIC8qIEp1c3QgaG9wIHRvIHRoZSBsaXN0ZW5fY2xpZW50
X3RocmVhZCBtZXRob2QuICovDQpAQCAtMzU4LDQ2ICszMTAsMjMgQEAgZmhh
bmRsZXJfZmlmbzo6bGlzdGVuX2NsaWVudF90aHJlYWQgKCkNCiANCiAgIHdo
aWxlICgxKQ0KICAgICB7DQotICAgICAgYm9vbCBmb3VuZDsNCi0gICAgICBI
QU5ETEUgd1tNQVhfQ0xJRU5UUyArIDFdOw0KLSAgICAgIGludCBpOw0KLSAg
ICAgIERXT1JEIHdhaXRfcmV0Ow0KKyAgICAgIC8qIEF0IHRoZSBiZWdpbm5p
bmcgb2YgdGhlIGxvb3AsIGFsbCBjbGllbnQgaGFuZGxlcnMgYXJlDQorCSBp
biB0aGUgZmNfY29ubmVjdGVkIG9yIGZjX2ludmFsaWQgc3RhdGUuICovDQog
DQorICAgICAgLyogRGVsZXRlIGFueSBpbnZhbGlkIGNsaWVudHMuICovDQog
ICAgICAgZmlmb19jbGllbnRfbG9jayAoKTsNCi0gICAgICBmb3VuZCA9IGZh
bHNlOw0KLSAgICAgIGZvciAoaSA9IDA7IGkgPCBuaGFuZGxlcnM7IGkrKykN
Ci0Jc3dpdGNoIChmY19oYW5kbGVyW2ldLnN0YXRlKQ0KLQkgIHsNCi0JICBj
YXNlIGZjX2ludmFsaWQ6DQotCSAgICBpZiAoZGlzY29ubmVjdF9hbmRfcmVj
b25uZWN0IChpKSA8IDApDQotCSAgICAgIHsNCi0JCWZpZm9fY2xpZW50X3Vu
bG9jayAoKTsNCi0JCWdvdG8gb3V0Ow0KLQkgICAgICB9DQotCSAgICBlbHNl
DQotCSAgICAgIC8qIFJlY2hlY2sgZmNfaGFuZGxlcltpXS5zdGF0ZS4gKi8N
Ci0JICAgICAgaS0tOw0KLQkgICAgYnJlYWs7DQotCSAgY2FzZSBmY19jb25u
ZWN0ZWQ6DQotCSAgICB3W2ldID0gZmNfaGFuZGxlcltpXS5kdW1teV9ldnQ7
DQotCSAgICBicmVhazsNCi0JICBjYXNlIGZjX2Nvbm5lY3Rpbmc6DQotCSAg
ICBmb3VuZCA9IHRydWU7DQotCSAgICB3W2ldID0gZmNfaGFuZGxlcltpXS5j
b25uZWN0X2V2dDsNCi0JICAgIGJyZWFrOw0KLQkgIGNhc2UgZmNfdW5rbm93
bjoJLyogU2hvdWxkbid0IGhhcHBlbi4gKi8NCi0JICBkZWZhdWx0Og0KLQkg
ICAgYnJlYWs7DQotCSAgfQ0KLSAgICAgIHdbbmhhbmRsZXJzXSA9IGxjdF90
ZXJtaW5hdGlvbl9ldnQ7DQotICAgICAgaW50IHJlcyA9IDA7DQotICAgICAg
aWYgKCFmb3VuZCkNCi0JcmVzID0gYWRkX2NsaWVudF9oYW5kbGVyICgpOw0K
LSAgICAgIGZpZm9fY2xpZW50X3VubG9jayAoKTsNCi0gICAgICBpZiAocmVz
IDwgMCkNCisgICAgICBpbnQgaSA9IDA7DQorICAgICAgd2hpbGUgKGkgPCBu
aGFuZGxlcnMpDQorCXsNCisJICBpZiAoZmNfaGFuZGxlcltpXS5zdGF0ZSA9
PSBmY19pbnZhbGlkKQ0KKwkgICAgZGVsZXRlX2NsaWVudF9oYW5kbGVyIChp
KTsNCisJICBlbHNlDQorCSAgICBpKys7DQorCX0NCisNCisgICAgICAvKiBD
cmVhdGUgYSBuZXcgY2xpZW50IGhhbmRsZXIuICovDQorICAgICAgaWYgKGFk
ZF9jbGllbnRfaGFuZGxlciAoKSA8IDApDQogCWdvdG8gb3V0Ow0KLSAgICAg
IGVsc2UgaWYgKCFmb3VuZCkNCi0JY29udGludWU7DQogDQogICAgICAgLyog
QWxsb3cgYSB3cml0ZXIgdG8gb3Blbi4gKi8NCiAgICAgICBpZiAoIWFybSAo
cmVhZF9yZWFkeSkpDQpAQCAtNDA1LDI2ICszMzQsNzMgQEAgZmhhbmRsZXJf
Zmlmbzo6bGlzdGVuX2NsaWVudF90aHJlYWQgKCkNCiAJICBfX3NldGVycm5v
ICgpOw0KIAkgIGdvdG8gb3V0Ow0KIAl9DQorICAgICAgZmlmb19jbGllbnRf
dW5sb2NrICgpOw0KIA0KLSAgICAgIC8qIFdhaXQgZm9yIGEgY2xpZW50IHRv
IGNvbm5lY3QuICovDQotICAgICAgd2FpdF9yZXQgPSBXYWl0Rm9yTXVsdGlw
bGVPYmplY3RzIChuaGFuZGxlcnMgKyAxLCB3LCBmYWxzZSwgSU5GSU5JVEUp
Ow0KLSAgICAgIGkgPSB3YWl0X3JldCAtIFdBSVRfT0JKRUNUXzA7DQotICAg
ICAgaWYgKGkgPCAwIHx8IGkgPiBuaGFuZGxlcnMpDQotCWdvdG8gb3V0Ow0K
LSAgICAgIGVsc2UgaWYgKGkgPT0gbmhhbmRsZXJzKQkvKiBUaHJlYWQgdGVy
bWluYXRpb24gcmVxdWVzdGVkLiAqLw0KKyAgICAgIC8qIExpc3RlbiBmb3Ig
YSB3cml0ZXIgdG8gY29ubmVjdCB0byB0aGUgbmV3IGNsaWVudCBoYW5kbGVy
LiAqLw0KKyAgICAgIGZpZm9fY2xpZW50X2hhbmRsZXImIGZjID0gZmNfaGFu
ZGxlcltuaGFuZGxlcnMgLSAxXTsNCisgICAgICBkbw0KKwl7DQorCSAgTlRT
VEFUVVMgc3RhdHVzOw0KKwkgIElPX1NUQVRVU19CTE9DSyBpbzsNCisNCisJ
ICBzdGF0dXMgPSBOdEZzQ29udHJvbEZpbGUgKGZjLmZoLT5nZXRfaGFuZGxl
ICgpLCBmYy5jb25uZWN0X2V2dCwNCisJCQkJICAgIE5VTEwsIE5VTEwsICZp
bywgRlNDVExfUElQRV9MSVNURU4sDQorCQkJCSAgICBOVUxMLCAwLCBOVUxM
LCAwKTsNCisJICBpZiAoc3RhdHVzID09IFNUQVRVU19QRU5ESU5HKQ0KKwkg
ICAgew0KKwkgICAgICBIQU5ETEUgd1syXSA9IHsgZmMuY29ubmVjdF9ldnQs
IGxjdF90ZXJtaW5hdGlvbl9ldnQgfTsNCisJICAgICAgRFdPUkQgd2FpdHJl
dCA9IFdhaXRGb3JNdWx0aXBsZU9iamVjdHMgKDIsIHcsIGZhbHNlLCBJTkZJ
TklURSk7DQorCSAgICAgIHN3aXRjaCAod2FpdHJldCkNCisJCXsNCisJCWNh
c2UgV0FJVF9PQkpFQ1RfMDoNCisJCSAgc3RhdHVzID0gaW8uU3RhdHVzOw0K
KwkJICBicmVhazsNCisJCWNhc2UgV0FJVF9PQkpFQ1RfMCArIDE6DQorCQkg
IHJldCA9IDA7DQorCQkgIHN0YXR1cyA9IFNUQVRVU19USFJFQURfSVNfVEVS
TUlOQVRJTkc7DQorCQkgIGJyZWFrOw0KKwkJZGVmYXVsdDoNCisJCSAgX19z
ZXRlcnJubyAoKTsNCisJCSAgZGVidWdfcHJpbnRmICgiV2FpdEZvck11bHRp
cGxlT2JqZWN0cyBmYWlsZWQsICVFIik7DQorCQkgIHN0YXR1cyA9IFNUQVRV
U19USFJFQURfSVNfVEVSTUlOQVRJTkc7DQorCQkgIGJyZWFrOw0KKwkJfQ0K
KwkgICAgfQ0KKwkgIHN3aXRjaCAoc3RhdHVzKQ0KKwkgICAgew0KKwkgICAg
Y2FzZSBTVEFUVVNfU1VDQ0VTUzoNCisJICAgIGNhc2UgU1RBVFVTX1BJUEVf
Q09OTkVDVEVEOg0KKwkgICAgICBmaWZvX2NsaWVudF9sb2NrICgpOw0KKwkg
ICAgICBmYy5zdGF0ZSA9IGZjX2Nvbm5lY3RlZDsNCisJICAgICAgbmNvbm5l
Y3RlZCsrOw0KKwkgICAgICBzZXRfcGlwZV9ub25fYmxvY2tpbmcgKGZjLmZo
LT5nZXRfaGFuZGxlICgpLCB0cnVlKTsNCisJICAgICAgZmlmb19jbGllbnRf
dW5sb2NrICgpOw0KKwkgICAgICBicmVhazsNCisJICAgIGNhc2UgU1RBVFVT
X1BJUEVfTElTVEVOSU5HOg0KKwkgICAgICAvKiBSZXRyeS4gKi8NCisJICAg
ICAgZmMuc3RhdGUgPSBmY19jb25uZWN0aW5nOw0KKwkgICAgICBSZXNldEV2
ZW50IChmYy5jb25uZWN0X2V2dCk7DQorCSAgICAgIGJyZWFrOw0KKwkgICAg
Y2FzZSBTVEFUVVNfVEhSRUFEX0lTX1RFUk1JTkFUSU5HOg0KKwkgICAgICBm
aWZvX2NsaWVudF9sb2NrICgpOw0KKwkgICAgICBkZWxldGVfY2xpZW50X2hh
bmRsZXIgKG5oYW5kbGVycyAtIDEpOw0KKwkgICAgICBmaWZvX2NsaWVudF91
bmxvY2sgKCk7DQorCSAgICAgIGdvdG8gb3V0Ow0KKwkgICAgZGVmYXVsdDoN
CisJICAgICAgX19zZXRlcnJub19mcm9tX250X3N0YXR1cyAoc3RhdHVzKTsN
CisJICAgICAgZmlmb19jbGllbnRfbG9jayAoKTsNCisJICAgICAgZGVsZXRl
X2NsaWVudF9oYW5kbGVyIChuaGFuZGxlcnMgLSAxKTsNCisJICAgICAgZmlm
b19jbGllbnRfdW5sb2NrICgpOw0KKwkgICAgICBnb3RvIG91dDsNCisJICAg
IH0NCisJfSB3aGlsZSAoZmMuc3RhdGUgPT0gZmNfY29ubmVjdGluZyk7DQor
ICAgICAgLyogQ2hlY2sgZm9yIHRocmVhZCB0ZXJtaW5hdGlvbiBpbiBjYXNl
IFdhaXRGb3JNdWx0aXBsZU9iamVjdHMNCisJIGRpZG4ndCBnZXQgY2FsbGVk
IGFib3ZlLiAqLw0KKyAgICAgIGlmIChJc0V2ZW50U2lnbmFsbGVkIChsY3Rf
dGVybWluYXRpb25fZXZ0KSkNCiAJew0KIAkgIHJldCA9IDA7DQogCSAgZ290
byBvdXQ7DQogCX0NCi0gICAgICBlbHNlDQotCXsNCi0JICBmaWZvX2NsaWVu
dF9sb2NrICgpOw0KLQkgIGZjX2hhbmRsZXJbaV0uc3RhdGUgPSBmY19jb25u
ZWN0ZWQ7DQotCSAgbmNvbm5lY3RlZCsrOw0KLQkgIHNldF9waXBlX25vbl9i
bG9ja2luZyAoZmNfaGFuZGxlcltpXS5maC0+Z2V0X2hhbmRsZSAoKSwgdHJ1
ZSk7DQotCSAgZmlmb19jbGllbnRfdW5sb2NrICgpOw0KLQkgIHlpZWxkICgp
Ow0KLQl9DQogICAgIH0NCiBvdXQ6DQogICBSZXNldEV2ZW50IChyZWFkX3Jl
YWR5KTsNCkBAIC00OTAsNyArNDY2LDcgQEAgZmhhbmRsZXJfZmlmbzo6b3Bl
biAoaW50IGZsYWdzLCBtb2RlX3QpDQogICAvKiBJZiB3ZSdyZSBhIGR1cGxl
eGVyLCBjcmVhdGUgdGhlIHBpcGUgYW5kIHRoZSBmaXJzdCBjbGllbnQgaGFu
ZGxlci4gKi8NCiAgIGlmIChkdXBsZXhlcikNCiAgICAgew0KLSAgICAgIEhB
TkRMRSBwaCwgY29ubmVjdF9ldnQsIGR1bW15X2V2dDsNCisgICAgICBIQU5E
TEUgcGgsIGNvbm5lY3RfZXZ0Ow0KICAgICAgIGZoYW5kbGVyX2Jhc2UgKmZo
Ow0KIA0KICAgICAgIHBoID0gY3JlYXRlX3BpcGVfaW5zdGFuY2UgKHRydWUp
Ow0KQEAgLTUxNiwxNiArNDkyLDcgQEAgZmhhbmRsZXJfZmlmbzo6b3BlbiAo
aW50IGZsYWdzLCBtb2RlX3QpDQogCSAgZGVsZXRlIGZoOw0KIAkgIGdvdG8g
b3V0Ow0KIAl9DQotICAgICAgaWYgKCEoZHVtbXlfZXZ0ID0gY3JlYXRlX2V2
ZW50ICgpKSkNCi0Jew0KLQkgIHJlcyA9IGVycm9yX2Vycm5vX3NldDsNCi0J
ICBkZWxldGUgZmg7DQotCSAgZmgtPmNsb3NlICgpOw0KLQkgIENsb3NlSGFu
ZGxlIChjb25uZWN0X2V2dCk7DQotCSAgZ290byBvdXQ7DQotCX0NCi0gICAg
ICBmY19oYW5kbGVyWzBdID0gZmlmb19jbGllbnRfaGFuZGxlciAoZmgsIGZj
X2Nvbm5lY3RlZCwgY29ubmVjdF9ldnQsDQotCQkJCSAgICAgICBkdW1teV9l
dnQpOw0KKyAgICAgIGZjX2hhbmRsZXJbMF0gPSBmaWZvX2NsaWVudF9oYW5k
bGVyIChmaCwgZmNfY29ubmVjdGVkLCBjb25uZWN0X2V2dCk7DQogICAgICAg
bmNvbm5lY3RlZCA9IG5oYW5kbGVycyA9IDE7DQogICAgIH0NCiANCkBAIC04
NjYsOCArODMzLDYgQEAgZmlmb19jbGllbnRfaGFuZGxlcjo6Y2xvc2UgKCkN
CiAgICAgfQ0KICAgaWYgKGNvbm5lY3RfZXZ0KQ0KICAgICBDbG9zZUhhbmRs
ZSAoY29ubmVjdF9ldnQpOw0KLSAgaWYgKGR1bW15X2V2dCkNCi0gICAgQ2xv
c2VIYW5kbGUgKGR1bW15X2V2dCk7DQogICByZXR1cm4gcmVzOw0KIH0NCiAN
CkBAIC05NDYsMTAgKzkxMSw2IEBAIGZoYW5kbGVyX2ZpZm86OmR1cCAoZmhh
bmRsZXJfYmFzZSAqY2hpbGQsIGludCBmbGFncykNCiAJICB8fCAhRHVwbGlj
YXRlSGFuZGxlIChHZXRDdXJyZW50UHJvY2VzcyAoKSwgZmNfaGFuZGxlcltp
XS5jb25uZWN0X2V2dCwNCiAJCQkgICAgICAgR2V0Q3VycmVudFByb2Nlc3Mg
KCksDQogCQkJICAgICAgICZmaGYtPmZjX2hhbmRsZXJbaV0uY29ubmVjdF9l
dnQsDQotCQkJICAgICAgIDAsIHRydWUsIERVUExJQ0FURV9TQU1FX0FDQ0VT
UykNCi0JICB8fCAhRHVwbGljYXRlSGFuZGxlIChHZXRDdXJyZW50UHJvY2Vz
cyAoKSwgZmNfaGFuZGxlcltpXS5kdW1teV9ldnQsDQotCQkJICAgICAgIEdl
dEN1cnJlbnRQcm9jZXNzICgpLA0KLQkJCSAgICAgICAmZmhmLT5mY19oYW5k
bGVyW2ldLmR1bW15X2V2dCwNCiAJCQkgICAgICAgMCwgdHJ1ZSwgRFVQTElD
QVRFX1NBTUVfQUNDRVNTKSkNCiAJew0KIAkgIENsb3NlSGFuZGxlIChmaGYt
PnJlYWRfcmVhZHkpOw0KQEAgLTk3OCw3ICs5MzksNiBAQCBmaGFuZGxlcl9m
aWZvOjpmaXh1cF9hZnRlcl9mb3JrIChIQU5ETEUgcGFyZW50KQ0KICAgICB7
DQogICAgICAgZmNfaGFuZGxlcltpXS5maC0+ZmhhbmRsZXJfYmFzZTo6Zml4
dXBfYWZ0ZXJfZm9yayAocGFyZW50KTsNCiAgICAgICBmb3JrX2ZpeHVwIChw
YXJlbnQsIGZjX2hhbmRsZXJbaV0uY29ubmVjdF9ldnQsICJjb25uZWN0X2V2
dCIpOw0KLSAgICAgIGZvcmtfZml4dXAgKHBhcmVudCwgZmNfaGFuZGxlcltp
XS5kdW1teV9ldnQsICJkdW1teV9ldnQiKTsNCiAgICAgfQ0KICAgbGlzdGVu
X2NsaWVudF90aHIgPSBOVUxMOw0KICAgbGN0X3Rlcm1pbmF0aW9uX2V2dCA9
IE5VTEw7DQpAQCAtOTk1LDYgKzk1NSw1IEBAIGZoYW5kbGVyX2ZpZm86OnNl
dF9jbG9zZV9vbl9leGVjIChib29sIHZhbCkNCiAgICAgew0KICAgICAgIGZj
X2hhbmRsZXJbaV0uZmgtPmZoYW5kbGVyX2Jhc2U6OnNldF9jbG9zZV9vbl9l
eGVjICh2YWwpOw0KICAgICAgIHNldF9ub19pbmhlcml0YW5jZSAoZmNfaGFu
ZGxlcltpXS5jb25uZWN0X2V2dCwgdmFsKTsNCi0gICAgICBzZXRfbm9faW5o
ZXJpdGFuY2UgKGZjX2hhbmRsZXJbaV0uZHVtbXlfZXZ0LCB2YWwpOw0KICAg
ICB9DQogfQ0KLS0gDQoyLjE3LjANCg0K
