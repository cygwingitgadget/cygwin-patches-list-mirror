Return-Path: <SRS0=4nz8=GR=t-online.de=Christian.Franke@sourceware.org>
Received: from mailout12.t-online.de (mailout12.t-online.de [194.25.134.22])
	by sourceware.org (Postfix) with ESMTPS id 47DA73858D32
	for <cygwin-patches@cygwin.com>; Sat,  4 Nov 2023 15:53:26 +0000 (GMT)
DMARC-Filter: OpenDMARC Filter v1.4.2 sourceware.org 47DA73858D32
Authentication-Results: sourceware.org; dmarc=none (p=none dis=none) header.from=t-online.de
Authentication-Results: sourceware.org; spf=pass smtp.mailfrom=t-online.de
ARC-Filter: OpenARC Filter v1.0.0 sourceware.org 47DA73858D32
Authentication-Results: server2.sourceware.org; arc=none smtp.remote-ip=194.25.134.22
ARC-Seal: i=1; a=rsa-sha256; d=sourceware.org; s=key; t=1699113210; cv=none;
	b=Sejq2YyREGkaXZwEQ4eh73ogBdWIgKtXsr+QTz9cQQYbyb1T6TWDsnuCAbTmYpyBwDaR2W+JBskx6opQym1aOiL8BRcCZ01brk1eOo5l5p6R0a2wvbqKjwYIOfCTJaZcrs++qW57KRzLPTL0O0u12Lgex7Pz3inJ8C4LT2v8e1Q=
ARC-Message-Signature: i=1; a=rsa-sha256; d=sourceware.org; s=key;
	t=1699113210; c=relaxed/simple;
	bh=h8jAPgqHP2chshJeRmCwSOyOosQ87SvPh9CoGgwrxE0=;
	h=Subject:To:From:Message-ID:Date:MIME-Version; b=v4nUpJA8z+aAvhiCU+11GSfTKYaNw7h+Yl9fHNMBp7BdbeR/D6yl9YXCHYJJPKQBaaZq47TXIDk4f6nXsMFzxmY2qjEEGVz1yUpBGpnpn6jyplQsPdep3bvVjIvWs542NYQ2Wv94RgXjNSYXBIG6OtYGa/RZ9oUhKO3IQg3Bbq8=
ARC-Authentication-Results: i=1; server2.sourceware.org
Received: from fwd83.aul.t-online.de (fwd83.aul.t-online.de [10.223.144.109])
	by mailout12.t-online.de (Postfix) with SMTP id F1760146A
	for <cygwin-patches@cygwin.com>; Sat,  4 Nov 2023 16:53:24 +0100 (CET)
Received: from [192.168.2.101] ([91.57.240.134]) by fwd83.t-online.de
	with (TLSv1.3:TLS_AES_256_GCM_SHA384 encrypted)
	esmtp id 1qzIxa-0htV2G0; Sat, 4 Nov 2023 16:53:18 +0100
Subject: Re: [PATCH] Cygwin: Add /dev/disk/by-id symlinks
To: cygwin-patches@cygwin.com
References: <9fd70b83-2364-1e02-555f-dc7b24feff9c@t-online.de>
 <ZUTDd9BH4iysokAl@calimero.vinschen.de>
 <ZUTG5lqjvknVC9ri@calimero.vinschen.de>
 <ZUTVDlCF4q0Qp3QX@calimero.vinschen.de>
 <ZUT1JUYoh+y3H2wk@calimero.vinschen.de>
 <8ceefddf-6f66-ab44-f2fc-48072a5c7207@t-online.de>
 <ZUUfit/OdR3G5G/H@calimero.vinschen.de>
 <ZUUgKHqlCQRghuzy@calimero.vinschen.de>
 <1133d1d3-e6d9-4a52-a595-89ee338f8d2f@t-online.de>
 <ZUYQPPsrxf5yp1Ir@calimero.vinschen.de>
 <ZUYVeeYDcAKC74wg@calimero.vinschen.de>
From: Christian Franke <Christian.Franke@t-online.de>
Message-ID: <c82507ab-193a-4a85-7ef0-64f7a7f30705@t-online.de>
Date: Sat, 4 Nov 2023 16:53:18 +0100
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101
 SeaMonkey/2.53.16
MIME-Version: 1.0
In-Reply-To: <ZUYVeeYDcAKC74wg@calimero.vinschen.de>
Content-Type: multipart/mixed;
 boundary="------------22795A73DC1BC5A0421F3747"
X-TOI-EXPURGATEID: 150726::1699113198-E4DD6DE8-E8CCC7D0/0/0 CLEAN NORMAL
X-TOI-MSGID: 089708a5-4a12-4935-895b-1387c2900831
X-Spam-Status: No, score=-10.9 required=5.0 tests=BAYES_00,FREEMAIL_FROM,GIT_PATCH_0,KAM_DMARC_STATUS,NICE_REPLY_A,RCVD_IN_BARRACUDACENTRAL,RCVD_IN_DNSWL_NONE,RCVD_IN_MSPIKE_H3,RCVD_IN_MSPIKE_WL,SPF_HELO_NONE,SPF_PASS,TXREP,T_SCC_BODY_TEXT_LINE autolearn=ham autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on server2.sourceware.org
List-Id: <cygwin-patches.cygwin.com>

This is a multi-part message in MIME format.
--------------22795A73DC1BC5A0421F3747
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit

Corinna Vinschen wrote:
> On Nov  4 10:34, Corinna Vinschen wrote:
>> On Nov  3 18:54, Christian Franke wrote:
>>> ...
>>> Conclusion: The behavior of the current patch is compatible with Linux :-)
>> Ok, but with the DUID we have a workaround which makes it  work even
>> better than on Linux, so it would begreat if we used it, unless we find
>> out where the UUID in "\GLOBAL??\Disk{<UUID>} comes from...
>>
>> Given the size of the STORAGE_DEVICE_UNIQUE_IDENTIFIER struct, we could
>> even contemplate a 128 bit hash, just to be on the safe side.
> Kind of like this
>
> -  strcat (name, ioctl_buf + desc->SerialNumberOffset);
> +  /* Use SerialNumber in the first place, if available */
> +  if (desc->SerialNumberOffset && desc_buf[desc->SerialNumberOffset])
> +    strcat (name, desc_buf + desc->SerialNumberOffset);
> +  else /* Utilize the DUID as defined by MSDN to generate a hash */
> +    {
> +      union {
> +	unsigned __int128 all;
> +	struct {
> +	  unsigned long high;
> +	  unsigned long low;
> +	};
> +      } hash = { 0 };
> +
> +      for (ULONG i = 0; i < id->Size; ++i)
> +	hash.all = ioctl_buf[i] + (hash.all << 6) + (hash.all << 16) - hash.all;
> +      __small_sprintf (name + strlen (name), "%X%X", hash.high, hash.low);
> +    }
>

New patch attached. Only fhandler/dev_disk.cc changed, devices.cc again 
not included.

Christian


--------------22795A73DC1BC5A0421F3747
Content-Type: text/plain; charset=UTF-8;
 name="0001-Cygwin-Add-dev-disk-by-id-symlinks.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
 filename="0001-Cygwin-Add-dev-disk-by-id-symlinks.patch"

RnJvbSA1ZGIxY2QwMDllOGRjNmZmMDFmYWJkZWI4Y2RkZjY1ZDYwOWJmZTJmIE1vbiBTZXAg
MTcgMDA6MDA6MDAgMjAwMQpGcm9tOiBDaHJpc3RpYW4gRnJhbmtlIDxjaHJpc3RpYW4uZnJh
bmtlQHQtb25saW5lLmRlPgpEYXRlOiBTYXQsIDQgTm92IDIwMjMgMTY6NDk6MjggKzAxMDAK
U3ViamVjdDogW1BBVENIXSBDeWd3aW46IEFkZCAvZGV2L2Rpc2svYnktaWQgc3ltbGlua3MK
ClRoZSBuZXcgZGlyZWN0b3J5ICcvZGV2L2Rpc2svYnktaWQnIHByb3ZpZGVzIHN5bWxpbmtz
IGZvciBlYWNoCmRpc2sgYW5kIGl0cyBwYXJ0aXRpb25zOgonQlVTVFlQRS1bVkVORE9SX11Q
Uk9EVUNUX1NFUklBTFstcGFydE5dJyAtPiAnLi4vLi4vc2RYW05dJy4KVGhpcyBpcyBiYXNl
ZCBvbiBzdHJpbmdzIHByb3ZpZGVkIGJ5IFNUT1JBR0VfREVWSUNFX0RFU0NSSVBUT1IuCklm
IHRoaXMgaW5mb3JtYXRpb24gaXMgdG9vIHNob3J0LCBhIDEyOC1iaXQgaGFzaCBvZiB0aGUK
U1RPUkFHRV9ERVZJQ0VfVU5JUVVFX0lERU5USUZJRVIgcmF3IGRhdGEgaXMgYWRkZWQuCkFk
bWluaXN0cmF0b3IgcHJpdmlsZWdlcyBhcmUgbm90IHJlcXVpcmVkLgoKU2lnbmVkLW9mZi1i
eTogQ2hyaXN0aWFuIEZyYW5rZSA8Y2hyaXN0aWFuLmZyYW5rZUB0LW9ubGluZS5kZT4KLS0t
CiB3aW5zdXAvY3lnd2luL01ha2VmaWxlLmFtICAgICAgICAgICAgICAgfCAgIDEgKwogd2lu
c3VwL2N5Z3dpbi9kZXZpY2VzLmluICAgICAgICAgICAgICAgIHwgICA0ICsKIHdpbnN1cC9j
eWd3aW4vZHRhYmxlLmNjICAgICAgICAgICAgICAgICB8ICAgMyArCiB3aW5zdXAvY3lnd2lu
L2ZoYW5kbGVyL2Rldl9kaXNrLmNjICAgICAgfCA2NDYgKysrKysrKysrKysrKysrKysrKysr
KysrCiB3aW5zdXAvY3lnd2luL2xvY2FsX2luY2x1ZGVzL2RldmljZXMuaCAgfCAgIDYgKy0K
IHdpbnN1cC9jeWd3aW4vbG9jYWxfaW5jbHVkZXMvZmhhbmRsZXIuaCB8ICA0NyArKwogd2lu
c3VwL2N5Z3dpbi9tb3VudC5jYyAgICAgICAgICAgICAgICAgIHwgIDEwICsKIDcgZmlsZXMg
Y2hhbmdlZCwgNzE2IGluc2VydGlvbnMoKyksIDEgZGVsZXRpb24oLSkKIGNyZWF0ZSBtb2Rl
IDEwMDY0NCB3aW5zdXAvY3lnd2luL2ZoYW5kbGVyL2Rldl9kaXNrLmNjCgpkaWZmIC0tZ2l0
IGEvd2luc3VwL2N5Z3dpbi9NYWtlZmlsZS5hbSBiL3dpbnN1cC9jeWd3aW4vTWFrZWZpbGUu
YW0KaW5kZXggNjRiMjUyYTIyLi4zNzZjNzlmYzMgMTAwNjQ0Ci0tLSBhL3dpbnN1cC9jeWd3
aW4vTWFrZWZpbGUuYW0KKysrIGIvd2luc3VwL2N5Z3dpbi9NYWtlZmlsZS5hbQpAQCAtODQs
NiArODQsNyBAQCBGSEFORExFUl9GSUxFUz0gXAogCWZoYW5kbGVyL2NvbnNvbGUuY2MgXAog
CWZoYW5kbGVyL2N5Z2RyaXZlLmNjIFwKIAlmaGFuZGxlci9kZXYuY2MgXAorCWZoYW5kbGVy
L2Rldl9kaXNrLmNjIFwKIAlmaGFuZGxlci9kZXZfZmQuY2MgXAogCWZoYW5kbGVyL2Rpc2tf
ZmlsZS5jYyBcCiAJZmhhbmRsZXIvZHNwLmNjIFwKZGlmZiAtLWdpdCBhL3dpbnN1cC9jeWd3
aW4vZGV2aWNlcy5pbiBiL3dpbnN1cC9jeWd3aW4vZGV2aWNlcy5pbgppbmRleCAyNTQ1ZGQ4
NWUuLjQ4ZDM4NDNmZSAxMDA2NDQKLS0tIGEvd2luc3VwL2N5Z3dpbi9kZXZpY2VzLmluCisr
KyBiL3dpbnN1cC9jeWd3aW4vZGV2aWNlcy5pbgpAQCAtMTE1LDYgKzExNSw5IEBAIGNvbnN0
IF9kZXZpY2UgZGV2X2N5Z2RyaXZlX3N0b3JhZ2UgPQogY29uc3QgX2RldmljZSBkZXZfZnNf
c3RvcmFnZSA9CiAgIHsiIiwge0ZIX0ZTfSwgIiIsIGV4aXN0c307CiAKK2NvbnN0IF9kZXZp
Y2UgZGV2X2Rldl9kaXNrX3N0b3JhZ2UgPQorICB7IiIsIHtGSF9ERVZfRElTS30sICIiLCBl
eGlzdHN9OworCiBjb25zdCBfZGV2aWNlIGRldl9wcm9jX3N0b3JhZ2UgPQogICB7IiIsIHtG
SF9QUk9DfSwgIiIsIGV4aXN0c307CiAKQEAgLTE3Myw2ICsxNzYsNyBAQCBjb25zdCBfZGV2
aWNlIGRldl9lcnJvcl9zdG9yYWdlID0KICAgIHRoZSBQT1NJWCBuYW1lc3BhY2UuICAqLwog
JSUKICIvZGV2IiwgQlJBQ0soRkhfREVWKSwgIiIsIGV4aXN0cywgU19JRkRJUgorIi9kZXYv
ZGlzayIsIEJSQUNLKEZIX0RFVl9ESVNLKSwgIiIsIGV4aXN0cywgU19JRkRJUgogIi9kZXYv
dHR5IiwgQlJBQ0soRkhfVFRZKSwgIi9kZXYvdHR5IiwgZXhpc3RzLCBTX0lGQ0hSCiAiL2Rl
di9wdHklKDAtMTI3KWQiLCBCUkFDSyhGSERFVihERVZfUFRZU19NQUpPUiwgeyQxfSkpLCAi
L2Rldi9wdHl7JDF9IiwgZXhpc3RzX3B0eSwgU19JRkNIUiwgPXB0eXNfZGV2CiAiOnB0eW0l
KDAtMTI3KWQiLCBCUkFDSyhGSERFVihERVZfUFRZTV9NQUpPUiwgeyQxfSkpLCAiL2Rldi9w
dHlteyQxfSIsIGV4aXN0c19pbnRlcm5hbCwgU19JRkNIUiwgPXB0eW1fZGV2CmRpZmYgLS1n
aXQgYS93aW5zdXAvY3lnd2luL2R0YWJsZS5jYyBiL3dpbnN1cC9jeWd3aW4vZHRhYmxlLmNj
CmluZGV4IDIxZDUyNTM4OS4uOTUwOGYzZTBiIDEwMDY0NAotLS0gYS93aW5zdXAvY3lnd2lu
L2R0YWJsZS5jYworKysgYi93aW5zdXAvY3lnd2luL2R0YWJsZS5jYwpAQCAtNTg1LDYgKzU4
NSw5IEBAIGZoX2FsbG9jIChwYXRoX2NvbnYmIHBjKQogCWNhc2UgRkhfREVWOgogCSAgZmgg
PSBjbmV3IChmaGFuZGxlcl9kZXYpOwogCSAgYnJlYWs7CisJY2FzZSBGSF9ERVZfRElTSzoK
KwkgIGZoID0gY25ldyAoZmhhbmRsZXJfZGV2X2Rpc2spOworCSAgYnJlYWs7CiAJY2FzZSBG
SF9ERVZfRkQ6CiAJICBmaCA9IGNuZXcgKGZoYW5kbGVyX2Rldl9mZCk7CiAJICBicmVhazsK
ZGlmZiAtLWdpdCBhL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXIvZGV2X2Rpc2suY2MgYi93aW5z
dXAvY3lnd2luL2ZoYW5kbGVyL2Rldl9kaXNrLmNjCm5ldyBmaWxlIG1vZGUgMTAwNjQ0Cmlu
ZGV4IDAwMDAwMDAwMC4uMmNiZTU0MzRlCi0tLSAvZGV2L251bGwKKysrIGIvd2luc3VwL2N5
Z3dpbi9maGFuZGxlci9kZXZfZGlzay5jYwpAQCAtMCwwICsxLDY0NiBAQAorLyogZmhhbmRs
ZXIvZGV2X2Rpc2suY2M6IGZoYW5kbGVyIGZvciB0aGUgL2Rldi9kaXNrL2J5LWlkLy4uLiBz
eW1saW5rcy4KKworVGhpcyBmaWxlIGlzIHBhcnQgb2YgQ3lnd2luLgorCitUaGlzIHNvZnR3
YXJlIGlzIGEgY29weXJpZ2h0ZWQgd29yayBsaWNlbnNlZCB1bmRlciB0aGUgdGVybXMgb2Yg
dGhlCitDeWd3aW4gbGljZW5zZS4gIFBsZWFzZSBjb25zdWx0IHRoZSBmaWxlICJDWUdXSU5f
TElDRU5TRSIgZm9yCitkZXRhaWxzLiAqLworCisjaW5jbHVkZSAid2luc3VwLmgiCisjaW5j
bHVkZSAicGF0aC5oIgorI2luY2x1ZGUgImZoYW5kbGVyLmgiCisjaW5jbHVkZSAidGxzX3Bi
dWYuaCIKKyNpbmNsdWRlIDxzdG9yZHVpZC5oPgorI2luY2x1ZGUgPHdjdHlwZS5oPgorI2lu
Y2x1ZGUgPHdpbmlvY3RsLmg+CisKKy8qIFJlcGxhY2Ugbm9uLXByaW50aW5nIGFuZCB1bmV4
cGVjdGVkIGNoYXJhY3RlcnMsIHJlbW92ZSB0cmFpbGluZyBzcGFjZXMsCisgICByZXR1cm4g
cmVtYWluaW5nIHN0cmluZyBsZW5ndGguICovCitzdGF0aWMgaW50CitzYW5pdGl6ZV9pZF9z
dHJpbmcgKGNoYXIgKnMpCit7CisgIGludCBsYXN0c3BhY2UgPSAtMSwgaTsKKyAgZm9yIChp
ID0gMDsgc1tpXTsgaSsrKQorICAgIHsKKyAgICAgIGNoYXIgYyA9IHNbaV07CisgICAgICBp
ZiAoYyAhPSAnICcpCisJbGFzdHNwYWNlID0gLTE7CisgICAgICBlbHNlIGlmIChsYXN0c3Bh
Y2UgPCAwKQorCWxhc3RzcGFjZSA9IGk7CisgICAgICBpZiAoKCcwJyA8PSBjICYmIGMgPD0g
JzknKSB8fCBjID09ICcuJyB8fCBjID09ICctJworCSAgfHwgKCdBJyA8PSBjICYmIGMgPD0g
J1onKSB8fCAoJ2EnIDw9IGMgJiYgYyA8PSAneicpKQorCWNvbnRpbnVlOworICAgICAgc1tp
XSA9ICdfJzsKKyAgICB9CisgIGlmIChsYXN0c3BhY2UgPj0gMCkKKyAgICBzWyhpID0gbGFz
dHNwYWNlKV0gPSAnXDAnOworICByZXR1cm4gaTsKK30KKworLyogRmV0Y2ggc3RvcmFnZSBw
cm9wZXJ0aWVzIGFuZCBjcmVhdGUgdGhlIElEIHN0cmluZy4KKyAgIHJldHVybnM6IDE6IHN1
Y2Nlc3MsIDA6IGRldmljZSBpZ25vcmVkLCAtMTogSW9Db250cm9sIGVycm9yLiAqLworc3Rh
dGljIGludAorc3RvcnByb3BfdG9faWRfbmFtZSAoSEFORExFIGRldmhkbCwgY29uc3QgVU5J
Q09ERV9TVFJJTkcgKnVwYXRoLAorCQkgICAgIGNoYXIgKmlvY3RsX2J1ZiwgY2hhciAoJiBu
YW1lKVtOQU1FX01BWCArIDFdKQoreworICBEV09SRCBieXRlc19yZWFkOworICBTVE9SQUdF
X1BST1BFUlRZX1FVRVJZIGRlc2NxdWVyeSA9CisgICAgeyBTdG9yYWdlRGV2aWNlUHJvcGVy
dHksIFByb3BlcnR5U3RhbmRhcmRRdWVyeSwgeyAwIH0gfTsKKyAgaWYgKCFEZXZpY2VJb0Nv
bnRyb2wgKGRldmhkbCwgSU9DVExfU1RPUkFHRV9RVUVSWV9QUk9QRVJUWSwKKwkJCSZkZXNj
cXVlcnksIHNpemVvZiAoZGVzY3F1ZXJ5KSwKKwkJCWlvY3RsX2J1ZiwgTlRfTUFYX1BBVEgs
CisJCQkmYnl0ZXNfcmVhZCwgbnVsbHB0cikpCisgICAgeworICAgICAgX19zZXRlcnJub19m
cm9tX3dpbl9lcnJvciAoR2V0TGFzdEVycm9yICgpKTsKKyAgICAgIGRlYnVnX3ByaW50ZiAo
IkRldmljZUlvQ29udHJvbCAoJVMsIElPQ1RMX1NUT1JBR0VfUVVFUllfUFJPUEVSVFksIgor
CQkgICAgIiB7U3RvcmFnZURldmljZVByb3BlcnR5fSk6ICVFIiwgdXBhdGgpOworICAgICAg
cmV0dXJuIC0xOworICAgIH0KKworICBjb25zdCBTVE9SQUdFX0RFVklDRV9ERVNDUklQVE9S
ICpkZXNjID0KKyAgICByZWludGVycHJldF9jYXN0PGNvbnN0IFNUT1JBR0VfREVWSUNFX0RF
U0NSSVBUT1IgKj4oaW9jdGxfYnVmKTsKKyAgaW50IHZlbmRvcl9sZW4gPSAwLCBwcm9kdWN0
X2xlbiA9IDAsIHNlcmlhbF9sZW4gPSAwOworICBpZiAoZGVzYy0+VmVuZG9ySWRPZmZzZXQp
CisgICAgdmVuZG9yX2xlbiA9IHNhbml0aXplX2lkX3N0cmluZyAoaW9jdGxfYnVmICsgZGVz
Yy0+VmVuZG9ySWRPZmZzZXQpOworICBpZiAoZGVzYy0+UHJvZHVjdElkT2Zmc2V0KQorICAg
IHByb2R1Y3RfbGVuID0gc2FuaXRpemVfaWRfc3RyaW5nIChpb2N0bF9idWYgKyBkZXNjLT5Q
cm9kdWN0SWRPZmZzZXQpOworICBpZiAoZGVzYy0+U2VyaWFsTnVtYmVyT2Zmc2V0KQorICAg
IHNlcmlhbF9sZW4gPSBzYW5pdGl6ZV9pZF9zdHJpbmcgKGlvY3RsX2J1ZiArIGRlc2MtPlNl
cmlhbE51bWJlck9mZnNldCk7CisKKyAgLyogSWdub3JlIGRyaXZlIGlmIGluZm9ybWF0aW9u
IGlzIGVtcHR5IG9yIHRvbyBsb25nIChzaG91bGQgbm90IGhhcHBlbikuICovCisgIGlmICgh
KCh2ZW5kb3JfbGVuIHx8IHByb2R1Y3RfbGVuKSAmJiAoMjAvKmJ1c3R5cGUqLyArIHZlbmRv
cl9sZW4gKyAxICsKKyAgICAgIHByb2R1Y3RfbGVuICsgMSArIHNlcmlhbF9sZW4gKyAxICsg
MzQvKmhhc2gqLyArIDEgKyAxMC8qcGFydE4qLworICAgICAgPCAoaW50KSBzaXplb2YgKG5h
bWUpKSkpCisgICAgcmV0dXJuIDA7CisKKyAgLyogVHJhbnNsYXRlIGJ1cyB0eXBlcy4gKi8K
KyAgY29uc3QgY2hhciAqYnVzOworICBzd2l0Y2ggKGRlc2MtPkJ1c1R5cGUpCisgICAgewor
ICAgICAgY2FzZSBCdXNUeXBlQXRhOiAgICAgYnVzID0gImF0YS0iOyBicmVhazsKKyAgICAg
IGNhc2UgQnVzVHlwZUZpYnJlOiAgIGJ1cyA9ICJmaWJyZS0iOyBicmVhazsKKyAgICAgIGNh
c2UgQnVzVHlwZU52bWU6ICAgIGJ1cyA9ICJudm1lLSI7IGJyZWFrOworICAgICAgY2FzZSBC
dXNUeXBlUkFJRDogICAgYnVzID0gInJhaWQtIjsgYnJlYWs7CisgICAgICBjYXNlIEJ1c1R5
cGVTYXM6ICAgICBidXMgPSAic2FzLSI7IGJyZWFrOworICAgICAgY2FzZSBCdXNUeXBlU2F0
YTogICAgYnVzID0gInNhdGEtIjsgYnJlYWs7CisgICAgICBjYXNlIEJ1c1R5cGVTY3NpOiAg
ICBidXMgPSAic2NzaS0iOyBicmVhazsKKyAgICAgIGNhc2UgQnVzVHlwZVVzYjogICAgIGJ1
cyA9ICJ1c2ItIjsgYnJlYWs7CisgICAgICBjYXNlIEJ1c1R5cGVWaXJ0dWFsOiBidXMgPSAi
dmlydHVhbC0iOyBicmVhazsKKyAgICAgIGRlZmF1bHQ6ICAgICAgICAgICAgIGJ1cyA9IG51
bGxwdHI7IGJyZWFrOworICAgIH0KKworICAvKiBDcmVhdGUgIkJVU1RZUEUtW1ZFTkRPUl9d
UFJPRFVDVFtfU0VSSUFMXSIgc3RyaW5nLiAqLworICBjaGFyICogY3AgPSBuYW1lOworICBp
ZiAoYnVzKQorICAgIGNwID0gc3RwY3B5IChjcCwgYnVzKTsKKyAgZWxzZQorICAgIGNwICs9
IF9fc21hbGxfc3ByaW50ZiAoY3AsICJidXN0eXBlJTAyX3ktIiwgZGVzYy0+QnVzVHlwZSk7
CisKKyAgaWYgKHZlbmRvcl9sZW4pCisgICAgY3AgPSBzdHBjcHkgKGNwLCBpb2N0bF9idWYg
KyBkZXNjLT5WZW5kb3JJZE9mZnNldCk7CisgIGlmIChwcm9kdWN0X2xlbikKKyAgICB7Cisg
ICAgICBpZiAodmVuZG9yX2xlbikKKwljcCA9IHN0cGNweSAoY3AsICJfIik7CisgICAgICBj
cCA9IHN0cGNweSAoY3AsIGlvY3RsX2J1ZiArIGRlc2MtPlByb2R1Y3RJZE9mZnNldCk7Cisg
ICAgfQorICBpZiAoc2VyaWFsX2xlbikKKyAgICB7CisgICAgICBjcCA9IHN0cGNweSAoY3As
ICJfIik7CisgICAgICBjcCA9IHN0cGNweSAoY3AsIGlvY3RsX2J1ZiArIGRlc2MtPlNlcmlh
bE51bWJlck9mZnNldCk7CisgICAgfQorCisgIC8qIEFkZCBoYXNoIGlmIGluZm9ybWF0aW9u
IGlzIHRvbyBzaG9ydCAoZS5nLiBtaXNzaW5nIHNlcmlhbCBudW1iZXIpLiAqLworICBib29s
IGFkZF9oYXNoID0gISg0IDw9IHZlbmRvcl9sZW4gKyBwcm9kdWN0X2xlbiAmJiA0IDw9IHNl
cmlhbF9sZW4pOworICBkZWJ1Z19wcmludGYgKCIlUzogYnVzdHlwZTogJTAyX3ksIGFkZF9o
YXNoOiAlZCwgaWQ6ICclcycgJyVzJyAnJXMnICIsCisJCXVwYXRoLCAodW5zaWduZWQpIGRl
c2MtPkJ1c1R5cGUsIChpbnQpIGFkZF9oYXNoLAorCQkodmVuZG9yX2xlbiA/IGlvY3RsX2J1
ZiArIGRlc2MtPlZlbmRvcklkT2Zmc2V0IDogIiIpLAorCQkocHJvZHVjdF9sZW4gPyBpb2N0
bF9idWYgKyBkZXNjLT5Qcm9kdWN0SWRPZmZzZXQgOiAiIiksCisJCShzZXJpYWxfbGVuID8g
aW9jdGxfYnVmICsgZGVzYy0+U2VyaWFsTnVtYmVyT2Zmc2V0IDogIiIpKTsKKyAgaWYgKCFh
ZGRfaGFzaCkKKyAgICByZXR1cm4gMTsKKworICAvKiBUaGUgY2FsbCBiZWxvdyBhbHNvIHJl
dHVybnMgdGhlIFNUT1JBR0VfREVWSUNFX0RFU0NSSVBUT1IgdXNlZCBhYm92ZS4KKyAgICAg
TVNETiBkb2N1bWVudGF0aW9uIGZvciBTVE9SQUdFX0RFVklDRV9VTklRVUVfSURFTlRJRklF
UiBzYXlzOgorICAgICAiVGhlIGRldmljZSBkZXNjcmlwdG9yIGNvbnRhaW5zIElEcyB0aGF0
IGFyZSBleHRyYWN0ZWQgZnJvbSBub24tVlBECisgICAgIGlucXVpcnkgZGF0YS4iICBUaGlz
IG1heSBtZWFuIHRoYXQgdGhlIHNlcmlhbCBudW1iZXIgKHBhcnQgb2YKKyAgICAgU0NTSS9T
QVMgVlBEIGRhdGEpIG1heSBub3QgYWx3YXlzIGJlIHByb3ZpZGVkLiAgVGhlcmVmb3JlIGEg
c2VwYXJhdGUKKyAgICAgY2FsbCB0byByZXRyaWV2ZSBTVE9SQUdFX0RFVklDRV9ERVNDUklQ
VE9SIG9ubHkgaXMgZG9uZSBhYm92ZS4gKi8KKyAgU1RPUkFHRV9QUk9QRVJUWV9RVUVSWSBp
ZHF1ZXJ5ID0KKyAgICB7IFN0b3JhZ2VEZXZpY2VVbmlxdWVJZFByb3BlcnR5LCBQcm9wZXJ0
eVN0YW5kYXJkUXVlcnksIHsgMCB9IH07CisgIGlmICghRGV2aWNlSW9Db250cm9sIChkZXZo
ZGwsIElPQ1RMX1NUT1JBR0VfUVVFUllfUFJPUEVSVFksCisJCQkmaWRxdWVyeSwgc2l6ZW9m
IChpZHF1ZXJ5KSwKKwkJCWlvY3RsX2J1ZiwgTlRfTUFYX1BBVEgsCisJCQkmYnl0ZXNfcmVh
ZCwgbnVsbHB0cikpCisgICAgeworICAgICAgX19zZXRlcnJub19mcm9tX3dpbl9lcnJvciAo
R2V0TGFzdEVycm9yICgpKTsKKyAgICAgIGRlYnVnX3ByaW50ZiAoIkRldmljZUlvQ29udHJv
bCAoJVMsIElPQ1RMX1NUT1JBR0VfUVVFUllfUFJPUEVSVFksIgorCQkgICAgIiB7U3RvcmFn
ZURldmljZVVuaXF1ZUlkUHJvcGVydHl9KTogJUUiLCB1cGF0aCk7CisgICAgICByZXR1cm4g
LTE7CisgICAgfQorCisgIC8qIFV0aWxpemUgdGhlIERVSUQgYXMgZGVmaW5lZCBieSBNU0RO
IHRvIGdlbmVyYXRlIGEgaGFzaC4gKi8KKyAgY29uc3QgU1RPUkFHRV9ERVZJQ0VfVU5JUVVF
X0lERU5USUZJRVIgKmlkID0KKyAgICByZWludGVycHJldF9jYXN0PGNvbnN0IFNUT1JBR0Vf
REVWSUNFX1VOSVFVRV9JREVOVElGSUVSICo+KGlvY3RsX2J1Zik7CisgIGRlYnVnX3ByaW50
ZiAoIlNUT1JBR0VfREVWSUNFX1VOSVFVRV9JREVOVElGSUVSLlNpemU6ICV1IiwgaWQtPlNp
emUpOworCisgICBfX2ludDEyOCBoYXNoID0gMDsKKyAgIGZvciAoVUxPTkcgaSA9IDA7IGkg
PCBpZC0+U2l6ZTsgaSsrKQorICAgICAgaGFzaCA9IGlvY3RsX2J1ZltpXSArIChoYXNoIDw8
IDYpICsgKGhhc2ggPDwgMTYpIC0gaGFzaDsKKyAgX19zbWFsbF9zcHJpbnRmIChjcCwgIl8l
MDE2X1klMDE2X1giLCAodW5zaWduZWQgbG9uZyBsb25nKSAoaGFzaCA+PiA2NCksCisJCSAg
ICh1bnNpZ25lZCBsb25nIGxvbmcpIGhhc2gpOworICByZXR1cm4gMTsKK30KKworc3RydWN0
IGJ5X2lkX2VudHJ5Cit7CisgIGNoYXIgbmFtZVtOQU1FX01BWCArIDFdOworICB1X2ludDhf
dCBkcml2ZTsKKyAgdV9pbnQ4X3QgcGFydDsKK307CisKK3N0YXRpYyBpbnQKK2J5X2lkX2Nv
bXBhcmVfbmFtZSAoY29uc3Qgdm9pZCAqYSwgY29uc3Qgdm9pZCAqYikKK3sKKyAgY29uc3Qg
YnlfaWRfZW50cnkgKmFwID0gcmVpbnRlcnByZXRfY2FzdDxjb25zdCBieV9pZF9lbnRyeSAq
PihhKTsKKyAgY29uc3QgYnlfaWRfZW50cnkgKmJwID0gcmVpbnRlcnByZXRfY2FzdDxjb25z
dCBieV9pZF9lbnRyeSAqPihiKTsKKyAgcmV0dXJuIHN0cmNtcCAoYXAtPm5hbWUsIGJwLT5u
YW1lKTsKK30KKworc3RhdGljIGJ5X2lkX2VudHJ5ICoKK2J5X2lkX3JlYWxsb2MgKGJ5X2lk
X2VudHJ5ICpwLCBzaXplX3QgbikKK3sKKyAgdm9pZCAqcDIgPSByZWFsbG9jIChwLCBuICog
c2l6ZW9mICgqcCkpOworICBpZiAoIXAyKQorICAgIGZyZWUgKHApOworICByZXR1cm4gcmVp
bnRlcnByZXRfY2FzdDxieV9pZF9lbnRyeSAqPihwMik7Cit9CisKKy8qIENyZWF0ZSBzb3J0
ZWQgbmFtZSAtPiBkcml2ZSBtYXBwaW5nIHRhYmxlLiBNdXN0IGJlIGZyZWVkIGJ5IGNhbGxl
ci4gKi8KK3N0YXRpYyBpbnQKK2dldF9ieV9pZF90YWJsZSAoYnlfaWRfZW50cnkgKiAmdGFi
bGUpCit7CisgIHRhYmxlID0gbnVsbHB0cjsKKworICAvKiBPcGVuIFxEZXZpY2Ugb2JqZWN0
IGRpcmVjdG9yeS4gKi8KKyAgd2NoYXJfdCB3cGF0aFtNQVhfUEFUSF0gPSBMIlxcRGV2aWNl
IjsKKyAgVU5JQ09ERV9TVFJJTkcgdXBhdGggPSB7MTQsIDE2LCB3cGF0aH07CisgIE9CSkVD
VF9BVFRSSUJVVEVTIGF0dHI7CisgIEluaXRpYWxpemVPYmplY3RBdHRyaWJ1dGVzICgmYXR0
ciwgJnVwYXRoLCBPQkpfQ0FTRV9JTlNFTlNJVElWRSwgbnVsbHB0ciwgbnVsbHB0cik7Cisg
IEhBTkRMRSBkaXJoZGw7CisgIE5UU1RBVFVTIHN0YXR1cyA9IE50T3BlbkRpcmVjdG9yeU9i
amVjdCAoJmRpcmhkbCwgRElSRUNUT1JZX1FVRVJZLCAmYXR0cik7CisgIGlmICghTlRfU1VD
Q0VTUyAoc3RhdHVzKSkKKyAgICB7CisgICAgICBkZWJ1Z19wcmludGYgKCJOdE9wZW5EaXJl
Y3RvcnlPYmplY3QsIHN0YXR1cyAleSIsIHN0YXR1cyk7CisgICAgICBfX3NldGVycm5vX2Zy
b21fbnRfc3RhdHVzIChzdGF0dXMpOworICAgICAgcmV0dXJuIC0xOworICAgIH0KKworICAv
KiBMaW1pdCBkaXNrIGFuZCBwYXJ0aXRpb24gbnVtYmVycyBsaWtlIGZoYW5kbGVyX2Rldjo6
cmVhZGRpciAoKS4gKi8KKyAgY29uc3QgdW5zaWduZWQgbWF4X2RyaXZlX251bSA9IDEyNywg
bWF4X3BhcnRfbnVtID0gNjM7CisKKyAgdW5zaWduZWQgYWxsb2Nfc2l6ZSA9IDAsIHRhYmxl
X3NpemUgPSAwOworICB0bXBfcGF0aGJ1ZiB0cDsKKyAgY2hhciAqaW9jdGxfYnVmID0gdHAu
Y19nZXQgKCk7CisgIERJUkVDVE9SWV9CQVNJQ19JTkZPUk1BVElPTiAqZGJpX2J1ZiA9Cisg
ICAgICByZWludGVycHJldF9jYXN0PERJUkVDVE9SWV9CQVNJQ19JTkZPUk1BVElPTiAqPih0
cC53X2dldCAoKSk7CisKKyAgLyogVHJhdmVyc2UgXERldmljZSBkaXJlY3RvcnkgLi4uICov
CisgIGJvb2wgZXJybm9fc2V0ID0gZmFsc2U7CisgIEhBTkRMRSBkZXZoZGwgPSBJTlZBTElE
X0hBTkRMRV9WQUxVRTsKKyAgQk9PTEVBTiByZXN0YXJ0ID0gVFJVRTsKKyAgYm9vbCBsYXN0
X3J1biA9IGZhbHNlOworICBVTE9ORyBjb250ZXh0ID0gMDsKKyAgd2hpbGUgKCFsYXN0X3J1
bikKKyAgICB7CisgICAgICBpZiAoZGV2aGRsICE9IElOVkFMSURfSEFORExFX1ZBTFVFKQor
CXsKKwkgIC8qIENsb3NlIGhhbmRsZSBmcm9tIHByZXZpb3VzIHJ1bi4gKi8KKwkgIE50Q2xv
c2UoZGV2aGRsKTsKKwkgIGRldmhkbCA9IElOVkFMSURfSEFORExFX1ZBTFVFOworCX0KKwor
ICAgICAgc3RhdHVzID0gTnRRdWVyeURpcmVjdG9yeU9iamVjdCAoZGlyaGRsLCBkYmlfYnVm
LCA2NTUzNiwgRkFMU0UsIHJlc3RhcnQsCisJCQkJICAgICAgICZjb250ZXh0LCBudWxscHRy
KTsKKyAgICAgIGlmICghTlRfU1VDQ0VTUyAoc3RhdHVzKSkKKwl7CisJICBfX3NldGVycm5v
X2Zyb21fbnRfc3RhdHVzIChzdGF0dXMpOworCSAgZXJybm9fc2V0ID0gdHJ1ZTsKKwkgIGRl
YnVnX3ByaW50ZiAoIk50UXVlcnlEaXJlY3RvcnlPYmplY3QsIHN0YXR1cyAleSIsIHN0YXR1
cyk7CisJICBicmVhazsKKwl9CisgICAgICBpZiAoc3RhdHVzICE9IFNUQVRVU19NT1JFX0VO
VFJJRVMpCisJbGFzdF9ydW4gPSB0cnVlOworICAgICAgcmVzdGFydCA9IEZBTFNFOworICAg
ICAgZm9yIChjb25zdCBESVJFQ1RPUllfQkFTSUNfSU5GT1JNQVRJT04gKmRiaSA9IGRiaV9i
dWY7CisJICAgZGJpLT5PYmplY3ROYW1lLkxlbmd0aCA+IDA7CisJICAgZGJpKyspCisJewor
CSAgLyogLi4uIGFuZCBjaGVjayBmb3IgYSAiSGFyZGRpc2tbMC05XSoiIGVudHJ5LiAqLwor
CSAgaWYgKGRiaS0+T2JqZWN0TmFtZS5MZW5ndGggPCA5ICogc2l6ZW9mIChXQ0hBUikKKwkg
ICAgICB8fCB3Y3NuY2FzZWNtcCAoZGJpLT5PYmplY3ROYW1lLkJ1ZmZlciwgTCJIYXJkZGlz
ayIsIDgpICE9IDAKKwkgICAgICB8fCAhaXN3ZGlnaXQgKGRiaS0+T2JqZWN0TmFtZS5CdWZm
ZXJbOF0pKQorCSAgICBjb250aW51ZTsKKwkgIC8qIEdvdCBpdC4gIE5vdyBjb25zdHJ1Y3Qg
dGhlIHBhdGggdG8gdGhlIGVudGlyZSBkaXNrLCB3aGljaCBpcworCSAgICAgIlxcRGV2aWNl
XFxIYXJkZGlza1hcXFBhcnRpdGlvbjAiLCBhbmQgb3BlbiB0aGUgZGlzayB3aXRoCisJICAg
ICBtaW5pbXVtIHBlcm1pc3Npb25zLiAqLworCSAgdW5zaWduZWQgbG9uZyBkcml2ZV9udW0g
PSB3Y3N0b3VsIChkYmktPk9iamVjdE5hbWUuQnVmZmVyICsgOCwKKwkJCQkJICAgICBudWxs
cHRyLCAxMCk7CisJICBpZiAoZHJpdmVfbnVtID4gbWF4X2RyaXZlX251bSkKKwkgICAgY29u
dGludWU7CisJICB3Y3NjcHkgKHdwYXRoLCBkYmktPk9iamVjdE5hbWUuQnVmZmVyKTsKKwkg
IFBXQ0hBUiB3cGFydCA9IHdwYXRoICsgZGJpLT5PYmplY3ROYW1lLkxlbmd0aCAvIHNpemVv
ZiAoV0NIQVIpOworCSAgd2NwY3B5ICh3cGFydCwgTCJcXFBhcnRpdGlvbjAiKTsKKwkgIHVw
YXRoLkxlbmd0aCA9IGRiaS0+T2JqZWN0TmFtZS5MZW5ndGggKyAyMjsKKwkgIHVwYXRoLk1h
eGltdW1MZW5ndGggPSB1cGF0aC5MZW5ndGggKyBzaXplb2YgKFdDSEFSKTsKKwkgIEluaXRp
YWxpemVPYmplY3RBdHRyaWJ1dGVzICgmYXR0ciwgJnVwYXRoLCBPQkpfQ0FTRV9JTlNFTlNJ
VElWRSwKKwkJCQkgICAgICBkaXJoZGwsIG51bGxwdHIpOworCSAgLyogU1lOQ0hST05JWkUg
YWNjZXNzIGlzIHJlcXVpcmVkIGZvciBJT0NUTF9TVE9SQUdFX1FVRVJZX1BST1BFUlRZCisJ
ICAgICBmb3IgZHJpdmVzIGJlaGluZCBzb21lIGRyaXZlcnMgKG52bWVzdG9yLnN5cykuICov
CisJICBJT19TVEFUVVNfQkxPQ0sgaW87CisJICBzdGF0dXMgPSBOdE9wZW5GaWxlICgmZGV2
aGRsLCBSRUFEX0NPTlRST0wgfCBTWU5DSFJPTklaRSwgJmF0dHIsICZpbywKKwkJCSAgICAg
ICBGSUxFX1NIQVJFX1ZBTElEX0ZMQUdTLCAwKTsKKwkgIGlmICghTlRfU1VDQ0VTUyAoc3Rh
dHVzKSkKKwkgICAgeworCSAgICAgIGRldmhkbCA9IElOVkFMSURfSEFORExFX1ZBTFVFOwor
CSAgICAgIF9fc2V0ZXJybm9fZnJvbV9udF9zdGF0dXMgKHN0YXR1cyk7CisJICAgICAgZXJy
bm9fc2V0ID0gdHJ1ZTsKKwkgICAgICBkZWJ1Z19wcmludGYgKCJOdE9wZW5GaWxlKCVTKSwg
c3RhdHVzICV5IiwgJnVwYXRoLCBzdGF0dXMpOworCSAgICAgIGNvbnRpbnVlOworCSAgICB9
CisKKwkgIC8qIEFkZCB0YWJsZSBzcGFjZSBmb3IgZHJpdmUsIHBhcnRpdGlvbnMgYW5kIGVu
ZCBtYXJrZXIuICovCisJICBpZiAoYWxsb2Nfc2l6ZSA8PSB0YWJsZV9zaXplICsgbWF4X3Bh
cnRfbnVtKQorCSAgICB7CisJICAgICAgYWxsb2Nfc2l6ZSA9IHRhYmxlX3NpemUgKyBtYXhf
cGFydF9udW0gKyA4OworCSAgICAgIHRhYmxlID0gYnlfaWRfcmVhbGxvYyAodGFibGUsIGFs
bG9jX3NpemUpOworCSAgICAgIGlmICghdGFibGUpCisJCXsKKwkJICBOdENsb3NlIChkZXZo
ZGwpOworCQkgIE50Q2xvc2UgKGRpcmhkbCk7CisJCSAgcmV0dXJuIC0xOworCQl9CisJICAg
IH0KKworCSAgLyogRmV0Y2ggc3RvcmFnZSBwcm9wZXJ0aWVzIGFuZCBjcmVhdGUgdGhlIElE
IHN0cmluZy4gKi8KKwkgIGludCByYyA9IHN0b3Jwcm9wX3RvX2lkX25hbWUgKGRldmhkbCwg
JnVwYXRoLCBpb2N0bF9idWYsCisJCQkJCXRhYmxlW3RhYmxlX3NpemVdLm5hbWUpOworCSAg
aWYgKHJjIDw9IDApCisJICAgIHsKKwkgICAgICBpZiAocmMgPCAwKQorCQllcnJub19zZXQg
PSB0cnVlOworCSAgICAgIGNvbnRpbnVlOworCSAgICB9CisJICBpbnQgZHJpdmVfaW5kZXgg
PSB0YWJsZV9zaXplKys7CisJICBzaXplX3QgZHJpdmVfbGVuID0gc3RybGVuKHRhYmxlW2Ry
aXZlX2luZGV4XS5uYW1lKTsKKwkgIHRhYmxlW2RyaXZlX2luZGV4XS5kcml2ZSA9IGRyaXZl
X251bTsKKwkgIHRhYmxlW2RyaXZlX2luZGV4XS5wYXJ0ID0gMDsKKworCSAgLyogRmV0Y2gg
ZHJpdmUgbGF5b3V0IGluZm8gdG8gZ2V0IHNpemUgb2YgYWxsIHBhcnRpdGlvbnMgb24gZGlz
ay4gKi8KKwkgIERXT1JEIHBhcnRfY250ID0gMDsKKwkgIFBBUlRJVElPTl9JTkZPUk1BVElP
Tl9FWCAqcGl4ID0gbnVsbHB0cjsKKwkgIFBBUlRJVElPTl9JTkZPUk1BVElPTiAqcGkgPSBu
dWxscHRyOworCSAgRFdPUkQgYnl0ZXNfcmVhZDsKKwkgIGlmIChEZXZpY2VJb0NvbnRyb2wg
KGRldmhkbCwgSU9DVExfRElTS19HRVRfRFJJVkVfTEFZT1VUX0VYLCBudWxscHRyLCAwLAor
CQkJICAgICAgIGlvY3RsX2J1ZiwgTlRfTUFYX1BBVEgsICZieXRlc19yZWFkLCBudWxscHRy
KSkKKwkgICAgeworCSAgICAgIERSSVZFX0xBWU9VVF9JTkZPUk1BVElPTl9FWCAqcGRsaXgg
PQorCQkgIHJlaW50ZXJwcmV0X2Nhc3Q8RFJJVkVfTEFZT1VUX0lORk9STUFUSU9OX0VYICo+
KGlvY3RsX2J1Zik7CisJICAgICAgcGFydF9jbnQgPSBwZGxpeC0+UGFydGl0aW9uQ291bnQ7
CisJICAgICAgcGl4ID0gcGRsaXgtPlBhcnRpdGlvbkVudHJ5OworCSAgICB9CisJICBlbHNl
IGlmIChEZXZpY2VJb0NvbnRyb2wgKGRldmhkbCwgSU9DVExfRElTS19HRVRfRFJJVkVfTEFZ
T1VULCBudWxscHRyLAorCQkJCSAgICAwLCBpb2N0bF9idWYsIE5UX01BWF9QQVRILCAmYnl0
ZXNfcmVhZCwKKwkJCQkgICAgbnVsbHB0cikpCisJICAgIHsKKwkgICAgICBEUklWRV9MQVlP
VVRfSU5GT1JNQVRJT04gKnBkbGkgPQorCQkgIHJlaW50ZXJwcmV0X2Nhc3Q8RFJJVkVfTEFZ
T1VUX0lORk9STUFUSU9OICo+KGlvY3RsX2J1Zik7CisJICAgICAgcGFydF9jbnQgPSBwZGxp
LT5QYXJ0aXRpb25Db3VudDsKKwkgICAgICBwaSA9IHBkbGktPlBhcnRpdGlvbkVudHJ5Owor
CSAgICB9CisJICBlbHNlCisJICAgIGRlYnVnX3ByaW50ZiAoIkRldmljZUlvQ29udHJvbCgl
UywgIgorCQkJICAiSU9DVExfRElTS19HRVRfRFJJVkVfTEFZT1VUe19FWH0pOiAlRSIsICZ1
cGF0aCk7CisKKwkgIC8qIExvb3Agb3ZlciBwYXJ0aXRpb25zLiAqLworCSAgaWYgKHBpeCB8
fCBwaSkKKwkgICAgZm9yIChEV09SRCBpID0gMDsgaSA8IHBhcnRfY250OyBpKyspCisJICAg
ICAgeworCQlEV09SRCBwYXJ0X251bTsKKwkJaWYgKHBpeCkKKwkJICB7CisJCSAgICBwYXJ0
X251bSA9IHBpeC0+UGFydGl0aW9uTnVtYmVyOworCQkgICAgKytwaXg7CisJCSAgfQorCQll
bHNlCisJCSAgeworCQkgICAgcGFydF9udW0gPSBwaS0+UGFydGl0aW9uTnVtYmVyOworCQkg
ICAgKytwaTsKKwkJICB9CisJCS8qIEEgcGFydGl0aW9uIG51bWJlciBvZiAwIGRlbm90ZXMg
YW4gZXh0ZW5kZWQgcGFydGl0aW9uIG9yIGEKKwkJICAgZmlsbGVyIGVudHJ5IGFzIGRlc2Ny
aWJlZCBpbgorCQkgICBmaGFuZGxlcl9kZXZfZmxvcHB5Ojpsb2NrX3BhcnRpdGlvbi4gIEp1
c3Qgc2tpcC4gKi8KKwkJaWYgKHBhcnRfbnVtID09IDApCisJCSAgY29udGludWU7CisJCWlm
IChwYXJ0X251bSA+IG1heF9wYXJ0X251bSkKKwkJICBicmVhazsKKwkJdGFibGVbdGFibGVf
c2l6ZV0gPSB0YWJsZVtkcml2ZV9pbmRleF07CisJCV9fc21hbGxfc3ByaW50Zih0YWJsZVt0
YWJsZV9zaXplXS5uYW1lICsgZHJpdmVfbGVuLCAiLXBhcnQldSIsCisJCQkJcGFydF9udW0p
OworCQl0YWJsZVt0YWJsZV9zaXplXS5wYXJ0ID0gcGFydF9udW07CisJCXRhYmxlX3NpemUr
KzsKKwkgICAgICB9CisJfQorICAgIH0KKyAgaWYgKGRldmhkbCAhPSBJTlZBTElEX0hBTkRM
RV9WQUxVRSkKKyAgICBOdENsb3NlKGRldmhkbCk7CisgIE50Q2xvc2UgKGRpcmhkbCk7CisK
KyAgaWYgKCF0YWJsZV9zaXplICYmIHRhYmxlKQorICAgIHsKKyAgICAgIGZyZWUgKHRhYmxl
KTsKKyAgICAgIHRhYmxlID0gbnVsbHB0cjsKKyAgICB9CisgIGlmICghdGFibGUpCisgICAg
cmV0dXJuIChlcnJub19zZXQgPyAtMSA6IDApOworCisgIC8qIFNvcnQgYnkgbmFtZSBhbmQg
cmVtb3ZlIGR1cGxpY2F0ZXMuICovCisgIHFzb3J0ICh0YWJsZSwgdGFibGVfc2l6ZSwgc2l6
ZW9mICgqdGFibGUpLCBieV9pZF9jb21wYXJlX25hbWUpOworICBmb3IgKHVuc2lnbmVkIGkg
PSAwOyBpIDwgdGFibGVfc2l6ZTsgaSsrKQorICAgIHsKKyAgICAgIHVuc2lnbmVkIGogPSBp
ICsgMTsKKyAgICAgIHdoaWxlIChqIDwgdGFibGVfc2l6ZSAmJiAhc3RyY21wICh0YWJsZVtp
XS5uYW1lLCB0YWJsZVtqXS5uYW1lKSkKKwlqKys7CisgICAgICBpZiAoaiA9PSBpICsgMSkK
Kwljb250aW51ZTsKKyAgICAgIC8qIER1cGxpY2F0ZShzKSBmb3VuZCwgcmVtb3ZlIGFsbCBl
bnRyaWVzIHdpdGggdGhpcyBuYW1lLiAqLworICAgICAgZGVidWdfcHJpbnRmICgicmVtb3Zp
bmcgZHVwbGljYXRlcyAlZC0lZDogJyVzJyIsIGksIGogLSAxLCB0YWJsZVtpXS5uYW1lKTsK
KyAgICAgIGlmIChqIDwgdGFibGVfc2l6ZSkKKwltZW1tb3ZlICh0YWJsZSArIGksIHRhYmxl
ICsgaiwgKHRhYmxlX3NpemUgLSBqKSAqIHNpemVvZiAoKnRhYmxlKSk7CisgICAgICB0YWJs
ZV9zaXplIC09IGogLSBpOworICAgICAgaS0tOworICAgIH0KKworICBkZWJ1Z19wcmludGYg
KCJ0YWJsZV9zaXplOiAlZCIsIHRhYmxlX3NpemUpOworICByZXR1cm4gdGFibGVfc2l6ZTsK
K30KKworY29uc3QgY2hhciBkZXZfZGlza1tdID0gIi9kZXYvZGlzayI7Citjb25zdCBzaXpl
X3QgZGV2X2Rpc2tfbGVuID0gc2l6ZW9mIChkZXZfZGlzaykgLSAxOworCitmaGFuZGxlcl9k
ZXZfZGlzazo6ZmhhbmRsZXJfZGV2X2Rpc2sgKCk6CisgIGZoYW5kbGVyX3ZpcnR1YWwgKCks
CisgIGxvYyAodW5rbm93bl9sb2MpLAorICBkcml2ZV9mcm9tX2lkICgtMSksCisgIHBhcnRf
ZnJvbV9pZCAoMCkKK3sKK30KKwordm9pZAorZmhhbmRsZXJfZGV2X2Rpc2s6OmluaXRfZGV2
X2Rpc2sgKCkKK3sKKyAgaWYgKGxvYyAhPSB1bmtub3duX2xvYykKKyAgICByZXR1cm47CisK
KyAgc3RhdGljIGNvbnN0IGNoYXIgYnlfaWRbXSA9ICIvYnktaWQiOworICBjb25zdCBzaXpl
X3QgYnlfaWRfbGVuID0gc2l6ZW9mKGJ5X2lkKSAtIDE7CisKKyAgLyogRGV0ZXJtaW5lIGxv
Y2F0aW9uLiAqLworICBjb25zdCBjaGFyICpwYXRoID0gZ2V0X25hbWUgKCk7CisgIGlmICgh
cGF0aF9wcmVmaXhfcCAoZGV2X2Rpc2ssIHBhdGgsIGRldl9kaXNrX2xlbiwgZmFsc2UpKQor
ICAgIGxvYyA9IGludmFsaWRfbG9jOyAvLyBzaG91bGQgbm90IGhhcHBlbgorICBlbHNlIGlm
ICghcGF0aFtkZXZfZGlza19sZW5dKQorICAgIGxvYyA9IGRpc2tfZGlyOyAvLyAiL2Rldi9k
aXNrIgorICBlbHNlIGlmICghcGF0aF9wcmVmaXhfcCAoYnlfaWQsIHBhdGggKyBkZXZfZGlz
a19sZW4sIGJ5X2lkX2xlbiwgZmFsc2UpKQorICAgIGxvYyA9IGludmFsaWRfbG9jOyAvLyAi
L2Rldi9kaXNrL2ludmFsaWQiCisgIGVsc2UgaWYgKCFwYXRoW2Rldl9kaXNrX2xlbiArIGJ5
X2lkX2xlbl0pCisgICAgbG9jID0gYnlfaWRfZGlyOyAvLyAiL2Rldi9kaXNrL2J5LWlkIgor
ICBlbHNlIGlmIChzdHJjaHIgKHBhdGggKyBkZXZfZGlza19sZW4gKyBieV9pZF9sZW4gKyAx
LCAnLycpKQorICAgIGxvYyA9IGludmFsaWRfbG9jOyAvLyAiL2Rldi9kaXNrL2J5LWlkL2Rp
ci9pbnZhbGlkIgorICBlbHNlCisgICAgbG9jID0gYnlfaWRfbGluazsgLy8gcG9zc2libGUg
Ii9kZXYvZGlzay9ieS1pZC9MSU5LIgorICBkZWJ1Z19wcmludGYgKCInJXMnOiBsb2MgJWQi
LCBwYXRoLCAoaW50KWxvYyk7CisKKyAgLyogRG9uZSBpZiAiL2Rldi9kaXNrIiwgIi9kZXYv
ZGlzay9ieV9pZCIgb3IgaW52YWxpZC4gKi8KKyAgaWYgKGxvYyAhPSBieV9pZF9saW5rKQor
ICAgIHJldHVybjsKKworICAvKiBDaGVjayB3aGV0aGVyICIvZGV2L2Rpc2svYnlfaWQvTElO
SyIgZXhpc3RzLiAqLworICBieV9pZF9lbnRyeSAqdGFibGU7CisgIGludCB0YWJsZV9zaXpl
ID0gZ2V0X2J5X2lkX3RhYmxlICh0YWJsZSk7CisgIGlmICghdGFibGUpCisgICAgeworICAg
ICAgbG9jID0gaW52YWxpZF9sb2M7CisgICAgICByZXR1cm47CisgICAgfQorCisgIGJ5X2lk
X2VudHJ5IGtleTsKKyAgc3RyY3B5IChrZXkubmFtZSwgcGF0aCArIGRldl9kaXNrX2xlbiAr
IGJ5X2lkX2xlbiArIDEpOworICBjb25zdCB2b2lkICpmb3VuZCA9IGJzZWFyY2ggKCZrZXks
IHRhYmxlLCB0YWJsZV9zaXplLCBzaXplb2YgKCp0YWJsZSksCisJCQkgICAgICAgYnlfaWRf
Y29tcGFyZV9uYW1lKTsKKyAgaWYgKGZvdW5kKQorICAgIHsKKyAgICAgIC8qIFByZXNlcnZl
IGRyaXZlIGFuZCBwYXJ0aXRpb24gbnVtYmVycyBmb3IgZmlsbGJ1ZiAoKS4gKi8KKyAgICAg
IGNvbnN0IGJ5X2lkX2VudHJ5ICplID0gcmVpbnRlcnByZXRfY2FzdDxjb25zdCBieV9pZF9l
bnRyeSAqPihmb3VuZCk7CisgICAgICBkcml2ZV9mcm9tX2lkID0gZS0+ZHJpdmU7CisgICAg
ICBwYXJ0X2Zyb21faWQgPSBlLT5wYXJ0OworICAgIH0KKyAgZWxzZQorICAgIGxvYyA9IGlu
dmFsaWRfbG9jOworICBmcmVlICh0YWJsZSk7Cit9CisKK3ZpcnR1YWxfZnR5cGVfdAorZmhh
bmRsZXJfZGV2X2Rpc2s6OmV4aXN0cyAoKQoreworICBkZWJ1Z19wcmludGYgKCJleGlzdHMg
KCVzKSIsIGdldF9uYW1lICgpKTsKKyAgZW5zdXJlX2luaXRlZCAoKTsKKyAgc3dpdGNoIChs
b2MpCisgICAgeworICAgICAgY2FzZSBkaXNrX2RpcjoKKyAgICAgIGNhc2UgYnlfaWRfZGly
OgorCXJldHVybiB2aXJ0X2RpcmVjdG9yeTsKKyAgICAgIGNhc2UgYnlfaWRfbGluazoKKwly
ZXR1cm4gdmlydF9zeW1saW5rOworICAgICAgZGVmYXVsdDoKKwlyZXR1cm4gdmlydF9ub25l
OworICAgIH0KK30KKworaW50CitmaGFuZGxlcl9kZXZfZGlzazo6ZnN0YXQgKHN0cnVjdCBz
dGF0ICpidWYpCit7CisgIGRlYnVnX3ByaW50ZiAoImZzdGF0ICglcykiLCBnZXRfbmFtZSAo
KSk7CisgIGVuc3VyZV9pbml0ZWQgKCk7CisgIGlmIChsb2MgPT0gaW52YWxpZF9sb2MpCisg
ICAgeworICAgICAgc2V0X2Vycm5vIChFTk9FTlQpOworICAgICAgcmV0dXJuIC0xOworICAg
IH0KKworICBmaGFuZGxlcl9iYXNlOjpmc3RhdCAoYnVmKTsKKyAgYnVmLT5zdF9tb2RlID0g
KGxvYyA9PSBieV9pZF9saW5rID8gU19JRkxOSyB8IFNfSVdVU1IgfCBTX0lXR1JQIHwgU19J
V09USAorCQkgIDogU19JRkRJUikgfCBTVERfUkJJVFMgfCBTVERfWEJJVFM7CisgIGJ1Zi0+
c3RfaW5vID0gZ2V0X2lubyAoKTsKKyAgcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbmxpbmUg
YnlfaWRfZW50cnkgKioKK2Rpcl9pZF90YWJsZSAoRElSICpkaXIpCit7CisgIHJldHVybiBy
ZWludGVycHJldF9jYXN0PGJ5X2lkX2VudHJ5ICoqPigmZGlyLT5fX2RfaW50ZXJuYWwpOwor
fQorCitESVIgKgorZmhhbmRsZXJfZGV2X2Rpc2s6Om9wZW5kaXIgKGludCBmZCkKK3sKKyAg
ZW5zdXJlX2luaXRlZCAoKTsKKyAgaWYgKCEobG9jID09IGRpc2tfZGlyIHx8IGxvYyA9PSBi
eV9pZF9kaXIpKQorICAgIHsKKyAgICAgIHNldF9lcnJubyAoRU5PVERJUik7CisgICAgICBy
ZXR1cm4gbnVsbHB0cjsKKyAgICB9CisKKyAgYnlfaWRfZW50cnkgKnRhYmxlID0gbnVsbHB0
cjsKKyAgaWYgKGxvYyA9PSBieV9pZF9kaXIpCisgICAgeworICAgICAgaW50IHRhYmxlX3Np
emUgPSBnZXRfYnlfaWRfdGFibGUgKHRhYmxlKTsKKyAgICAgIGlmICh0YWJsZV9zaXplIDwg
MCkKKwlyZXR1cm4gbnVsbHB0cjsgLyogZXJybm8gaXMgc2V0LiAqLworICAgICAgaWYgKHRh
YmxlKQorCXsKKwkgIC8qIFNocmluayB0byByZXF1aXJlZCB0YWJsZV9zaXplLiAqLworCSAg
dGFibGUgPSBieV9pZF9yZWFsbG9jICh0YWJsZSwgdGFibGVfc2l6ZSArIDEpOworCSAgaWYg
KCF0YWJsZSkKKwkgICAgcmV0dXJuIG51bGxwdHI7IC8qIFNob3VsZCBub3QgaGFwcGVuLiAq
LworCSAgLyogTWFyayBlbmQgb2YgdGFibGUgZm9yIHJlYWRkaXIgKCkuICovCisJICB0YWJs
ZVt0YWJsZV9zaXplXS5uYW1lWzBdID0gJ1wwJzsKKwl9CisgICAgfQorCisgIERJUiAqZGly
ID0gZmhhbmRsZXJfdmlydHVhbDo6b3BlbmRpciAoZmQpOworICBpZiAoIWRpcikKKyAgICB7
CisgICAgICBmcmVlICh0YWJsZSk7CisgICAgICByZXR1cm4gbnVsbHB0cjsKKyAgICB9Cisg
IGRpci0+X19mbGFncyA9IGRpcmVudF9zYXdfZG90IHwgZGlyZW50X3Nhd19kb3RfZG90Owor
ICAqZGlyX2lkX3RhYmxlIChkaXIpID0gdGFibGU7CisgIHJldHVybiBkaXI7Cit9CisKK2lu
dAorZmhhbmRsZXJfZGV2X2Rpc2s6OmNsb3NlZGlyIChESVIgKmRpcikKK3sKKyAgZnJlZSAo
KmRpcl9pZF90YWJsZSAoZGlyKSk7CisgIHJldHVybiBmaGFuZGxlcl92aXJ0dWFsOjpjbG9z
ZWRpciAoZGlyKTsKK30KKworaW50CitmaGFuZGxlcl9kZXZfZGlzazo6cmVhZGRpciAoRElS
ICpkaXIsIGRpcmVudCAqZGUpCit7CisgIGludCByZXM7CisgIGlmIChkaXItPl9fZF9wb3Np
dGlvbiA8IDIpCisgICAgeworICAgICAgZGUtPmRfbmFtZVswXSA9ICcuJzsKKyAgICAgIGRl
LT5kX25hbWVbMV0gPSAoZGlyLT5fX2RfcG9zaXRpb24gPyAnLicgOiAnXDAnKTsKKyAgICAg
IGRlLT5kX25hbWVbMl0gPSAnXDAnOworICAgICAgZGUtPmRfdHlwZSA9IERUX0RJUjsKKyAg
ICAgIGRpci0+X19kX3Bvc2l0aW9uKys7CisgICAgICByZXMgPSAwOworICAgIH0KKyAgZWxz
ZSBpZiAobG9jID09IGRpc2tfZGlyICYmIGRpci0+X19kX3Bvc2l0aW9uID09IDIpCisgICAg
eworICAgICAgc3RyY3B5IChkZS0+ZF9uYW1lLCAiYnktaWQiKTsKKyAgICAgIGRlLT5kX3R5
cGUgPSBEVF9ESVI7CisgICAgICBkaXItPl9fZF9wb3NpdGlvbisrOworICAgICAgcmVzID0g
MDsKKyAgICB9CisgIGVsc2UgaWYgKGxvYyA9PSBieV9pZF9kaXIgJiYgKmRpcl9pZF90YWJs
ZSAoZGlyKSkKKyAgICB7CisgICAgICBjb25zdCBjaGFyICpuYW1lID0gKCpkaXJfaWRfdGFi
bGUgKGRpcikpW2Rpci0+X19kX3Bvc2l0aW9uIC0gMl0ubmFtZTsKKyAgICAgIGlmIChuYW1l
WzBdKQorCXsKKwkgIHN0cmNweSAoZGUtPmRfbmFtZSwgbmFtZSk7CisJICBkZS0+ZF90eXBl
ID0gRFRfTE5LOworCSAgZGlyLT5fX2RfcG9zaXRpb24rKzsKKwkgIHJlcyA9IDA7CisJfQor
ICAgICAgZWxzZQorCXJlcyA9IEVOTUZJTEU7CisgICAgfQorICBlbHNlCisgICAgcmVzID0g
RU5NRklMRTsKKworICBzeXNjYWxsX3ByaW50ZiAoIiVkID0gcmVhZGRpciglcCwgJXApICgl
cykiLCByZXMsIGRpciwgZGUsCisJCSAgKCFyZXMgPyBkZS0+ZF9uYW1lIDogIiIpKTsKKyAg
cmV0dXJuIHJlczsKK30KKworaW50CitmaGFuZGxlcl9kZXZfZGlzazo6b3BlbiAoaW50IGZs
YWdzLCBtb2RlX3QgbW9kZSkKK3sKKyAgZW5zdXJlX2luaXRlZCAoKTsKKyAgaW50IGVyciA9
IDA7CisgIGlmICghZmhhbmRsZXJfdmlydHVhbDo6b3BlbiAoZmxhZ3MsIG1vZGUpKQorICAg
IGVyciA9IC0xOworICBlbHNlIGlmIChsb2MgPT0gZGlza19kaXIgfHwgbG9jID09IGJ5X2lk
X2RpcikKKyAgICB7CisgICAgICBpZiAoKGZsYWdzICYgKE9fQ1JFQVQgfCBPX0VYQ0wpKSA9
PSAoT19DUkVBVCB8IE9fRVhDTCkpCisJZXJyID0gRUVYSVNUOworICAgICAgZWxzZSBpZiAo
ZmxhZ3MgJiBPX1dST05MWSkKKwllcnIgPSBFSVNESVI7CisgICAgICBlbHNlCisJZGlyb3Bl
biA9IHRydWU7CisgICAgfQorICAvKiBlbHNlIGlmIChsb2MgPT0gYnlfaWRfbGluaykgeyB9
ICovIC8qIHNob3VsZCBub3QgaGFwcGVuICovCisgIGVsc2UgLyogKGxvYyA9PSBpbnZhbGlk
X2xvYykgKi8KKyAgICB7CisgICAgICBpZiAoZmxhZ3MgJiBPX0NSRUFUKQorCWVyciA9IEVS
T0ZTOworICAgICAgZWxzZQorCWVyciA9IEVOT0VOVDsKKyAgICB9CisKKyAgaW50IHJlczsK
KyAgaWYgKCFlcnIpCisgICAgeworICAgICAgbm9oYW5kbGUgKHRydWUpOworICAgICAgc2V0
X29wZW5fc3RhdHVzICgpOworICAgICAgcmVzID0gMTsKKyAgICB9CisgIGVsc2UKKyAgICB7
CisgICAgICBpZiAoZXJyID4gMCkKKwlzZXRfZXJybm8gKGVycik7CisgICAgICByZXMgPSAw
OworICAgIH0KKworICBzeXNjYWxsX3ByaW50ZiAoIiVkID0gZmhhbmRsZXJfZGV2X2Rpc2s6
Om9wZW4oJXksIDAlbykiLCByZXMsIGZsYWdzLCBtb2RlKTsKKyAgcmV0dXJuIHJlczsKK30K
KworYm9vbAorZmhhbmRsZXJfZGV2X2Rpc2s6OmZpbGxfZmlsZWJ1ZiAoKQoreworICBkZWJ1
Z19wcmludGYgKCJmaWxsX2ZpbGVidWYgKCVzKSIsIGdldF9uYW1lICgpKTsKKyAgZW5zdXJl
X2luaXRlZCAoKTsKKyAgaWYgKCEobG9jID09IGJ5X2lkX2xpbmsgJiYgZHJpdmVfZnJvbV9p
ZCA+PSAwKSkKKyAgICByZXR1cm4gZmFsc2U7CisKKyAgY2hhciBidWZbMzJdOworICBpbnQg
bGVuOworICBpZiAoZHJpdmVfZnJvbV9pZCArICdhJyA8PSAneicpCisgICAgbGVuID0gX19z
bWFsbF9zcHJpbnRmIChidWYsICIuLi8uLi9zZCVjIiwgZHJpdmVfZnJvbV9pZCArICdhJyk7
CisgIGVsc2UKKyAgICBsZW4gPSBfX3NtYWxsX3NwcmludGYgKGJ1ZiwgIi4uLy4uL3NkJWMl
YyIsCisJCQkgICBkcml2ZV9mcm9tX2lkIC8gKCd6JyAtICdhJyArIDEpIC0gMSArICdhJywK
KwkJCSAgIGRyaXZlX2Zyb21faWQgJSAoJ3onIC0gJ2EnICsgMSkgKyAnYScpOworICBpZiAo
cGFydF9mcm9tX2lkKQorICAgIF9fc21hbGxfc3ByaW50ZiAoYnVmICsgbGVuLCAiJWQiLCBw
YXJ0X2Zyb21faWQpOworCisgIGlmIChmaWxlYnVmKQorICAgIGNmcmVlIChmaWxlYnVmKTsK
KyAgZmlsZWJ1ZiA9IGNzdHJkdXAgKGJ1Zik7CisgIHJldHVybiB0cnVlOworfQpkaWZmIC0t
Z2l0IGEvd2luc3VwL2N5Z3dpbi9sb2NhbF9pbmNsdWRlcy9kZXZpY2VzLmggYi93aW5zdXAv
Y3lnd2luL2xvY2FsX2luY2x1ZGVzL2RldmljZXMuaAppbmRleCAxMDAzNTI2M2QuLjFlMDM1
ZjlkNiAxMDA2NDQKLS0tIGEvd2luc3VwL2N5Z3dpbi9sb2NhbF9pbmNsdWRlcy9kZXZpY2Vz
LmgKKysrIGIvd2luc3VwL2N5Z3dpbi9sb2NhbF9pbmNsdWRlcy9kZXZpY2VzLmgKQEAgLTcx
LDYgKzcxLDcgQEAgZW51bSBmaF9kZXZpY2VzCiAgIEZIX0RFViAgICAgPSBGSERFViAoREVW
X1ZJUlRGU19NQUpPUiwgMTkzKSwKICAgRkhfQ1lHRFJJVkU9IEZIREVWIChERVZfVklSVEZT
X01BSk9SLCAxOTIpLAogICBGSF9ERVZfRkQgID0gRkhERVYgKERFVl9WSVJURlNfTUFKT1Is
IDE5MSksCisgIEZIX0RFVl9ESVNLPSBGSERFViAoREVWX1ZJUlRGU19NQUpPUiwgMTkwKSwK
IAogICBGSF9TSUdOQUxGRD0gRkhERVYgKERFVl9WSVJURlNfTUFKT1IsIDEzKSwKICAgRkhf
VElNRVJGRCA9IEZIREVWIChERVZfVklSVEZTX01BSk9SLCAxNCksCkBAIC00MTUsNiArNDE2
LDggQEAgZXh0ZXJuIGNvbnN0IF9kZXZpY2UgZGV2X3BpcGVyX3N0b3JhZ2U7CiAjZGVmaW5l
IHBpcGVyX2RldiAoKGRldmljZSAqKSAmZGV2X3BpcGVyX3N0b3JhZ2UpCiBleHRlcm4gY29u
c3QgX2RldmljZSBkZXZfcGlwZXdfc3RvcmFnZTsKICNkZWZpbmUgcGlwZXdfZGV2ICgoZGV2
aWNlICopICZkZXZfcGlwZXdfc3RvcmFnZSkKK2V4dGVybiBjb25zdCBfZGV2aWNlIGRldl9k
ZXZfZGlza19zdG9yYWdlOworI2RlZmluZSBkZXZfZGlza19kZXYgKChkZXZpY2UgKikgJmRl
dl9kZXZfZGlza19zdG9yYWdlKQogZXh0ZXJuIGNvbnN0IF9kZXZpY2UgZGV2X3Byb2Nfc3Rv
cmFnZTsKICNkZWZpbmUgcHJvY19kZXYgKChkZXZpY2UgKikgJmRldl9wcm9jX3N0b3JhZ2Up
CiBleHRlcm4gY29uc3QgX2RldmljZSBkZXZfZGV2X3N0b3JhZ2U7CkBAIC00MzksNyArNDQy
LDggQEAgZXh0ZXJuIGNvbnN0IF9kZXZpY2UgZGV2X2ZzX3N0b3JhZ2U7CiAjZGVmaW5lIGlz
cHJvY3N5c19kZXYoZGV2bikgKGRldm4gPT0gRkhfUFJPQ1NZUykKIAogI2RlZmluZSBpc3Zp
cnR1YWxfZGV2KGRldm4pIFwKLSAgKGlzcHJvY19kZXYgKGRldm4pIHx8IGRldm4gPT0gRkhf
Q1lHRFJJVkUgfHwgZGV2biA9PSBGSF9ORVREUklWRSB8fCBkZXZuID09IEZIX0RFVl9GRCkK
KyAgKGlzcHJvY19kZXYgKGRldm4pIHx8IGRldm4gPT0gRkhfQ1lHRFJJVkUgfHwgZGV2biA9
PSBGSF9ORVREUklWRSBcCisgICB8fCBkZXZuID09IEZIX0RFVl9GRCB8fCBkZXZuID09IEZI
X0RFVl9ESVNLKQogCiAjZGVmaW5lIGlzY29uc19kZXYobikgXAogICAoKGRldmljZTo6bWFq
b3IgKChkZXZfdCkgKG4pKSA9PSBERVZfQ09OU19NQUpPUikgXApkaWZmIC0tZ2l0IGEvd2lu
c3VwL2N5Z3dpbi9sb2NhbF9pbmNsdWRlcy9maGFuZGxlci5oIGIvd2luc3VwL2N5Z3dpbi9s
b2NhbF9pbmNsdWRlcy9maGFuZGxlci5oCmluZGV4IDIxMmMyMjM0NC4uY2Q2MWFhZGY4IDEw
MDY0NAotLS0gYS93aW5zdXAvY3lnd2luL2xvY2FsX2luY2x1ZGVzL2ZoYW5kbGVyLmgKKysr
IGIvd2luc3VwL2N5Z3dpbi9sb2NhbF9pbmNsdWRlcy9maGFuZGxlci5oCkBAIC00MCw2ICs0
MCw4IEBAIGRldGFpbHMuICovCiBleHRlcm4gY29uc3QgY2hhciAqd2luZG93c19kZXZpY2Vf
bmFtZXNbXTsKIGV4dGVybiBzdHJ1Y3QgX19jeWd3aW5fcGVyZmlsZSAqcGVyZmlsZV90YWJs
ZTsKICNkZWZpbmUgX19mbW9kZSAoKih1c2VyX2RhdGEtPmZtb2RlX3B0cikpCitleHRlcm4g
Y29uc3QgY2hhciBkZXZfZGlza1tdOworZXh0ZXJuIGNvbnN0IHNpemVfdCBkZXZfZGlza19s
ZW47CiBleHRlcm4gY29uc3QgY2hhciBwcm9jW107CiBleHRlcm4gY29uc3Qgc2l6ZV90IHBy
b2NfbGVuOwogZXh0ZXJuIGNvbnN0IGNoYXIgcHJvY3N5c1tdOwpAQCAtMzE5MCw2ICszMTky
LDUwIEBAIGNsYXNzIGZoYW5kbGVyX3Byb2NuZXQ6IHB1YmxpYyBmaGFuZGxlcl9wcm9jCiAg
IH0KIH07CiAKK2NsYXNzIGZoYW5kbGVyX2Rldl9kaXNrOiBwdWJsaWMgZmhhbmRsZXJfdmly
dHVhbAoreworICBlbnVtIGRldl9kaXNrX2xvY2F0aW9uIHsKKyAgICB1bmtub3duX2xvYywg
aW52YWxpZF9sb2MsIGRpc2tfZGlyLCBieV9pZF9kaXIsIGJ5X2lkX2xpbmsKKyAgfTsKKyAg
ZGV2X2Rpc2tfbG9jYXRpb24gbG9jOworCisgIHZvaWQgaW5pdF9kZXZfZGlzayAoKTsKKyAg
dm9pZCBlbnN1cmVfaW5pdGVkICgpCisgIHsKKyAgICBpZiAobG9jID09IHVua25vd25fbG9j
KQorICAgICAgaW5pdF9kZXZfZGlzayAoKTsKKyAgfQorCisgIGludCBkcml2ZV9mcm9tX2lk
OworICBpbnQgcGFydF9mcm9tX2lkOworCisgcHVibGljOgorICBmaGFuZGxlcl9kZXZfZGlz
ayAoKTsKKyAgZmhhbmRsZXJfZGV2X2Rpc2sgKHZvaWQgKikge30KKyAgdmlydHVhbF9mdHlw
ZV90IGV4aXN0cygpOworICBESVIgKm9wZW5kaXIgKGludCBmZCk7CisgIGludCBjbG9zZWRp
ciAoRElSICopOworICBpbnQgcmVhZGRpciAoRElSICosIGRpcmVudCAqKTsKKyAgaW50IG9w
ZW4gKGludCBmbGFncywgbW9kZV90IG1vZGUgPSAwKTsKKyAgaW50IGZzdGF0IChzdHJ1Y3Qg
c3RhdCAqYnVmKTsKKyAgYm9vbCBmaWxsX2ZpbGVidWYgKCk7CisKKyAgdm9pZCBjb3B5X2Zy
b20gKGZoYW5kbGVyX2Jhc2UgKngpCisgIHsKKyAgICBwYy5mcmVlX3N0cmluZ3MgKCk7Cisg
ICAgKnRoaXMgPSAqcmVpbnRlcnByZXRfY2FzdDxmaGFuZGxlcl9kZXZfZGlzayAqPiAoeCk7
CisgICAgX2NvcHlfZnJvbV9yZXNldF9oZWxwZXIgKCk7CisgIH0KKworICBmaGFuZGxlcl9k
ZXZfZGlzayAqY2xvbmUgKGN5Z2hlYXBfdHlwZXMgbWFsbG9jX3R5cGUgPSBIRUFQX0ZIQU5E
TEVSKQorICB7CisgICAgdm9pZCAqcHRyID0gKHZvaWQgKikgY2NhbGxvYyAobWFsbG9jX3R5
cGUsIDEsIHNpemVvZiAoZmhhbmRsZXJfZGV2X2Rpc2spKTsKKyAgICBmaGFuZGxlcl9kZXZf
ZGlzayAqZmggPSBuZXcgKHB0cikgZmhhbmRsZXJfZGV2X2Rpc2sgKHB0cik7CisgICAgZmgt
PmNvcHlfZnJvbSAodGhpcyk7CisgICAgcmV0dXJuIGZoOworICB9Cit9OworCiBjbGFzcyBm
aGFuZGxlcl9kZXZfZmQ6IHB1YmxpYyBmaGFuZGxlcl92aXJ0dWFsCiB7CiAgcHVibGljOgpA
QCAtMzQxNiw2ICszNDYyLDcgQEAgdHlwZWRlZiB1bmlvbgogICBjaGFyIF9fZGV2X3Jhd1tz
aXplb2YgKGZoYW5kbGVyX2Rldl9yYXcpXTsKICAgY2hhciBfX2Rldl90YXBlW3NpemVvZiAo
ZmhhbmRsZXJfZGV2X3RhcGUpXTsKICAgY2hhciBfX2Rldl96ZXJvW3NpemVvZiAoZmhhbmRs
ZXJfZGV2X3plcm8pXTsKKyAgY2hhciBfX2Rldl9kaXNrW3NpemVvZiAoZmhhbmRsZXJfZGV2
X2Rpc2spXTsKICAgY2hhciBfX2Rldl9mZFtzaXplb2YgKGZoYW5kbGVyX2Rldl9mZCldOwog
ICBjaGFyIF9fZGlza19maWxlW3NpemVvZiAoZmhhbmRsZXJfZGlza19maWxlKV07CiAgIGNo
YXIgX19maWZvW3NpemVvZiAoZmhhbmRsZXJfZmlmbyldOwpkaWZmIC0tZ2l0IGEvd2luc3Vw
L2N5Z3dpbi9tb3VudC5jYyBiL3dpbnN1cC9jeWd3aW4vbW91bnQuY2MKaW5kZXggMzZhYjA0
MmE3Li4xM2FjZTYyNTAgMTAwNjQ0Ci0tLSBhL3dpbnN1cC9jeWd3aW4vbW91bnQuY2MKKysr
IGIvd2luc3VwL2N5Z3dpbi9tb3VudC5jYwpAQCAtMzUsNiArMzUsOSBAQCBkZXRhaWxzLiAq
LwogICAgKHBhdGhbbW91bnRfdGFibGUtPmN5Z2RyaXZlX2xlbiArIDFdID09ICcvJyB8fCBc
CiAgICAgIXBhdGhbbW91bnRfdGFibGUtPmN5Z2RyaXZlX2xlbiArIDFdKSkKIAorI2RlZmlu
ZSBpc2Rldl9kaXNrKHBhdGgpIFwKKyAgKHBhdGhfcHJlZml4X3AgKGRldl9kaXNrLCAocGF0
aCksIGRldl9kaXNrX2xlbiwgZmFsc2UpKQorCiAjZGVmaW5lIGlzcHJvYyhwYXRoKSBcCiAg
IChwYXRoX3ByZWZpeF9wIChwcm9jLCAocGF0aCksIHByb2NfbGVuLCBmYWxzZSkpCiAKQEAg
LTY4NSw2ICs2ODgsMTMgQEAgbW91bnRfaW5mbzo6Y29udl90b193aW4zMl9wYXRoIChjb25z
dCBjaGFyICpzcmNfcGF0aCwgY2hhciAqZHN0LCBkZXZpY2UmIGRldiwKICAgICAgIC8qIEdv
IHRocm91Z2ggY2hyb290IGNoZWNrICovCiAgICAgICBnb3RvIG91dDsKICAgICB9CisgIGlm
IChpc2Rldl9kaXNrIChzcmNfcGF0aCkpCisgICAgeworICAgICAgZGV2ID0gKmRldl9kaXNr
X2RldjsKKyAgICAgICpmbGFncyA9IDA7CisgICAgICBzdHJjcHkgKGRzdCwgc3JjX3BhdGgp
OworICAgICAgZ290byBvdXQ7CisgICAgfQogICBpZiAoaXNwcm9jIChzcmNfcGF0aCkpCiAg
ICAgewogICAgICAgZGV2ID0gKnByb2NfZGV2OwotLSAKMi40Mi4wCgo=
--------------22795A73DC1BC5A0421F3747--
