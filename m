Return-Path: <corinna@sourceware.org>
Received: by sourceware.org (Postfix, from userid 2155)
	id C12583858D33; Thu, 24 Jul 2025 10:37:46 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 sourceware.org C12583858D33
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=cygwin.com;
	s=default; t=1753353466;
	bh=PVf5WLDgy5bO2UNryiZ8Al1c5Nw3MJCUDT5YnXrAeX8=;
	h=Date:From:To:Cc:Subject:Reply-To:References:In-Reply-To:From;
	b=AxTMNG7AqcUtH5jg6ZmupNkR07jT+17ixpu9p9A+RP332nOD+3/5n8UKM7uPkkKBy
	 wHdfZmAF+hbOfG5Wd+RAONtKbnRTCswmP7oDoLCcAg60yXTwhTu8qb7jOJgjqHp308
	 MZA6t5ALtehrGCNbYGz9osjsHoOvzUTfv4gzbqxk=
Received: by calimero.vinschen.de (Postfix, from userid 500)
	id 13CCDA80DCD; Thu, 24 Jul 2025 12:37:45 +0200 (CEST)
Date: Thu, 24 Jul 2025 12:37:45 +0200
From: Corinna Vinschen <corinna-cygwin@cygwin.com>
To: Radek Barton <radek.barton@microsoft.com>
Cc: "cygwin-patches@cygwin.com" <cygwin-patches@cygwin.com>,
	Jeremy Drake <cygwin@jdrake.com>
Subject: Re: [PATCH v2] Cygwin: mkimport: implement AArch64 +/-4GB relocations
Message-ID: <aIIM-ZOEUZDsq-og@calimero.vinschen.de>
Reply-To: cygwin-patches@cygwin.com
Mail-Followup-To: Radek Barton <radek.barton@microsoft.com>,
	"cygwin-patches@cygwin.com" <cygwin-patches@cygwin.com>,
	Jeremy Drake <cygwin@jdrake.com>
References: <DB9PR83MB0923E3D187978CF43940B188925DA@DB9PR83MB0923.EURPRD83.prod.outlook.com>
 <aH4NM_WJNC2KHpHT@calimero.vinschen.de>
 <23af2767-7e76-74fd-198f-2abdee7cc73e@jdrake.com>
 <GV4PR83MB0941B168699D42E77A73814F925CA@GV4PR83MB0941.EURPRD83.prod.outlook.com>
 <aH9Pi6bJNDa_Q7V1@calimero.vinschen.de>
 <GV4PR83MB09417042234459A19594C15C925CA@GV4PR83MB0941.EURPRD83.prod.outlook.com>
 <aH9jZCS92AGUaP-o@calimero.vinschen.de>
 <b76de53a-24a7-0983-c756-2fd7213950f2@jdrake.com>
 <aICZuCg3tKXOj_mR@calimero.vinschen.de>
 <GV4PR83MB0941AA5AD0E67B89787B1FE0925EA@GV4PR83MB0941.EURPRD83.prod.outlook.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <GV4PR83MB0941AA5AD0E67B89787B1FE0925EA@GV4PR83MB0941.EURPRD83.prod.outlook.com>
List-Id: <cygwin-patches.cygwin.com>

Hi Radek,

On Jul 24 10:30, Radek Barton via Cygwin-patches wrote:
> Hello.
> 
> Sending another version of the patch with the comments added.

Thanks for this.  A small nit:

> 
> Radek
> 
> ---
> >From b9d04d2359a258f4a08f7f50fe5a11c03859f2b5 Mon Sep 17 00:00:00 2001
> From: =?UTF-8?q?Radek=20Barto=C5=88?= <radek.barton@microsoft.com>
> Date: Sat, 19 Jul 2025 19:17:12 +0200
> Subject: [PATCH v2] Cygwin: mkimport: implement AArch64 +/-4GB relocations
> MIME-Version: 1.0
> Content-Type: text/plain; charset=UTF-8
> Content-Transfer-Encoding: 8bit
> 
> Based on https://sourceware.org/pipermail/cygwin-patches/2025q3/014154.html
> suggestion, this patch implements +/-4GB relocations for AArch64 in the mkimport
> script by using adrp and ldr instructions. This change required update
> in winsup\cygwin\mm\malloc_wrapper.cc where those instructions are
> decoded to get target import address.
> 
> Signed-off-by: Radek Barto≈à <radek.barton@microsoft.com>
> ---
>  winsup/cygwin/mm/malloc_wrapper.cc | 26 +++++++++++++++++---------
>  winsup/cygwin/scripts/mkimport     |  7 +++++--
>  2 files changed, 22 insertions(+), 11 deletions(-)
> 
> diff --git a/winsup/cygwin/mm/malloc_wrapper.cc b/winsup/cygwin/mm/malloc_wrapper.cc
> index 863d3089c..991bd57be 100644
> --- a/winsup/cygwin/mm/malloc_wrapper.cc
> +++ b/winsup/cygwin/mm/malloc_wrapper.cc
> @@ -51,16 +51,24 @@ import_address (void *imp)
>    __try
>      {
>  #if defined(__aarch64__)
> -      // If opcode is an adr instruction.
> -      uint32_t opcode = *(uint32_t *) imp;
> -      if ((opcode & 0x9f000000) == 0x10000000)

For multiline comments, please use /* ... */ as in the surrounding code.

> +      // If opcode1 is an adrp and opcode2 is ldr instruction:
> +      //   - https://www.scs.stanford.edu/~zyedidia/arm64/adrp.html
> +      //   - https://www.scs.stanford.edu/~zyedidia/arm64/ldr_imm_gen.html
> +      // NOTE: This implementation assumes that the relocation table is made of
> +      // those specific AArch64 instructions as generated by the
> +      // winsup\cygwin\scripts\mkimport script. Please, keep it in sync.

And for paths, please use forward slashes. We're POSIXy here ;)

Apart from that this LGTM, but I would like to wait for a GTG from
Jeremy as well.


Thanks,
Corinna
