Return-Path: <cygwin-patches-return-1909-listarch-cygwin-patches=sourceware.cygnus.com@cygwin.com>
Received: (qmail 861 invoked by alias); 27 Feb 2002 06:49:07 -0000
Mailing-List: contact cygwin-patches-help@cygwin.com; run by ezmlm
Precedence: bulk
List-Subscribe: <mailto:cygwin-patches-subscribe@cygwin.com>
List-Post: <mailto:cygwin-patches@cygwin.com>
List-Archive: <http://sources.redhat.com/ml/cygwin-patches/>
List-Help: <mailto:cygwin-patches-help@cygwin.com>, <http://sources.redhat.com/ml/#faqs>
Sender: cygwin-patches-owner@cygwin.com
Received: (qmail 834 invoked from network); 27 Feb 2002 06:49:06 -0000
Message-ID: <20020227045945.5521.qmail@web20009.mail.yahoo.com>
Date: Wed, 27 Feb 2002 03:03:00 -0000
From: Joshua Daniel Franklin <joshuadfranklin@yahoo.com>
Subject: RE: help/version patches
To: Robert Collins <robert.collins@itdomain.com.au>
Cc: cygwin-patches@cygwin.com
In-Reply-To: <FC169E059D1A0442A04C40F86D9BA76008AABC@itdomain003.itdomain.net.au>
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="0-172676778-1014785985=:4934"
X-SW-Source: 2002-q1/txt/msg00266.txt.bz2

--0-172676778-1014785985=:4934
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-length: 1517


--- Robert Collins <robert.collins@itdomain.com.au> wrote:
> 
> 
> > -----Original Message-----
> > From: Joshua Daniel Franklin [mailto:joshuadfranklin@yahoo.com] 
> 
> +const char *revision="$Revision: 1.22 $";
> 
> This is suspect: The revision string can look like $Revision:$ in some
> circumstances - see man co again - which is why I had "$Revision: $ " - note
> the space after the second $ sign.

Hmm. Sounds like if -kk is used, it could be replaced with just "$Revision$",
which gives the +11 part problems. Another if...

> Likewise, the 
> +  /* Get version number out of the autogenerated revision string  */
> +  (void *) version = malloc(sizeof(revision));
> +  strcpy(version, revision+11);
> +  version[strlen(version)-1]= 0;
> 
> Could be more robustly done as 
> +  version = (char *) malloc(sizeof(revision));
> +  strcpy(version, revision+11);
> +  {
> +    char *temp=version + strlen (version);
> +    while (isspace(--temp) && temp >= version);
> +    temp[1]='\0';
> +  }
> 
> Which will munch an arbitrary amount of whitespace.

Well, except that that loop does away with the whole point--eating the
trailing '$'. Here's another go. I tested it with "$Revision$", 
"$Revision:$", "$Revision: $ ", "$Revision: 1.22 $ ", and "$Revision: 1.2 2 $ "
(in the unlikely event of a version number with spaces) and it does the right
thing on each.


__________________________________________________
Do You Yahoo!?
Yahoo! Greetings - Send FREE e-cards for every occasion!
http://greetings.yahoo.com
--0-172676778-1014785985=:4934
Content-Type: text/plain; name="cygcheck.cc-patch"
Content-Description: cygcheck.cc-patch
Content-Disposition: inline; filename="cygcheck.cc-patch"
Content-length: 3506

--- cygcheck.cc-orig	Sun Feb 24 13:28:27 2002
+++ cygcheck.cc	Tue Feb 26 22:55:33 2002
@@ -1,6 +1,6 @@
 /* cygcheck.cc
 
-   Copyright 1998, 1999, 2000, 2001 Red Hat, Inc.
+   Copyright 1998-2002 Red Hat, Inc.
 
    This file is part of Cygwin.
 
@@ -33,6 +33,8 @@ typedef __int64 longlong;
 
 void dump_setup (int, char **, bool);
 
+const char *revision="$Revision: 1.22 $ ";
+
 const char *known_env_vars[] = {
   "c_include_path",
   "compiler_path",
@@ -1216,17 +1218,19 @@ check_keys ()
 }
 
 void
-usage ()
+usage (FILE *stream, int status)
 {
-  fprintf (stderr, "Usage: cygcheck [OPTIONS] [program ...]\n");
-  fprintf (stderr, "  -c, --check-setup = check packages installed via setup.exe\n");
-  fprintf (stderr, "  -s, --sysinfo     = system information (not with -k)\n");
-  fprintf (stderr, "  -v, --verbose     = verbose output (indented) (for -s or programs)\n");
-  fprintf (stderr, "  -r, --registry    = registry search (requires -s)\n");
-  fprintf (stderr, "  -k, --keycheck    = perform a keyboard check session (not with -s)\n");
-  fprintf (stderr, "  -h, --help        = give help about the info (not with -c)\n");
-  fprintf (stderr, "You must at least give either -s or -k or a program name\n");
-  exit (1);
+  fprintf (stream, "\
+Usage: cygcheck [OPTIONS] [program ...]\n\
+ -c, --check-setup  check packages installed via setup.exe\n\
+ -s, --sysinfo      system information (not with -k)\n\
+ -v, --verbose      verbose output (indented) (for -s or programs)\n\
+ -r, --registry     registry search (requires -s)\n\
+ -k, --keycheck     perform a keyboard check session (not with -s)\n\
+ -h, --help         give help about the info (not with -c)\n\
+ -z, --version      output version information and exit\n\
+You must at least give either -s or -k or a program name\n");
+  exit (status);
 }
 
 struct option longopts[] = {
@@ -1236,15 +1240,32 @@ struct option longopts[] = {
   {"verbose", no_argument, NULL, 'v'},
   {"keycheck", no_argument, NULL, 'k'},
   {"help", no_argument, NULL, 'h'},
+  {"version", no_argument, 0, 'z'},
   {0, no_argument, NULL, 0}
 };
 
-char opts[] = "srvkhc";
+char opts[] = "chkrsvz";
 
 int
 main (int argc, char **argv)
 {
   int i;
+  char *version;
+  
+  /* Get version number out of the autogenerated revision string  */
+  (void *) version = malloc(sizeof(revision));
+  strcpy(version, revision+9);
+  if (version[0] != ':')
+    *version=0;
+  else
+  {
+    version = version+2;
+    char *temp=version + strlen (version);
+    while (isspace((int)*--temp) || *temp=='$' && temp >= version)
+      temp[1]='\0';
+  }
+
+  version[strlen(version)-1]= 0;
 
   while ((i = getopt_long (argc, argv, opts, longopts, NULL)) != EOF)
     switch (i)
@@ -1267,17 +1288,27 @@ main (int argc, char **argv)
       case 'h':
 	givehelp = 1;
 	break;
+      case 'z':
+        printf ("cygcheck (cygwin) %s\n", version);
+        printf ("System Checker\n");
+        printf ("Copyright 1998-2002 Red Hat, Inc.\n");
+        fputs ("Compiled "__DATE__"\n", stdout);
+        exit (0);
       default:
-	usage ();
+	usage (stderr, 1);
        /*NOTREACHED*/}
   argc -= optind;
   argv += optind;
 
-  if (argc == 0 && !sysinfo && !keycheck && !check_setup)
-    usage ();
+  if (argc == 0 && !sysinfo && !keycheck && !check_setup) {
+     if (givehelp)
+	usage (stdout, 0);
+     else
+	usage (stderr, 1);
+     }
 
   if ((check_setup || sysinfo) && keycheck)
-    usage ();
+	usage (stderr, 1);
 
   if (keycheck)
     return check_keys ();

--0-172676778-1014785985=:4934--
