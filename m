Return-Path: <cygwin-patches-return-9440-listarch-cygwin-patches=sources.redhat.com@cygwin.com>
Received: (qmail 128371 invoked by alias); 7 Jun 2019 18:05:36 -0000
Mailing-List: contact cygwin-patches-help@cygwin.com; run by ezmlm
Precedence: bulk
List-Id: <cygwin-patches.cygwin.com>
List-Subscribe: <mailto:cygwin-patches-subscribe@cygwin.com>
List-Post: <mailto:cygwin-patches@cygwin.com>
List-Archive: <http://sourceware.org/ml/cygwin-patches/>
List-Help: <mailto:cygwin-patches-help@cygwin.com>, <http://sourceware.org/ml/#faqs>
Sender: cygwin-patches-owner@cygwin.com
Mail-Followup-To: cygwin-patches@cygwin.com
Received: (qmail 128313 invoked by uid 89); 7 Jun 2019 18:05:36 -0000
Authentication-Results: sourceware.org; auth=none
X-Spam-SWARE-Status: No, score=-22.3 required=5.0 tests=AWL,BAYES_00,GIT_PATCH_0,GIT_PATCH_1,GIT_PATCH_2,GIT_PATCH_3,MIME_BASE64_BLANKS,RCVD_IN_DNSWL_NONE,SPF_HELO_PASS,SPF_PASS autolearn=ham version=3.3.1 spammy=
X-HELO: NAM04-SN1-obe.outbound.protection.outlook.com
Received: from mail-eopbgr700115.outbound.protection.outlook.com (HELO NAM04-SN1-obe.outbound.protection.outlook.com) (40.107.70.115) by sourceware.org (qpsmtpd/0.93/v0.84-503-g423c35a) with ESMTP; Fri, 07 Jun 2019 18:05:34 +0000
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=cornell.edu; s=selector2; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=u0nq2AHUmyAWy083TycCVFar8a89johJylHkRXncy4k=; b=RWxk9sCG9mXEyoUKlByUv3xFUoYAC2qmhi+4oejvYTjxDxHydbvarbrxc56maER9qpU6V6VPT2JH72+uX9+QC/jJRspI4niQQvLaUuWEBnR9IxyV/afvABDEKOaMcGQ0jxYGlLs2evGCvM6hwFRnzzRJpnivka3PWoXFhicOVCo=
Received: from DM6PR04MB5211.namprd04.prod.outlook.com (20.178.24.208) by DM6PR04MB4313.namprd04.prod.outlook.com (20.176.77.22) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.1965.14; Fri, 7 Jun 2019 18:05:28 +0000
Received: from DM6PR04MB5211.namprd04.prod.outlook.com ([fe80::510a:3a42:f346:a4d8]) by DM6PR04MB5211.namprd04.prod.outlook.com ([fe80::510a:3a42:f346:a4d8%7]) with mapi id 15.20.1965.011; Fri, 7 Jun 2019 18:05:28 +0000
From: Ken Brown <kbrown@cornell.edu>
To: "cygwin-patches@cygwin.com" <cygwin-patches@cygwin.com>
Subject: [PATCH draft v2 2/6] Cygwin: fhandler_pipe: add raw_read and raw_write
Date: Fri, 07 Jun 2019 18:05:00 -0000
Message-ID: <20190607180511.46369-3-kbrown@cornell.edu>
References: <20190607180511.46369-1-kbrown@cornell.edu>
In-Reply-To: <20190607180511.46369-1-kbrown@cornell.edu>
authentication-results: spf=none (sender IP is ) smtp.mailfrom=kbrown@cornell.edu;
x-ms-oob-tlc-oobclassifiers: OLM:1201;
received-spf: None (protection.outlook.com: cornell.edu does not designate permitted sender hosts)
x-ms-exchange-senderadcheck: 1
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
X-MS-Exchange-CrossTenant-userprincipalname: ksb2@cornell.edu
X-IsSubscribed: yes
X-SW-Source: 2019-q2/txt/msg00146.txt.bz2

LS0tDQogd2luc3VwL2N5Z3dpbi9maGFuZGxlci5oICAgICAgIHwgICAyICsN
CiB3aW5zdXAvY3lnd2luL2ZoYW5kbGVyX3BpcGUuY2MgfCAyMDAgKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrDQogMiBmaWxlcyBjaGFuZ2Vk
LCAyMDIgaW5zZXJ0aW9ucygrKQ0KDQpkaWZmIC0tZ2l0IGEvd2luc3VwL2N5
Z3dpbi9maGFuZGxlci5oIGIvd2luc3VwL2N5Z3dpbi9maGFuZGxlci5oDQpp
bmRleCBiZGZlNGEyNzIuLmI5Y2M3YjQ3MSAxMDA2NDQNCi0tLSBhL3dpbnN1
cC9jeWd3aW4vZmhhbmRsZXIuaA0KKysrIGIvd2luc3VwL2N5Z3dpbi9maGFu
ZGxlci5oDQpAQCAtMTIwNiw2ICsxMjA2LDggQEAgcHVibGljOg0KICAgY2hh
ciAqZ2V0X3Byb2NfZmRfbmFtZSAoY2hhciAqYnVmKTsNCiAgIGludCBvcGVu
IChpbnQgZmxhZ3MsIG1vZGVfdCBtb2RlID0gMCk7DQogICBpbnQgZHVwIChm
aGFuZGxlcl9iYXNlICpjaGlsZCwgaW50KTsNCisgIHZvaWQgX19yZWczIHJh
d19yZWFkICh2b2lkICpwdHIsIHNpemVfdCYgbGVuKTsNCisgIHNzaXplX3Qg
X19yZWczIHJhd193cml0ZSAoY29uc3Qgdm9pZCAqcHRyLCBzaXplX3QgbGVu
KTsNCiAgIGludCBpb2N0bCAodW5zaWduZWQgaW50IGNtZCwgdm9pZCAqKTsN
CiAgIGludCBfX3JlZzIgZnN0YXQgKHN0cnVjdCBzdGF0ICpidWYpOw0KICAg
aW50IF9fcmVnMiBmc3RhdHZmcyAoc3RydWN0IHN0YXR2ZnMgKmJ1Zik7DQpk
aWZmIC0tZ2l0IGEvd2luc3VwL2N5Z3dpbi9maGFuZGxlcl9waXBlLmNjIGIv
d2luc3VwL2N5Z3dpbi9maGFuZGxlcl9waXBlLmNjDQppbmRleCAyZWE2OWY4
ZWQuLmQxMzgyMjZiYSAxMDA2NDQNCi0tLSBhL3dpbnN1cC9jeWd3aW4vZmhh
bmRsZXJfcGlwZS5jYw0KKysrIGIvd2luc3VwL2N5Z3dpbi9maGFuZGxlcl9w
aXBlLmNjDQpAQCAtMjAsNiArMjAsMTQgQEAgZGV0YWlscy4gKi8NCiAjaW5j
bHVkZSAicGluZm8uaCINCiAjaW5jbHVkZSAic2hhcmVkX2luZm8uaCINCiAN
CisvKiBUaGlzIGlzIG9ubHkgdG8gYmUgdXNlZCBmb3Igd3JpdGluZy4gIFdo
ZW4gcmVhZGluZywNCitTVEFUVVNfUElQRV9FTVBUWSBzaW1wbHkgbWVhbnMg
dGhlcmUncyBubyBkYXRhIHRvIGJlIHJlYWQuICovDQorI2RlZmluZSBTVEFU
VVNfUElQRV9JU19DTE9TRUQoc3RhdHVzKQlcDQorCQkoeyBOVFNUQVRVUyBf
cyA9IChzdGF0dXMpOyBcDQorCQkgICBfcyA9PSBTVEFUVVNfUElQRV9DTE9T
SU5HIFwNCisJCSAgIHx8IF9zID09IFNUQVRVU19QSVBFX0JST0tFTiBcDQor
CQkgICB8fCBfcyA9PSBTVEFUVVNfUElQRV9FTVBUWTsgfSkNCisNCiBmaGFu
ZGxlcl9waXBlOjpmaGFuZGxlcl9waXBlICgpDQogICA6IGZoYW5kbGVyX2Jh
c2UgKCksIHBvcGVuX3BpZCAoMCkNCiB7DQpAQCAtMTg0LDYgKzE5MiwxOTgg
QEAgZmhhbmRsZXJfcGlwZTo6Z2V0X3Byb2NfZmRfbmFtZSAoY2hhciAqYnVm
KQ0KICAgcmV0dXJuIGJ1ZjsNCiB9DQogDQordm9pZCBfX3JlZzMNCitmaGFu
ZGxlcl9waXBlOjpyYXdfcmVhZCAodm9pZCAqcHRyLCBzaXplX3QmIGxlbikN
Cit7DQorICBOVFNUQVRVUyBzdGF0dXM7DQorICBJT19TVEFUVVNfQkxPQ0sg
aW87DQorICBIQU5ETEUgZXZ0ID0gTlVMTDsNCisgIERXT1JEIHdhaXRyZXQg
PSBXQUlUX09CSkVDVF8wOw0KKyAgYm9vbCBrZWVwX2xvb3BpbmcgPSBmYWxz
ZTsNCisgIHNpemVfdCBvcmlnX2xlbiA9IGxlbjsNCisNCisgIGlmICghbGVu
KQ0KKyAgICByZXR1cm47DQorDQorICAvKiBDcmVhdGUgYSB3YWl0IGV2ZW50
IGlmIHdlJ3JlIGluIGJsb2NraW5nIG1vZGUuICovDQorICBpZiAoIWlzX25v
bmJsb2NraW5nICgpICYmICEoZXZ0ID0gQ3JlYXRlRXZlbnQgKE5VTEwsIGZh
bHNlLCBmYWxzZSwgTlVMTCkpKQ0KKyAgICB7DQorICAgICAgX19zZXRlcnJu
byAoKTsNCisgICAgICBsZW4gPSAoc2l6ZV90KSAtMTsNCisgICAgICByZXR1
cm47DQorICAgIH0NCisNCisgIGRvDQorICAgIHsNCisgICAgICBsZW4gPSBv
cmlnX2xlbjsNCisgICAgICBrZWVwX2xvb3BpbmcgPSBmYWxzZTsNCisgICAg
ICBpZiAoZXZ0KQ0KKwlSZXNldEV2ZW50IChldnQpOw0KKyAgICAgIHN0YXR1
cyA9IE50UmVhZEZpbGUgKGdldF9oYW5kbGUgKCksIGV2dCwgTlVMTCwgTlVM
TCwgJmlvLCBwdHIsDQorCQkJICAgbGVuLCBOVUxMLCBOVUxMKTsNCisgICAg
ICBpZiAoZXZ0ICYmIHN0YXR1cyA9PSBTVEFUVVNfUEVORElORykNCisJew0K
KwkgIHdhaXRyZXQgPSBjeWd3YWl0IChldnQpOw0KKwkgIGlmICh3YWl0cmV0
ID09IFdBSVRfT0JKRUNUXzApDQorCSAgICBzdGF0dXMgPSBpby5TdGF0dXM7
DQorCX0NCisgICAgICBpZiAod2FpdHJldCA9PSBXQUlUX0NBTkNFTEVEKQ0K
KwlzdGF0dXMgPSBTVEFUVVNfVEhSRUFEX0NBTkNFTEVEOw0KKyAgICAgIGVs
c2UgaWYgKHdhaXRyZXQgPT0gV0FJVF9TSUdOQUxFRCkNCisJc3RhdHVzID0g
U1RBVFVTX1RIUkVBRF9TSUdOQUxFRDsNCisgICAgICBlbHNlIGlmIChpc2Ns
b3NlZCAoKSkgIC8qIEEgc2lnbmFsIGhhbmRsZXIgbWlnaHQgaGF2ZSBjbG9z
ZWQgdGhlIGZkLiAqLw0KKwl7DQorCSAgaWYgKHdhaXRyZXQgPT0gV0FJVF9P
QkpFQ1RfMCkNCisJICAgIHNldF9lcnJubyAoRUJBREYpOw0KKwkgIGVsc2UN
CisJICAgIF9fc2V0ZXJybm8gKCk7DQorCSAgbGVuID0gKHNpemVfdCkgLTE7
DQorCX0NCisgICAgICBlbHNlIGlmIChOVF9TVUNDRVNTIChzdGF0dXMpKQ0K
Kwl7DQorCSAgbGVuID0gaW8uSW5mb3JtYXRpb247DQorCSAgaWYgKGxlbiA9
PSAwKQ0KKwkgICAga2VlcF9sb29waW5nID0gdHJ1ZTsNCisJfQ0KKyAgICAg
IGVsc2UNCisJew0KKwkgIC8qIFNvbWUgZXJyb3JzIGFyZSBub3QgcmVhbGx5
IGVycm9ycy4gIERldGVjdCBzdWNoIGNhc2VzIGhlcmUuICAqLw0KKwkgIHN3
aXRjaCAoc3RhdHVzKQ0KKwkgICAgew0KKwkgICAgY2FzZSBTVEFUVVNfRU5E
X09GX0ZJTEU6DQorCSAgICBjYXNlIFNUQVRVU19QSVBFX0JST0tFTjoNCisJ
ICAgICAgLyogVGhpcyBpcyByZWFsbHkgRU9GLiAgKi8NCisJICAgICAgbGVu
ID0gMDsNCisJICAgICAgYnJlYWs7DQorCSAgICBjYXNlIFNUQVRVU19NT1JF
X0VOVFJJRVM6DQorCSAgICBjYXNlIFNUQVRVU19CVUZGRVJfT1ZFUkZMT1c6
DQorCSAgICAgIC8qIGBpby5JbmZvcm1hdGlvbicgaXMgc3VwcG9zZWRseSB2
YWxpZC4gICovDQorCSAgICAgIGxlbiA9IGlvLkluZm9ybWF0aW9uOw0KKwkg
ICAgICBpZiAobGVuID09IDApDQorCQlrZWVwX2xvb3BpbmcgPSB0cnVlOw0K
KwkgICAgICBicmVhazsNCisJICAgIGNhc2UgU1RBVFVTX1BJUEVfTElTVEVO
SU5HOg0KKwkgICAgY2FzZSBTVEFUVVNfUElQRV9FTVBUWToNCisJICAgICAg
aWYgKGlzX25vbmJsb2NraW5nICgpKQ0KKwkJew0KKwkJICBzZXRfZXJybm8g
KEVBR0FJTik7DQorCQkgIGxlbiA9IChzaXplX3QpIC0xOw0KKwkJICBicmVh
azsNCisJCX0NCisJICAgICAgLyogRmFsbCB0aHJvdWdoLiAqLw0KKwkgICAg
ZGVmYXVsdDoNCisJICAgICAgX19zZXRlcnJub19mcm9tX250X3N0YXR1cyAo
c3RhdHVzKTsNCisJICAgICAgbGVuID0gKHNpemVfdCkgLTE7DQorCSAgICAg
IGJyZWFrOw0KKwkgICAgfQ0KKwl9DQorICAgIH0gd2hpbGUgKGtlZXBfbG9v
cGluZyk7DQorICBpZiAoZXZ0KQ0KKyAgICBDbG9zZUhhbmRsZSAoZXZ0KTsN
CisgIGlmIChzdGF0dXMgPT0gU1RBVFVTX1RIUkVBRF9TSUdOQUxFRCkNCisg
ICAgew0KKyAgICAgIHNldF9lcnJubyAoRUlOVFIpOw0KKyAgICAgIGxlbiA9
IChzaXplX3QpIC0xOw0KKyAgICB9DQorICBlbHNlIGlmIChzdGF0dXMgPT0g
U1RBVFVTX1RIUkVBRF9DQU5DRUxFRCkNCisgICAgcHRocmVhZDo6c3RhdGlj
X2NhbmNlbF9zZWxmICgpOw0KK30NCisNCitzc2l6ZV90IF9fcmVnMw0KK2Zo
YW5kbGVyX3BpcGU6OnJhd193cml0ZSAoY29uc3Qgdm9pZCAqcHRyLCBzaXpl
X3QgbGVuKQ0KK3sNCisgIHNzaXplX3QgcmV0ID0gLTE7DQorICBzaXplX3Qg
bmJ5dGVzID0gMDsNCisgIFVMT05HIGNodW5rOw0KKyAgTlRTVEFUVVMgc3Rh
dHVzID0gU1RBVFVTX1NVQ0NFU1M7DQorICBJT19TVEFUVVNfQkxPQ0sgaW87
DQorICBIQU5ETEUgZXZ0ID0gTlVMTDsNCisNCisgIGlmICghbGVuKQ0KKyAg
ICByZXR1cm4gMDsNCisNCisgIGlmIChsZW4gPD0gbWF4X2F0b21pY193cml0
ZSkNCisgICAgY2h1bmsgPSBsZW47DQorICBlbHNlIGlmIChpc19ub25ibG9j
a2luZyAoKSkNCisgICAgY2h1bmsgPSBsZW4gPSBtYXhfYXRvbWljX3dyaXRl
Ow0KKyAgZWxzZQ0KKyAgICBjaHVuayA9IG1heF9hdG9taWNfd3JpdGU7DQor
DQorICAvKiBDcmVhdGUgYSB3YWl0IGV2ZW50IGlmIHRoZSBwaXBlIGlzIGlu
IGJsb2NraW5nIG1vZGUuICovDQorICBpZiAoIWlzX25vbmJsb2NraW5nICgp
ICYmICEoZXZ0ID0gQ3JlYXRlRXZlbnQgKE5VTEwsIGZhbHNlLCBmYWxzZSwg
TlVMTCkpKQ0KKyAgICB7DQorICAgICAgX19zZXRlcnJubyAoKTsNCisgICAg
ICByZXR1cm4gLTE7DQorICAgIH0NCisNCisgIC8qIFdyaXRlIGluIGNodW5r
cywgYWNjdW11bGF0aW5nIGEgdG90YWwuICBJZiB0aGVyZSdzIGFuIGVycm9y
LCBqdXN0DQorICAgICByZXR1cm4gdGhlIGFjY3VtdWxhdGVkIHRvdGFsIHVu
bGVzcyB0aGUgZmlyc3Qgd3JpdGUgZmFpbHMsIGluDQorICAgICB3aGljaCBj
YXNlIHJldHVybiAtMS4gKi8NCisgIHdoaWxlIChuYnl0ZXMgPCBsZW4pDQor
ICAgIHsNCisgICAgICBVTE9OR19QVFIgbmJ5dGVzX25vdyA9IDA7DQorICAg
ICAgc2l6ZV90IGxlZnQgPSBsZW4gLSBuYnl0ZXM7DQorICAgICAgVUxPTkcg
bGVuMTsNCisgICAgICBEV09SRCB3YWl0cmV0ID0gV0FJVF9PQkpFQ1RfMDsN
CisNCisgICAgICBpZiAobGVmdCA+IGNodW5rKQ0KKwlsZW4xID0gY2h1bms7
DQorICAgICAgZWxzZQ0KKwlsZW4xID0gKFVMT05HKSBsZWZ0Ow0KKyAgICAg
IG5ieXRlc19ub3cgPSAwOw0KKyAgICAgIHN0YXR1cyA9IE50V3JpdGVGaWxl
IChnZXRfaGFuZGxlICgpLCBldnQsIE5VTEwsIE5VTEwsICZpbywNCisJCQkg
ICAgKFBWT0lEKSBwdHIsIGxlbjEsIE5VTEwsIE5VTEwpOw0KKyAgICAgIGlm
IChldnQgJiYgc3RhdHVzID09IFNUQVRVU19QRU5ESU5HKQ0KKwl7DQorCSAg
d2FpdHJldCA9IGN5Z3dhaXQgKGV2dCk7DQorCSAgaWYgKHdhaXRyZXQgPT0g
V0FJVF9PQkpFQ1RfMCkNCisJICAgIHN0YXR1cyA9IGlvLlN0YXR1czsNCisJ
fQ0KKyAgICAgIGlmICh3YWl0cmV0ID09IFdBSVRfQ0FOQ0VMRUQpDQorCXN0
YXR1cyA9IFNUQVRVU19USFJFQURfQ0FOQ0VMRUQ7DQorICAgICAgZWxzZSBp
ZiAod2FpdHJldCA9PSBXQUlUX1NJR05BTEVEKQ0KKwlzdGF0dXMgPSBTVEFU
VVNfVEhSRUFEX1NJR05BTEVEOw0KKyAgICAgIGVsc2UgaWYgKGlzY2xvc2Vk
ICgpKSAgLyogQSBzaWduYWwgaGFuZGxlciBtaWdodCBoYXZlIGNsb3NlZCB0
aGUgZmQuICovDQorCXsNCisJICBpZiAod2FpdHJldCA9PSBXQUlUX09CSkVD
VF8wKQ0KKwkgICAgc2V0X2Vycm5vIChFQkFERik7DQorCSAgZWxzZQ0KKwkg
ICAgX19zZXRlcnJubyAoKTsNCisJICBsZW4gPSAoc2l6ZV90KSAtMTsNCisJ
fQ0KKyAgICAgIGVsc2UgaWYgKE5UX1NVQ0NFU1MgKHN0YXR1cykpDQorCXsN
CisJICBuYnl0ZXNfbm93ID0gaW8uSW5mb3JtYXRpb247DQorCSAgLyogTnRX
cml0ZUZpbGUgcmV0dXJucyBzdWNjZXNzIHdpdGggIyBvZiBieXRlcyB3cml0
dGVuID09IDANCisJICAgICBpZiB3cml0aW5nIG9uIGEgbm9uLWJsb2NraW5n
IHBpcGUgZmFpbHMgYmVjYXVzZSB0aGUgcGlwZQ0KKwkgICAgIGJ1ZmZlciBk
b2Vzbid0IGhhdmUgc3VmZmljaWVudCBzcGFjZS4gKi8NCisJICBpZiAobmJ5
dGVzX25vdyA9PSAwKQ0KKwkgICAgc2V0X2Vycm5vIChFQUdBSU4pOw0KKwkg
IHB0ciA9ICgoY2hhciAqKSBwdHIpICsgY2h1bms7DQorCSAgbmJ5dGVzICs9
IG5ieXRlc19ub3c7DQorCX0NCisgICAgICBlbHNlIGlmIChTVEFUVVNfUElQ
RV9JU19DTE9TRUQgKHN0YXR1cykpDQorCXsNCisJICBzZXRfZXJybm8gKEVQ
SVBFKTsNCisJICByYWlzZSAoU0lHUElQRSk7DQorCX0NCisgICAgICBlbHNl
DQorCV9fc2V0ZXJybm9fZnJvbV9udF9zdGF0dXMgKHN0YXR1cyk7DQorDQor
ICAgICAgaWYgKG5ieXRlc19ub3cgPT0gMCkNCisJbGVuID0gMDsJCS8qIFRl
cm1pbmF0ZSBsb29wLiAqLw0KKyAgICAgIGlmIChuYnl0ZXMgPiAwKQ0KKwly
ZXQgPSBuYnl0ZXM7DQorICAgIH0NCisgIGlmIChldnQpDQorICAgIENsb3Nl
SGFuZGxlIChldnQpOw0KKyAgaWYgKHN0YXR1cyA9PSBTVEFUVVNfVEhSRUFE
X1NJR05BTEVEICYmIHJldCA8IDApDQorICAgIHNldF9lcnJubyAoRUlOVFIp
Ow0KKyAgZWxzZSBpZiAoc3RhdHVzID09IFNUQVRVU19USFJFQURfQ0FOQ0VM
RUQpDQorICAgIHB0aHJlYWQ6OnN0YXRpY19jYW5jZWxfc2VsZiAoKTsNCisg
IHJldHVybiByZXQ7DQorfQ0KKw0KIGludA0KIGZoYW5kbGVyX3BpcGU6OmR1
cCAoZmhhbmRsZXJfYmFzZSAqY2hpbGQsIGludCBmbGFncykNCiB7DQotLSAN
CjIuMjEuMA0KDQo=
