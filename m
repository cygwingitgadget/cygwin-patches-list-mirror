From: "Town, Brad" <btown@ceddec.com>
To: "'cygwin-patches@cygwin.com'" <cygwin-patches@cygwin.com>
Subject: Mouse support
Date: Thu, 30 Nov 2000 13:33:00 -0000
Message-id: <F10D23B02E54D011A0AB0020AF9CEFE988FA6E@lynx.ceddec.com>
X-SW-Source: 2000-q4/msg00031.html
Content-type: multipart/mixed; boundary="----------=_1583532846-65437-19"

This is a multi-part message in MIME format...

------------=_1583532846-65437-19
Content-length: 889

Attached are patches that enable xterm-style mouse event reporting for
console windows.

To use mouse event reporting, make sure your console windows do not have
QuickEdit mode enabled.

To enable ncurses support for the mouse, add "kmous=\E[M" to your source
terminfo file and re-tic.  I've tested it with ncurses's main test program
"ncurses" and "knights" (an ncurses test program) as supplied by the Cygwin
ncurses distribution.

Issues:
. Instead of mouse support always being enabled (as it is now), it should be
enabled when the console receives \E[?1000h and disabled when the console
receives \E[?1000l.  (That's a lower-case 'L'.)
. Single-clicking and triple-clicking seem to work fine, but for ncurses's
"ncurses" program to see a double-click, you need to move the mouse
afterward.  I spent the better part of the afternoon looking for the cause,
but to no avail.

Brad Town


------------=_1583532846-65437-19
Content-Type: text/plain; charset=us-ascii; name="ChangeLog.mouse"
Content-Disposition: inline; filename="ChangeLog.mouse"
Content-Transfer-Encoding: base64
Content-Length: 423

VGh1IE5vdiAzMCAxNjowNDoyNiAyMDAwICBCcmFkbGV5IEEuIFRvd24gPHRv
d25iYUBwb2JveC5jb20+CgoJKiBmaGFuZGxlcl9jb25zb2xlLmNjIChmaGFu
ZGxlcl9jb25zb2xlOjpyZWFkKTogQWRkZWQKCXh0ZXJtLXN0eWxlIG1vdXNl
IGV2ZW50IHJlcG9ydGluZy4KCShmaGFuZGxlcl9jb25zb2xlOjpvcGVuKTog
RW5hYmxlZCBtb3VzZSBpbnB1dCBldmVudHMuCgkoZmhhbmRsZXJfY29uc29s
ZTo6aW5wdXRfdGNzZXRhdHRyKTogRGl0dG8uCgkqIHNlbGVjdC5jYyAocGVl
a19jb25zb2xlKTogQWRkZWQgY2hlY2sgZm9yIG1vdXNlIGV2ZW50cy4K

------------=_1583532846-65437-19
Content-Type: text/x-diff; charset=us-ascii; name="fhandler_console.cc.diff"
Content-Disposition: inline; filename="fhandler_console.cc.diff"
Content-Transfer-Encoding: base64
Content-Length: 7272

LS0tIGZoYW5kbGVyX2NvbnNvbGUuY2Mub3JpZwlUaHUgTm92IDMwIDE2OjAw
OjMxIDIwMDAKKysrIGZoYW5kbGVyX2NvbnNvbGUuY2MJVGh1IE5vdiAzMCAx
NjowMTozMyAyMDAwCkBAIC0xOTMsNTAgKzE5MywxMzkgQEAgZmhhbmRsZXJf
Y29uc29sZTo6cmVhZCAodm9pZCAqcHYsIHNpemVfdAogCSAgcmV0dXJuIC0x
OwkJLyogc2VlbXMgdG8gYmUgZmFpbHVyZSAqLwogCX0KIAorICAgICAgLyog
Y2hlY2sgdGhlIGV2ZW50IHRoYXQgb2NjdXJyZWQgKi8KKyAgICAgIHN3aXRj
aCAoaW5wdXRfcmVjLkV2ZW50VHlwZSkKKwl7CisJY2FzZSBLRVlfRVZFTlQ6
CisJICBpZiAoIWlucHV0X3JlYy5FdmVudC5LZXlFdmVudC5iS2V5RG93bikK
KwkgICAgY29udGludWU7CisKICNkZWZpbmUgaWNoIChpbnB1dF9yZWMuRXZl
bnQuS2V5RXZlbnQudUNoYXIuQXNjaWlDaGFyKQogI2RlZmluZSB3Y2ggKGlu
cHV0X3JlYy5FdmVudC5LZXlFdmVudC51Q2hhci5Vbmljb2RlQ2hhcikKIAot
ICAgICAgLyogY2hlY2sgaWYgd2UncmUganVzdCBkaXNwb3Npbmcgb2YgdGhp
cyBvbmUgKi8KLQotICAgICAgaWYgKGlucHV0X3JlYy5FdmVudFR5cGUgPT0g
V0lORE9XX0JVRkZFUl9TSVpFX0VWRU5UKQotCXsKLQkgIGtpbGxfcGdycCAo
dGMtPmdldHBnaWQgKCksIFNJR1dJTkNIKTsKLQkgIGNvbnRpbnVlOwotCX0K
LSAgICAgIGlmIChpbnB1dF9yZWMuRXZlbnRUeXBlICE9IEtFWV9FVkVOVCB8
fAotCSAgIWlucHV0X3JlYy5FdmVudC5LZXlFdmVudC5iS2V5RG93bikKLQlj
b250aW51ZTsKLQotICAgICAgaWYgKHdjaCA9PSAwIHx8Ci0JICAvKiBhcnJv
dy9mdW5jdGlvbiBrZXlzICovCi0JICAoaW5wdXRfcmVjLkV2ZW50LktleUV2
ZW50LmR3Q29udHJvbEtleVN0YXRlICYgRU5IQU5DRURfS0VZKSkKLQl7Ci0J
ICB0b2FkZCA9IGdldF9ub25hc2NpaV9rZXkgKGlucHV0X3JlYywgdG1wKTsK
LQkgIGlmICghdG9hZGQpCi0JICAgIGNvbnRpbnVlOwotCSAgbnJlYWQgPSBz
dHJsZW4gKHRvYWRkKTsKLQl9Ci0gICAgICBlbHNlCi0JewotCSAgdG1wWzFd
ID0gaWNoOwotCSAgLyogTmVlZCB0aGlzIGNoZWNrIHNpbmNlIFVTIGNvZGUg
cGFnZSBzZWVtcyB0byBoYXZlIGEgYnVnIHdoZW4KLQkgICAgIGNvbnZlcnRp
bmcgYSBDVFJMLVUuICovCi0JICBpZiAoKHVuc2lnbmVkIGNoYXIpaWNoID4g
MHg3ZikKLQkgICAgT2VtVG9DaGFyQnVmZiAodG1wICsgMSwgdG1wICsgMSwg
MSk7Ci0JICBpZiAoIShpbnB1dF9yZWMuRXZlbnQuS2V5RXZlbnQuZHdDb250
cm9sS2V5U3RhdGUgJiBMRUZUX0FMVF9QUkVTU0VEKSkKLQkgICAgdG9hZGQg
PSB0bXAgKyAxOworCSAgaWYgKHdjaCA9PSAwIHx8CisJICAgICAgLyogYXJy
b3cvZnVuY3Rpb24ga2V5cyAqLworCSAgICAgIChpbnB1dF9yZWMuRXZlbnQu
S2V5RXZlbnQuZHdDb250cm9sS2V5U3RhdGUgJiBFTkhBTkNFRF9LRVkpKQor
CSAgICB7CisJICAgICAgdG9hZGQgPSBnZXRfbm9uYXNjaWlfa2V5IChpbnB1
dF9yZWMsIHRtcCk7CisJICAgICAgaWYgKCF0b2FkZCkKKwkJY29udGludWU7
CisJICAgICAgbnJlYWQgPSBzdHJsZW4gKHRvYWRkKTsKKwkgICAgfQogCSAg
ZWxzZQogCSAgICB7Ci0JICAgICAgdG1wWzBdID0gJ1wwMzMnOwotCSAgICAg
IHRtcFsxXSA9IGN5Z190b2xvd2VyICh0bXBbMV0pOwotCSAgICAgIHRvYWRk
ID0gdG1wOwotCSAgICAgIG5yZWFkKys7CisJICAgICAgdG1wWzFdID0gaWNo
OworCSAgICAgIC8qIE5lZWQgdGhpcyBjaGVjayBzaW5jZSBVUyBjb2RlIHBh
Z2Ugc2VlbXMgdG8gaGF2ZSBhIGJ1ZyB3aGVuCisJCSBjb252ZXJ0aW5nIGEg
Q1RSTC1VLiAqLworCSAgICAgIGlmICgodW5zaWduZWQgY2hhcilpY2ggPiAw
eDdmKQorCQlPZW1Ub0NoYXJCdWZmICh0bXAgKyAxLCB0bXAgKyAxLCAxKTsK
KwkgICAgICBpZiAoIShpbnB1dF9yZWMuRXZlbnQuS2V5RXZlbnQuZHdDb250
cm9sS2V5U3RhdGUgJiBMRUZUX0FMVF9QUkVTU0VEKSkKKwkJdG9hZGQgPSB0
bXAgKyAxOworCSAgICAgIGVsc2UKKwkJeworCQkgIHRtcFswXSA9ICdcMDMz
JzsKKwkJICB0bXBbMV0gPSBjeWdfdG9sb3dlciAodG1wWzFdKTsKKwkJICB0
b2FkZCA9IHRtcDsKKwkJICBucmVhZCsrOworCQl9CiAJICAgIH0KKyN1bmRl
ZiBpY2gKKyN1bmRlZiB3Y2gKKwkgIGJyZWFrOworCisJY2FzZSBNT1VTRV9F
VkVOVDoKKwkgIHsKKwkgICAgTU9VU0VfRVZFTlRfUkVDT1JEICYgbW91c2Vf
ZXZlbnQgPSBpbnB1dF9yZWMuRXZlbnQuTW91c2VFdmVudDsKKworCSAgICAv
KiBUcmVhdCB0aGUgZG91YmxlLWNsaWNrIGV2ZW50IGxpa2UgYSByZWd1bGFy
IGJ1dHRvbiBwcmVzcyAqLworCSAgICBpZiAobW91c2VfZXZlbnQuZHdFdmVu
dEZsYWdzID09IERPVUJMRV9DTElDSykKKwkgICAgICB7CisJCXN5c2NhbGxf
cHJpbnRmKCJtb3VzZTogZG91YmxlLWNsaWNrIC0+IGNsaWNrIik7CisJCW1v
dXNlX2V2ZW50LmR3RXZlbnRGbGFncyA9IDA7CisJICAgICAgfQorCisJICAg
IC8qIERpZCBzb21ldGhpbmcgb3RoZXIgdGhhbiBhIGNsaWNrIG9jY3VyPyAq
LworCSAgICBpZiAobW91c2VfZXZlbnQuZHdFdmVudEZsYWdzKQorCSAgICAg
IGNvbnRpbnVlOworCisJICAgIC8qIElmIHRoZSBtb3VzZSBldmVudCBvY2N1
cnJlZCBvdXQgb2YgdGhlIGFyZWEgd2UgY2FuIGhhbmRsZSwKKwkgICAgICAg
aWdub3JlIGl0LiAqLworCSAgICBpbnQgeCA9IG1vdXNlX2V2ZW50LmR3TW91
c2VQb3NpdGlvbi5YOworCSAgICBpbnQgeSA9IG1vdXNlX2V2ZW50LmR3TW91
c2VQb3NpdGlvbi5ZOworCSAgICBpZiAoKHggKyAnICcgKyAxID4gMHhGRikg
fHwgKHkgKyAnICcgKyAxID4gMHhGRikpCisJICAgICAgeworCQlzeXNjYWxs
X3ByaW50ZigibW91c2U6IHBvc2l0aW9uIG91dCBvZiByYW5nZSIpOworCQlj
b250aW51ZTsKKwkgICAgICB9CisKKwkgICAgLyogSWdub3JlIHVuaW1wb3J0
YW50IG1vdXNlIGJ1dHRvbnMgKi8KKwkgICAgbW91c2VfZXZlbnQuZHdCdXR0
b25TdGF0ZSAmPSAweDc7CisKKwkgICAgLyogVGhpcyBjb2RlIGFzc3VtZXMg
V2luZG93cyBuZXZlciByZXBvcnRzIG11bHRpcGxlIGJ1dHRvbgorCSAgICAg
ICBldmVudHMgYXQgdGhlIHNhbWUgdGltZS4gKi8KKwkgICAgc3RhdGljIERX
T1JEIGR3TGFzdEJ1dHRvblN0YXRlID0gMDsKKwkgICAgaW50IGIgPSAwOwor
CSAgICBjaGFyIHN6WzMyXTsKKwkgICAgaWYgKG1vdXNlX2V2ZW50LmR3QnV0
dG9uU3RhdGUgPT0gZHdMYXN0QnV0dG9uU3RhdGUpCisJICAgICAgeworCQlz
eXNjYWxsX3ByaW50ZigibW91c2U6IGJ1dHRvbiBzdGF0ZSB1bmNoYW5nZWQi
KTsKKwkJY29udGludWU7CisJICAgICAgfQorCSAgICBlbHNlIGlmIChtb3Vz
ZV9ldmVudC5kd0J1dHRvblN0YXRlIDwgZHdMYXN0QnV0dG9uU3RhdGUpCisJ
ICAgICAgeworCQliID0gMzsKKwkJc3RyY3B5KHN6LCAiYnRuIHVwIik7CisJ
ICAgICAgfQorCSAgICBlbHNlIGlmICgobW91c2VfZXZlbnQuZHdCdXR0b25T
dGF0ZSAmIDEpICE9IChkd0xhc3RCdXR0b25TdGF0ZSAmIDEpKQorCSAgICAg
IHsKKwkJYiA9IDA7CisJCXN0cmNweShzeiwgImJ0bjEgZG93biIpOworCSAg
ICAgIH0KKwkgICAgZWxzZSBpZiAoKG1vdXNlX2V2ZW50LmR3QnV0dG9uU3Rh
dGUgJiAyKSAhPSAoZHdMYXN0QnV0dG9uU3RhdGUgJiAyKSkKKwkgICAgICB7
CisJCWIgPSAxOworCQlzdHJjcHkoc3osICJidG4yIGRvd24iKTsKKwkgICAg
ICB9CisJICAgIGVsc2UgaWYgKChtb3VzZV9ldmVudC5kd0J1dHRvblN0YXRl
ICYgNCkgIT0gKGR3TGFzdEJ1dHRvblN0YXRlICYgNCkpCisJICAgICAgewor
CQliID0gMjsKKwkJc3RyY3B5KHN6LCAiYnRuMyBkb3duIik7CisJICAgICAg
fQorCisJICAgIC8qIFJlbWVtYmVyIHRoZSBjdXJyZW50IGJ1dHRvbiBzdGF0
ZSAqLworCSAgICBkd0xhc3RCdXR0b25TdGF0ZSA9IG1vdXNlX2V2ZW50LmR3
QnV0dG9uU3RhdGU7CisKKwkgICAgc3RhdGljIGludCBuTW9kaWZpZXJzID0g
MDsKKwkgICAgLyogSWYgYSBidXR0b24gd2FzIHByZXNzZWQsIHJlbWVtYmVy
IHRoZSBtb2RpZmllcnMgKi8KKwkgICAgaWYgKGIgIT0gMykKKwkgICAgICB7
CisJCW5Nb2RpZmllcnMgPSAwOworCQlpZiAobW91c2VfZXZlbnQuZHdDb250
cm9sS2V5U3RhdGUgJiBTSElGVF9QUkVTU0VEKQorCQkgIG5Nb2RpZmllcnMg
fD0gMHg0OworCQlpZiAobW91c2VfZXZlbnQuZHdDb250cm9sS2V5U3RhdGUg
JiAoUklHSFRfQUxUX1BSRVNTRUR8TEVGVF9BTFRfUFJFU1NFRCkpCisJCSAg
bk1vZGlmaWVycyB8PSAweDg7CisJCWlmIChtb3VzZV9ldmVudC5kd0NvbnRy
b2xLZXlTdGF0ZSAmIChSSUdIVF9DVFJMX1BSRVNTRUR8TEVGVF9DVFJMX1BS
RVNTRUQpKQorCQkgIG5Nb2RpZmllcnMgfD0gMHgxMDsKKwkgICAgICB9CisK
KwkgICAgYiB8PSBuTW9kaWZpZXJzOworCisJICAgIC8qIFdlIGNhbiBub3cg
Y3JlYXRlIHRoZSBjb2RlLiAqLworCSAgICBzcHJpbnRmKHRtcCwgIlwwMzNb
TSVjJWMlYyIsIGIgKyAnICcsIHggKyAnICcgKyAxLCB5ICsgJyAnICsgMSk7
CisJICAgIHN5c2NhbGxfcHJpbnRmKCJtb3VzZTogJXMgYXQgKCVkLCVkKSIs
IHN6LCB4LCB5KTsKKwkgIH0KKwkgIGJyZWFrOworCisJY2FzZSBXSU5ET1df
QlVGRkVSX1NJWkVfRVZFTlQ6CisJICBraWxsX3BncnAgKHRjLT5nZXRwZ2lk
ICgpLCBTSUdXSU5DSCk7CisJICBjb250aW51ZTsKKworCWRlZmF1bHQ6CisJ
ICBjb250aW51ZTsKIAl9CiAKICAgICAgIGlmIChsaW5lX2VkaXQgKHRvYWRk
LCBucmVhZCkpCiAJYnJlYWs7Ci0jdW5kZWYgaWNoCiAgICAgfQogCiAgIHdo
aWxlIChidWZsZW4pCkBAIC0zODIsNyArNDcxLDcgQEAgZmhhbmRsZXJfY29u
c29sZTo6b3BlbiAoY29uc3QgY2hhciAqLCBpbgogICBpZiAoR2V0Q29uc29s
ZU1vZGUgKGdldF9pb19oYW5kbGUgKCksICZjZmxhZ3MpKQogICAgIHsKICAg
ICAgIGNmbGFncyB8PSBFTkFCTEVfUFJPQ0VTU0VEX0lOUFVUOwotICAgICAg
U2V0Q29uc29sZU1vZGUgKGdldF9pb19oYW5kbGUgKCksIEVOQUJMRV9XSU5E
T1dfSU5QVVQgfCBjZmxhZ3MpOworICAgICAgU2V0Q29uc29sZU1vZGUgKGdl
dF9pb19oYW5kbGUgKCksIEVOQUJMRV9XSU5ET1dfSU5QVVQgfCBFTkFCTEVf
TU9VU0VfSU5QVVQgfCBjZmxhZ3MpOwogICAgIH0KIAogICBUVFlDTEVBUkYg
KFJTVENPTlMpOwpAQCAtNTQ1LDcgKzYzNCw3IEBAIGZoYW5kbGVyX2NvbnNv
bGU6OmlucHV0X3Rjc2V0YXR0ciAoaW50LCAKICAgICAgIHRjLT50aS5jX2xm
bGFnID0gMDsKICAgICB9CiAKLSAgZmxhZ3MgfD0gRU5BQkxFX1dJTkRPV19J
TlBVVDsKKyAgZmxhZ3MgfD0gRU5BQkxFX1dJTkRPV19JTlBVVCB8IEVOQUJM
RV9NT1VTRV9JTlBVVDsKIAogICBpbnQgcmVzOwogICBpZiAoZmxhZ3MgPT0g
b2ZsYWdzKQo=

------------=_1583532846-65437-19
Content-Type: text/x-diff; charset=us-ascii; name="select.cc.diff"
Content-Disposition: inline; filename="select.cc.diff"
Content-Transfer-Encoding: base64
Content-Length: 846

LS0tIHNlbGVjdC5jYy5vcmlnCVRodSBOb3YgIDkgMDk6MDQ6NTMgMjAwMAor
Kysgc2VsZWN0LmNjCVRodSBOb3YgMzAgMTY6MDk6MzAgMjAwMApAQCAtNjM1
LDYgKzYzNSwxMCBAQCBwZWVrX2NvbnNvbGUgKHNlbGVjdF9yZWNvcmQgKm1l
LCBpbnQgaWduCiAgICAgICB7CiAJaWYgKGlyZWMuRXZlbnRUeXBlID09IFdJ
TkRPV19CVUZGRVJfU0laRV9FVkVOVCkKIAkgIGtpbGxfcGdycCAoZmgtPnRj
LT5nZXRwZ2lkICgpLCBTSUdXSU5DSCk7CisJZWxzZSBpZiAoaXJlYy5FdmVu
dFR5cGUgPT0gTU9VU0VfRVZFTlQgJiYKKwkJIChpcmVjLkV2ZW50Lk1vdXNl
RXZlbnQuZHdFdmVudEZsYWdzID09IDAgfHwKKwkJICBpcmVjLkV2ZW50Lk1v
dXNlRXZlbnQuZHdFdmVudEZsYWdzID09IERPVUJMRV9DTElDSykpCisJICBy
ZXR1cm4gbWUtPnJlYWRfcmVhZHkgPSAxOwogCWVsc2UgaWYgKGlyZWMuRXZl
bnRUeXBlID09IEtFWV9FVkVOVCAmJiBpcmVjLkV2ZW50LktleUV2ZW50LmJL
ZXlEb3duID09IFRSVUUgJiYKIAkJIChpcmVjLkV2ZW50LktleUV2ZW50LnVD
aGFyLkFzY2lpQ2hhciB8fCBnZXRfbm9uYXNjaWlfa2V5IChpcmVjLCB0bXBi
dWYpKSkKIAkgIHJldHVybiBtZS0+cmVhZF9yZWFkeSA9IDE7Cg==

------------=_1583532846-65437-19--
