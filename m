From: Egor Duda <deo@logos-m.ru>
To: cygwin-patches@sourceware.cygnus.com
Subject: cfree from newlib is linked instead of "cygheap" cfree
Date: Wed, 06 Sep 2000 10:32:00 -0000
Message-id: <178102785918.20000906213200@logos-m.ru>
X-SW-Source: 2000-q3/msg00068.html
Content-type: multipart/mixed; boundary="----------=_1583532846-65437-9"

This is a multi-part message in MIME format...

------------=_1583532846-65437-9
Content-length: 388

Hi!

  class  child_info  uses cfree in it's destructor, assuming this will
be  cfree  for  cygheap. Nevertheless, in spawn.cc compiler uses cfree
from  newlib,  when ciresrv variable in  spawn_guts  get  freed. this,
obviously, causes crash. how about this patch? 

Egor.            mailto:deo@logos-m.ru ICQ 5165414 FidoNet 2:5020/496.19
cfree-ambiguity.diff
cfree-ambiguity.ChangeLog


------------=_1583532846-65437-9
Content-Type: text/plain; charset=us-ascii; name="cfree-ambiguity.ChangeLog"
Content-Disposition: inline; filename="cfree-ambiguity.ChangeLog"
Content-Transfer-Encoding: base64
Content-Length: 834

MjAwMC0wOS0wNiAgRWdvciBEdWRhICA8ZGVvQGxvZ29zLW0ucnU+CgoJKiBj
eWdoZWFwLmg6IFJlbmFtZSBjZnJlZSB0byBjeWdoZWFwX2ZyZWUgdG8gcHJl
dmVudAoJY29sbGlzaW9uIHdpdGggbmV3bGliJ3MgY2ZyZWUuCgkqIGN5Z2hl
YXAuY2M6IERpdHRvLgoJKiBjaGlsZF9pbmZvIChjaGlsZF9pbmZvX3NwYXdu
Ojp+Y2hpbGRfaW5mb19zcGF3bik6IERpdHRvLgoJKiBkY3J0MC5jYyAoZGxs
X2NydDBfMSk6IERpdHRvLgoJKiBkdGFiZS5jYyAoZHRhYmxlOjpleHRlbmQp
OiBEaXR0by4KCShkdGFibGU6OmR1cF93b3JrZXIpOiBEaXR0by4KCSogZW52
aXJvbi5jYyAoZW52aXJvbl9pbml0KTogRGl0dG8uCgkqIGZoYW5kbGVyLmNj
IChmaGFuZGxlcl9iYXNlOjpzZXRfbmFtZSk6IERpdHRvLgoJKGZoYW5kbGVy
X2Jhc2U6Om9wZXJhdG9yIGRlbGV0ZSk6IERpdHRvLgoJKGZoYW5kbGVyX2Jh
c2U6On5maGFuZGxlcl9iYXNlKTogRGl0dG8uCgkqIGZoYW5kbGVyX3Jhdy5j
YyAoZmhhbmRsZXJfZGV2X3Jhdzo6fmZoYW5kbGVyX2Rldl9yYXcpOiBEaXR0
by4KCShmaGFuZGxlcl9kZXZfcmF3Ojppb2N0bCk6IERpdHRvLgoJKiBzcGF3
bi5jYyAoc3RydWN0IGF2Ojp+YXYpOiBEaXR0by4K

------------=_1583532846-65437-9
Content-Type: text/x-diff; charset=us-ascii; name="cfree-ambiguity.diff"
Content-Disposition: inline; filename="cfree-ambiguity.diff"
Content-Transfer-Encoding: base64
Content-Length: 8703

SW5kZXg6IHdpbnN1cC9jeWd3aW4vY2hpbGRfaW5mby5oCj09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT0KUkNTIGZpbGU6IC9jdnMvc3JjL3NyYy93aW5zdXAvY3ln
d2luL2NoaWxkX2luZm8uaCx2CnJldHJpZXZpbmcgcmV2aXNpb24gMS4yCmRp
ZmYgLXUgLXIxLjIgY2hpbGRfaW5mby5oCi0tLSBjaGlsZF9pbmZvLmgJMjAw
MC8wOS8wMyAwNDoxNjozNQkxLjIKKysrIGNoaWxkX2luZm8uaAkyMDAwLzA5
LzA2IDE3OjE1OjI1CkBAIC04NCwxNSArODQsMTUgQEAKICAgICBpZiAobW9y
ZWluZm8pCiAgICAgICB7CiAJaWYgKG1vcmVpbmZvLT5vbGRfdGl0bGUpCi0J
ICBjZnJlZSAobW9yZWluZm8tPm9sZF90aXRsZSk7CisJICBjeWdoZWFwX2Zy
ZWUgKG1vcmVpbmZvLT5vbGRfdGl0bGUpOwogCWlmIChtb3JlaW5mby0+ZW52
aXJvbikKIAkgIHsKIAkgICAgZm9yIChjaGFyICoqZSA9IG1vcmVpbmZvLT5l
bnZpcm9uOyAqZTsgZSsrKQotCSAgICAgIGNmcmVlICgqZSk7Ci0JICAgIGNm
cmVlIChtb3JlaW5mby0+ZW52aXJvbik7CisJICAgICAgY3lnaGVhcF9mcmVl
ICgqZSk7CisJICAgIGN5Z2hlYXBfZnJlZSAobW9yZWluZm8tPmVudmlyb24p
OwogCSAgfQogCUNsb3NlSGFuZGxlIChtb3JlaW5mby0+bXlzZWxmX3BpbmZv
KTsKLQljZnJlZSAobW9yZWluZm8pOworCWN5Z2hlYXBfZnJlZSAobW9yZWlu
Zm8pOwogICAgICAgfQogICB9CiB9OwpJbmRleDogd2luc3VwL2N5Z3dpbi9j
eWdoZWFwLmNjCj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KUkNTIGZpbGU6IC9j
dnMvc3JjL3NyYy93aW5zdXAvY3lnd2luL2N5Z2hlYXAuY2MsdgpyZXRyaWV2
aW5nIHJldmlzaW9uIDEuMgpkaWZmIC11IC1yMS4yIGN5Z2hlYXAuY2MKLS0t
IGN5Z2hlYXAuY2MJMjAwMC8wOS8wNSAwMzoxNjoyOAkxLjIKKysrIGN5Z2hl
YXAuY2MJMjAwMC8wOS8wNiAxNzoxNToyNQpAQCAtMjA4LDcgKzIwOCw3IEBA
CiB9CiAKIGV4dGVybiAiQyIgdm9pZCBfX3N0ZGNhbGwKLWNmcmVlICh2b2lk
ICpzKQorY3lnaGVhcF9mcmVlICh2b2lkICpzKQogewogICBhc3NlcnQgKCFp
bmhlYXAgKHMpKTsKICAgKHZvaWQpIF9jZnJlZSAodG9jeWdoZWFwIChzKSk7
CkluZGV4OiB3aW5zdXAvY3lnd2luL2N5Z2hlYXAuaAo9PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09ClJDUyBmaWxlOiAvY3ZzL3NyYy9zcmMvd2luc3VwL2N5Z3dp
bi9jeWdoZWFwLmgsdgpyZXRyaWV2aW5nIHJldmlzaW9uIDEuMQpkaWZmIC11
IC1yMS4xIGN5Z2hlYXAuaAotLS0gY3lnaGVhcC5oCTIwMDAvMDkvMDMgMDQ6
MTY6MzUJMS4xCisrKyBjeWdoZWFwLmgJMjAwMC8wOS8wNiAxNzoxNToyNQpA
QCAtOCw4ICs4LDYgQEAKIEN5Z3dpbiBsaWNlbnNlLiAgUGxlYXNlIGNvbnN1
bHQgdGhlIGZpbGUgIkNZR1dJTl9MSUNFTlNFIiBmb3IKIGRldGFpbHMuICov
CiAKLSN1bmRlZiBjZnJlZQotCiBlbnVtIGN5Z2hlYXBfdHlwZXMKIHsKICAg
SEVBUF9GSEFORExFUiwKQEAgLTI4LDcgKzI2LDcgQEAKIAogdm9pZCBjeWdo
ZWFwX2luaXQgKCk7CiBleHRlcm4gIkMiIHsKLXZvaWQgX19zdGRjYWxsIGNm
cmVlICh2b2lkICopOwordm9pZCBfX3N0ZGNhbGwgY3lnaGVhcF9mcmVlICh2
b2lkICopOwogdm9pZCBfX3N0ZGNhbGwgY3lnaGVhcF9maXh1cF9pbl9jaGls
ZCAoSEFORExFKTsKIHZvaWQgKl9fc3RkY2FsbCBjbWFsbG9jIChjeWdoZWFw
X3R5cGVzLCBEV09SRCk7CiB2b2lkICpfX3N0ZGNhbGwgY3JlYWxsb2MgKHZv
aWQgKiwgRFdPUkQpOwpJbmRleDogd2luc3VwL2N5Z3dpbi9kY3J0MC5jYwo9
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09ClJDUyBmaWxlOiAvY3ZzL3NyYy9zcmMv
d2luc3VwL2N5Z3dpbi9kY3J0MC5jYyx2CnJldHJpZXZpbmcgcmV2aXNpb24g
MS41MgpkaWZmIC11IC1yMS41MiBkY3J0MC5jYwotLS0gZGNydDAuY2MJMjAw
MC8wOS8wNSAwMzoxNjoyOAkxLjUyCisrKyBkY3J0MC5jYwkyMDAwLzA5LzA2
IDE3OjE1OjI2CkBAIC02ODAsNyArNjgwLDcgQEAKIAkgICAgaWYgKHNwYXdu
X2luZm8tPm1vcmVpbmZvLT5vbGRfdGl0bGUpCiAJICAgICAgewogCQlvbGRf
dGl0bGUgPSBzdHJjcHkgKHRpdGxlX2J1Ziwgc3Bhd25faW5mby0+bW9yZWlu
Zm8tPm9sZF90aXRsZSk7Ci0JCWNmcmVlIChzcGF3bl9pbmZvLT5tb3JlaW5m
by0+b2xkX3RpdGxlKTsKKwkJY3lnaGVhcF9mcmVlIChzcGF3bl9pbmZvLT5t
b3JlaW5mby0+b2xkX3RpdGxlKTsKIAkgICAgICB9CiAJICAgIFByb3RlY3RI
YW5kbGUgKGNoaWxkX3Byb2NfaW5mby0+c3VicHJvY19yZWFkeSk7CiAJICAg
IGJyZWFrOwpJbmRleDogd2luc3VwL2N5Z3dpbi9kdGFibGUuY2MKPT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PQpSQ1MgZmlsZTogL2N2cy9zcmMvc3JjL3dpbnN1
cC9jeWd3aW4vZHRhYmxlLmNjLHYKcmV0cmlldmluZyByZXZpc2lvbiAxLjE5
CmRpZmYgLXUgLXIxLjE5IGR0YWJsZS5jYwotLS0gZHRhYmxlLmNjCTIwMDAv
MDkvMDMgMDQ6MTY6MzUJMS4xOQorKysgZHRhYmxlLmNjCTIwMDAvMDkvMDYg
MTc6MTU6MjYKQEAgLTcxLDcgKzcxLDcgQEAKICAgaWYgKGZkcykKICAgICB7
CiAgICAgICBtZW1jcHkgKG5ld2ZkcywgZmRzLCBzaXplICogc2l6ZW9mIChm
ZHNbMF0pKTsKLSAgICAgIGNmcmVlIChmZHMpOworICAgICAgY3lnaGVhcF9m
cmVlIChmZHMpOwogICAgIH0KIAogICBzaXplID0gbmV3X3NpemU7CkBAIC0z
MTMsNyArMzEzLDcgQEAKICAgbmV3ZmgtPnNldF9pb19oYW5kbGUgKE5VTEwp
OwogICBpZiAob2xkZmgtPmR1cCAobmV3ZmgpKQogICAgIHsKLSAgICAgIGNm
cmVlIChuZXdmaCk7CisgICAgICBjeWdoZWFwX2ZyZWUgKG5ld2ZoKTsKICAg
ICAgIG5ld2ZoID0gTlVMTDsKICAgICAgIHJldHVybiBOVUxMOwogICAgIH0K
QEAgLTUwNCw3ICs1MDQsNyBAQAogICBmaGFuZGxlcl9iYXNlICoqZGVsZXRl
bWUgPSBmZHM7CiAgIGZkcyA9IGZkc19vbl9ob2xkOwogICBmZHNfb25faG9s
ZCA9IE5VTEw7Ci0gIGNmcmVlIChkZWxldGVtZSk7CisgIGN5Z2hlYXBfZnJl
ZSAoZGVsZXRlbWUpOwogCiAgIFJlbGVhc2VSZXNvdXJjZUxvY2soTE9DS19G
RF9MSVNULFdSSVRFX0xPQ0t8UkVBRF9MT0NLLCJkdXAiKTsKICAgcmV0dXJu
OwpJbmRleDogd2luc3VwL2N5Z3dpbi9lbnZpcm9uLmNjCj09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT0KUkNTIGZpbGU6IC9jdnMvc3JjL3NyYy93aW5zdXAvY3ln
d2luL2Vudmlyb24uY2MsdgpyZXRyaWV2aW5nIHJldmlzaW9uIDEuMjUKZGlm
ZiAtdSAtcjEuMjUgZW52aXJvbi5jYwotLS0gZW52aXJvbi5jYwkyMDAwLzA5
LzAzIDA0OjQ1OjUyCTEuMjUKKysrIGVudmlyb24uY2MJMjAwMC8wOS8wNiAx
NzoxNToyNgpAQCAtNTM3LDcgKzUzNyw3IEBACiAgICAgICBzeiA9IGVudnNp
emUgKGVudnAsIDEpOwogICAgICAgY2hhciAqKm5ld2VudiA9IChjaGFyICoq
KSBtYWxsb2MgKHN6KTsKICAgICAgIG1lbWNweSAobmV3ZW52LCBlbnZwLCBz
eik7Ci0gICAgICBjZnJlZSAoZW52cCk7CisgICAgICBjeWdoZWFwX2ZyZWUg
KGVudnApOwogICAgICAgZW52cCA9IG5ld2VudjsKICAgICAgIGdvdG8gb3V0
OwogICAgIH0KSW5kZXg6IHdpbnN1cC9jeWd3aW4vZmhhbmRsZXIuY2MKPT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PQpSQ1MgZmlsZTogL2N2cy9zcmMvc3JjL3dp
bnN1cC9jeWd3aW4vZmhhbmRsZXIuY2MsdgpyZXRyaWV2aW5nIHJldmlzaW9u
IDEuMzIKZGlmZiAtdSAtcjEuMzIgZmhhbmRsZXIuY2MKLS0tIGZoYW5kbGVy
LmNjCTIwMDAvMDkvMDMgMDQ6MTY6MzUJMS4zMgorKysgZmhhbmRsZXIuY2MJ
MjAwMC8wOS8wNiAxNzoxNToyNwpAQCAtMTUyLDkgKzE1Miw5IEBACiAgIGlm
ICghbm9fZnJlZV9uYW1lcyAoKSkKICAgICB7CiAgICAgICBpZiAodW5peF9w
YXRoX25hbWVfICE9IE5VTEwgJiYgdW5peF9wYXRoX25hbWVfICE9IGZoYW5k
bGVyX2Rpc2tfZHVtbXlfbmFtZSkKLQljZnJlZSAodW5peF9wYXRoX25hbWVf
KTsKKwljeWdoZWFwX2ZyZWUgKHVuaXhfcGF0aF9uYW1lXyk7CiAgICAgICBp
ZiAod2luMzJfcGF0aF9uYW1lXyAhPSBOVUxMICYmIHVuaXhfcGF0aF9uYW1l
XyAhPSBmaGFuZGxlcl9kaXNrX2R1bW15X25hbWUpCi0JY2ZyZWUgKHdpbjMy
X3BhdGhfbmFtZV8pOworCWN5Z2hlYXBfZnJlZSAod2luMzJfcGF0aF9uYW1l
Xyk7CiAgICAgfQogCiAgIHVuaXhfcGF0aF9uYW1lXyA9IHdpbjMyX3BhdGhf
bmFtZV8gPSBOVUxMOwpAQCAtMTExMSw3ICsxMTExLDcgQEAKIHZvaWQKIGZo
YW5kbGVyX2Jhc2U6Om9wZXJhdG9yIGRlbGV0ZSAodm9pZCAqcCkKIHsKLSAg
Y2ZyZWUgKHApOworICBjeWdoZWFwX2ZyZWUgKHApOwogICByZXR1cm47CiB9
CiAKQEAgLTExNDgsOSArMTE0OCw5IEBACiAgIGlmICghbm9fZnJlZV9uYW1l
cyAoKSkKICAgICB7CiAgICAgICBpZiAodW5peF9wYXRoX25hbWVfICE9IE5V
TEwgJiYgdW5peF9wYXRoX25hbWVfICE9IGZoYW5kbGVyX2Rpc2tfZHVtbXlf
bmFtZSkKLQljZnJlZSAodW5peF9wYXRoX25hbWVfKTsKKwljeWdoZWFwX2Zy
ZWUgKHVuaXhfcGF0aF9uYW1lXyk7CiAgICAgICBpZiAod2luMzJfcGF0aF9u
YW1lXyAhPSBOVUxMICYmIHdpbjMyX3BhdGhfbmFtZV8gIT0gZmhhbmRsZXJf
ZGlza19kdW1teV9uYW1lKQotCWNmcmVlICh3aW4zMl9wYXRoX25hbWVfKTsK
KwljeWdoZWFwX2ZyZWUgKHdpbjMyX3BhdGhfbmFtZV8pOwogICAgIH0KICAg
aWYgKHJhYnVmKQogICAgIGZyZWUgKHJhYnVmKTsKSW5kZXg6IHdpbnN1cC9j
eWd3aW4vZmhhbmRsZXJfcmF3LmNjCj09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0K
UkNTIGZpbGU6IC9jdnMvc3JjL3NyYy93aW5zdXAvY3lnd2luL2ZoYW5kbGVy
X3Jhdy5jYyx2CnJldHJpZXZpbmcgcmV2aXNpb24gMS44CmRpZmYgLXUgLXIx
LjggZmhhbmRsZXJfcmF3LmNjCi0tLSBmaGFuZGxlcl9yYXcuY2MJMjAwMC8w
OS8wMyAwNDoxNjozNQkxLjgKKysrIGZoYW5kbGVyX3Jhdy5jYwkyMDAwLzA5
LzA2IDE3OjE1OjI3CkBAIC0xMjIsNyArMTIyLDcgQEAKIGZoYW5kbGVyX2Rl
dl9yYXc6On5maGFuZGxlcl9kZXZfcmF3ICh2b2lkKQogewogICBpZiAoZGV2
YnVmc2l6ID49IDFMKQotICAgIGNmcmVlIChkZXZidWYpOworICAgIGN5Z2hl
YXBfZnJlZSAoZGV2YnVmKTsKICAgY2xlYXIgKCk7CiB9CiAKQEAgLTQ5Myw3
ICs0OTMsNyBAQAogCQkgIHsKIAkJICAgIG1lbWNweSAoYnVmLCBkZXZidWYg
KyBkZXZidWZzdGFydCwgZGV2YnVmZW5kIC0gZGV2YnVmc3RhcnQpOwogCQkg
ICAgZGV2YnVmZW5kIC09IGRldmJ1ZnN0YXJ0OwotCQkgICAgY2ZyZWUgKGRl
dmJ1Zik7CisJCSAgICBjeWdoZWFwX2ZyZWUgKGRldmJ1Zik7CiAJCSAgfQog
CQllbHNlCiAJCSAgZGV2YnVmZW5kID0gMDsKSW5kZXg6IHdpbnN1cC9jeWd3
aW4vc3Bhd24uY2MKPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpSQ1MgZmlsZTog
L2N2cy9zcmMvc3JjL3dpbnN1cC9jeWd3aW4vc3Bhd24uY2MsdgpyZXRyaWV2
aW5nIHJldmlzaW9uIDEuMzYKZGlmZiAtdSAtcjEuMzYgc3Bhd24uY2MKLS0t
IHNwYXduLmNjCTIwMDAvMDkvMDUgMDM6MTY6MjgJMS4zNgorKysgc3Bhd24u
Y2MJMjAwMC8wOS8wNiAxNzoxNToyNwpAQCAtMjUsOSArMjUsOSBAQAogI2lu
Y2x1ZGUgImR0YWJsZS5oIgogI2luY2x1ZGUgInN5bmMuaCIKICNpbmNsdWRl
ICJzaWdwcm9jLmgiCisjaW5jbHVkZSAiY3lnaGVhcC5oIgogI2luY2x1ZGUg
ImNoaWxkX2luZm8uaCIKICNpbmNsdWRlICJwaW5mby5oIgotI2luY2x1ZGUg
ImN5Z2hlYXAuaCIKICNpbmNsdWRlICJwZXJ0aHJlYWQuaCIKIAogI2RlZmlu
ZSBMSU5FX0JVRl9DSFVOSyAoTUFYX1BBVEggKiAyKQpAQCAtMjU0LDggKzI1
NCw4IEBACiAgIH5hdiAoKQogICB7CiAgICAgZm9yIChpbnQgaSA9IDA7IGkg
PCBjYWxsb2NlZDsgaSsrKQotICAgICAgY2ZyZWUgKGFyZ3ZbaV0pOwotICAg
IGNmcmVlIChhcmd2KTsKKyAgICAgIGN5Z2hlYXBfZnJlZSAoYXJndltpXSk7
CisgICAgY3lnaGVhcF9mcmVlIChhcmd2KTsKICAgfQogICBpbnQgdW5zaGlm
dCAoY29uc3QgY2hhciAqd2hhdCwgaW50IGNvbnYgPSAwKTsKICAgb3BlcmF0
b3IgY2hhciAqKigpIHtyZXR1cm4gYXJndjt9Cg==

------------=_1583532846-65437-9--
