Return-Path: <cygwin-patches-return-5772-listarch-cygwin-patches=sources.redhat.com@cygwin.com>
Received: (qmail 15917 invoked by alias); 22 Feb 2006 18:55:58 -0000
Received: (qmail 15902 invoked by uid 22791); 22 Feb 2006 18:55:56 -0000
X-Spam-Check-By: sourceware.org
Received: from ACCESS1.CIMS.NYU.EDU (HELO access1.cims.nyu.edu) (128.122.81.155)     by sourceware.org (qpsmtpd/0.31) with ESMTP; Wed, 22 Feb 2006 18:55:53 +0000
Received: from localhost (localhost [127.0.0.1]) 	by access1.cims.nyu.edu (8.12.10+Sun/8.12.10) with ESMTP id k1MItpfo004548 	for <cygwin-patches@cygwin.com>; Wed, 22 Feb 2006 13:55:51 -0500 (EST)
Date: Wed, 22 Feb 2006 18:55:00 -0000
From: Igor Peshansky <pechtcha@cs.nyu.edu>
Reply-To: cygwin-patches@cygwin.com
To: cygwin-patches@cygwin.com
Subject: Re: [PATCH] cygcheck: follow symbolic links
In-Reply-To: <Pine.GSO.4.63.0602170900350.1592@access1.cims.nyu.edu>
Message-ID: <Pine.GSO.4.63.0602221335110.4972@access1.cims.nyu.edu>
References: <Pine.GSO.4.63.0602131341020.17217@access1.cims.nyu.edu>   <20060216160637.GQ26541@calimero.vinschen.de> <Pine.GSO.4.63.0602161116540.22053@access1.cims.nyu.edu>   <20060217113100.GT26541@calimero.vinschen.de>  <Pine.GSO.4.63.0602170900350.1592@access1.cims.nyu.edu>
MIME-Version: 1.0
Content-Type: MULTIPART/MIXED; BOUNDARY="-559023410-33463914-1140634551=:4972"
X-IsSubscribed: yes
Mailing-List: contact cygwin-patches-help@cygwin.com; run by ezmlm
Precedence: bulk
List-Subscribe: <mailto:cygwin-patches-subscribe@cygwin.com>
List-Post: <mailto:cygwin-patches@cygwin.com>
List-Archive: <http://sourceware.org/ml/cygwin-patches/>
List-Help: <mailto:cygwin-patches-help@cygwin.com>, <http://sourceware.org/ml/#faqs>
Sender: cygwin-patches-owner@cygwin.com
X-SW-Source: 2006-q1/txt/msg00081.txt.bz2

  This message is in MIME format.  The first part should be readable text,
  while the remaining parts are likely unreadable without MIME-aware tools.

---559023410-33463914-1140634551=:4972
Content-Type: TEXT/PLAIN; charset=US-ASCII
Content-length: 2637

On Fri, 17 Feb 2006, Igor Peshansky wrote:

> On Fri, 17 Feb 2006, Corinna Vinschen wrote:
>
> > On Feb 16 12:26, Igor Peshansky wrote:
> > > On Thu, 16 Feb 2006, Corinna Vinschen wrote:
> > > > - Most of your patch should go into path.cc so it can be reused,
> > > >   for instance in strace.
> > >
> > > Agreed -- that's why I put that TODO in there. :-)  Should I move it
> > > in the next iteration of the patch?
> >
> > Please move it now.  I don't think it's non-trivial enough to justify
> > multiple iterations.
>
> Whoops.  Misspoke.  I meant "incarnation".  Never mind, I'll just do it.
> :-)  Expect a new patch today.

I guess "today" is a stretchable concept. :-)  In any case, here's a new
patch.  Moving things into path.cc turned out to be indeed non-trivial,
since the new functionality was using static functions in cygcheck.cc
which now needed to be moved out into a separate file.  I don't expect
this to be applied right away (hence no ChangeLog), but is this along the
lines of what you were expecting?

> > > > - Couldn't you just reuse the readlink implementation in
> > > >   ../cygwin/path.cc as is, to avoid having to different
> > > >   implementations?
> > >
> > > Umm, most of that code is very general purpose, and has too much
> > > extra stuff in it.  I basically used part of it
> > > (symlink_info::check_shortcut) for my implementation.  I wanted
> > > something lightweight and easy to understand (also, the code in
> > > path.cc doesn't check for PE headers, so I had to write that part
> > > anyway).
> >
> > Well, what I meant isn't readlink but symlink_info::check_shortcut and
> > cmp_shortcut_header.  It would be helpful if the rules to identify a
> > symlink are identical, wouldn't it?  As for the PE headers, that's
> > fine.
>
> It would certainly help, but then we would need to extract the bit of
> code that deals with symlinks and put it in a Cygwin-independent static
> library.  See my reply to Dave.

I did copy cmp_shortcut_header, but most of the rest of the code was
judicious cut-and-paste (with some rewriting on the side).  Again, it
wasn't as trivial as you made it sound.
	Igor
-- 
				http://cs.nyu.edu/~pechtcha/
      |\      _,,,---,,_	    pechtcha@cs.nyu.edu | igor@watson.ibm.com
ZZZzz /,`.-'`'    -.  ;-;;,_		Igor Peshansky, Ph.D. (name changed!)
     |,4-  ) )-,_. ,\ (  `'-'		old name: Igor Pechtchanski
    '---''(_/--'  `-'\_) fL	a.k.a JaguaR-R-R-r-r-r-.-.-.  Meow!

"Las! je suis sot... -Mais non, tu ne l'es pas, puisque tu t'en rends compte."
"But no -- you are no fool; you call yourself a fool, there's proof enough in
that!" -- Rostand, "Cyrano de Bergerac"
---559023410-33463914-1140634551=:4972
Content-Type: TEXT/PLAIN; charset=US-ASCII; name=cygcheck-follow-symlinks.patch
Content-Transfer-Encoding: BASE64
Content-ID: <Pine.GSO.4.63.0602221355510.4972@access1.cims.nyu.edu>
Content-Description: 
Content-Disposition: attachment; filename=cygcheck-follow-symlinks.patch
Content-length: 25661

SW5kZXg6IE1ha2VmaWxlLmluDQo9PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQpS
Q1MgZmlsZTogL2N2cy9zcmMvc3JjL3dpbnN1cC91dGlscy9NYWtlZmlsZS5p
bix2DQpyZXRyaWV2aW5nIHJldmlzaW9uIDEuNjINCmRpZmYgLXUgLXAgLXIx
LjYyIE1ha2VmaWxlLmluDQotLS0gTWFrZWZpbGUuaW4JMTggSmFuIDIwMDYg
MTU6NTc6NTUgLTAwMDAJMS42Mg0KKysrIE1ha2VmaWxlLmluCTIyIEZlYiAy
MDA2IDE4OjQ5OjQyIC0wMDAwDQpAQCAtOTEsMjMgKzkxLDIzIEBAIGVuZGlm
DQogDQogYWxsOiBNYWtlZmlsZSAkKFBST0dTKQ0KIA0KLXN0cmFjZS5leGU6
IHN0cmFjZS5vIHBhdGgubyAkKE1JTkdXX0RFUF9MRExJQlMpDQorc3RyYWNl
LmV4ZTogc3RyYWNlLm8gcGF0aC5vIGZpbGV1dGlsLm8gJChNSU5HV19ERVBf
TERMSUJTKQ0KIGlmZGVmIFZFUkJPU0UNCi0JJChDWFgpICQoTUlOR1dfQ1hY
RkxBR1MpIC1vICRAICR7d29yZGxpc3QgMSwyLCRefSAtQiQobWluZ3dfYnVp
bGQpLyAkKE1JTkdXX0xERkxBR1MpDQorCSQoQ1hYKSAkKE1JTkdXX0NYWEZM
QUdTKSAtbyAkQCAke3dvcmRsaXN0IDEsMywkXn0gLUIkKG1pbmd3X2J1aWxk
KS8gJChNSU5HV19MREZMQUdTKQ0KIGVsc2UNCi0JQGVjaG8gJChDWFgpIC1v
ICRAICR7d29yZGxpc3QgMSwyLCRefSAke2ZpbHRlci1vdXQgLUIlLCAkKE1J
TkdXX0NYWEZMQUdTKSAkKE1JTkdXX0xERkxBR1MpfTtcDQotCSQoQ1hYKSAk
KE1JTkdXX0NYWEZMQUdTKSAtbyAkQCAke3dvcmRsaXN0IDEsMiwkXn0gLUIk
KG1pbmd3X2J1aWxkKS8gJChNSU5HV19MREZMQUdTKQ0KKwlAZWNobyAkKENY
WCkgLW8gJEAgJHt3b3JkbGlzdCAxLDMsJF59ICR7ZmlsdGVyLW91dCAtQiUs
ICQoTUlOR1dfQ1hYRkxBR1MpICQoTUlOR1dfTERGTEFHUyl9O1wNCisJJChD
WFgpICQoTUlOR1dfQ1hYRkxBR1MpIC1vICRAICR7d29yZGxpc3QgMSwzLCRe
fSAtQiQobWluZ3dfYnVpbGQpLyAkKE1JTkdXX0xERkxBR1MpDQogZW5kaWYN
CiANCi1jeWdjaGVjay5leGU6IGN5Z2NoZWNrLm8gcGF0aC5vIGR1bXBfc2V0
dXAubyAkKE1JTkdXX0RFUF9MRExJQlMpDQorY3lnY2hlY2suZXhlOiBjeWdj
aGVjay5vIHBhdGgubyBmaWxldXRpbC5vIGR1bXBfc2V0dXAubyAkKE1JTkdX
X0RFUF9MRExJQlMpDQogaWZlcSAiJChsaWJ6KSIgIiINCiAJQGVjaG8gJyoq
KiBCdWlsZGluZyBjeWdjaGVjayB3aXRob3V0IHBhY2thZ2UgY29udGVudCBj
aGVja2luZyBkdWUgdG8gbWlzc2luZyBtaW5ndyBsaWJ6LmEuJw0KIGVuZGlm
DQogaWZkZWYgVkVSQk9TRQ0KLQkkKENYWCkgJChNSU5HV19DWFhGTEFHUykg
LW8gJEAgJHt3b3JkbGlzdCAxLDMsJF59IC1CJChtaW5nd19idWlsZCkvICQo
TUlOR1dfTERGTEFHUykgJChsaWJ6KQ0KKwkkKENYWCkgJChNSU5HV19DWFhG
TEFHUykgLW8gJEAgJHt3b3JkbGlzdCAxLDQsJF59IC1CJChtaW5nd19idWls
ZCkvICQoTUlOR1dfTERGTEFHUykgJChsaWJ6KQ0KIGVsc2UNCi0JQGVjaG8g
JChDWFgpIC1vICRAICR7d29yZGxpc3QgMSwzLCRefSAke2ZpbHRlci1vdXQg
LUIlLCAkKE1JTkdXX0NYWEZMQUdTKSAkKE1JTkdXX0xERkxBR1MpfSAkKGxp
YnopO1wNCi0JJChDWFgpICQoTUlOR1dfQ1hYRkxBR1MpIC1vICRAICR7d29y
ZGxpc3QgMSwzLCRefSAtQiQobWluZ3dfYnVpbGQpLyAkKE1JTkdXX0xERkxB
R1MpICQobGlieikNCisJQGVjaG8gJChDWFgpIC1vICRAICR7d29yZGxpc3Qg
MSw0LCRefSAke2ZpbHRlci1vdXQgLUIlLCAkKE1JTkdXX0NYWEZMQUdTKSAk
KE1JTkdXX0xERkxBR1MpfSAkKGxpYnopO1wNCisJJChDWFgpICQoTUlOR1df
Q1hYRkxBR1MpIC1vICRAICR7d29yZGxpc3QgMSw0LCRefSAtQiQobWluZ3df
YnVpbGQpLyAkKE1JTkdXX0xERkxBR1MpICQobGlieikNCiBlbmRpZg0KIA0K
IGR1bXBlci5vOiBkdW1wZXIuY2MgZHVtcGVyLmgNCkBAIC0xNTAsNiArMTUw
LDE0IEBAIGVsc2UNCiAJJChNSU5HV19DWFgpICQoemNvbmZfaCkgJCh6bGli
X2gpICRjIC1vICQoQEQpLyQoYmFzZW5hbWUgJEApJG8gJChNSU5HV19DWFhG
TEFHUykgJDwNCiBlbmRpZg0KIA0KK2ZpbGV1dGlsLm86IGZpbGV1dGlsLmNj
DQoraWZkZWYgVkVSQk9TRQ0KKwkkKE1JTkdXX0NYWCkgJGMgLW8gJChARCkv
JChiYXNlbmFtZSAkQCkkbyAkKE1JTkdXX0NYWEZMQUdTKSAkPA0KK2Vsc2UN
CisJQGVjaG8gJChNSU5HV19DWFgpICRjIC1vICQoQEQpLyQoYmFzZW5hbWUg
JEApJG8gJChNSU5HV19DWFhGTEFHUykgLi4uICReO1wNCisJJHtNSU5HV19D
WFh9ICRjIC1vICQoQEQpLyQoYmFzZW5hbWUgJEApJG8gJChNSU5HV19DWFhG
TEFHUykgJDwNCitlbmRpZg0KKw0KIGN5Z2NoZWNrLm86IGN5Z2NoZWNrLmNj
DQogaWZkZWYgVkVSQk9TRQ0KIAkke01JTkdXX0NYWH0gJGMgLW8gJChARCkv
JChiYXNlbmFtZSAkQCkkbyAkKE1JTkdXX0NYWEZMQUdTKSAtSSQodXBkaXIp
ICQ8DQpJbmRleDogY3lnY2hlY2suY2MNCj09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT0NClJDUyBmaWxlOiAvY3ZzL3NyYy9zcmMvd2luc3VwL3V0aWxzL2N5Z2No
ZWNrLmNjLHYNCnJldHJpZXZpbmcgcmV2aXNpb24gMS45MA0KZGlmZiAtdSAt
cCAtcjEuOTAgY3lnY2hlY2suY2MNCi0tLSBjeWdjaGVjay5jYwk4IEZlYiAy
MDA2IDE0OjE5OjQwIC0wMDAwCTEuOTANCisrKyBjeWdjaGVjay5jYwkyMiBG
ZWIgMjAwNiAxODo0OTo0MiAtMDAwMA0KQEAgLTUyLDYgKzUyLDEwIEBAIHZv
aWQgZHVtcF9zZXR1cCAoaW50LCBjaGFyICoqLCBib29sKTsNCiB2b2lkIHBh
Y2thZ2VfZmluZCAoaW50LCBjaGFyICoqKTsNCiB2b2lkIHBhY2thZ2VfbGlz
dCAoaW50LCBjaGFyICoqKTsNCiANCitpbnQgZ2V0X3dvcmQgKEhBTkRMRSwg
aW50KTsNCitpbnQgZ2V0X2R3b3JkIChIQU5ETEUsIGludCk7DQoraW50IGRp
c3BsYXlfZXJyb3IgKGNvbnN0IGNoYXIgKiwgYm9vbCBzaG93X2Vycm9yID0g
dHJ1ZSwgYm9vbCBwcmludF9mYWlsZWQgPSB0cnVlKTsNCisNCiBzdGF0aWMg
Y29uc3QgY2hhciB2ZXJzaW9uW10gPSAiJFJldmlzaW9uOiAxLjkwICQiOw0K
IA0KIHN0YXRpYyBjb25zdCBjaGFyICprbm93bl9lbnZfdmFyc1tdID0gew0K
QEAgLTEyNiwyMSArMTMwLDYgQEAgZXByaW50ZiAoY29uc3QgY2hhciAqZm9y
bWF0LCAuLi4pDQogICB2YV9lbmQgKGFwKTsNCiB9DQogDQotLyoNCi0gKiBk
aXNwbGF5X2Vycm9yKCkgaXMgdXNlZCB0byByZXBvcnQgZmFpbHVyZSBtb2Rl
cw0KLSAqLw0KLXN0YXRpYyBpbnQNCi1kaXNwbGF5X2Vycm9yIChjb25zdCBj
aGFyICpuYW1lLCBib29sIHNob3dfZXJyb3IgPSB0cnVlLCBib29sIHByaW50
X2ZhaWxlZCA9IHRydWUpDQotew0KLSAgaWYgKHNob3dfZXJyb3IpDQotICAg
IGZwcmludGYgKHN0ZGVyciwgImN5Z2NoZWNrOiAlcyVzOiAlbHVcbiIsIG5h
bWUsDQotCXByaW50X2ZhaWxlZCA/ICIgZmFpbGVkIiA6ICIiLCBHZXRMYXN0
RXJyb3IgKCkpOw0KLSAgZWxzZQ0KLSAgICBmcHJpbnRmIChzdGRlcnIsICJj
eWdjaGVjazogJXMlc1xuIiwgbmFtZSwNCi0JcHJpbnRfZmFpbGVkID8gIiBm
YWlsZWQiIDogIiIpOw0KLSAgcmV0dXJuIDE7DQotfQ0KLQ0KIC8qIERpc3Bs
YXkgYSBXaW5JbmV0IGVycm9yIG1lc3NhZ2UsIGFuZCBjbG9zZSBhIHZhcmlh
YmxlIG51bWJlciBvZiBoYW5kbGVzLg0KICAgIChQYXNzZWQgYSBsaXN0IG9m
IGhhbmRsZXMgdGVybWluYXRlZCBieSBOVUxMLikgICovDQogc3RhdGljIGlu
dA0KQEAgLTI0OSw5ICsyMzgsNDEgQEAgaW5pdF9wYXRocyAoKQ0KICAgICB9
DQogfQ0KIA0KKyNkZWZpbmUgTElOS19FWFRFTlNJT04gIi5sbmsiDQorDQor
c3RhdGljIGJvb2wNCitjaGVja19leGlzdGVuY2UgKGNoYXIgKmZpbGUsIGlu
dCBzaG93YWxsLCBpbnQgZm91bmRvbmUsIGNoYXIgKmZpcnN0KQ0KK3sNCisg
IGlmIChHZXRGaWxlQXR0cmlidXRlcyAoZmlsZSkgIT0gKERXT1JEKSAtIDEp
DQorICAgIHsNCisgICAgICBjaGFyICpsYXN0ZG90ID0gc3RycmNociAoZmls
ZSwgJy4nKTsNCisgICAgICBib29sIGlzX2xpbmsgPSBsYXN0ZG90ICYmICFz
dHJjbXAgKGxhc3Rkb3QsIExJTktfRVhURU5TSU9OKTsNCisgICAgICAvLyBJ
ZiBmaWxlIGlzIGEgbGluaywgZml4IHVwIHRoZSBleHRlbnNpb24gYmVmb3Jl
IHByaW50aW5nDQorICAgICAgaWYgKGlzX2xpbmspDQorCSpsYXN0ZG90ID0g
J1wwJzsNCisgICAgICBpZiAoc2hvd2FsbCkNCisJcHJpbnRmICgiRm91bmQ6
ICVzXG4iLCBmaWxlKTsNCisgICAgICBpZiAoZm91bmRvbmUpDQorCXsNCisJ
ICBjaGFyICpmbGFzdGRvdCA9IHN0cnJjaHIgKGZpcnN0LCAnLicpOw0KKwkg
IGJvb2wgZl9pc19saW5rID0gZmxhc3Rkb3QgJiYgIXN0cmNtcCAoZmxhc3Rk
b3QsIExJTktfRVhURU5TSU9OKTsNCisJICAvLyBpZiBmaXJzdCBpcyBhIGxp
bmssIGZpeCB1cCB0aGUgZXh0ZW5zaW9uIGJlZm9yZSBwcmludGluZw0KKwkg
IGlmIChmX2lzX2xpbmspDQorCSAgICAqZmxhc3Rkb3QgPSAnXDAnOw0KKwkg
IHByaW50ZiAoIldhcm5pbmc6ICVzIGhpZGVzICVzXG4iLCBmaXJzdCwgZmls
ZSk7DQorCSAgaWYgKGZfaXNfbGluaykNCisJICAgICpmbGFzdGRvdCA9ICcu
JzsNCisJfQ0KKyAgICAgIGlmIChpc19saW5rKQ0KKwkqbGFzdGRvdCA9ICcu
JzsNCisgICAgICByZXR1cm4gdHJ1ZTsNCisgICAgfQ0KKyAgcmV0dXJuIGZh
bHNlOw0KK30NCisNCiBzdGF0aWMgY2hhciAqDQogZmluZF9vbl9wYXRoIChj
aGFyICpmaWxlLCBjaGFyICpkZWZhdWx0X2V4dGVuc2lvbiwNCi0JICAgICAg
aW50IHNob3dhbGwgPSAwLCBpbnQgc2VhcmNoX3N5c2RpcnMgPSAwKQ0KKwkg
ICAgICBpbnQgc2hvd2FsbCA9IDAsIGludCBzZWFyY2hfc3lzZGlycyA9IDAs
IGludCBjaGVja2xpbmtzID0gMCkNCiB7DQogICBzdGF0aWMgY2hhciBydls0
MDAwXTsNCiAgIGNoYXIgdG1wWzQwMDBdLCAqcHRyID0gcnY7DQpAQCAtMjcw
LDExICsyOTEsMjEgQEAgZmluZF9vbl9wYXRoIChjaGFyICpmaWxlLCBjaGFy
ICpkZWZhdWx0Xw0KIA0KICAgaWYgKHN0cmNociAoZmlsZSwgJzonKSB8fCBz
dHJjaHIgKGZpbGUsICdcXCcpIHx8IHN0cmNociAoZmlsZSwgJy8nKSkNCiAg
ICAgew0KKyAgICAgIC8vIEZJWE1FOiB0aGlzIHdpbGwgZmluZCAiZm9vIiBi
ZWZvcmUgImZvby5leGUiIC0tIGNvbnRyYXJ5IHRvIFdpbmRvd3MNCiAgICAg
ICBjaGFyICpmbiA9IGN5Z3BhdGggKGZpbGUsIE5VTEwpOw0KICAgICAgIGlm
IChhY2Nlc3MgKGZuLCBGX09LKSA9PSAwKQ0KIAlyZXR1cm4gZm47DQogICAg
ICAgc3RyY3B5IChydiwgZm4pOw0KICAgICAgIHN0cmNhdCAocnYsIGRlZmF1
bHRfZXh0ZW5zaW9uKTsNCisgICAgICBpZiAoYWNjZXNzIChydiwgRl9PSykg
PT0gMCkNCisJcmV0dXJuIHJ2Ow0KKyAgICAgIGlmICghY2hlY2tsaW5rcykN
CisJcmV0dXJuIGZuOw0KKyAgICAgIHN0cmNhdCAocnYsIExJTktfRVhURU5T
SU9OKTsNCisgICAgICBpZiAoYWNjZXNzIChydiwgRl9PSykgPT0gMCkNCisJ
cmV0dXJuIHJ2Ow0KKyAgICAgIHN0cmNweSAocnYsIGZuKTsNCisgICAgICBz
dHJjYXQgKHJ2LCBMSU5LX0VYVEVOU0lPTik7DQogICAgICAgcmV0dXJuIGFj
Y2VzcyAocnYsIEZfT0spID09IDAgPyBzdHJkdXAgKHJ2KSA6IGZuOw0KICAg
ICB9DQogDQpAQCAtMjg2LDE0ICszMTcsMjUgQEAgZmluZF9vbl9wYXRoIChj
aGFyICpmaWxlLCBjaGFyICpkZWZhdWx0Xw0KICAgICAgIGlmIChpID09IDAg
fHwgIXNlYXJjaF9zeXNkaXJzIHx8IHN0cmNhc2VjbXAgKHBhdGhzW2ldLCBw
YXRoc1swXSkpDQogCXsNCiAJICBzcHJpbnRmIChwdHIsICIlc1xcJXMlcyIs
IHBhdGhzW2ldLCBmaWxlLCBkZWZhdWx0X2V4dGVuc2lvbik7DQotCSAgaWYg
KEdldEZpbGVBdHRyaWJ1dGVzIChwdHIpICE9IChEV09SRCkgLSAxKQ0KLQkg
ICAgew0KLQkgICAgICBpZiAoc2hvd2FsbCkNCi0JCXByaW50ZiAoIkZvdW5k
OiAlc1xuIiwgcHRyKTsNCi0JICAgICAgaWYgKHB0ciA9PSB0bXAgJiYgdmVy
Ym9zZSkNCi0JCXByaW50ZiAoIldhcm5pbmc6ICVzIGhpZGVzICVzXG4iLCBy
diwgcHRyKTsNCi0JICAgICAgcHRyID0gdG1wOw0KLQkgICAgfQ0KKwkgIGlm
IChjaGVja19leGlzdGVuY2UgKHB0ciwgc2hvd2FsbCwgcHRyID09IHRtcCAm
JiB2ZXJib3NlLCBydikpDQorCSAgICBwdHIgPSB0bXA7DQorDQorCSAgaWYg
KCFjaGVja2xpbmtzKQ0KKwkgICAgY29udGludWU7DQorDQorCSAgc3ByaW50
ZiAocHRyLCAiJXNcXCVzJXMlcyIsIHBhdGhzW2ldLCBmaWxlLCBkZWZhdWx0
X2V4dGVuc2lvbiwgTElOS19FWFRFTlNJT04pOw0KKwkgIGlmIChjaGVja19l
eGlzdGVuY2UgKHB0ciwgc2hvd2FsbCwgcHRyID09IHRtcCAmJiB2ZXJib3Nl
LCBydikpDQorCSAgICBwdHIgPSB0bXA7DQorDQorCSAgaWYgKCEqZGVmYXVs
dF9leHRlbnNpb24pDQorCSAgICBjb250aW51ZTsNCisNCisJICBzcHJpbnRm
IChwdHIsICIlc1xcJXMiLCBwYXRoc1tpXSwgZmlsZSk7DQorCSAgaWYgKGNo
ZWNrX2V4aXN0ZW5jZSAocHRyLCBzaG93YWxsLCBwdHIgPT0gdG1wICYmIHZl
cmJvc2UsIHJ2KSkNCisJICAgIHB0ciA9IHRtcDsNCisJICBzcHJpbnRmIChw
dHIsICIlc1xcJXMlcyIsIHBhdGhzW2ldLCBmaWxlLCBMSU5LX0VYVEVOU0lP
Tik7DQorCSAgaWYgKGNoZWNrX2V4aXN0ZW5jZSAocHRyLCBzaG93YWxsLCBw
dHIgPT0gdG1wICYmIHZlcmJvc2UsIHJ2KSkNCisJICAgIHB0ciA9IHRtcDsN
CiAJfQ0KICAgICB9DQogDQpAQCAtMzMwLDM4ICszNzIsNiBAQCBhbHJlYWR5
X2RpZCAoY2hhciAqZmlsZSkNCiAgIHJldHVybiBkOw0KIH0NCiANCi1zdGF0
aWMgaW50DQotZ2V0X3dvcmQgKEhBTkRMRSBmaCwgaW50IG9mZnNldCkNCi17
DQotICBzaG9ydCBydjsNCi0gIHVuc2lnbmVkIHI7DQotDQotICBpZiAoU2V0
RmlsZVBvaW50ZXIgKGZoLCBvZmZzZXQsIDAsIEZJTEVfQkVHSU4pID09IElO
VkFMSURfU0VUX0ZJTEVfUE9JTlRFUg0KLSAgICAgICYmIEdldExhc3RFcnJv
ciAoKSAhPSBOT19FUlJPUikNCi0gICAgZGlzcGxheV9lcnJvciAoImdldF93
b3JkOiBTZXRGaWxlUG9pbnRlcigpIik7DQotDQotICBpZiAoIVJlYWRGaWxl
IChmaCwgJnJ2LCAyLCAoRFdPUkQgKikgJnIsIDApKQ0KLSAgICBkaXNwbGF5
X2Vycm9yICgiZ2V0X3dvcmQ6IFJlYWRmaWxlKCkiKTsNCi0NCi0gIHJldHVy
biBydjsNCi19DQotDQotc3RhdGljIGludA0KLWdldF9kd29yZCAoSEFORExF
IGZoLCBpbnQgb2Zmc2V0KQ0KLXsNCi0gIGludCBydjsNCi0gIHVuc2lnbmVk
IHI7DQotDQotICBpZiAoU2V0RmlsZVBvaW50ZXIgKGZoLCBvZmZzZXQsIDAs
IEZJTEVfQkVHSU4pID09IElOVkFMSURfU0VUX0ZJTEVfUE9JTlRFUg0KLSAg
ICAgICYmIEdldExhc3RFcnJvciAoKSAhPSBOT19FUlJPUikNCi0gICAgZGlz
cGxheV9lcnJvciAoImdldF9kd29yZDogU2V0RmlsZVBvaW50ZXIoKSIpOw0K
LQ0KLSAgaWYgKCFSZWFkRmlsZSAoZmgsICZydiwgNCwgKERXT1JEICopICZy
LCAwKSkNCi0gICAgZGlzcGxheV9lcnJvciAoImdldF9kd29yZDogUmVhZGZp
bGUoKSIpOw0KLQ0KLSAgcmV0dXJuIHJ2Ow0KLX0NCi0NCiBzdHJ1Y3QgU2Vj
dGlvbg0KIHsNCiAgIGNoYXIgbmFtZVs4XTsNCkBAIC02MTAsNiArNjIwLDEw
IEBAIGRsbF9pbmZvIChjb25zdCBjaGFyICpwYXRoLCBIQU5ETEUgZmgsIGkN
CiAgICAgY3lnd2luX2luZm8gKGZoKTsNCiB9DQogDQorZXh0ZXJuIGludCBp
c19leGUgKEhBTkRMRSk7DQorZXh0ZXJuIGludCBpc19zeW1saW5rIChIQU5E
TEUpOw0KK2V4dGVybiBpbnQgcmVhZGxpbmsgKEhBTkRMRSwgY2hhciAqLCBp
bnQpOw0KKw0KIC8vIFJldHVybiB0cnVlIG9uIHN1Y2Nlc3MsIGZhbHNlIGlm
IGVycm9yIHByaW50ZWQNCiBzdGF0aWMgYm9vbA0KIHRyYWNrX2Rvd24gKGNo
YXIgKmZpbGUsIGNoYXIgKnN1ZmZpeCwgaW50IGx2bCkNCkBAIC02ODIsNyAr
Njk2LDE3IEBAIHRyYWNrX2Rvd24gKGNoYXIgKmZpbGUsIGNoYXIgKnN1ZmZp
eCwgaW4NCiANCiAgIGQtPnN0YXRlID0gRElEX0FDVElWRTsNCiANCi0gIGRs
bF9pbmZvIChwYXRoLCBmaCwgbHZsLCAxKTsNCisgIGlmIChpc19leGUgKGZo
KSkNCisgICAgZGxsX2luZm8gKHBhdGgsIGZoLCBsdmwsIDEpOw0KKyAgZWxz
ZSBpZiAoaXNfc3ltbGluayAoZmgpKQ0KKyAgICBkaXNwbGF5X2Vycm9yICgi
dHJhY2tfZG93bjogSHVoPyAgR290IGEgc3ltbGluayEiKTsNCisgIGVsc2UN
CisgICAgew0KKyAgICAgIGludCBtYWdpYyA9IGdldF93b3JkIChmaCwgMHgw
KTsNCisgICAgICBtYWdpYyAmPSAweDAwRkZGRkZGOw0KKyAgICAgIHByaW50
ZiAoIiAtIE5vdCBhIERMTDogbWFnaWMgbnVtYmVyICV4ICglZCkgJyVzJ1xu
IiwgbWFnaWMsIG1hZ2ljLCAoY2hhciAqKSZtYWdpYyk7DQorICAgIH0NCisN
CiAgIGQtPnN0YXRlID0gRElEX0lOQUNUSVZFOw0KICAgaWYgKCFDbG9zZUhh
bmRsZSAoZmgpKQ0KICAgICBkaXNwbGF5X2Vycm9yICgidHJhY2tfZG93bjog
Q2xvc2VIYW5kbGUoKSIpOw0KQEAgLTcxMSwxMSArNzM1LDU1IEBAIGxzIChj
aGFyICpmKQ0KICAgICBkaXNwbGF5X2Vycm9yICgibHM6IENsb3NlSGFuZGxl
KCkiKTsNCiB9DQogDQorLy8gRmluZCBhIHJlYWwgYXBwbGljYXRpb24gb24g
dGhlIHBhdGggKHBvc3NpYmx5IGZvbGxvd2luZyBzeW1saW5rcykNCitzdGF0
aWMgY2hhciAqDQorZmluZF9hcHBfb25fcGF0aCAoY2hhciAqYXBwLCBpbnQg
c2hvd2FsbCA9IDApDQorew0KKyAgY2hhciAqcGFwcCA9IGZpbmRfb25fcGF0
aCAoYXBwLCAoY2hhciAqKSAiLmV4ZSIsIHNob3dhbGwsIDAsIDEpOw0KKw0K
KyAgSEFORExFIGZoID0NCisgICAgQ3JlYXRlRmlsZSAocGFwcCwgR0VORVJJ
Q19SRUFELCBGSUxFX1NIQVJFX1JFQUQgfCBGSUxFX1NIQVJFX1dSSVRFLA0K
KwkJTlVMTCwgT1BFTl9FWElTVElORywgRklMRV9BVFRSSUJVVEVfTk9STUFM
LCBOVUxMKTsNCisgIGlmIChmaCA9PSBJTlZBTElEX0hBTkRMRV9WQUxVRSkN
CisgICAgew0KKyAgICAgIHByaW50ZiAoIiAtIENhbm5vdCBvcGVuXG4iKTsN
CisgICAgICByZXR1cm4gTlVMTDsNCisgICAgfQ0KKw0KKyAgaWYgKGlzX3N5
bWxpbmsgKGZoKSkNCisgICAgew0KKyAgICAgIHN0YXRpYyBjaGFyIHRtcFs0
MDAwXSA9ICIiOw0KKyAgICAgIGNoYXIgKnB0cjsNCisgICAgICByZWFkbGlu
ayhmaCwgdG1wLCAzOTk5KTsNCisgICAgICBwdHIgPSBjeWdwYXRoKHRtcCwg
TlVMTCk7DQorICAgICAgZm9yIChjaGFyICpwID0gcHRyOyAocCA9IHN0cmNo
ciAocCwgJy8nKSk7IHArKykNCisJKnAgPSAnXFwnOw0KKyAgICAgIHByaW50
ZiAoIiAtPiAlc1xuIiwgcHRyKTsNCisgICAgICBpZiAoIXN0cmNociAocHRy
LCAnXFwnKSkNCisJew0KKwkgIGNoYXIgKmxhc3RzZXA7DQorCSAgc3RybmNw
eSAodG1wLCBjeWdwYXRoIChwYXBwLCBOVUxMKSwgMzk5OSk7DQorCSAgZm9y
IChjaGFyICpwID0gdG1wOyAocCA9IHN0cmNociAocCwgJy8nKSk7IHArKykN
CisJICAgICpwID0gJ1xcJzsNCisJICBsYXN0c2VwID0gc3RycmNociAodG1w
LCAnXFwnKTsNCisJICBzdHJuY3B5KGxhc3RzZXArMSwgcHRyLCAzOTk5LShs
YXN0c2VwLXRtcCkpOw0KKwkgIHB0ciA9IHRtcDsNCisJfQ0KKyAgICAgIGlm
ICghQ2xvc2VIYW5kbGUgKGZoKSkNCisJZGlzcGxheV9lcnJvciAoImZpbmRf
YXBwX29uX3BhdGg6IENsb3NlSGFuZGxlKCkiKTsNCisgICAgICByZXR1cm4g
ZmluZF9hcHBfb25fcGF0aCAocHRyLCBzaG93YWxsKTsNCisgICAgfQ0KKw0K
KyAgaWYgKCFDbG9zZUhhbmRsZSAoZmgpKQ0KKyAgICBkaXNwbGF5X2Vycm9y
ICgiZmluZF9hcHBfb25fcGF0aDogQ2xvc2VIYW5kbGUoKSIpOw0KKyAgcmV0
dXJuIHBhcHA7DQorfQ0KKw0KIC8vIFJldHVybiB0cnVlIG9uIHN1Y2Nlc3Ms
IGZhbHNlIGlmIGVycm9yIHByaW50ZWQNCiBzdGF0aWMgYm9vbA0KIGN5Z2No
ZWNrIChjaGFyICphcHApDQogew0KLSAgY2hhciAqcGFwcCA9IGZpbmRfb25f
cGF0aCAoYXBwLCAoY2hhciAqKSAiLmV4ZSIsIDEsIDApOw0KKyAgY2hhciAq
cGFwcCA9IGZpbmRfYXBwX29uX3BhdGggKGFwcCwgMSk7DQogICBpZiAoIXBh
cHApDQogICAgIHsNCiAgICAgICBwcmludGYgKCJFcnJvcjogY291bGQgbm90
IGZpbmQgJXNcbiIsIGFwcCk7DQpAQCAtMTQ0MSw3ICsxNTA5LDcgQEAgZHVt
cF9zeXNpbmZvICgpDQogICAgIHByaW50Zg0KICAgICAgICgiTG9va2luZyB0
byBzZWUgd2hlcmUgY29tbW9uIHByb2dyYW1zIGNhbiBiZSBmb3VuZCwgaWYg
YXQgYWxsLi4uXG4iKTsNCiAgIGZvciAoaSA9IDA7IGNvbW1vbl9hcHBzW2ld
Lm5hbWU7IGkrKykNCi0gICAgaWYgKCFmaW5kX29uX3BhdGggKChjaGFyICop
IGNvbW1vbl9hcHBzW2ldLm5hbWUsIChjaGFyICopICIuZXhlIiwgMSwgMCkp
DQorICAgIGlmICghZmluZF9hcHBfb25fcGF0aCAoKGNoYXIgKikgY29tbW9u
X2FwcHNbaV0ubmFtZSwgMSkpDQogICAgICAgew0KIAlpZiAoY29tbW9uX2Fw
cHNbaV0ubWlzc2luZ19pc19nb29kKQ0KIAkgIHByaW50ZiAoIk5vdCBGb3Vu
ZDogJXMgKGdvb2QhKVxuIiwgY29tbW9uX2FwcHNbaV0ubmFtZSk7DQpJbmRl
eDogZmlsZXV0aWwuY2MNCj09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NClJDUyBm
aWxlOiBmaWxldXRpbC5jYw0KZGlmZiAtTiBmaWxldXRpbC5jYw0KLS0tIC9k
ZXYvbnVsbAkxIEphbiAxOTcwIDAwOjAwOjAwIC0wMDAwDQorKysgZmlsZXV0
aWwuY2MJMjIgRmViIDIwMDYgMTg6NDk6NDIgLTAwMDANCkBAIC0wLDAgKzEs
NjIgQEANCisvKiBmaWxldXRpbC5jYw0KKw0KKyAgIENvcHlyaWdodCAyMDA2
IFJlZCBIYXQsIEluYy4NCisNCisgICBUaGlzIGZpbGUgaXMgcGFydCBvZiBD
eWd3aW4uDQorDQorICAgVGhpcyBzb2Z0d2FyZSBpcyBhIGNvcHlyaWdodGVk
IHdvcmsgbGljZW5zZWQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZQ0KKyAgIEN5
Z3dpbiBsaWNlbnNlLiAgUGxlYXNlIGNvbnN1bHQgdGhlIGZpbGUgIkNZR1dJ
Tl9MSUNFTlNFIiBmb3INCisgICBkZXRhaWxzLiAqLw0KKw0KKyNkZWZpbmUg
Y3lnd2luX2ludGVybmFsIGN5Z3dpbl9pbnRlcm5hbF9kb250dXNlDQorI2lu
Y2x1ZGUgPHN0ZGlvLmg+DQorI2luY2x1ZGUgPHdpbmRvd3MuaD4NCisjdW5k
ZWYgY3lnd2luX2ludGVybmFsDQorDQorLyoNCisgKiBkaXNwbGF5X2Vycm9y
KCkgaXMgdXNlZCB0byByZXBvcnQgZmFpbHVyZSBtb2Rlcw0KKyAqLw0KK2lu
dA0KK2Rpc3BsYXlfZXJyb3IgKGNvbnN0IGNoYXIgKm5hbWUsIGJvb2wgc2hv
d19lcnJvciA9IHRydWUsIGJvb2wgcHJpbnRfZmFpbGVkID0gdHJ1ZSkNCit7
DQorICBpZiAoc2hvd19lcnJvcikNCisgICAgZnByaW50ZiAoc3RkZXJyLCAi
Y3lnY2hlY2s6ICVzJXM6ICVsdVxuIiwgbmFtZSwNCisJcHJpbnRfZmFpbGVk
ID8gIiBmYWlsZWQiIDogIiIsIEdldExhc3RFcnJvciAoKSk7DQorICBlbHNl
DQorICAgIGZwcmludGYgKHN0ZGVyciwgImN5Z2NoZWNrOiAlcyVzXG4iLCBu
YW1lLA0KKwlwcmludF9mYWlsZWQgPyAiIGZhaWxlZCIgOiAiIik7DQorICBy
ZXR1cm4gMTsNCit9DQorDQoraW50DQorZ2V0X3dvcmQgKEhBTkRMRSBmaCwg
aW50IG9mZnNldCkNCit7DQorICBzaG9ydCBydjsNCisgIHVuc2lnbmVkIHI7
DQorDQorICBpZiAoU2V0RmlsZVBvaW50ZXIgKGZoLCBvZmZzZXQsIDAsIEZJ
TEVfQkVHSU4pID09IElOVkFMSURfU0VUX0ZJTEVfUE9JTlRFUg0KKyAgICAg
ICYmIEdldExhc3RFcnJvciAoKSAhPSBOT19FUlJPUikNCisgICAgZGlzcGxh
eV9lcnJvciAoImdldF93b3JkOiBTZXRGaWxlUG9pbnRlcigpIik7DQorDQor
ICBpZiAoIVJlYWRGaWxlIChmaCwgJnJ2LCAyLCAoRFdPUkQgKikgJnIsIDAp
KQ0KKyAgICBkaXNwbGF5X2Vycm9yICgiZ2V0X3dvcmQ6IFJlYWRmaWxlKCki
KTsNCisNCisgIHJldHVybiBydjsNCit9DQorDQoraW50DQorZ2V0X2R3b3Jk
IChIQU5ETEUgZmgsIGludCBvZmZzZXQpDQorew0KKyAgaW50IHJ2Ow0KKyAg
dW5zaWduZWQgcjsNCisNCisgIGlmIChTZXRGaWxlUG9pbnRlciAoZmgsIG9m
ZnNldCwgMCwgRklMRV9CRUdJTikgPT0gSU5WQUxJRF9TRVRfRklMRV9QT0lO
VEVSDQorICAgICAgJiYgR2V0TGFzdEVycm9yICgpICE9IE5PX0VSUk9SKQ0K
KyAgICBkaXNwbGF5X2Vycm9yICgiZ2V0X2R3b3JkOiBTZXRGaWxlUG9pbnRl
cigpIik7DQorDQorICBpZiAoIVJlYWRGaWxlIChmaCwgJnJ2LCA0LCAoRFdP
UkQgKikgJnIsIDApKQ0KKyAgICBkaXNwbGF5X2Vycm9yICgiZ2V0X2R3b3Jk
OiBSZWFkZmlsZSgpIik7DQorDQorICByZXR1cm4gcnY7DQorfQ0KKw0KSW5k
ZXg6IHBhdGguY2MNCj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NClJDUyBmaWxl
OiAvY3ZzL3NyYy9zcmMvd2luc3VwL3V0aWxzL3BhdGguY2Msdg0KcmV0cmll
dmluZyByZXZpc2lvbiAxLjkNCmRpZmYgLXUgLXAgLXIxLjkgcGF0aC5jYw0K
LS0tIHBhdGguY2MJMjkgQXByIDIwMDUgMTY6Mzk6MzQgLTAwMDAJMS45DQor
KysgcGF0aC5jYwkyMiBGZWIgMjAwNiAxODo0OTo0MyAtMDAwMA0KQEAgLTks
OCArOSw5IEBAIEN5Z3dpbiBsaWNlbnNlLiAgUGxlYXNlIGNvbnN1bHQgdGhl
IGZpbGUNCiBkZXRhaWxzLiAqLw0KIA0KIC8qIFRoZSBwdXJwb3NlIG9mIHRo
aXMgZmlsZSBpcyB0byBoaWRlIGFsbCB0aGUgZGV0YWlscyBhYm91dCBhY2Nl
c3NpbmcNCi0gICBDeWd3aW4ncyBtb3VudCB0YWJsZS4gIElmIHRoZSBmb3Jt
YXQgb3IgbG9jYXRpb24gb2YgdGhlIG1vdW50IHRhYmxlDQotICAgY2hhbmdl
cywgdGhpcyBpcyB0aGUgZmlsZSB0byBjaGFuZ2UgdG8gbWF0Y2ggaXQuICov
DQorICAgQ3lnd2luJ3MgbW91bnQgdGFibGUsIHNob3J0Y3V0cywgZXRjLiAg
SWYgdGhlIGZvcm1hdCBvciBsb2NhdGlvbiBvZg0KKyAgIHRoZSBtb3VudCB0
YWJsZSwgb3IgdGhlIHNob3J0Y3V0IGZvcm1hdCBjaGFuZ2VzLCB0aGlzIGlz
IHRoZSBmaWxlIHRvDQorICAgY2hhbmdlIHRvIG1hdGNoIGl0LiAqLw0KIA0K
ICNkZWZpbmUgc3RyKGEpICNhDQogI2RlZmluZSBzY2F0KGEsYikgc3RyKGEj
I2IpDQpAQCAtMjEsNiArMjIsOSBAQCBkZXRhaWxzLiAqLw0KICNpbmNsdWRl
ICJjeWd3aW4vaW5jbHVkZS9zeXMvbW91bnQuaCINCiAjaW5jbHVkZSAiY3ln
d2luL2luY2x1ZGUvbW50ZW50LmgiDQogDQoraW50IGdldF93b3JkIChIQU5E
TEUsIGludCk7DQoraW50IGRpc3BsYXlfZXJyb3IgKGNvbnN0IGNoYXIgKiwg
Ym9vbCBzaG93X2Vycm9yID0gdHJ1ZSwgYm9vbCBwcmludF9mYWlsZWQgPSB0
cnVlKTsNCisNCiAvKiBVc2VkIHdoZW4gdHJlYXRpbmcgLyBhbmQgXCBhcyBl
cXVpdmFsZW50LiAqLw0KICNkZWZpbmUgU0xBU0hfUChjaCkgXA0KICAgKHsg
XA0KQEAgLTI5LDYgKzMzLDE3OCBAQCBkZXRhaWxzLiAqLw0KICAgIH0pDQog
DQogDQorc3RhdGljIGNvbnN0IEdVSUQgR1VJRF9zaG9ydGN1dA0KKwkJCT0g
eyAweDAwMDIxNDAxTCwgMCwgMCwgMHhjMCwgMCwgMCwgMCwgMCwgMCwgMCwg
MHg0NiB9Ow0KKw0KK2VudW0gew0KKyAgV1NIX0ZMQUdfSURMSVNUID0gMHgw
MSwJLyogQ29udGFpbnMgYW4gSVRFTUlETElTVC4gKi8NCisgIFdTSF9GTEFH
X0ZJTEUgPSAweDAyLAkJLyogQ29udGFpbnMgYSBmaWxlIGxvY2F0b3IgZWxl
bWVudC4gKi8NCisgIFdTSF9GTEFHX0RFU0MgPSAweDA0LAkJLyogQ29udGFp
bnMgYSBkZXNjcmlwdGlvbi4gKi8NCisgIFdTSF9GTEFHX1JFTFBBVEggPSAw
eDA4LAkvKiBDb250YWlucyBhIHJlbGF0aXZlIHBhdGguICovDQorICBXU0hf
RkxBR19XRCA9IDB4MTAsCQkvKiBDb250YWlucyBhIHdvcmtpbmcgZGlyLiAq
Lw0KKyAgV1NIX0ZMQUdfQ01ETElORSA9IDB4MjAsCS8qIENvbnRhaW5zIGNv
bW1hbmQgbGluZSBhcmdzLiAqLw0KKyAgV1NIX0ZMQUdfSUNPTiA9IDB4NDAJ
CS8qIENvbnRhaW5zIGEgY3VzdG9tIGljb24uICovDQorfTsNCisNCitzdHJ1
Y3Qgd2luX3Nob3J0Y3V0X2hkcg0KKyAgew0KKyAgICBEV09SRCBzaXplOwkJ
LyogSGVhZGVyIHNpemUgaW4gYnl0ZXMuICBNdXN0IGNvbnRhaW4gMHg0Yy4g
Ki8NCisgICAgR1VJRCBtYWdpYzsJCS8qIEdVSUQgb2Ygc2hvcnRjdXQgZmls
ZXMuICovDQorICAgIERXT1JEIGZsYWdzOwkvKiBDb250ZW50IGZsYWdzLiAg
U2VlIGFib3ZlLiAqLw0KKw0KKyAgICAvKiBUaGUgbmV4dCBmaWVsZHMgZnJv
bSBhdHRyIHRvIGljb25fbm8gYXJlIGFsd2F5cyBzZXQgdG8gMCBpbiBDeWd3
aW4NCisgICAgICAgYW5kIFUvV2luIHNob3J0Y3V0cy4gKi8NCisgICAgRFdP
UkQgYXR0cjsJLyogVGFyZ2V0IGZpbGUgYXR0cmlidXRlcy4gKi8NCisgICAg
RklMRVRJTUUgY3RpbWU7CS8qIFRoZXNlIGZpbGV0aW1lIGl0ZW1zIGFyZSBu
ZXZlciB0b3VjaGVkIGJ5IHRoZSAqLw0KKyAgICBGSUxFVElNRSBtdGltZTsJ
Lyogc3lzdGVtLCBhcHBhcmVudGx5LiBWYWx1ZXMgZG9uJ3QgbWF0dGVyLiAq
Lw0KKyAgICBGSUxFVElNRSBhdGltZTsNCisgICAgRFdPUkQgZmlsZXNpemU7
CS8qIFRhcmdldCBmaWxlc2l6ZS4gKi8NCisgICAgRFdPUkQgaWNvbl9ubzsJ
LyogSWNvbiBudW1iZXIuICovDQorDQorICAgIERXT1JEIHJ1bjsJCS8qIFZh
bHVlcyBkZWZpbmVkIGluIHdpbnVzZXIuaC4gVXNlIFNXX05PUk1BTC4gKi8N
CisgICAgRFdPUkQgaG90a2V5OwkvKiBIb3RrZXkgdmFsdWUuIFNldCB0byAw
LiAgKi8NCisgICAgRFdPUkQgZHVtbXlbMl07CS8qIEZ1dHVyZSBleHRlbnNp
b24gcHJvYmFibHkuIEFsd2F5cyAwLiAqLw0KKyAgfTsNCisNCitzdGF0aWMg
Ym9vbA0KK2NtcF9zaG9ydGN1dF9oZWFkZXIgKHdpbl9zaG9ydGN1dF9oZHIg
KmZpbGVfaGVhZGVyKQ0KK3sNCisgIC8qIEEgQ3lnd2luIG9yIFUvV2luIHNo
b3J0Y3V0IG9ubHkgY29udGFpbnMgYSBkZXNjcmlwdGlvbiBhbmQgYSByZWxw
YXRoLg0KKyAgICAgQ3lnd2luIHNob3J0Y3V0cyBhbHNvIG1pZ2h0IGNvbnRh
aW4gYW4gSVRFTUlETElTVC4gVGhlIHJ1biB0eXBlIGlzDQorICAgICBhbHdh
eXMgc2V0IHRvIFNXX05PUk1BTC4gKi8NCisgIHJldHVybiBmaWxlX2hlYWRl
ci0+c2l6ZSA9PSBzaXplb2YgKHdpbl9zaG9ydGN1dF9oZHIpDQorICAgICAg
JiYgIW1lbWNtcCAoJmZpbGVfaGVhZGVyLT5tYWdpYywgJkdVSURfc2hvcnRj
dXQsIHNpemVvZiBHVUlEX3Nob3J0Y3V0KQ0KKyAgICAgICYmIChmaWxlX2hl
YWRlci0+ZmxhZ3MgJiB+V1NIX0ZMQUdfSURMSVNUKQ0KKwkgPT0gKFdTSF9G
TEFHX0RFU0MgfCBXU0hfRkxBR19SRUxQQVRIKQ0KKyAgICAgICYmIGZpbGVf
aGVhZGVyLT5ydW4gPT0gU1dfTk9STUFMOw0KK30NCisNCisjZGVmaW5lIEVY
RV9NQUdJQyAoKGludCkqKHVuc2lnbmVkIHNob3J0ICopIk1aIikNCisjZGVm
aW5lIFNIT1JUQ1VUX01BR0lDICgoaW50KSoodW5zaWduZWQgc2hvcnQgKiki
TFwwIikNCisjZGVmaW5lIFNZTUxJTktfQ09PS0lFICIhPHN5bWxpbms+Ig0K
KyNkZWZpbmUgU1lNTElOS19NQUdJQyAoKGludCkqKHVuc2lnbmVkIHNob3J0
ICopU1lNTElOS19DT09LSUUpDQorDQorYm9vbA0KK2lzX2V4ZSAoSEFORExF
IGZoKQ0KK3sNCisgIGludCBtYWdpYyA9IGdldF93b3JkIChmaCwgMHgwKTsN
CisgIHJldHVybiBtYWdpYyA9PSBFWEVfTUFHSUM7DQorfQ0KKw0KK2Jvb2wN
Citpc19zeW1saW5rIChIQU5ETEUgZmgpDQorew0KKyAgaW50IG1hZ2ljID0g
Z2V0X3dvcmQgKGZoLCAweDApOw0KKyAgaWYgKG1hZ2ljICE9IFNIT1JUQ1VU
X01BR0lDICYmIG1hZ2ljICE9IFNZTUxJTktfTUFHSUMpDQorICAgIHJldHVy
biBmYWxzZTsNCisgIERXT1JEIGdvdDsNCisgIEJZX0hBTkRMRV9GSUxFX0lO
Rk9STUFUSU9OIGxvY2FsOw0KKyAgaWYgKCFHZXRGaWxlSW5mb3JtYXRpb25C
eUhhbmRsZSAoZmgsICZsb2NhbCkpDQorICAgIHJldHVybiBmYWxzZTsNCisg
IGlmIChtYWdpYyA9PSBTSE9SVENVVF9NQUdJQykNCisgICAgew0KKyAgICAg
IERXT1JEIHNpemU7DQorICAgICAgaWYgKCFsb2NhbC5kd0ZpbGVBdHRyaWJ1
dGVzICYgRklMRV9BVFRSSUJVVEVfUkVBRE9OTFkpDQorCXJldHVybiBmYWxz
ZTsgLyogTm90IGEgQ3lnd2luIHN5bWxpbmsuICovDQorICAgICAgaWYgKChz
aXplID0gR2V0RmlsZVNpemUgKGZoLCBOVUxMKSkgPiA4MTkyKQ0KKwlyZXR1
cm4gZmFsc2U7IC8qIE5vdCBhIEN5Z3dpbiBzeW1saW5rLiAqLw0KKyAgICAg
IGNoYXIgYnVmW3NpemVdOw0KKyAgICAgIFNldEZpbGVQb2ludGVyIChmaCwg
MCwgMCwgRklMRV9CRUdJTik7DQorICAgICAgaWYgKCFSZWFkRmlsZSAoZmgs
IGJ1Ziwgc2l6ZSwgJmdvdCwgMCkpDQorCXJldHVybiBmYWxzZTsNCisgICAg
ICBpZiAoZ290ICE9IHNpemUgfHwgIWNtcF9zaG9ydGN1dF9oZWFkZXIgKCh3
aW5fc2hvcnRjdXRfaGRyICopIGJ1ZikpDQorCXJldHVybiBmYWxzZTsgLyog
Tm90IGEgQ3lnd2luIHN5bWxpbmsuICovDQorICAgICAgLyogVE9ETzogY2hl
Y2sgZm9yIGludmFsaWQgcGF0aCBjb250ZW50cyAoc2VlIC4uL2N5Z3dpbi9w
YXRoLmNjOjMzMTMgKi8NCisgICAgfQ0KKyAgZWxzZSAvKiBtYWdpYyA9PSBT
WU1MSU5LX01BR0lDICovDQorICAgIHsNCisgICAgICBpZiAoIWxvY2FsLmR3
RmlsZUF0dHJpYnV0ZXMgJiBGSUxFX0FUVFJJQlVURV9TWVNURU0pDQorCXJl
dHVybiBmYWxzZTsgLyogTm90IGEgQ3lnd2luIHN5bWxpbmsuICovDQorICAg
ICAgY2hhciBidWZbc2l6ZW9mIChTWU1MSU5LX0NPT0tJRSkgLSAxXTsNCisg
ICAgICBTZXRGaWxlUG9pbnRlciAoZmgsIDAsIDAsIEZJTEVfQkVHSU4pOw0K
KyAgICAgIGlmICghUmVhZEZpbGUgKGZoLCBidWYsIHNpemVvZiAoYnVmKSwg
JmdvdCwgMCkpDQorCXJldHVybiBmYWxzZTsNCisgICAgICBpZiAoZ290ICE9
IHNpemVvZiAoYnVmKSB8fCBtZW1jbXAgKGJ1ZiwgU1lNTElOS19DT09LSUUs
IHNpemVvZiAoYnVmKSkgIT0gMCkNCisJcmV0dXJuIGZhbHNlOyAvKiBOb3Qg
YSBDeWd3aW4gc3ltbGluay4gKi8NCisgICAgfQ0KKyAgcmV0dXJuIHRydWU7
DQorfQ0KKw0KKy8qIEFzc3VtZXMgaXNfc3ltbGluayhmaCkgaXMgdHJ1ZSAq
Lw0KK2Jvb2wNCityZWFkbGluayAoSEFORExFIGZoLCBjaGFyICpwYXRoLCBp
bnQgbWF4bGVuKQ0KK3sNCisgIGludCBnb3Q7DQorICBpbnQgbWFnaWMgPSBn
ZXRfd29yZCAoZmgsIDB4MCk7DQorDQorICBpZiAobWFnaWMgPT0gU0hPUlRD
VVRfTUFHSUMpDQorICAgIHsNCisgICAgICBpbnQgb2Zmc2V0ID0gZ2V0X3dv
cmQgKGZoLCAweDRjKTsNCisgICAgICBpbnQgc2xlbiA9IGdldF93b3JkIChm
aCwgMHg0YyArIG9mZnNldCArIDIpOw0KKyAgICAgIGlmIChzbGVuID49IG1h
eGxlbikNCisJew0KKwkgIGRpc3BsYXlfZXJyb3IgKCJyZWFkbGluazogUGF0
aCB0b28gbG9uZyIpOw0KKwkgIHJldHVybiBmYWxzZTsNCisJfQ0KKyAgICAg
IGlmIChTZXRGaWxlUG9pbnRlciAoZmgsIDB4NGMgKyBvZmZzZXQgKyA0LCAw
LCBGSUxFX0JFR0lOKSA9PSBJTlZBTElEX1NFVF9GSUxFX1BPSU5URVINCisJ
ICAmJiBHZXRMYXN0RXJyb3IgKCkgIT0gTk9fRVJST1IpDQorCXsNCisJICBk
aXNwbGF5X2Vycm9yICgicmVhZGxpbms6IFNldEZpbGVQb2ludGVyKCkiKTsN
CisJICByZXR1cm4gZmFsc2U7DQorCX0NCisNCisgICAgICBpZiAoIVJlYWRG
aWxlIChmaCwgcGF0aCwgc2xlbiwgKERXT1JEICopICZnb3QsIDApKQ0KKwl7
DQorCSAgZGlzcGxheV9lcnJvciAoInJlYWRsaW5rOiBSZWFkRmlsZSgpIik7
DQorCSAgcmV0dXJuIGZhbHNlOw0KKwl9DQorICAgICAgZWxzZSBpZiAoZ290
IDwgc2xlbikNCisJew0KKwkgIGRpc3BsYXlfZXJyb3IgKCJyZWFkbGluazog
UmVhZEZpbGUoKSIpOw0KKwkgIHJldHVybiBmYWxzZTsNCisJfQ0KKyAgICAg
IGVsc2UNCisJcGF0aFtnb3RdID0gJ1wwJzsNCisgICAgfQ0KKyAgZWxzZSBp
ZiAobWFnaWMgPT0gU1lNTElOS19NQUdJQykNCisgICAgew0KKyAgICAgIGNo
YXIgY29va2llX2J1ZltzaXplb2YgKFNZTUxJTktfQ09PS0lFKSAtIDFdOw0K
Kw0KKyAgICAgIGlmIChTZXRGaWxlUG9pbnRlciAoZmgsIDAsIDAsIEZJTEVf
QkVHSU4pID09IElOVkFMSURfU0VUX0ZJTEVfUE9JTlRFUg0KKwkgICYmIEdl
dExhc3RFcnJvciAoKSAhPSBOT19FUlJPUikNCisJew0KKwkgIGRpc3BsYXlf
ZXJyb3IgKCJyZWFkbGluazogU2V0RmlsZVBvaW50ZXIoKSIpOw0KKwkgIHJl
dHVybiBmYWxzZTsNCisJfQ0KKw0KKyAgICAgIGlmICghUmVhZEZpbGUgKGZo
LCBjb29raWVfYnVmLCBzaXplb2YgKGNvb2tpZV9idWYpLCAoRFdPUkQgKikg
JmdvdCwgMCkpDQorCXsNCisJICBkaXNwbGF5X2Vycm9yICgicmVhZGxpbms6
IFJlYWRmaWxlKCkiKTsNCisJICByZXR1cm4gZmFsc2U7DQorCX0NCisgICAg
ICBlbHNlIGlmIChnb3QgPT0gc2l6ZW9mIChjb29raWVfYnVmKQ0KKwkgICAg
ICAgJiYgbWVtY21wIChjb29raWVfYnVmLCBTWU1MSU5LX0NPT0tJRSwgc2l6
ZW9mIChjb29raWVfYnVmKSkgPT0gMCkNCisJew0KKwkgIGlmICghUmVhZEZp
bGUgKGZoLCBwYXRoLCBtYXhsZW4sIChEV09SRCAqKSAmZ290LCAwKSkNCisJ
ICAgIHsNCisJICAgICAgZGlzcGxheV9lcnJvciAoInJlYWRsaW5rOiBSZWFk
RmlsZSgpIik7DQorCSAgICAgIHJldHVybiBmYWxzZTsNCisJICAgIH0NCisJ
ICBlbHNlIGlmIChnb3QgPj0gbWF4bGVuKQ0KKwkgICAgew0KKwkgICAgICBk
aXNwbGF5X2Vycm9yICgicmVhZGxpbms6IFBhdGggdG9vIGxvbmciKTsNCisJ
ICAgICAgcGF0aFswXSA9ICdcMCc7DQorCSAgICAgIHJldHVybiBmYWxzZTsN
CisJICAgIH0NCisJICBlbHNlDQorCSAgICBwYXRoW2dvdF0gPSAnXDAnOw0K
Kwl9DQorICAgIH0NCisgIGVsc2UNCisgICAgcmV0dXJuIGZhbHNlOw0KKyAg
cmV0dXJuIHRydWU7DQorfQ0KKw0KIHN0YXRpYyBzdHJ1Y3QgbW50DQogICB7
DQogICAgIGNvbnN0IGNoYXIgKm5hdGl2ZTsNCg==

---559023410-33463914-1140634551=:4972--
