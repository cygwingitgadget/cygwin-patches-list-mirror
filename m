From: egor duda <deo@logos-m.ru>
To: Christopher Faylor <cygwin-patches@cygwin.com>
Subject: Re: SYSTEMROOT, SYSTEMDRIVE
Date: Thu, 10 May 2001 02:25:00 -0000
Message-id: <8973604858.20010510132418@logos-m.ru>
References: <20010508001319.A16059@redhat.com> <8111460809.20010508190550@logos-m.ru> <12720489682.20010509223903@logos-m.ru> <20010509162006.C2089@redhat.com>
X-SW-Source: 2001-q2/msg00226.html
Content-type: multipart/mixed; boundary="----------=_1583532847-65438-59"

This is a multi-part message in MIME format...

------------=_1583532847-65438-59
Content-length: 1160

Hi!

Thursday, 10 May, 2001 Christopher Faylor cgf@redhat.com wrote:

CF> The difference is the call to the "OS".  It's optional in my case and
CF> mandatory in yours.  I don't know if this makes a difference but I would
CF> bet that the scanning of the environment is not a quick process.  That
CF> would be weighed against the potentially extra two elements to be sorted
CF> by qsort.

CF> Hmm.  Actually, you stop checking for the extra variables after the
CF> build of winenv passes the place where they would be placed, too,
CF> so that is a difference.

yes, because both lists are sorted.

CF> I don't know.  I think that the calls to GetEnvironmentVariable outweigh
CF> anything else, especially since most of the time they probably aren't
CF> needed.

CF> Comments?

you're right. always calling GetEnvironmentVariable is a waste of
time. i've changed my patch to 

- avoid repeated scanning of forced env vars list.
- look into native environment only when needed.
- don't truncate forced vars values to MAX_PATH symbols.

Egor.            mailto:deo@logos-m.ru ICQ 5165414 FidoNet 2:5020/496.19
force-systemroot-2.diff
force-systemroot-2.ChangeLog


------------=_1583532847-65438-59
Content-Type: text/plain; charset=us-ascii;
 name="force-systemroot-2.ChangeLog"
Content-Disposition: inline; filename="force-systemroot-2.ChangeLog"
Content-Transfer-Encoding: base64
Content-Length: 228

MjAwMS0wNS0xMCAgRWdvciBEdWRhICA8ZGVvQGxvZ29zLW0ucnU+CgoJKiBl
bnZpcm9uLmNjIChhcHBlbmRfdG9fd2luZW52KTogTmV3IGZ1bmN0aW9uLgoJ
KHdpbmVudik6IEFsd2F5cyBhZGQgU1lTVEVNRFJJVkUgYW5kIFNZU1lFTVJP
T1QgdG8gd2luMzItc3R5bGUKCWVudmlyb25tZW50Lgo=

------------=_1583532847-65438-59
Content-Type: text/x-diff; charset=us-ascii; name="force-systemroot-2.diff"
Content-Disposition: inline; filename="force-systemroot-2.diff"
Content-Transfer-Encoding: base64
Content-Length: 5913

SW5kZXg6IGVudmlyb24uY2MKPT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpSQ1Mg
ZmlsZTogL2N2cy9zcmMvc3JjL3dpbnN1cC9jeWd3aW4vZW52aXJvbi5jYyx2
CnJldHJpZXZpbmcgcmV2aXNpb24gMS40OQpkaWZmIC11IC1wIC0yIC1yMS40
OSBlbnZpcm9uLmNjCi0tLSBlbnZpcm9uLmNjCTIwMDEvMDUvMDQgMjA6Mzk6
MzgJMS40OQorKysgZW52aXJvbi5jYwkyMDAxLzA1LzEwIDA5OjEzOjAyCkBA
IC03MjksNCArNzI5LDIyIEBAIGVudl9zb3J0IChjb25zdCB2b2lkICphLCBj
b25zdCB2b2lkICpiKQogfQogCitzdGF0aWMgY2hhcioKK2FwcGVuZF90b193
aW5lbnYgKGNoYXIqIHdpbmVudnAsIGNvbnN0IGNoYXIqIHN0cikKK3sKKyAg
aW50IGxlbiA9IHN0cmxlbiAoc3RyKTsKKyAgbWVtY3B5ICh3aW5lbnZwLCBz
dHIsIGxlbiArIDEpOworICByZXR1cm4gKHdpbmVudnAgKyBsZW4gKyAxKTsK
K30KKworLyogS2VlcCB0aGlzIGxpc3QgaW4gdXBwZXIgY2FzZSBhbmQgc29y
dGVkICovCitjb25zdCBjaGFyKiBmb3JjZWRfd2luZW52X3ZhcnMgW10gPQor
ICB7CisgICAgIlNZU1RFTURSSVZFIiwKKyAgICAiU1lTVEVNUk9PVCIsCisg
ICAgTlVMTAorICB9OworCisjZGVmaW5lIEZPUkNFRF9XSU5FTlZfU0laRSAo
c2l6ZW9mIChmb3JjZWRfd2luZW52X3ZhcnMpIC8gc2l6ZW9mIChmb3JjZWRf
d2luZW52X3ZhcnNbMF0pKSAKKwogLyogQ3JlYXRlIGEgV2luZG93cy1zdHls
ZSBlbnZpcm9ubWVudCBibG9jaywgaS5lLiBhIHR5cGljYWwgY2hhcmFjdGVy
IGJ1ZmZlcgogICAgZmlsbGVkIHdpdGggbnVsbCB0ZXJtaW5hdGVkIHN0cmlu
Z3MsIHRlcm1pbmF0ZWQgYnkgZG91YmxlIG51bGwgY2hhcmFjdGVycy4KQEAg
LTczNiw4ICs3NTQsMTcgQEAgY2hhciAqIF9fc3RkY2FsbAogd2luZW52IChj
b25zdCBjaGFyICogY29uc3QgKmVudnAsIGludCBrZWVwX3Bvc2l4KQogewot
ICBpbnQgbGVuLCBuLCB0bDsKKyAgaW50IGxlbiwgbiwgdGwsIGNtcDsKICAg
Y29uc3QgY2hhciAqIGNvbnN0ICpzcmNwOworICBjb25zdCBjaGFyICogY29u
c3QgKmZvcmNlZF9zcmNwOworICBjb25zdCBjaGFyICpuYXRpdmVfc3JjcDsK
ICAgY29uc3QgY2hhciAqICpkc3RwOworICBjb25zdCBjaGFyKiBuYXRpdmVf
ZW52X3B0ciBbRk9SQ0VEX1dJTkVOVl9TSVpFXTsKKyAgY29uc3QgY2hhciog
Y29uc3QgKmN5Z3dpbl9lbnZfcHRyIFtGT1JDRURfV0lORU5WX1NJWkVdOwor
ICBjaGFyKiBwOwogCisgIGRlYnVnX3ByaW50ZiAoImVudnAgJXAsIGtlZXBf
cG9zaXggJWQiLCBlbnZwLCBrZWVwX3Bvc2l4KTsKKworICB0bCA9IDA7CisK
ICAgZm9yIChuID0gMDsgZW52cFtuXTsgbisrKQogICAgIGNvbnRpbnVlOwpA
QCAtNzQ1LDcgKzc3Miw1IEBAIHdpbmVudiAoY29uc3QgY2hhciAqIGNvbnN0
ICplbnZwLCBpbnQga2UKICAgY29uc3QgY2hhciAqbmV3ZW52cFtuICsgMV07
CiAKLSAgZGVidWdfcHJpbnRmICgiZW52cCAlcCwga2VlcF9wb3NpeCAlZCIs
IGVudnAsIGtlZXBfcG9zaXgpOwotCi0gIGZvciAodGwgPSAwLCBzcmNwID0g
ZW52cCwgZHN0cCA9IG5ld2VudnA7ICpzcmNwOyBzcmNwKyssIGRzdHArKykK
KyAgZm9yIChzcmNwID0gZW52cCwgZHN0cCA9IG5ld2VudnA7ICpzcmNwOyBz
cmNwKyssIGRzdHArKykKICAgICB7CiAgICAgICBsZW4gPSBzdHJjc3BuICgq
c3JjcCwgIj0iKSArIDE7CkBAIC03NTYsNSArNzgxLDUgQEAgd2luZW52IChj
b25zdCBjaGFyICogY29uc3QgKmVudnAsIGludCBrZQogICAgICAgZWxzZQog
CXsKLQkgIGNoYXIgKnAgPSAoY2hhciAqKSBhbGxvY2EgKHN0cmxlbiAoY29u
di0+bmF0aXZlKSArIDEpOworCSAgcCA9IChjaGFyICopIGFsbG9jYSAoc3Ry
bGVuIChjb252LT5uYXRpdmUpICsgMSk7CiAJICBzdHJjcHkgKHAsIGNvbnYt
Pm5hdGl2ZSk7CiAJICAqZHN0cCA9IHA7CkBAIC03NjMsNSArNzg4LDUgQEAg
d2luZW52IChjb25zdCBjaGFyICogY29uc3QgKmVudnAsIGludCBrZQogICAg
ICAgaWYgKCgqZHN0cClbMF0gPT0gJyEnICYmIGlzZHJpdmUgKCgqZHN0cCkg
KyAxKSAmJiAoKmRzdHApWzNdID09ICc9JykKIAl7Ci0JICBjaGFyICpwID0g
KGNoYXIgKikgYWxsb2NhIChzdHJsZW4gKCpkc3RwKSArIDEpOworCSAgcCA9
IChjaGFyICopIGFsbG9jYSAoc3RybGVuICgqZHN0cCkgKyAxKTsKIAkgIHN0
cmNweSAocCwgKmRzdHApOwogCSAgKnAgPSAnPSc7CkBAIC03NzgsMTMgKzgw
Myw2MSBAQCB3aW5lbnYgKGNvbnN0IGNoYXIgKiBjb25zdCAqZW52cCwgaW50
IGtlCiAgIHFzb3J0IChuZXdlbnZwLCBlbnZsZW4sIHNpemVvZiAoY2hhciAq
KSwgZW52X3NvcnQpOwogCisgIGZvciAoc3JjcCA9IG5ld2VudnAsIGZvcmNl
ZF9zcmNwID0gZm9yY2VkX3dpbmVudl92YXJzLCBuID0gMCwgbGVuID0gc3Ry
bGVuICgqZm9yY2VkX3NyY3ApOworICAgICAgICpzcmNwIHx8ICpmb3JjZWRf
c3JjcDsgKQorICAgIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIAorICAgICAgaWYgKCpzcmNwID09IDApCisgICAgICAgIGNt
cCA9IC0xOworICAgICAgZWxzZSBpZiAoKmZvcmNlZF9zcmNwID09IDApCisg
ICAgICAgIGNtcCA9IDE7CisgICAgICBlbHNlCisgICAgICAgIGNtcCA9IHN0
cm5jbXAgKCpmb3JjZWRfc3JjcCwgKnNyY3AsIGxlbik7CisgICAgICBpZiAo
Y21wIDwgMCkKKyAgICAgICAgeworICAgICAgICAgIC8qIGZvcmNlZCB2YXJp
YWJsZSBub3QgcHJlc2VuIGluIGVudnAuIHNjYW4gbmF0aXZlIGVudmlyb25l
bnQgZm9yCisgICAgICAgICAgICAgaXRzIHZhbHVlLCBhbmQgcmVtZW1iZXIg
cG9pbnRlciBmb3IgbGF0ZXIgaW5jbHVzaW9uICovCisgICAgICAgICAgZm9y
IChuYXRpdmVfc3JjcCA9IEdldEVudmlyb25tZW50U3RyaW5ncyAoKTsKKyAg
ICAgICAgICAgICAgICpuYXRpdmVfc3JjcCAmJgorICAgICAgICAgICAgICAg
ISBzdHJuY2FzZW1hdGNoICgqZm9yY2VkX3NyY3AsIG5hdGl2ZV9zcmNwLCBs
ZW4pOworICAgICAgICAgICAgICAgbmF0aXZlX3NyY3AgKz0gc3RybGVuIChu
YXRpdmVfc3JjcCkgKyAxKQorICAgICAgICAgICAgLyogZG8gbm90aGluZyAq
LyA7CisgICAgICAgICAgaWYgKCpuYXRpdmVfc3JjcCkKKyAgICAgICAgICAg
IHsKKyAgICAgICAgICAgICAgbmF0aXZlX2Vudl9wdHIgW25dID0gbmF0aXZl
X3NyY3A7CisgICAgICAgICAgICAgIHRsICs9IHN0cmxlbiAobmF0aXZlX3Ny
Y3ApICsgMTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICBlbHNlCisgICAg
ICAgICAgICBuYXRpdmVfZW52X3B0ciBbbl0gPSAwOworCisgICAgICAgICAg
Y3lnd2luX2Vudl9wdHIgW25dID0gc3JjcDsKKyAgICAgICAgICBuKys7Cisg
ICAgICAgICAgZm9yY2VkX3NyY3ArKzsKKyAgICAgICAgICBpZiAoKmZvcmNl
ZF9zcmNwKQorICAgICAgICAgICAgbGVuID0gc3RybGVuICgqZm9yY2VkX3Ny
Y3ApOworICAgICAgICB9CisgICAgICBlbHNlIGlmIChjbXAgPiAwKQorICAg
ICAgICBzcmNwKys7CisgICAgICBlbHNlCisgICAgICAgIHsKKyAgICAgICAg
ICBzcmNwKys7CisgICAgICAgICAgZm9yY2VkX3NyY3ArKzsKKyAgICAgICAg
ICBpZiAoKmZvcmNlZF9zcmNwKQorICAgICAgICAgICAgbGVuID0gc3RybGVu
ICgqZm9yY2VkX3NyY3ApOworICAgICAgICB9CisgICAgfQorICBjeWd3aW5f
ZW52X3B0ciBbbl0gPSAwOworCiAgIC8qIENyZWF0ZSBhbiBlbnZpcm9ubWVu
dCBibG9jayBzdWl0YWJsZSBmb3IgcGFzc2luZyB0byBDcmVhdGVQcm9jZXNz
LiAgKi8KICAgY2hhciAqcHRyLCAqZW52YmxvY2s7CiAgIGVudmJsb2NrID0g
KGNoYXIgKikgbWFsbG9jICh0bCArIDIpOwotICBmb3IgKHNyY3AgPSBuZXdl
bnZwLCBwdHIgPSBlbnZibG9jazsgKnNyY3A7IHNyY3ArKykKKyAgZm9yIChu
ID0gMCwgc3JjcCA9IG5ld2VudnAsIHB0ciA9IGVudmJsb2NrOyAqc3JjcDsg
c3JjcCsrKQogICAgIHsKLSAgICAgIGxlbiA9IHN0cmxlbiAoKnNyY3ApOwot
ICAgICAgbWVtY3B5IChwdHIsICpzcmNwLCBsZW4gKyAxKTsKLSAgICAgIHB0
ciArPSBsZW4gKyAxOworICAgICAgZm9yICg7IGN5Z3dpbl9lbnZfcHRyIFtu
XSA9PSBzcmNwOyBuKyspCisgICAgICAgIHsKKyAgICAgICAgICBpZiAobmF0
aXZlX2Vudl9wdHIgW25dICYmICoobmF0aXZlX2Vudl9wdHIgW25dKSkKKyAg
ICAgICAgICAgIHB0ciA9IGFwcGVuZF90b193aW5lbnYgKHB0ciwgbmF0aXZl
X2Vudl9wdHIgW25dKTsKKyAgICAgICAgfQorICAgICAgcHRyID0gYXBwZW5k
X3RvX3dpbmVudiAocHRyLCAqc3JjcCk7CiAgICAgfQorCiAgICpwdHIgPSAn
XDAnOwkJLyogVHdvIG51bGwgYnl0ZXMgYXQgdGhlIGVuZCAqLwogCg==

------------=_1583532847-65438-59--
