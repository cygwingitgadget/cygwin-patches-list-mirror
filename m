From: egor duda <deo@logos-m.ru>
To: cygwin-patches@cygwin.com
Subject: improving security of AF_UNIX sockets
Date: Wed, 04 Apr 2001 11:04:00 -0000
Message-id: <198204047314.20010404220250@logos-m.ru>
X-SW-Source: 2001-q2/msg00006.html
Content-type: multipart/mixed; boundary="----------=_1583532847-65438-35"

This is a multi-part message in MIME format...

------------=_1583532847-65438-35
Content-length: 553

Hi!

  this patch prevents local users from connecting to cygwin-emulated
AF_UNIX socket if this user have no read rights on socket's file.
it's done by adding 128-bit random secret cookie to !<socket>port
string in file. later, each processes which is negotiating connection
via connect() or accept() must signal its peer that it knows this
secret cookie.

sendto() and recvfrom() are still insecure, unfortunately.

Comments?


egor.            mailto:deo@logos-m.ru icq 5165414 fidonet 2:5020/496.19
af_unix-security.diff
af_unix-security.ChangeLog


------------=_1583532847-65438-35
Content-Type: text/plain; charset=us-ascii; name="af_unix-security.ChangeLog"
Content-Disposition: inline; filename="af_unix-security.ChangeLog"
Content-Transfer-Encoding: base64
Content-Length: 1172

MjAwMS0wNC0wNCAgRWdvciBEdWRhICA8ZGVvQGxvZ29zLW0ucnU+CgoJKiBm
aGFuZGxlci5oIChjbGFzcyBmaGFuZGxlcl9zb2NrZXQpOiBBZGQgbWVtYmVy
cyBhbmQgbWV0aG9kcyB0bwoJc3VwcG9ydCBzZWN1cmUgY29ubmVjdGlvbnMg
b24gQUZfVU5JWCBzb2NrZXRzLgoJKiBmaGFuZGxlcl9zb2NrZXQuY2MgKGZo
YW5kbGVyX3NvY2tldDo6c2V0X2Nvbm5lY3Rfc2VjcmV0KTogTmV3IG1ldGhv
ZC4KCShmaGFuZGxlcl9zb2NrZXQ6OmdldF9jb25uZWN0X3NlY3JldCk6IERp
dHRvLgoJKGZoYW5kbGVyX3NvY2tldDo6Y3JlYXRlX3NlY3JldF9ldmVudCk6
IERpdHRvLgoJKGZoYW5kbGVyX3NvY2tldDo6Y2xvc2Vfc2VjcmV0X2V2ZW50
KTogRGl0dG8uCgkoZmhhbmRsZXJfc29ja2V0OjpjaGVja19wZWVyX3NlY3Jl
dF9ldmVudCk6IERpdHRvLgoJKGZoYW5kbGVyX3NvY2tldDo6Zml4dXBfYWZ0
ZXJfZm9yayk6IER1cGxpY2F0ZSBzZWNyZXQgZXZlbnQgdG8gY2hpbGQuCgko
ZmhhbmRsZXJfc29ja2V0OjpkdXApOiBDb3B5IGFkZHJlc3MgZmFtaWx5LgoJ
KGZoYW5kbGVyX3NvY2tldDo6Y2xvc2UpOiBDbG9zZSBzZWNyZXQgZXZlbnQu
CgkqIG5ldC5jYyAoZ2V0X2luZXRfYWRkcik6IFJlYWQgc2VjcmV0IGNvb2tp
ZS4KCShjeWd3aW5fY29ubmVjdCk6IENoZWNrIGlmIHBlZXIga25vd3Mgc2Vj
cmV0IGNvb2tpZSB2YWx1ZS4KCShjeWd3aW5fYWNjZXB0KTogRGl0dG8uIENv
cHkgYWRkcmVzcyBmYW1pbHkgdG8gbmV3bHkgY3JlYXRlZCBzb2NrZXQuCgko
Y3lnd2luX2JpbmQpOiBHZW5lcmF0ZSBhbmQgd3JpdGUgc2VjcmV0IGNvb2tp
ZS4KCSh3c29ja19pbml0KTogSW5pdGlhbGl6ZSByYW5kb20gbnVtYmVyIGdl
bmVyYXRvci4K

------------=_1583532847-65438-35
Content-Type: text/x-diff; charset=us-ascii; name="af_unix-security.diff"
Content-Disposition: inline; filename="af_unix-security.diff"
Content-Transfer-Encoding: base64
Content-Length: 12798

SW5kZXg6IGZoYW5kbGVyLmgKPT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpSQ1Mg
ZmlsZTogL2N2cy9zcmMvc3JjL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXIuaCx2
CnJldHJpZXZpbmcgcmV2aXNpb24gMS41MgpkaWZmIC11IC1wIC0yIC1yMS41
MiBmaGFuZGxlci5oCi0tLSBmaGFuZGxlci5oCTIwMDEvMDMvMzEgMDk6MTk6
MzIJMS41MgorKysgZmhhbmRsZXIuaAkyMDAxLzA0LzA0IDE3OjUwOjMyCkBA
IC0zNDMsNCArMzQzLDYgQEAgY2xhc3MgZmhhbmRsZXJfc29ja2V0OiBwdWJs
aWMgZmhhbmRsZXJfYgogcHJpdmF0ZToKICAgaW50IGFkZHJfZmFtaWx5Owor
ICBpbnQgY29ubmVjdF9zZWNyZXQgWzRdOworICBIQU5ETEUgc2VjcmV0X2V2
ZW50OwogICBzdHJ1Y3QgX1dTQVBST1RPQ09MX0lORk9BICpwcm90X2luZm9f
cHRyOwogCkBAIC0zNjksNCArMzcxLDkgQEAgcHVibGljOgogICBpbnQgZ2V0
X2FkZHJfZmFtaWx5ICgpIHtyZXR1cm4gYWRkcl9mYW1pbHk7fQogICB2b2lk
IHNldF9hZGRyX2ZhbWlseSAoaW50IGFmKSB7YWRkcl9mYW1pbHkgPSBhZjt9
CisgIHZvaWQgc2V0X2Nvbm5lY3Rfc2VjcmV0ICgpOworICB2b2lkIGdldF9j
b25uZWN0X3NlY3JldCAoY2hhciopOworICBIQU5ETEUgY3JlYXRlX3NlY3Jl
dF9ldmVudCAoaW50ICpzZWNyZXQgPSBOVUxMKTsKKyAgaW50IGNoZWNrX3Bl
ZXJfc2VjcmV0X2V2ZW50IChzdHJ1Y3Qgc29ja2FkZHJfaW4gKnBlZXIsIGlu
dCAqc2VjcmV0ID0gTlVMTCk7CisgIHZvaWQgY2xvc2Vfc2VjcmV0X2V2ZW50
ICgpOwogfTsKIApJbmRleDogZmhhbmRsZXJfc29ja2V0LmNjCj09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT0KUkNTIGZpbGU6IC9jdnMvc3JjL3NyYy93aW5zdXAv
Y3lnd2luL2ZoYW5kbGVyX3NvY2tldC5jYyx2CnJldHJpZXZpbmcgcmV2aXNp
b24gMS41CmRpZmYgLXUgLXAgLTIgLXIxLjUgZmhhbmRsZXJfc29ja2V0LmNj
Ci0tLSBmaGFuZGxlcl9zb2NrZXQuY2MJMjAwMS8wMy8yMCAxOTo1MDoyOAkx
LjUKKysrIGZoYW5kbGVyX3NvY2tldC5jYwkyMDAxLzA0LzA0IDE3OjUwOjMy
CkBAIC0xNyw0ICsxNyw1IEBACiAjaW5jbHVkZSA8c3lzL3NvY2tldC5oPgog
CisjaW5jbHVkZSA8c3RkbGliLmg+CiAjaW5jbHVkZSA8dW5pc3RkLmg+CiAj
aW5jbHVkZSA8ZmNudGwuaD4KQEAgLTI3LDQgKzI4LDYgQEAKICNpbmNsdWRl
ICJzaWdwcm9jLmgiCiAKKyNkZWZpbmUgU0VDUkVUX0VWRU5UX05BTUUgImN5
Z3dpbi5sb2NhbF9zb2NrZXQuc2VjcmV0LiVkLiUwOHgtJTA4eC0lMDh4LSUw
OHgiCisKIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioq
KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwogLyogZmhhbmRs
ZXJfc29ja2V0ICovCkBAIC00Niw0ICs0OSw4NSBAQCBmaGFuZGxlcl9zb2Nr
ZXQ6On5maGFuZGxlcl9zb2NrZXQgKCkKIAogdm9pZAorZmhhbmRsZXJfc29j
a2V0OjpzZXRfY29ubmVjdF9zZWNyZXQgKCkKK3sKKyAgZm9yIChpbnQgaSA9
IDA7IGkgPCA0OyBpKyspCisgICAgY29ubmVjdF9zZWNyZXQgW2ldID0gcmFu
ZG9tICgpOworfQorCit2b2lkCitmaGFuZGxlcl9zb2NrZXQ6OmdldF9jb25u
ZWN0X3NlY3JldCAoY2hhciogYnVmKQoreworICBfX3NtYWxsX3NwcmludGYg
KGJ1ZiwgIiUwOHgtJTA4eC0lMDh4LSUwOHgiLAorCQkgICBjb25uZWN0X3Nl
Y3JldCBbMF0sIGNvbm5lY3Rfc2VjcmV0IFsxXSwKKwkJICAgY29ubmVjdF9z
ZWNyZXQgWzJdLCBjb25uZWN0X3NlY3JldCBbM10pOworfQorCitIQU5ETEUK
K2ZoYW5kbGVyX3NvY2tldDo6Y3JlYXRlX3NlY3JldF9ldmVudCAoaW50KiBz
ZWNyZXQpCit7CisgIGNoYXIgYnVmIFsxMjhdOworICBpbnQqIHNlY3JldF9w
dHIgPSAoc2VjcmV0ID8gOiBjb25uZWN0X3NlY3JldCk7CisgIHN0cnVjdCBz
b2NrYWRkcl9pbiBzaW47CisgIGludCBzaW5fbGVuID0gc2l6ZW9mIChzaW4p
OworCisgIGlmIChnZXRzb2NrbmFtZSAoZ2V0X3NvY2tldCAoKSwgKHN0cnVj
dCBzb2NrYWRkciopICZzaW4sICZzaW5fbGVuKSkKKyAgICB7CisgICAgICBk
ZWJ1Z19wcmludGYgKCJlcnJvciBnZXR0aW5nIGxvY2FsIHNvY2tldCBuYW1l
ICglZCkiLCBXU0FHZXRMYXN0RXJyb3IgKCkpOworICAgICAgcmV0dXJuIE5V
TEw7CisgICAgfQorCisgIF9fc21hbGxfc3ByaW50ZiAoYnVmLCBTRUNSRVRf
RVZFTlRfTkFNRSwgc2luLnNpbl9wb3J0LAorCQkgICBzZWNyZXRfcHRyIFsw
XSwgc2VjcmV0X3B0ciBbMV0sCisJCSAgIHNlY3JldF9wdHIgWzJdLCBzZWNy
ZXRfcHRyIFszXSk7CisgIHNlY3JldF9ldmVudCA9IENyZWF0ZUV2ZW50ICgg
TlVMTCwgRkFMU0UsIEZBTFNFLCBidWYpOworICBpZiAoIXNlY3JldF9ldmVu
dCAmJiBHZXRMYXN0RXJyb3IgKCkgPT0gRVJST1JfQUxSRUFEWV9FWElTVFMp
CisgICAgc2VjcmV0X2V2ZW50ID0gT3BlbkV2ZW50IChFVkVOVF9BTExfQUND
RVNTLCBGQUxTRSwgYnVmKTsKKworICBpZiAoc2VjcmV0X2V2ZW50KQorICAg
IHsKKyAgICAgIFByb3RlY3RIYW5kbGUgKHNlY3JldF9ldmVudCk7CisgICAg
ICBTZXRFdmVudCAoc2VjcmV0X2V2ZW50KTsKKyAgICB9CisKKyAgcmV0dXJu
IHNlY3JldF9ldmVudDsKK30KKwordm9pZAorZmhhbmRsZXJfc29ja2V0Ojpj
bG9zZV9zZWNyZXRfZXZlbnQgKCkKK3sKKyAgaWYgKHNlY3JldF9ldmVudCkK
KyAgICBGb3JjZUNsb3NlSGFuZGxlIChzZWNyZXRfZXZlbnQpOworICBzZWNy
ZXRfZXZlbnQgPSBOVUxMOworfQorCitpbnQKK2ZoYW5kbGVyX3NvY2tldDo6
Y2hlY2tfcGVlcl9zZWNyZXRfZXZlbnQgKHN0cnVjdCBzb2NrYWRkcl9pbiog
cGVlciwgaW50KiBzZWNyZXQpCit7CisgIGNoYXIgYnVmIFsxMjhdOworICBI
QU5ETEUgZXY7CisgIGludCogc2VjcmV0X3B0ciA9IChzZWNyZXQgPyA6IGNv
bm5lY3Rfc2VjcmV0KTsKKworICBfX3NtYWxsX3NwcmludGYgKGJ1ZiwgU0VD
UkVUX0VWRU5UX05BTUUsIHBlZXItPnNpbl9wb3J0LAorICAgICAgICAgICAg
ICAgICAgc2VjcmV0X3B0ciBbMF0sIHNlY3JldF9wdHIgWzFdLAorICAgICAg
ICAgICAgICAgICAgc2VjcmV0X3B0ciBbMl0sIHNlY3JldF9wdHIgWzNdKTsK
KyAgZXYgPSBDcmVhdGVFdmVudCAoTlVMTCwgRkFMU0UsIEZBTFNFLCBidWYp
OworICBpZiAoIWV2ICYmIEdldExhc3RFcnJvciAoKSA9PSBFUlJPUl9BTFJF
QURZX0VYSVNUUykKKyAgICB7CisgICAgICBkZWJ1Z19wcmludGYgKCIlcyBl
dmVudCBhbHJlYWR5IGV4aXN0Iik7CisgICAgICBldiA9IE9wZW5FdmVudCAo
RVZFTlRfQUxMX0FDQ0VTUywgRkFMU0UsIGJ1Zik7CisgICAgfQorCisgIGlm
IChldikKKyAgICB7CisgICAgICBEV09SRCByYyA9IFdhaXRGb3JTaW5nbGVP
YmplY3QgKGV2LCAxMDAwMCk7CisgICAgICBkZWJ1Z19wcmludGYgKCJXRlNP
IHJjPSVkIiwgcmMpOworICAgICAgQ2xvc2VIYW5kbGUgKGV2KTsKKyAgICAg
IHJldHVybiAocmMgPT0gV0FJVF9PQkpFQ1RfMCA/IDEgOiAwICk7CisgICAg
fQorICBlbHNlCisgICAgcmV0dXJuIDA7Cit9CisKK3ZvaWQKIGZoYW5kbGVy
X3NvY2tldDo6Zml4dXBfYmVmb3JlX2ZvcmtfZXhlYyAoRFdPUkQgd2luX3By
b2NfaWQpCiB7CkBAIC05NCw0ICsxNzgsNiBAQCBmaGFuZGxlcl9zb2NrZXQ6
OmZpeHVwX2FmdGVyX2ZvcmsgKEhBTkRMCiAgICAgICBkZWJ1Z19wcmludGYg
KCJXaXRob3V0IFdpbnNvY2sgMi4wIik7CiAgICAgfQorICBpZiAoc2VjcmV0
X2V2ZW50KQorICAgIGZvcmtfZml4dXAgKHBhcmVudCwgc2VjcmV0X2V2ZW50
LCAic2VjcmV0X2V2ZW50Iik7CiB9CiAKQEAgLTEwMCw0ICsxODYsNSBAQCBm
aGFuZGxlcl9zb2NrZXQ6OmR1cCAoZmhhbmRsZXJfYmFzZSAqY2hpCiB7CiAg
IGZoYW5kbGVyX3NvY2tldCAqZmhzID0gKGZoYW5kbGVyX3NvY2tldCAqKSBj
aGlsZDsKKyAgZmhzLT5hZGRyX2ZhbWlseSA9IGFkZHJfZmFtaWx5OwogICBm
aHMtPnNldF9pb19oYW5kbGUgKGdldF9pb19oYW5kbGUgKCkpOwogICBmaHMt
PmZpeHVwX2JlZm9yZV9mb3JrX2V4ZWMgKEdldEN1cnJlbnRQcm9jZXNzSWQg
KCkpOwpAQCAtMTQ4LDQgKzIzNSw2IEBAIGZoYW5kbGVyX3NvY2tldDo6Y2xv
c2UgKCkKICAgICAgIHJlcyA9IC0xOwogICAgIH0KKworICBjbG9zZV9zZWNy
ZXRfZXZlbnQgKCk7CiAKICAgcmV0dXJuIHJlczsKSW5kZXg6IG5ldC5jYwo9
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09ClJDUyBmaWxlOiAvY3ZzL3NyYy9zcmMv
d2luc3VwL2N5Z3dpbi9uZXQuY2MsdgpyZXRyaWV2aW5nIHJldmlzaW9uIDEu
NDQKZGlmZiAtdSAtcCAtMiAtcjEuNDQgbmV0LmNjCi0tLSBuZXQuY2MJMjAw
MS8wNC8wMyAwMjo1MzoyNAkxLjQ0CisrKyBuZXQuY2MJMjAwMS8wNC8wNCAx
Nzo1MDozMgpAQCAtMTksNCArMTksNSBAQCBkZXRhaWxzLiAqLwogI2luY2x1
ZGUgPGlwaGxwYXBpLmg+CiAKKyNpbmNsdWRlIDxzdGRsaWIuaD4KICNpbmNs
dWRlIDx1bmlzdGQuaD4KICNpbmNsdWRlIDxuZXRkYi5oPgpAQCAtMzc4LDYg
KzM3OSw5IEBAIGRvbmU6CiAKIHN0YXRpYyBpbnQgZ2V0X2luZXRfYWRkciAo
Y29uc3Qgc3RydWN0IHNvY2thZGRyICppbiwgaW50IGlubGVuLAotCQkJICAg
c3RydWN0IHNvY2thZGRyX2luICpvdXQsIGludCAqb3V0bGVuKQorCQkJICAg
c3RydWN0IHNvY2thZGRyX2luICpvdXQsIGludCAqb3V0bGVuLCBpbnQqIHNl
Y3JldCA9IDApCiB7CisgIGludCBzZWNyZXRfYnVmIFs0XTsKKyAgaW50KiBz
ZWNyZXRfcHRyID0gKHNlY3JldCA/IDogc2VjcmV0X2J1Zik7CisKICAgaWYg
KGluLT5zYV9mYW1pbHkgPT0gQUZfSU5FVCkKICAgICB7CkBAIC0zOTMsNSAr
Mzk3LDUgQEAgc3RhdGljIGludCBnZXRfaW5ldF9hZGRyIChjb25zdCBzdHJ1
Y3QgcwogCiAgICAgICBpbnQgcmV0ID0gMDsKLSAgICAgIGNoYXIgYnVmWzMy
XTsKKyAgICAgIGNoYXIgYnVmWzEyOF07CiAgICAgICBtZW1zZXQgKGJ1Ziwg
MCwgc2l6ZW9mIGJ1Zik7CiAgICAgICBpZiAocmVhZCAoZmQsIGJ1Ziwgc2l6
ZW9mIGJ1ZikgIT0gLTEpCkBAIC0zOTksNSArNDAzLDcgQEAgc3RhdGljIGlu
dCBnZXRfaW5ldF9hZGRyIChjb25zdCBzdHJ1Y3QgcwogCSAgc29ja2FkZHJf
aW4gc2luOwogCSAgc2luLnNpbl9mYW1pbHkgPSBBRl9JTkVUOwotCSAgc3Nj
YW5mIChidWYgKyBzdHJsZW4gKFNPQ0tFVF9DT09LSUUpLCAiJWh1IiwgJnNp
bi5zaW5fcG9ydCk7CisJICBzc2NhbmYgKGJ1ZiArIHN0cmxlbiAoU09DS0VU
X0NPT0tJRSksICIlaHUgJTA4eC0lMDh4LSUwOHgtJTA4eCIsCisJCSAgJnNp
bi5zaW5fcG9ydCwKKwkJICBzZWNyZXRfcHRyLCBzZWNyZXRfcHRyICsgMSwg
c2VjcmV0X3B0ciArIDIsIHNlY3JldF9wdHIgKyAzKTsKIAkgIHNpbi5zaW5f
cG9ydCA9IGh0b25zIChzaW4uc2luX3BvcnQpOwogCSAgc2luLnNpbl9hZGRy
LnNfYWRkciA9IGh0b25sIChJTkFERFJfTE9PUEJBQ0spOwpAQCAtNjE2LDkg
KzYyMiwxMSBAQCBjeWd3aW5fY29ubmVjdCAoaW50IGZkLAogewogICBpbnQg
cmVzOworICBCT09MIHNlY3JldF9jaGVja19mYWlsZWQgPSBGQUxTRTsKICAg
ZmhhbmRsZXJfc29ja2V0ICpzb2NrID0gZ2V0IChmZCk7CiAgIHNvY2thZGRy
X2luIHNpbjsKKyAgaW50IHNlY3JldCBbNF07CiAgIHNpZ2ZyYW1lIHRoaXNm
cmFtZSAobWFpbnRocmVhZCk7CiAKLSAgaWYgKGdldF9pbmV0X2FkZHIgKG5h
bWUsIG5hbWVsZW4sICZzaW4sICZuYW1lbGVuKSA9PSAwKQorICBpZiAoZ2V0
X2luZXRfYWRkciAobmFtZSwgbmFtZWxlbiwgJnNpbiwgJm5hbWVsZW4sIHNl
Y3JldCkgPT0gMCkKICAgICByZXR1cm4gLTE7CiAKQEAgLTYzOSw0ICs2NDcs
MzIgQEAgY3lnd2luX2Nvbm5lY3QgKGludCBmZCwKIAkgIHNldF93aW5zb2Nr
X2Vycm5vICgpOwogICAgICAgICB9CisgICAgICBpZiAoc29jay0+Z2V0X2Fk
ZHJfZmFtaWx5ICgpID09IEFGX1VOSVgpCisgICAgICAgIHsKKyAgICAgICAg
ICBpZiAoIXJlcyB8fCBlcnJubyA9PSBFSU5QUk9HUkVTUykKKyAgICAgICAg
ICAgIHsKKyAgICAgICAgICAgICAgaWYgKCFzb2NrLT5jcmVhdGVfc2VjcmV0
X2V2ZW50IChzZWNyZXQpKQorICAgICAgICAgICAgICAgIHsgICAKKwkJICBz
ZWNyZXRfY2hlY2tfZmFpbGVkID0gVFJVRTsKKwkJfQorICAgICAgICAgICAg
fQorCisgICAgICAgICAgaWYgKCFzZWNyZXRfY2hlY2tfZmFpbGVkICYmICFy
ZXMpCisgICAgICAgICAgICB7CisJICAgICAgaWYgKCFzb2NrLT5jaGVja19w
ZWVyX3NlY3JldF9ldmVudCAoJnNpbiwgc2VjcmV0KSkKKwkJeworCQkgIGRl
YnVnX3ByaW50ZiAoICJhY2NlcHQgZnJvbSB1bmF1dGhvcml6ZWQgc2VydmVy
IiApOworCQkgIHNlY3JldF9jaGVja19mYWlsZWQgPSBUUlVFOworCQl9Cisg
ICAgICAgICAgIH0KKworICAgICAgICAgIGlmIChzZWNyZXRfY2hlY2tfZmFp
bGVkKQorICAgICAgICAgICAgeworCSAgICAgIHNvY2stPmNsb3NlX3NlY3Jl
dF9ldmVudCAoKTsKKyAgICAgICAgICAgICAgaWYgKHJlcykKKyAgICAgICAg
ICAgICAgICBjbG9zZXNvY2tldCAocmVzKTsKKwkgICAgICBzZXRfZXJybm8g
KEVDT05OUkVGVVNFRCk7CisJICAgICAgcmVzID0gLTE7CisgICAgICAgICAg
ICB9CisgICAgICAgIH0KICAgICB9CiAgIHJldHVybiByZXM7CkBAIC03MzQs
NCArNzcwLDUgQEAgY3lnd2luX2FjY2VwdCAoaW50IGZkLCBzdHJ1Y3Qgc29j
a2FkZHIgKgogewogICBpbnQgcmVzID0gLTE7CisgIEJPT0wgc2VjcmV0X2No
ZWNrX2ZhaWxlZCA9IEZBTFNFOwogICBzaWdmcmFtZSB0aGlzZnJhbWUgKG1h
aW50aHJlYWQpOwogCkBAIC03NDgsNCArNzg1LDM2IEBAIGN5Z3dpbl9hY2Nl
cHQgKGludCBmZCwgc3RydWN0IHNvY2thZGRyICoKICAgICAgIHJlcyA9IGFj
Y2VwdCAoc29jay0+Z2V0X3NvY2tldCAoKSwgcGVlciwgbGVuKTsgIC8vIGNh
bid0IHVzZSBhIGJsb2NraW5nIGNhbGwgaW5zaWRlIGEgbG9jawogCisgICAg
ICBpZiAoc29jay0+Z2V0X2FkZHJfZmFtaWx5ICgpID09IEFGX1VOSVgpCisg
ICAgICAgIHsKKyAgICAgICAgICBpZiAoKChTT0NLRVQpIHJlcyAhPSAoU09D
S0VUKSBJTlZBTElEX1NPQ0tFVCB8fAorICAgICAgICAgICAgICAgV1NBR2V0
TGFzdEVycm9yICgpID09IFdTQUVXT1VMREJMT0NLKSkKKyAgICAgICAgICAg
IHsKKyAgICAgICAgICAgICAgaWYgKCFzb2NrLT5jcmVhdGVfc2VjcmV0X2V2
ZW50ICgpKQorCQl7CisJCSAgc2VjcmV0X2NoZWNrX2ZhaWxlZCA9IFRSVUU7
CisgICAgICAgICAgICAgICAgfQorICAgICAgICAgICAgfQorCisgICAgICAg
ICAgaWYgKCFzZWNyZXRfY2hlY2tfZmFpbGVkICYmCisgICAgICAgICAgICAg
IChTT0NLRVQpIHJlcyAhPSAoU09DS0VUKSBJTlZBTElEX1NPQ0tFVCkKKyAg
ICAgICAgICAgIHsKKwkgICAgICBpZiAoIXNvY2stPmNoZWNrX3BlZXJfc2Vj
cmV0X2V2ZW50ICgoc3RydWN0IHNvY2thZGRyX2luKikgcGVlcikpCisJCXsK
KwkJICBkZWJ1Z19wcmludGYgKCJjb25uZWN0IGZyb20gdW5hdXRob3JpemVk
IGNsaWVudCIpOworCQkgIHNlY3JldF9jaGVja19mYWlsZWQgPSBUUlVFOwor
ICAgICAgICAgICAgICAgIH0KKyAgICAgICAgICAgIH0KKworICAgICAgICAg
IGlmIChzZWNyZXRfY2hlY2tfZmFpbGVkKQorICAgICAgICAgICAgeworICAg
ICAgICAgICAgICBzb2NrLT5jbG9zZV9zZWNyZXRfZXZlbnQgKCk7CisgICAg
ICAgICAgICAgIGlmICgoU09DS0VUKSByZXMgIT0gKFNPQ0tFVCkgSU5WQUxJ
RF9TT0NLRVQpCisgICAgICAgICAgICAgICAgY2xvc2Vzb2NrZXQgKHJlcyk7
CisJICAgICAgc2V0X2Vycm5vIChFQ09OTkFCT1JURUQpOworICAgICAgICAg
ICAgICByZXMgPSAtMTsKKyAgICAgICAgICAgICAgZ290byBkb25lOworICAg
ICAgICAgICAgfQorICAgICAgICB9CisKICAgICAgIFNldFJlc291cmNlTG9j
ayAoTE9DS19GRF9MSVNULCBXUklURV9MT0NLfFJFQURfTE9DSywgImFjY2Vw
dCIpOwogCkBAIC03NTUsNSArODI0LDUgQEAgY3lnd2luX2FjY2VwdCAoaW50
IGZkLCBzdHJ1Y3Qgc29ja2FkZHIgKgogCSAgLyogRklYTUU6IHdoYXQgaXMg
Y29ycmVjdCBlcnJubz8gKi8KIAkgIHNldF9lcnJubyAoRU1GSUxFKTsKLQkg
IGdvdG8gZG9uZTsKKwkgIGdvdG8gbG9ja19kb25lOwogCX0KICAgICAgIGlm
ICgoU09DS0VUKSByZXMgPT0gKFNPQ0tFVCkgSU5WQUxJRF9TT0NLRVQpCkBA
IC03NjEsMTEgKzgzMCwxMyBAQCBjeWd3aW5fYWNjZXB0IChpbnQgZmQsIHN0
cnVjdCBzb2NrYWRkciAqCiAgICAgICBlbHNlCiAJewotCSAgZmRzb2NrIChy
ZXNfZmQsIHNvY2stPmdldF9uYW1lICgpLCByZXMpOworCSAgZmhhbmRsZXJf
c29ja2V0KiByZXNfZmggPSBmZHNvY2sgKHJlc19mZCwgc29jay0+Z2V0X25h
bWUgKCksIHJlcyk7CisJICByZXNfZmgtPnNldF9hZGRyX2ZhbWlseSAoc29j
ay0+Z2V0X2FkZHJfZmFtaWx5ICgpKTsKIAkgIHJlcyA9IHJlc19mZDsKIAl9
CiAgICAgfQorbG9ja19kb25lOgorICBSZWxlYXNlUmVzb3VyY2VMb2NrIChM
T0NLX0ZEX0xJU1QsIFdSSVRFX0xPQ0t8UkVBRF9MT0NLLCAiYWNjZXB0Iik7
CiBkb25lOgogICBzeXNjYWxsX3ByaW50ZiAoIiVkID0gYWNjZXB0ICglZCwg
JXgsICV4KSIsIHJlcywgZmQsIHBlZXIsIGxlbik7Ci0gIFJlbGVhc2VSZXNv
dXJjZUxvY2sgKExPQ0tfRkRfTElTVCwgV1JJVEVfTE9DS3xSRUFEX0xPQ0ss
ICJhY2NlcHQiKTsKICAgcmV0dXJuIHJlczsKIH0KQEAgLTgyMiw3ICs4OTMs
MTAgQEAgY3lnd2luX2JpbmQgKGludCBmZCwgY29uc3Qgc3RydWN0IHNvY2th
ZAogCSAgICAgIGdvdG8gb3V0OwogCSAgICB9CisKKyAgICAgICAgICBzb2Nr
LT5zZXRfY29ubmVjdF9zZWNyZXQgKCk7CiAKLQkgIGNoYXIgYnVmW3NpemVv
ZiAoU09DS0VUX0NPT0tJRSkgKyAxMF07Ci0JICBfX3NtYWxsX3NwcmludGYg
KGJ1ZiwgIiVzJXUiLCBTT0NLRVRfQ09PS0lFLCBzaW4uc2luX3BvcnQpOwor
CSAgY2hhciBidWZbc2l6ZW9mIChTT0NLRVRfQ09PS0lFKSArIDgwXTsKKwkg
IF9fc21hbGxfc3ByaW50ZiAoYnVmLCAiJXMldSAiLCBTT0NLRVRfQ09PS0lF
LCBzaW4uc2luX3BvcnQpOworICAgICAgICAgIHNvY2stPmdldF9jb25uZWN0
X3NlY3JldCAoc3RyY2hyIChidWYsICdcMCcpKTsKIAkgIGxlbiA9IHN0cmxl
biAoYnVmKSArIDE7CiAKQEAgLTE4NjcsNCArMTk0MSw3IEBAIHdzb2NrX2lu
aXQgKCkKICAgaWYgKEZJT05CSU8gICE9IFJFQUxfRklPTkJJTykKICAgICBk
ZWJ1Z19wcmludGYgKCIqKioqKioqKioqKioqKioqICBGSU9OQklPICAhPSBS
RUFMX0ZJT05CSU8iKTsKKworICAvKiBGSVhNRTogd2lsbCByZXN1bHRpbmcg
cmFuZG9tIHNlcXVlbmNlIGJlIHVucHJlZGljdGFibGUgZW5vdWdoPyAqLwor
ICBzcmFuZG9tIChHZXRUaWNrQ291bnQgKCkpOwogfQogCg==

------------=_1583532847-65438-35--
