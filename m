From: Egor Duda <deo@logos-m.ru>
To: cygwin-patches@cygwin.com
Subject: tty-slave read() patch
Date: Wed, 28 Feb 2001 08:27:00 -0000
Message-id: <115104181535.20010228192351@logos-m.ru>
X-SW-Source: 2001-q1/msg00127.html
Content-type: multipart/mixed; boundary="----------=_1583532846-65438-15"

This is a multi-part message in MIME format...

------------=_1583532846-65438-15
Content-length: 610

Hi!

  i've  changed  the  way  fhandler_tty_slave::read  communicates with
master.   it  addresses  a  couple  of  problems.  currently,  when in
non-canonical  mode  and  vmin=1,  read() never reads more then 1 byte
from  the  pipe,   even   if  more  input  is available. the result is
following:  when user  presses  F1 key in ssh window, this keypress is
actually  sent  to server  not  in  one  packet but in 4. This is very
noticeable on slow links. it also eliminates pipe polling.

Egor.            mailto:deo@logos-m.ru ICQ 5165414 FidoNet 2:5020/496.19
tty-slave-read.diff
tty-slave-read.ChangeLog


------------=_1583532846-65438-15
Content-Type: text/plain; charset=us-ascii; name="tty-slave-read.ChangeLog"
Content-Disposition: inline; filename="tty-slave-read.ChangeLog"
Content-Transfer-Encoding: base64
Content-Length: 1220

MjAwMS0wMi0yOCAgRWdvciBEdWRhICA8ZGVvQGxvZ29zLW0ucnU+CgoJKiBm
aGFuZGxlci5oIChjbGFzcyBmaGFuZGxlcl90dHlfY29tbW9uKTogTmV3IG11
dGV4IGFuZCBldmVudCB0bwoJc3luY3Jvbml6ZSBpbnB1dCBvbiBtYXN0ZXIg
dHR5IHdpdGggc2xhdmUgdHR5LgoJKiBmaGFuZGxlcl90dHkuY2MgKGZoYW5k
bGVyX3B0eV9tYXN0ZXI6OmFjY2VwdF9pbnB1dCk6IFVzZSB0aGVtIHRvCglz
eW5jcm9uaXplIHdpdGggc2xhdmUuCgkqIGZoYW5kbGVyX3R0eS5jYyAoZmhh
bmRsZXJfdHR5X3NsYXZlOjpyZWFkKTogVXNlIGlucHV0IG11dGV4IGFuZAoJ
ZXZlbnQgdG8gc3luY3Jvbml6ZSB3aXRoIG1hc3Rlci4gRG8gbm90IGxpbWl0
IGFtb3VudCBvZiBkYXRhIHJlYWQKCWZyb20gbWFzdGVyIHRvIHZtaW4gdmFs
dWUuIEludGVycnVwdCBvbiBzaWduYWwgYW5kIHJldHVybiBhbHJlYWR5Cgly
ZWFkIGRhdGEsIGlmIGFueS4KCSogZmhhbmRsZXJfdHR5LmNjIChmaGFuZGxl
cl90dHlfc2xhdmU6Om9wZW4pOiBIYW5kbGUgaW5wdXQgbXV0ZXggYW5kCgll
dmVudC4KCSogZmhhbmRsZXJfdHR5LmNjIChmaGFuZGxlcl90dHlfY29tbW9u
OjpjbG9zZSk6IERpdHRvLgoJKiBmaGFuZGxlcl90dHkuY2MgKGZoYW5kbGVy
X3R0eV9jb21tb246OnNldF9jbG9zZV9vbl9leGVjKTogRGl0dG8uCgkqIGZo
YW5kbGVyX3R0eS5jYyAoZmhhbmRsZXJfdHR5X2NvbW1vbjo6Zml4dXBfYWZ0
ZXJfZm9yayk6IERpdHRvLgoJKiBmaGFuZGxlcl90dHkuY2MgKGZoYW5kbGVy
X3R0eV9jb21tb246OmR1cCk6IERpdHRvLgoJKiB0dHkuaCAodHR5OjpvcGVu
X2lucHV0X211dGV4KTogTmV3IGZ1bmN0aW9uLgoJKiB0dHkuY2MgKHR0eTo6
Y29tbW9uX2luaXQpOiBDcmVhdGUgaW5wdXQgbXV0ZXggYW5kIGV2ZW50Lgo=

------------=_1583532846-65438-15
Content-Type: text/x-diff; charset=us-ascii; name="tty-slave-read.diff"
Content-Disposition: inline; filename="tty-slave-read.diff"
Content-Transfer-Encoding: base64
Content-Length: 16084

SW5kZXg6IGZoYW5kbGVyLmgKPT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpSQ1Mg
ZmlsZTogL2N2cy9zcmMvc3JjL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXIuaCx2
CnJldHJpZXZpbmcgcmV2aXNpb24gMS40MQpkaWZmIC11IC1wIC0yIC1yMS40
MSBmaGFuZGxlci5oCi0tLSBmaGFuZGxlci5oCTIwMDEvMDIvMjcgMDk6MTQ6
MzUJMS40MQorKysgZmhhbmRsZXIuaAkyMDAxLzAyLzI4IDE0OjEwOjQyCkBA
IC03MDcsNSArNzA3LDYgQEAgcHVibGljOgogICBIQU5ETEUgaW9jdGxfZG9u
ZV9ldmVudDsJLy8gUmFpc2VkIGJ5IG1hc3RlciBvbiBpb2N0bCgpIGNvbXBs
ZXRpb24uCiAJCQkJLy8gSW9jdGwoKSBzdGF0dXMgaW4gdHR5Ojppb2N0bF9y
ZXR2YWwuCi0gIEhBTkRMRSBvdXRwdXRfbXV0ZXg7CisgIEhBTkRMRSBvdXRw
dXRfbXV0ZXgsIGlucHV0X211dGV4OworICBIQU5ETEUgaW5wdXRfYXZhaWxh
YmxlX2V2ZW50OwogICBIQU5ETEUgaW51c2U7CQkJLy8gdXNlZCB0byBpbmRp
Y2F0ZSB0aGF0IGEgdHR5IGlzIGluIHVzZQogCkluZGV4OiBmaGFuZGxlcl90
dHkuY2MKPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpSQ1MgZmlsZTogL2N2cy9z
cmMvc3JjL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXJfdHR5LmNjLHYKcmV0cmll
dmluZyByZXZpc2lvbiAxLjIzCmRpZmYgLXUgLXAgLTIgLXIxLjIzIGZoYW5k
bGVyX3R0eS5jYwotLS0gZmhhbmRsZXJfdHR5LmNjCTIwMDAvMTAvMTcgMDE6
NDI6MDQJMS4yMworKysgZmhhbmRsZXJfdHR5LmNjCTIwMDEvMDIvMjggMTQ6
MTA6NDQKQEAgLTE2OCwyMCArMTY4LDE5IEBAIGZoYW5kbGVyX3B0eV9tYXN0
ZXI6OmFjY2VwdF9pbnB1dCAoKQogICBEV09SRCB3cml0dGVuOwogICBEV09S
RCBuOwotICBjb25zdCBjaGFyIGR1bW15WzFdID0geydYJ307Ci0gIGNvbnN0
IGNoYXIgKmJ1ZjsKKyAgRFdPUkQgcmM7CiAKKyAgcmMgPSBXYWl0Rm9yU2lu
Z2xlT2JqZWN0ICggaW5wdXRfbXV0ZXgsIElORklOSVRFICk7CisKICAgbiA9
IGdldF90dHlwICgpLT5yZWFkX3JldHZhbCA9IGVhdF9yZWFkYWhlYWQgKC0x
KTsKIAotICBpZiAobiAhPSAwKQotICAgIGJ1ZiA9IHJhYnVmOwotICBlbHNl
CisgIGlmICggbiAhPSAwICkKICAgICB7Ci0gICAgICBuID0gMTsKLSAgICAg
IGJ1ZiA9IGR1bW15OwotICAgICAgdGVybWlvc19wcmludGYgKCJzZW5kaW5n
IEVPRiB0byBzbGF2ZSIpOworICAgICAgdGVybWlvc19wcmludGYgKCJhYm91
dCB0byB3cml0ZSAlZCBjaGFycyB0byBzbGF2ZSIsIG4pOworICAgICAgcmMg
PSBXcml0ZUZpbGUgKGdldF9vdXRwdXRfaGFuZGxlICgpLCByYWJ1Ziwgbiwg
JndyaXR0ZW4sIE5VTEwpOwogICAgIH0KLSAgdGVybWlvc19wcmludGYgKCJh
Ym91dCB0byB3cml0ZSAlZCBjaGFycyB0byBzbGF2ZSIsIG4pOwotICBpZiAo
IVdyaXRlRmlsZSAoZ2V0X291dHB1dF9oYW5kbGUgKCksIGJ1ZiwgbiwgJndy
aXR0ZW4sIE5VTEwpKQotICAgICAgcmV0dXJuIC0xOworICBlbHNlCisgICAg
dGVybWlvc19wcmludGYgKCJzZW5kaW5nIEVPRiB0byBzbGF2ZSIpOworICBT
ZXRFdmVudCAoIGlucHV0X2F2YWlsYWJsZV9ldmVudCApOworICBSZWxlYXNl
TXV0ZXggKCBpbnB1dF9tdXRleCApOwogICByZXR1cm4gZ2V0X3R0eXAgKCkt
PnJlYWRfcmV0dmFsOwogfQpAQCAtNDYwLDQgKzQ1OSwxNyBAQCBmaGFuZGxl
cl90dHlfc2xhdmU6Om9wZW4gKGNvbnN0IGNoYXIgKiwgCiAgICAgICByZXR1
cm4gMDsKICAgICB9CisgIGlmICghKGlucHV0X211dGV4ID0gZ2V0X3R0eXAo
KS0+b3Blbl9pbnB1dF9tdXRleCAoVFJVRSkpKQorICAgIHsKKyAgICAgIHRl
cm1pb3NfcHJpbnRmICgib3BlbiBpbnB1dCBtdXRleCBmYWlsZWQsICVFIik7
CisgICAgICBfX3NldGVycm5vICgpOworICAgICAgcmV0dXJuIDA7CisgICAg
fQorICBfX3NtYWxsX3NwcmludGYgKGJ1ZiwgSU5QVVRfQVZBSUxBQkxFX0VW
RU5ULCB0dHludW0pOworICBpZiAoIShpbnB1dF9hdmFpbGFibGVfZXZlbnQg
PSBPcGVuRXZlbnQgKEVWRU5UX0FMTF9BQ0NFU1MsIFRSVUUsIGJ1ZikpKQor
ICAgIHsKKyAgICAgIHRlcm1pb3NfcHJpbnRmICgib3BlbiBpbnB1dCBldmVu
dCBmYWlsZWQsICVFIik7CisgICAgICBfX3NldGVycm5vICgpOworICAgICAg
cmV0dXJuIDA7CisgICAgfQogCiAgIC8qIFRoZSBpb2N0bCBldmVudHMgbWF5
IG9yIG1heSBub3QgZXhpc3QuICBTZWUgb3V0cHV0X2RvbmVfZXZlbnQsCkBA
IC02MDAsNSArNjEyLDEwIEBAIGZoYW5kbGVyX3R0eV9zbGF2ZTo6cmVhZCAo
dm9pZCAqcHRyLCBzaXoKICAgaW50IHZtaW4gPSBJTlRfTUFYOwogICBpbnQg
dnRpbWUgPSAwOwkvKiBJbml0aWFsaXplZCB0byBwcmV2ZW50IC1XdW5pbml0
aWFsaXplZCB3YXJuaW5nICovCisgIHNpemVfdCByZWFkbGVuOworICBEV09S
RCBieXRlc19pbl9waXBlOwogICBjaGFyIGJ1ZltJTlBfQlVGRkVSX1NJWkVd
OworICBEV09SRCB0aW1lX3RvX3dhaXQ7CisgIERXT1JEIHJjOworICBIQU5E
TEUgdzRbMl07CiAKICAgdGVybWlvc19wcmludGYoInJlYWQoJXgsICVkKSBo
YW5kbGUgJWQiLCBwdHIsIGxlbiwgZ2V0X2hhbmRsZSAoKSk7CkBAIC02MDYs
MjEgKzYyMyw3NyBAQCBmaGFuZGxlcl90dHlfc2xhdmU6OnJlYWQgKHZvaWQg
KnB0ciwgc2l6CiAgIGlmICghKGdldF90dHlwICgpLT50aS5jX2xmbGFnICYg
SUNBTk9OKSkKICAgICB7Ci0gICAgICB2bWluID0gZ2V0X3R0eXAgKCktPnRp
LmNfY2NbVk1JTl07CisgICAgICB2bWluID0gbWluICggSU5QX0JVRkZFUl9T
SVpFLCBnZXRfdHR5cCAoKS0+dGkuY19jY1tWTUlOXSApOwogICAgICAgdnRp
bWUgPSBnZXRfdHR5cCAoKS0+dGkuY19jY1tWVElNRV07CisgICAgICBpZiAo
IHZtaW4gPCAwICkgdm1pbiA9IDA7CisgICAgICBpZiAoIHZ0aW1lIDwgMCAp
IHZ0aW1lID0gMDsKKyAgICAgIGlmICggdm1pbiA9PSAwICkKKyAgICAgICAg
dGltZV90b193YWl0ID0gSU5GSU5JVEU7CisgICAgICBlbHNlCisgICAgICAg
IHRpbWVfdG9fd2FpdCA9ICggdnRpbWUgPT0gMCA/IElORklOSVRFIDogMTAg
KiB2dGltZSApOwogICAgIH0KKyAgZWxzZQorICAgIHRpbWVfdG9fd2FpdCA9
IElORklOSVRFOwogCisgIHc0WzBdID0gc2lnbmFsX2Fycml2ZWQ7CisgIHc0
WzFdID0gaW5wdXRfYXZhaWxhYmxlX2V2ZW50OworCiAgIHdoaWxlIChsZW4p
CiAgICAgewotICAgICAgc2l6ZV90IHJlYWRsZW4gPSBtaW4gKCh1bnNpZ25l
ZCkgdm1pbiwgbWluIChsZW4sIHNpemVvZiAoYnVmKSkpOwotICAgICAgdGVy
bWlvc19wcmludGYgKCJyZWFkaW5nICVkIGJ5dGVzICh2dGltZSAlZCkiLAot
CQkgICAgICBtaW4gKCh1bnNpZ25lZCkgdm1pbiwgbWluIChsZW4sIHNpemVv
ZiAoYnVmKSkpLCB2dGltZSk7Ci0KLSAgICAgIG4gPSBnZXRfcmVhZGFoZWFk
X2ludG9fYnVmZmVyIChidWYsIHJlYWRsZW4pOwotCi0gICAgICBpZiAoIW4g
JiYgUmVhZEZpbGUgKGdldF9oYW5kbGUgKCksIGJ1ZiwgcmVhZGxlbiwgJm4s
IE5VTEwpID09IEZBTFNFKQorICAgICAgcmMgPSBXYWl0Rm9yTXVsdGlwbGVP
YmplY3RzICggMiwgdzQsIEZBTFNFLCB0aW1lX3RvX3dhaXQgKTsKKyAgICAg
IGlmIChyYyA9PSBXQUlUX09CSkVDVF8wKQorICAgICAgICB7CisgICAgICAg
ICAgLyogaWYgd2UndmUgcmVjaWV2ZWQgc2lnbmFsIGFmdGVyIHN1Y2Nlc3Nm
dWxseSByZWFkaW5nIHNvbWUgZGF0YSwKKyAgICAgICAgICAgICBqdXN0IHJl
dHVybiBhbGwgZGF0YSBzdWNjZXNzZnVsbHkgcmVhZCAqLworICAgICAgICAg
IGlmICh0b3RhbHJlYWQgPiAwKQorICAgICAgICAgICAgYnJlYWs7CisgICAg
ICAgICAgc2V0X3NpZ19lcnJubyAoRUlOVFIpOworICAgICAgICAgIHJldHVy
biAtMTsKKyAgICAgICAgfQorICAgICAgZWxzZSBpZiAocmMgPT0gV0FJVF9G
QUlMRUQpCisgICAgICAgIHsKKyAgICAgICAgICB0ZXJtaW9zX3ByaW50ZiAo
ICJ3YWl0IGZvciBpbnB1dCBldmVudCBmYWlsZWQsICVFIiApOworICAgICAg
ICAgIGJyZWFrOworICAgICAgICB9CisgICAgICBlbHNlIGlmIChyYyA9PSBX
QUlUX1RJTUVPVVQpCisgICAgICAgIGJyZWFrOworICAgICAgcmMgPSBXYWl0
Rm9yU2luZ2xlT2JqZWN0ICggaW5wdXRfbXV0ZXgsIDEwMDAgKTsKKyAgICAg
IGlmIChyYyA9PSBXQUlUX0ZBSUxFRCkKKyAgICAgICAgeworICAgICAgICAg
IHRlcm1pb3NfcHJpbnRmICggIndhaXQgZm9yIGlucHV0IG11dGV4IGZhaWxl
ZCwgJUUiICk7CisgICAgICAgICAgYnJlYWs7CisgICAgICAgIH0KKyAgICAg
IGVsc2UgaWYgKHJjID09IFdBSVRfVElNRU9VVCkKKyAgICAgICAgeworICAg
ICAgICAgIHRlcm1pb3NfcHJpbnRmICggImZhaWxlZCB0byBhY3F1aXJlIGlu
cHV0IG11dGV4IGFmdGVyIGlucHV0IGV2ZW50IGFycml2ZWQiICk7CisgICAg
ICAgICAgYnJlYWs7CisgICAgICAgIH0KKyAgICAgIGlmICghUGVla05hbWVk
UGlwZSAoZ2V0X2hhbmRsZSAoKSwgTlVMTCwgMCwgTlVMTCwgJmJ5dGVzX2lu
X3BpcGUsIE5VTEwpKQogCXsKLQkgIHRlcm1pb3NfcHJpbnRmICgicmVhZCBm
YWlsZWQsICVFIik7Ci0JICBfcmFpc2UgKFNJR0hVUCk7CisJICB0ZXJtaW9z
X3ByaW50ZigiUGVla05hbWVkUGlwZSBmYWlsZWQsICVFIik7CisgICAgICAg
ICAgX3JhaXNlIChTSUdIVVApOworICAgICAgICAgIGJ5dGVzX2luX3BpcGUg
PSAwOwogCX0KKyAgICAgIHJlYWRsZW4gPSBtaW4gKGJ5dGVzX2luX3BpcGUs
IG1pbiAobGVuLCBzaXplb2YgKGJ1ZikpKTsKKyAgICAgIGlmICggcmVhZGxl
biApCisgICAgICAgIHsKKyAgICAgICAgICB0ZXJtaW9zX3ByaW50ZiAoInJl
YWRpbmcgJWQgYnl0ZXMgKHZ0aW1lICVkKSIsIHJlYWRsZW4sIHZ0aW1lKTsK
KyAgICAgICAgICBpZiAoUmVhZEZpbGUgKGdldF9oYW5kbGUgKCksIGJ1Ziwg
cmVhZGxlbiwgJm4sIE5VTEwpID09IEZBTFNFKQorIAkgICAgeworCSAgICAg
IHRlcm1pb3NfcHJpbnRmICgicmVhZCBmYWlsZWQsICVFIik7CisJICAgICAg
X3JhaXNlIChTSUdIVVApOworCSAgICB9CisgICAgICAgICAgaWYgKG4pCisg
ICAgICAgICAgICB7CisgICAgICAgICAgICAgIGxlbiAtPSBuOworICAgICAg
ICAgICAgICB0b3RhbHJlYWQgKz0gbjsKKyAgICAgICAgICAgICAgbWVtY3B5
IChwdHIsIGJ1Ziwgbik7CisgICAgICAgICAgICAgIHB0ciA9IChjaGFyICop
IHB0ciArIG47CisgICAgICAgICAgICB9CisgICAgICAgIH0KKworICAgICAg
aWYgKCByZWFkbGVuICE9IGJ5dGVzX2luX3BpcGUgKQorICAgICAgICBTZXRF
dmVudCAoIGlucHV0X2F2YWlsYWJsZV9ldmVudCApOworCisgICAgICBSZWxl
YXNlTXV0ZXggKCBpbnB1dF9tdXRleCApOwogCiAgICAgICBpZiAoZ2V0X3R0
eXAgKCktPnJlYWRfcmV0dmFsIDwgMCkJLy8gcmVhZCBlcnJvcgpAQCAtNjM1
LDQ2ICs3MDgsMjYgQEAgZmhhbmRsZXJfdHR5X3NsYXZlOjpyZWFkICh2b2lk
ICpwdHIsIHNpegogCSAgYnJlYWs7CiAJfQotICAgICAgbGVuIC09IG47Ci0g
ICAgICB0b3RhbHJlYWQgKz0gbjsKLSAgICAgIG1lbWNweSAocHRyLCBidWYs
IG4pOwotICAgICAgcHRyID0gKGNoYXIgKikgcHRyICsgbjsKLSAgICAgIGlm
IChnZXRfdHR5cCAoKS0+dGkuY19sZmxhZyAmIElDQU5PTikKLQlicmVhazsK
LSAgICAgIGVsc2UgaWYgKHRvdGFscmVhZCA+PSB2bWluKQorICAgICAgaWYg
KCBnZXRfdHR5cCAoKS0+dGkuY19sZmxhZyAmIElDQU5PTiB8fAorICAgICAg
ICAgICBnZXRfZmxhZ3MgKCkgJiAoT19OT05CTE9DSyB8IE9fTkRFTEFZKSkK
IAlicmVhazsKKyAgICAgIGlmICggdG90YWxyZWFkID49IHZtaW4gJiYgKHZt
aW4gPiAwIHx8IHRvdGFscmVhZCA+IDApICkKKyAgICAgICAgYnJlYWs7CiAK
LSAgICAgIGlmICghUGVla05hbWVkUGlwZSAoZ2V0X2hhbmRsZSAoKSwgTlVM
TCwgMCwgTlVMTCwgJm4sIE5VTEwpKQotCXsKLQkgIHRlcm1pb3NfcHJpbnRm
KCJQZWVrTmFtZWRQaXBlIGZhaWxlZCwgJUUiKTsKLQkgIGJyZWFrOwotCX0K
LSAgICAgIGlmIChuID09IDApCi0JewotCSAgaWYgKGdldF9mbGFncyAoKSAm
IChPX05PTkJMT0NLIHwgT19OREVMQVkpKQotCSAgICBicmVhazsKKyAgICAg
IC8qIHZtaW4gPT0gMCAmJiB2dGltZSA9PSAwOiAKKyAgICAgICAqICAgd2Un
dmUgYWxyZWFkeSByZWFkIGFsbCBpbnB1dCwgaWYgYW55LCBzbyByZXR1cm4g
aW1tZWRpYXRlbHkKKyAgICAgICAqIHZtaW4gPT0gMCAmJiB2dGltZSA+IDA6
CisgICAgICAgKiAgIHdlJ3ZlIHdhaXRlZCBmb3IgaW5wdXQgMTAqdnRpbWUg
bXMgaW4gV0ZTTyhpbnB1dF9hdmFpbGFibGVfZXZlbnQpLAorICAgICAgICog
ICBubyBtYXR0ZXIgd2hldGhlciBhbnkgaW5wdXQgYXJyaXZlZCwgd2Ugc2hv
dWxkbid0IHdhaXQgYW55IGxvbmdlciwKKyAgICAgICAqICAgc28gcmV0dXJu
IGltbWVkaWF0ZWx5IAorICAgICAgICogdm1pbiA+IDAgJiYgdnRpbWUgPT0g
MDoKKyAgICAgICAqICAgaGVyZSwgdG90YWxyZWFkIDwgdm1pbiwgc28gY29u
dGludWUgd2FpdGluZyB1bnRpbCBtb3JlIGRhdGEKKyAgICAgICAqICAgYXJy
aXZlCisgICAgICAgKiB2bWluID4gMCAmJiB2dGltZSA+IDA6CisgICAgICAg
KiAgIHNpbWlsYXIgdG8gdGhlIHByZXZpb3VzIGhlcmUsIHRvdGFscmVhZCA8
IHZtaW4sIGFuZCB0aW1lcgorICAgICAgICogICBoYWRuJ3QgZXhwaXJlZCAt
LSBXRlNPKGlucHV0X2F2YWlsYWJsZV9ldmVudCkgIT0gV0FJVF9USU1FT1VU
LAorICAgICAgICogICBzbyAicmVzdGFydCB0aW1lciIgYW5kIHdhaXQgdW50
aWwgbW9yZSBkYXRhIGFycml2ZQorICAgICAgICovCiAKLQkgIC8qIFdlIGNh
bid0IGVudGVyIHRoZSBibG9ja2luZyBSZWFkZmlsZSBhcyBzaWduYWxzIHdp
bGwgYmUgbG9zdC4KLQkgICAqIFNvLCBwb2xsIHRoZSBwaXBlIGZvciBkYXRh
LgotCSAgICogRklYTUU6IHRyeSB0byBhdm9pZCBwb2xsaW5nLi4uCi0JICAg
KiBGSVhNRTogQ3VycmVudCBFSU5UUiBzY2hlbWUgZG9lcyBub3QgdGFrZSB2
bWluL3Z0aW1lIGludG8gYWNjb3VudC4KLQkgICAqLwotCSAgaWYgKCEoZ2V0
X3R0eXAgKCktPnRpLmNfbGZsYWcgJiBJQ0FOT04pKQotCSAgICB7Ci0JICAg
ICAgdGVybWlvc19wcmludGYoInZtaW4gJWQgdnRpbWUgJWQiLCB2bWluLCB2
dGltZSk7Ci0JICAgICAgaWYgKHZtaW4gPT0gMCAmJiB2dGltZSA9PSAwKQot
CQlyZXR1cm4gMDsJCS8vIG1pbiA9IDAsIHRpbWUgPSAwCi0JICAgICAgaWYg
KHZ0aW1lID09IDApCi0JCWNvbnRpbnVlOwkJLy8gbWluID4gMCwgdGltZSA9
IDAKLQkgICAgICB3aGlsZSAodnRpbWUtLSkKLQkJewotCQkgIFBlZWtOYW1l
ZFBpcGUgKGdldF9oYW5kbGUgKCksIE5VTEwsIDAsIE5VTEwsICZuLCBOVUxM
KTsKLQkJICBpZiAobikKLQkJICAgIGJyZWFrOwotCQkgIFNsZWVwKDEwKTsK
LQkJfQotCSAgICAgIGlmICh2dGltZSA9PSAwKQotCQlyZXR1cm4gdG90YWxy
ZWFkOwotCSAgICB9Ci0JfQorICAgICAgaWYgKHZtaW4gPT0gMCkgYnJlYWs7
CiAgICAgfQogICB0ZXJtaW9zX3ByaW50ZiAoIiVkPXJlYWQoJXgsICVkKSIs
IHRvdGFscmVhZCwgcHRyLCBsZW4pOwpAQCAtNzIyLDkgKzc3NSwyMyBAQCBm
aGFuZGxlcl90dHlfY29tbW9uOjpkdXAgKGZoYW5kbGVyX2Jhc2UgCiAgICAg
ICBnb3RvIGVycjsKICAgICB9CisgIGlmICghRHVwbGljYXRlSGFuZGxlICho
TWFpblByb2MsIGlucHV0X2F2YWlsYWJsZV9ldmVudCwgaE1haW5Qcm9jLAor
CQkJJmZ0cy0+aW5wdXRfYXZhaWxhYmxlX2V2ZW50LCAwLCAxLAorCQkJRFVQ
TElDQVRFX1NBTUVfQUNDRVNTKSkKKyAgICB7CisgICAgICBlcnJpbmQgPSA0
OworICAgICAgZ290byBlcnI7CisgICAgfQogICBpZiAoIUR1cGxpY2F0ZUhh
bmRsZSAoaE1haW5Qcm9jLCBvdXRwdXRfbXV0ZXgsIGhNYWluUHJvYywKIAkJ
CSZmdHMtPm91dHB1dF9tdXRleCwgMCwgMSwKIAkJCURVUExJQ0FURV9TQU1F
X0FDQ0VTUykpCiAgICAgewotICAgICAgZXJyaW5kID0gNDsKKyAgICAgIGVy
cmluZCA9IDU7CisgICAgICBnb3RvIGVycjsKKyAgICB9CisgIGlmICghRHVw
bGljYXRlSGFuZGxlIChoTWFpblByb2MsIGlucHV0X211dGV4LCBoTWFpblBy
b2MsCisJCQkmZnRzLT5pbnB1dF9tdXRleCwgMCwgMSwKKwkJCURVUExJQ0FU
RV9TQU1FX0FDQ0VTUykpCisgICAgeworICAgICAgZXJyaW5kID0gNjsKICAg
ICAgIGdvdG8gZXJyOwogICAgIH0KQEAgLTczMyw1ICs4MDAsNSBAQCBmaGFu
ZGxlcl90dHlfY29tbW9uOjpkdXAgKGZoYW5kbGVyX2Jhc2UgCiAJCQlEVVBM
SUNBVEVfU0FNRV9BQ0NFU1MpKQogICAgIHsKLSAgICAgIGVycmluZCA9IDU7
CisgICAgICBlcnJpbmQgPSA3OwogICAgICAgZ290byBlcnI7CiAgICAgfQpA
QCAtNzQyLDUgKzgwOSw1IEBAIGZoYW5kbGVyX3R0eV9jb21tb246OmR1cCAo
ZmhhbmRsZXJfYmFzZSAKIAkJCURVUExJQ0FURV9TQU1FX0FDQ0VTUykpCiAg
ICAgewotICAgICAgZXJyaW5kID0gNjsKKyAgICAgIGVycmluZCA9IDg7CiAg
ICAgICBnb3RvIGVycjsKICAgICB9CkBAIC03NTMsNSArODIwLDUgQEAgZmhh
bmRsZXJfdHR5X2NvbW1vbjo6ZHVwIChmaGFuZGxlcl9iYXNlIAogCQkJICAg
ICBEVVBMSUNBVEVfU0FNRV9BQ0NFU1MpKQogICAgIHsKLSAgICAgIGVycmlu
ZCA9IDc7CisgICAgICBlcnJpbmQgPSA5OwogICAgICAgZ290byBlcnI7CiAg
ICAgfQpAQCAtODg5LDQgKzk1Niw4IEBAIGZoYW5kbGVyX3R0eV9jb21tb246
OmNsb3NlICgpCiAgIGlmICghRm9yY2VDbG9zZUhhbmRsZSAob3V0cHV0X211
dGV4KSkKICAgICB0ZXJtaW9zX3ByaW50ZiAoIkNsb3NlSGFuZGxlIChvdXRw
dXRfbXV0ZXg8JXA+KSwgJUUiLCBvdXRwdXRfbXV0ZXgpOworICBpZiAoIUZv
cmNlQ2xvc2VIYW5kbGUgKGlucHV0X211dGV4KSkKKyAgICB0ZXJtaW9zX3By
aW50ZiAoIkNsb3NlSGFuZGxlIChpbnB1dF9tdXRleDwlcD4pLCAlRSIsIGlu
cHV0X211dGV4KTsKKyAgaWYgKCFGb3JjZUNsb3NlSGFuZGxlIChpbnB1dF9h
dmFpbGFibGVfZXZlbnQpKQorICAgIHRlcm1pb3NfcHJpbnRmICgiQ2xvc2VI
YW5kbGUgKGlucHV0X2F2YWlsYWJsZV9ldmVudDwlcD4pLCAlRSIsIGlucHV0
X2F2YWlsYWJsZV9ldmVudCk7CiAgIGlmICghRm9yY2VDbG9zZUhhbmRsZTEg
KGdldF9oYW5kbGUgKCksIGZyb21fcHR5KSkKICAgICB0ZXJtaW9zX3ByaW50
ZiAoIkNsb3NlSGFuZGxlIChnZXRfaGFuZGxlICgpPCVwPiksICVFIiwgZ2V0
X2hhbmRsZSAoKSk7CkBAIC0xMDEwLDQgKzEwODEsNiBAQCBmaGFuZGxlcl90
dHlfY29tbW9uOjpzZXRfY2xvc2Vfb25fZXhlYyAoCiAgICAgc2V0X2luaGVy
aXRhbmNlIChpbnVzZSwgdmFsKTsKICAgc2V0X2luaGVyaXRhbmNlIChvdXRw
dXRfbXV0ZXgsIHZhbCwgIm91dHB1dF9tdXRleCIpOworICBzZXRfaW5oZXJp
dGFuY2UgKGlucHV0X211dGV4LCB2YWwsICJpbnB1dF9tdXRleCIpOworICBz
ZXRfaW5oZXJpdGFuY2UgKGlucHV0X2F2YWlsYWJsZV9ldmVudCwgdmFsKTsK
ICAgc2V0X2luaGVyaXRhbmNlIChvdXRwdXRfaGFuZGxlLCB2YWwpOwogfQpA
QCAtMTAyOCw0ICsxMTAxLDExIEBAIGZoYW5kbGVyX3R0eV9jb21tb246OmZp
eHVwX2FmdGVyX2ZvcmsgKEgKICAgICAgIFByb3RlY3RIYW5kbGUgKG91dHB1
dF9tdXRleCk7CiAgICAgfQorICBpZiAoaW5wdXRfbXV0ZXgpCisgICAgewor
ICAgICAgZm9ya19maXh1cCAocGFyZW50LCBpbnB1dF9tdXRleCwgImlucHV0
X211dGV4Iik7CisgICAgICBQcm90ZWN0SGFuZGxlIChpbnB1dF9tdXRleCk7
CisgICAgfQorICBpZiAoaW5wdXRfYXZhaWxhYmxlX2V2ZW50KQorICAgIGZv
cmtfZml4dXAgKHBhcmVudCwgaW5wdXRfYXZhaWxhYmxlX2V2ZW50LCAiaW5w
dXRfYXZhaWxhYmxlX2V2ZW50Iik7CiAgIGZvcmtfZml4dXAgKHBhcmVudCwg
b3V0cHV0X2hhbmRsZSwgIm91dHB1dF9oYW5kbGUiKTsKICAgZm9ya19maXh1
cCAocGFyZW50LCBpbnVzZSwgImludXNlIik7CkluZGV4OiB0dHkuY2MKPT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PQpSQ1MgZmlsZTogL2N2cy9zcmMvc3JjL3dp
bnN1cC9jeWd3aW4vdHR5LmNjLHYKcmV0cmlldmluZyByZXZpc2lvbiAxLjEz
CmRpZmYgLXUgLXAgLTIgLXIxLjEzIHR0eS5jYwotLS0gdHR5LmNjCTIwMDAv
MTAvMTcgMDE6NDI6MDQJMS4xMworKysgdHR5LmNjCTIwMDEvMDIvMjggMTQ6
MTA6NDQKQEAgLTQwOSw0ICs0MDksNyBAQCB0dHk6OmNvbW1vbl9pbml0IChm
aGFuZGxlcl9wdHlfbWFzdGVyICpwCiAgICAgfQogCisgIGlmICghKHB0eW0t
PmlucHV0X2F2YWlsYWJsZV9ldmVudCA9IGdldF9ldmVudCAoSU5QVVRfQVZB
SUxBQkxFX0VWRU5ULCBGQUxTRSkpKQorICAgIHJldHVybiBGQUxTRTsKKwog
ICBjaGFyIGJ1Zls0MF07CiAgIF9fc21hbGxfc3ByaW50ZiAoYnVmLCBPVVRQ
VVRfTVVURVgsIG50dHkpOwpAQCAtNDE4LDUgKzQyMSwxNCBAQCB0dHk6OmNv
bW1vbl9pbml0IChmaGFuZGxlcl9wdHlfbWFzdGVyICpwCiAgICAgfQogCisg
IF9fc21hbGxfc3ByaW50ZiAoYnVmLCBJTlBVVF9NVVRFWCwgbnR0eSk7Cisg
IGlmICghKHB0eW0tPmlucHV0X211dGV4ID0gQ3JlYXRlTXV0ZXggKCZzZWNf
YWxsLCBGQUxTRSwgYnVmKSkpCisgICAgeworICAgICAgdGVybWlvc19wcmlu
dGYgKCJjYW4ndCBjcmVhdGUgJXMiLCBidWYpOworICAgICAgc2V0X2Vycm5v
IChFTk9FTlQpOworICAgICAgcmV0dXJuIEZBTFNFOworICAgIH0KKwogICBQ
cm90ZWN0SGFuZGxlMSAocHR5bS0+b3V0cHV0X211dGV4LCBvdXRwdXRfbXV0
ZXgpOworICBQcm90ZWN0SGFuZGxlMSAocHR5bS0+aW5wdXRfbXV0ZXgsIGlu
cHV0X211dGV4KTsKICAgd2luc2l6ZS53c19jb2wgPSA4MDsKICAgd2luc2l6
ZS53c19yb3cgPSAyNTsKSW5kZXg6IHR0eS5oCj09PT09PT09PT09PT09PT09
PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09
PT09PT0KUkNTIGZpbGU6IC9jdnMvc3JjL3NyYy93aW5zdXAvY3lnd2luL3R0
eS5oLHYKcmV0cmlldmluZyByZXZpc2lvbiAxLjIKZGlmZiAtdSAtcCAtMiAt
cjEuMiB0dHkuaAotLS0gdHR5LmgJMjAwMC8xMC8yNyAxNTozODozMgkxLjIK
KysrIHR0eS5oCTIwMDEvMDIvMjggMTQ6MTA6NDQKQEAgLTI0LDUgKzI0LDcg
QEAgZGV0YWlscy4gKi8KICNkZWZpbmUgSU9DVExfRE9ORV9FVkVOVAkiY3ln
dHR5JWQuaW9jdGwuZG9uZSIKICNkZWZpbmUgUkVTVEFSVF9PVVRQVVRfRVZF
TlQJImN5Z3R0eSVkLm91dHB1dC5yZXN0YXJ0IgorI2RlZmluZSBJTlBVVF9B
VkFJTEFCTEVfRVZFTlQJImN5Z3R0eSVkLmlucHV0LmF2YWlsIgogI2RlZmlu
ZSBPVVRQVVRfTVVURVgJCSJjeWd0dHklZC5vdXRwdXQubXV0ZXgiCisjZGVm
aW5lIElOUFVUX01VVEVYCQkiY3lndHR5JWQuaW5wdXQubXV0ZXgiCiAjZGVm
aW5lIFRUWV9TTEFWRV9BTElWRQkJImN5Z3R0eSV4LnNsYXZlX2FsaXZlIgog
I2RlZmluZSBUVFlfTUFTVEVSX0FMSVZFCSJjeWd0dHkleC5tYXN0ZXJfYWxp
dmUiCkBAIC0xMTAsNCArMTEyLDEwIEBAIHB1YmxpYzoKICAgICBjaGFyIGJ1
Zls4MF07CiAgICAgX19zbWFsbF9zcHJpbnRmIChidWYsIE9VVFBVVF9NVVRF
WCwgbnR0eSk7CisgICAgcmV0dXJuIE9wZW5NdXRleCAoTVVURVhfQUxMX0FD
Q0VTUywgaW5oZXJpdCwgYnVmKTsKKyAgfQorICBIQU5ETEUgb3Blbl9pbnB1
dF9tdXRleCAoQk9PTCBpbmhlcml0ID0gRkFMU0UpCisgIHsKKyAgICBjaGFy
IGJ1Zls4MF07CisgICAgX19zbWFsbF9zcHJpbnRmIChidWYsIElOUFVUX01V
VEVYLCBudHR5KTsKICAgICByZXR1cm4gT3Blbk11dGV4IChNVVRFWF9BTExf
QUNDRVNTLCBpbmhlcml0LCBidWYpOwogICB9Cg==

------------=_1583532846-65438-15--
