Return-Path: <cygwin-patches-return-8395-listarch-cygwin-patches=sources.redhat.com@cygwin.com>
Received: (qmail 9204 invoked by alias); 13 Mar 2016 21:37:25 -0000
Mailing-List: contact cygwin-patches-help@cygwin.com; run by ezmlm
Precedence: bulk
List-Id: <cygwin-patches.cygwin.com>
List-Subscribe: <mailto:cygwin-patches-subscribe@cygwin.com>
List-Post: <mailto:cygwin-patches@cygwin.com>
List-Archive: <http://sourceware.org/ml/cygwin-patches/>
List-Help: <mailto:cygwin-patches-help@cygwin.com>, <http://sourceware.org/ml/#faqs>
Sender: cygwin-patches-owner@cygwin.com
Mail-Followup-To: cygwin-patches@cygwin.com
Received: (qmail 9183 invoked by uid 89); 13 Mar 2016 21:37:24 -0000
Authentication-Results: sourceware.org; auth=none
X-Virus-Found: No
X-Spam-SWARE-Status: No, score=-0.0 required=5.0 tests=BAYES_40,SPF_HELO_PASS,SPF_PASS,TVD_RCVD_IP autolearn=ham version=3.3.2 spammy=sel, interrupted, alarm, wake
X-HELO: glup.org
Received: from 216-15-121-172.c3-0.smr-ubr2.sbo-smr.ma.static.cable.rcn.com (HELO glup.org) (216.15.121.172) by sourceware.org (qpsmtpd/0.93/v0.84-503-g423c35a) with (AES256-SHA encrypted) ESMTPS; Sun, 13 Mar 2016 21:37:20 +0000
Received: from minipixel.local (unknown [IPv6:2001:4830:1141:1:ae87:a3ff:fe0b:f9a8])	by glup.org (Postfix) with ESMTPSA id 0DA15854C4;	Sun, 13 Mar 2016 17:37:18 -0400 (EDT)
Authentication-Results: glup.org; dmarc=none header.from=glup.org
Subject: [PATCH] Re: Cygwin select() issues and improvements
To: cygwin-patches@cygwin.com
References: <56C03624.1030703@glup.org> <20160215125703.GE8374@calimero.vinschen.de> <56C66DDE.9070509@glup.org> <20160219104641.GA5574@calimero.vinschen.de> <20160304085843.GB8296@calimero.vinschen.de>
From: john hood <cgull@glup.org>
X-Enigmail-Draft-Status: N1010
Message-ID: <56E5DD8D.7060302@glup.org>
Date: Sun, 13 Mar 2016 21:37:00 -0000
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:38.0) Gecko/20100101 Thunderbird/38.6.0
MIME-Version: 1.0
In-Reply-To: <20160304085843.GB8296@calimero.vinschen.de>
Content-Type: multipart/mixed; boundary="------------060209090806070201090503"
X-SW-Source: 2016-q1/txt/msg00101.txt.bz2

This is a multi-part message in MIME format.
--------------060209090806070201090503
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: 8bit
Content-length: 556

On 3/4/16 3:58 AM, Corinna Vinschen wrote:
> John,
> 
> 
> Ping?  I'd be interested to get your patches into Cygwin.  select
> really needs some kicking :)

Sorry to be so slow responding.  Here's a rebased, squashed,
changelog-ified patch, and I've sent an assignment in to Red Hat.

Aside:  Why maintain Git comments in ChangeLog format?  That made sense
up into the CVS era, but now version control systems and viewers provide
most of the details that a ChangeLog needed to list, and newlib/Cygwin
has stopped maintaining ChangeLogs.

regards,

  --jh


--------------060209090806070201090503
Content-Type: text/plain; charset=UTF-8; x-mac-type="0"; x-mac-creator="0";
 name="0001-Improve-Cygwin-select-implementation.patch"
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
 filename="0001-Improve-Cygwin-select-implementation.patch"
Content-length: 24010

RnJvbSAwZTQwN2U0MjA2NzQ2ZDhhNmQxZWU5M2Q2ODBkYWVmYThhYzJmMDBi
IE1vbiBTZXAgMTcgMDA6MDA6MDAgMjAwMQpGcm9tOiBKb2huIEhvb2QgPGNn
dWxsQGdsdXAub3JnPgpEYXRlOiBUaHUsIDI4IEphbiAyMDE2IDE3OjA4OjM5
IC0wNTAwClN1YmplY3Q6IFtQQVRDSF0gSW1wcm92ZSBDeWd3aW4gc2VsZWN0
KCkgaW1wbGVtZW50YXRpb24uCgoJKiBmaGFuZGxlci5oOiAoZmhhbmRsZXJf
Y29uc29sZSkgTW92ZSBnZXRfbm9uYXNjaWlfa2V5KCkgZnJvbQoJc2VsZWN0
LmMgaW50byB0aGlzIGNsYXNzLgoJKiBmaGFuZGxlci5jYyAoZmhhbmRsZXJf
YmFzZTo6Z2V0X3JlYWRhaGVhZCk6IEFkZCBkZWJ1ZyBjb2RlLgoJKiBmaGFu
ZGxlcl9jb25zb2xlLmNjIChmaGFuZGxlcl9jb25zb2xlOjpyZWFkKTogQWRk
IGRlYnVnIGNvZGUuCgkqIHNlbGVjdC5oOiBFbGltaW5hdGUgcmVkdW5kYW50
IHNlbGVjdF9zdHVmZjo6c2VsZWN0X2xvb3Agc3RhdGUuCglDaGFuZ2UgcHJv
dG90eXBlIGZvciBzZWxlY3Rfc3R1ZmY6OndhaXQoKSBmb3IgbGFyZ2VyIG1p
Y3Jvc2Vjb25kCgl0aW1lb3V0cy4KCSogc2VsZWN0LmNjIChwc2VsZWN0KTog
Q29udmVydCBmcm9tIG9sZCBjeWd3aW5fc2VsZWN0KCkuCglJbXBsZW1lbnQg
bWljcm9zZWNvbmQgdGltZW91dHMuICBBZGQgZGVidWcgY29kZS4KCShjeWd3
aW5fc2VsZWN0KTogUmV3cml0ZSBhcyBhIHdyYXBwZXIgb24gcHNlbGVjdCgp
LgoJKHNlbGVjdCk6IEltcGxlbWVudCBtaWNyb3NlY29uZCB0aW1lb3V0cy4g
IEVsaW1pbmF0ZSByZWR1bmRhbnQKCXNlbGVjdF9zdHVmZjo6c2VsZWN0X2xv
b3Agc3RhdGUuICBFbGltaW5hdGUgcmVkdW5kYW50IGNvZGUgZm9yCgl6ZXJv
IHRpbWVvdXQuICBEbyBub3QgcmV0dXJuIGVhcmx5IG9uIGVhcmx5IHRpbWVy
IHJldHVybi4KCShzZWxlY3Rfc3R1ZmY6OndhaXQpOiBJbXBsZW1lbnQgbWlj
cm9zZWNvbmQgdGltZW91dHMgd2l0aCBhIHRpbWVyCglvYmplY3QuICBFbGlt
aW5hdGUgcmVkdW5kYW50IHNlbGVjdF9zdHVmZjo6c2VsZWN0X2xvb3Agc3Rh
dGUuCgkocGVla19jb25zb2xlKTogTW92ZSBnZXRfbm9uYXNjaWlfa2V5KCkg
aW50byBmaGFuZGxlcl9jb25zb2xlCgljbGFzcy4gIEFkZCBkZWJ1ZyBjb2Rl
LgotLS0KIHdpbnN1cC9jeWd3aW4vZmhhbmRsZXIuY2MgICAgICAgICB8ICAg
MSArCiB3aW5zdXAvY3lnd2luL2ZoYW5kbGVyLmggICAgICAgICAgfCAgIDEg
Kwogd2luc3VwL2N5Z3dpbi9maGFuZGxlcl9jb25zb2xlLmNjIHwgIDEzICst
CiB3aW5zdXAvY3lnd2luL3NlbGVjdC5jYyAgICAgICAgICAgfCAyNTQgKysr
KysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0KIHdpbnN1cC9j
eWd3aW4vc2VsZWN0LmggICAgICAgICAgICB8ICAgMyArLQogd2luc3VwL3Rl
c3RzdWl0ZS9jb25maWd1cmUgICAgICAgIHwgICAwCiA2IGZpbGVzIGNoYW5n
ZWQsIDE0OSBpbnNlcnRpb25zKCspLCAxMjMgZGVsZXRpb25zKC0pCiBtb2Rl
IGNoYW5nZSAxMDA2NDQgPT4gMTAwNzU1IHdpbnN1cC90ZXN0c3VpdGUvY29u
ZmlndXJlCgpkaWZmIC0tZ2l0IGEvd2luc3VwL2N5Z3dpbi9maGFuZGxlci5j
YyBiL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXIuY2MKaW5kZXggMzM3NDNkNC4u
ODZmNzdjMyAxMDA2NDQKLS0tIGEvd2luc3VwL2N5Z3dpbi9maGFuZGxlci5j
YworKysgYi93aW5zdXAvY3lnd2luL2ZoYW5kbGVyLmNjCkBAIC05MCw2ICs5
MCw3IEBAIGZoYW5kbGVyX2Jhc2U6OmdldF9yZWFkYWhlYWQgKCkKICAgLyog
RklYTUUgLSBub3QgdGhyZWFkIHNhZmUgKi8KICAgaWYgKHJhaXhnZXQgPj0g
cmFsZW4pCiAgICAgcmFpeGdldCA9IHJhaXhwdXQgPSByYWxlbiA9IDA7Cisg
IGRlYnVnX3ByaW50ZigiYXZhaWxhYmxlOiAlZCIsIGNocmV0ID4gLTEpOwog
ICByZXR1cm4gY2hyZXQ7CiB9CiAKZGlmZiAtLWdpdCBhL3dpbnN1cC9jeWd3
aW4vZmhhbmRsZXIuaCBiL3dpbnN1cC9jeWd3aW4vZmhhbmRsZXIuaAppbmRl
eCAxMzRmZDcxLi5iYWQ2M2YyIDEwMDY0NAotLS0gYS93aW5zdXAvY3lnd2lu
L2ZoYW5kbGVyLmgKKysrIGIvd2luc3VwL2N5Z3dpbi9maGFuZGxlci5oCkBA
IC0xNDYzLDYgKzE0NjMsNyBAQCBwcml2YXRlOgogICBib29sIHNldF91bml0
ICgpOwogICBzdGF0aWMgYm9vbCBuZWVkX2ludmlzaWJsZSAoKTsKICAgc3Rh
dGljIHZvaWQgZnJlZV9jb25zb2xlICgpOworICBzdGF0aWMgY29uc3QgY2hh
ciAqZ2V0X25vbmFzY2lpX2tleSAoSU5QVVRfUkVDT1JEJiBpbnB1dF9yZWMs
IGNoYXIgKik7CiAKICAgZmhhbmRsZXJfY29uc29sZSAodm9pZCAqKSB7fQog
CmRpZmYgLS1naXQgYS93aW5zdXAvY3lnd2luL2ZoYW5kbGVyX2NvbnNvbGUu
Y2MgYi93aW5zdXAvY3lnd2luL2ZoYW5kbGVyX2NvbnNvbGUuY2MKaW5kZXgg
YTUyNDQ5ZS4uM2NmMmY0MSAxMDA2NDQKLS0tIGEvd2luc3VwL2N5Z3dpbi9m
aGFuZGxlcl9jb25zb2xlLmNjCisrKyBiL3dpbnN1cC9jeWd3aW4vZmhhbmRs
ZXJfY29uc29sZS5jYwpAQCAtNDYsOCArNDYsNiBAQCBkZXRhaWxzLiAqLwog
I2RlZmluZSBzclRvcCAoY29uLmIuc3JXaW5kb3cuVG9wICsgY29uLnNjcm9s
bF9yZWdpb24uVG9wKQogI2RlZmluZSBzckJvdHRvbSAoKGNvbi5zY3JvbGxf
cmVnaW9uLkJvdHRvbSA8IDApID8gY29uLmIuc3JXaW5kb3cuQm90dG9tIDog
Y29uLmIuc3JXaW5kb3cuVG9wICsgY29uLnNjcm9sbF9yZWdpb24uQm90dG9t
KQogCi1jb25zdCBjaGFyICpnZXRfbm9uYXNjaWlfa2V5IChJTlBVVF9SRUNP
UkQmLCBjaGFyICopOwotCiBjb25zdCB1bnNpZ25lZCBmaGFuZGxlcl9jb25z
b2xlOjpNQVhfV1JJVEVfQ0hBUlMgPSAxNjM4NDsKIAogZmhhbmRsZXJfY29u
c29sZTo6Y29uc29sZV9zdGF0ZSBOT19DT1BZICpmaGFuZGxlcl9jb25zb2xl
OjpzaGFyZWRfY29uc29sZV9pbmZvOwpAQCAtMzEwLDcgKzMwOCw5IEBAIGZo
YW5kbGVyX2NvbnNvbGU6OnJlYWQgKHZvaWQgKnB2LCBzaXplX3QmIGJ1Zmxl
bikKICAgaW50IGNoOwogICBzZXRfaW5wdXRfc3RhdGUgKCk7CiAKKyAgZGVi
dWdfcHJpbnRmKCJyZXF1ZXN0ZWQgYnVmbGVuICVkIiwgYnVmbGVuKTsKICAg
aW50IGNvcGllZF9jaGFycyA9IGdldF9yZWFkYWhlYWRfaW50b19idWZmZXIg
KGJ1ZiwgYnVmbGVuKTsKKyAgZGVidWdfcHJpbnRmKCJjb3BpZWRfY2hhcnMg
JWQiLCBjb3BpZWRfY2hhcnMpOwogCiAgIGlmIChjb3BpZWRfY2hhcnMpCiAg
ICAgewpAQCAtNjg4LDkgKzY4OCwxMSBAQCBmaGFuZGxlcl9jb25zb2xlOjpy
ZWFkICh2b2lkICpwdiwgc2l6ZV90JiBidWZsZW4pCiAJICBjb250aW51ZTsK
IAl9CiAKKyAgICAgIGRlYnVnX3ByaW50ZigidG9hZGQgPSAlcCwgbnJlYWQg
PSAlZCIsIHRvYWRkLCBucmVhZCk7CiAgICAgICBpZiAodG9hZGQpCiAJewot
CSAgbGluZV9lZGl0X3N0YXR1cyByZXMgPSBsaW5lX2VkaXQgKHRvYWRkLCBu
cmVhZCwgdGkpOworCSAgc3NpemVfdCBieXRlc19yZWFkOworCSAgbGluZV9l
ZGl0X3N0YXR1cyByZXMgPSBsaW5lX2VkaXQgKHRvYWRkLCBucmVhZCwgdGks
ICZieXRlc19yZWFkKTsKIAkgIGlmIChyZXMgPT0gbGluZV9lZGl0X3NpZ25h
bGxlZCkKIAkgICAgZ290byBzaWdfZXhpdDsKIAkgIGVsc2UgaWYgKHJlcyA9
PSBsaW5lX2VkaXRfaW5wdXRfZG9uZSkKQEAgLTY5OCw2ICs3MDAsOCBAQCBm
aGFuZGxlcl9jb25zb2xlOjpyZWFkICh2b2lkICpwdiwgc2l6ZV90JiBidWZs
ZW4pCiAJfQogICAgIH0KIAorICBkZWJ1Z19wcmludGYoInJhbGVuID0gJWQs
IGJ5dGVzID0gJWQiLCByYWxlbiwgcmFsZW4gLSByYWl4Z2V0KTsKKwogICB3
aGlsZSAoYnVmbGVuKQogICAgIGlmICgoY2ggPSBnZXRfcmVhZGFoZWFkICgp
KSA8IDApCiAgICAgICBicmVhazsKQEAgLTcwOSw2ICs3MTMsNyBAQCBmaGFu
ZGxlcl9jb25zb2xlOjpyZWFkICh2b2lkICpwdiwgc2l6ZV90JiBidWZsZW4p
CiAjdW5kZWYgYnVmCiAKICAgYnVmbGVuID0gY29waWVkX2NoYXJzOworICBk
ZWJ1Z19wcmludGYoImJ1ZmxlbiBzZXQgdG8gJWQiLCBidWZsZW4pOwogICBy
ZXR1cm47CiAKIGVycjoKQEAgLTIzNzcsNyArMjM4Miw3IEBAIHN0YXRpYyBj
b25zdCBzdHJ1Y3QgewogfTsKIAogY29uc3QgY2hhciAqCi1nZXRfbm9uYXNj
aWlfa2V5IChJTlBVVF9SRUNPUkQmIGlucHV0X3JlYywgY2hhciAqdG1wKQor
ZmhhbmRsZXJfY29uc29sZTo6Z2V0X25vbmFzY2lpX2tleSAoSU5QVVRfUkVD
T1JEJiBpbnB1dF9yZWMsIGNoYXIgKnRtcCkKIHsKICNkZWZpbmUgTk9STUFM
ICAwCiAjZGVmaW5lIFNISUZUCTEKZGlmZiAtLWdpdCBhL3dpbnN1cC9jeWd3
aW4vc2VsZWN0LmNjIGIvd2luc3VwL2N5Z3dpbi9zZWxlY3QuY2MKaW5kZXgg
ZTFkNDhhMy4uNGJmYzQ4NCAxMDA2NDQKLS0tIGEvd2luc3VwL2N5Z3dpbi9z
ZWxlY3QuY2MKKysrIGIvd2luc3VwL2N5Z3dpbi9zZWxlY3QuY2MKQEAgLTMy
LDcgKzMyLDYgQEAgZGV0YWlscy4gKi8KICNpbmNsdWRlICJwaW5mby5oIgog
I2luY2x1ZGUgInNpZ3Byb2MuaCIKICNpbmNsdWRlICJjeWd0bHMuaCIKLSNp
bmNsdWRlICJjeWd3YWl0LmgiCiAKIC8qCiAgKiBBbGwgdGhlc2UgZGVmaW5l
cyBiZWxvdyBzaG91bGQgYmUgaW4gc3lzL3R5cGVzLmgKQEAgLTg1LDQxICs4
NCw2OCBAQCBkZXRhaWxzLiAqLwogICAgICAgcmV0dXJuIC0xOyBcCiAgICAg
fQogCi1zdGF0aWMgaW50IHNlbGVjdCAoaW50LCBmZF9zZXQgKiwgZmRfc2V0
ICosIGZkX3NldCAqLCBEV09SRCk7CitzdGF0aWMgaW50IHNlbGVjdCAoaW50
LCBmZF9zZXQgKiwgZmRfc2V0ICosIGZkX3NldCAqLCBMT05HTE9ORyk7CiAK
IC8qIFRoZSBtYWluIHNlbGVjdCBjb2RlLiAgKi8KIGV4dGVybiAiQyIgaW50
Ci1jeWd3aW5fc2VsZWN0IChpbnQgbWF4ZmRzLCBmZF9zZXQgKnJlYWRmZHMs
IGZkX3NldCAqd3JpdGVmZHMsIGZkX3NldCAqZXhjZXB0ZmRzLAotCSAgICAg
ICBzdHJ1Y3QgdGltZXZhbCAqdG8pCitwc2VsZWN0KGludCBtYXhmZHMsIGZk
X3NldCAqcmVhZGZkcywgZmRfc2V0ICp3cml0ZWZkcywgZmRfc2V0ICpleGNl
cHRmZHMsCisJY29uc3Qgc3RydWN0IHRpbWVzcGVjICp0bywgY29uc3Qgc2ln
c2V0X3QgKnNldCkKIHsKLSAgc2VsZWN0X3ByaW50ZiAoInNlbGVjdCglZCwg
JXAsICVwLCAlcCwgJXApIiwgbWF4ZmRzLCByZWFkZmRzLCB3cml0ZWZkcywg
ZXhjZXB0ZmRzLCB0byk7CisgIHNpZ3NldF90IG9sZHNldCA9IF9teV90bHMu
c2lnbWFzazsKIAotICBwdGhyZWFkX3Rlc3RjYW5jZWwgKCk7Ci0gIGludCBy
ZXM7Ci0gIGlmIChtYXhmZHMgPCAwKQotICAgIHsKLSAgICAgIHNldF9lcnJu
byAoRUlOVkFMKTsKLSAgICAgIHJlcyA9IC0xOwotICAgIH0KLSAgZWxzZQor
ICBfX3RyeQogICAgIHsKLSAgICAgIC8qIENvbnZlcnQgdG8gbWlsbGlzZWNv
bmRzIG9yIElORklOSVRFIGlmIHRvID09IE5VTEwgKi8KLSAgICAgIERXT1JE
IG1zID0gdG8gPyAodG8tPnR2X3NlYyAqIDEwMDApICsgKHRvLT50dl91c2Vj
IC8gMTAwMCkgOiBJTkZJTklURTsKLSAgICAgIGlmIChtcyA9PSAwICYmIHRv
LT50dl91c2VjKQotCW1zID0gMTsJCQkvKiBBdCBsZWFzdCAxIG1zIGdyYW51
bGFyaXR5ICovCisgICAgICBpZiAoc2V0KQorCXNldF9zaWduYWxfbWFzayAo
X215X3Rscy5zaWdtYXNrLCAqc2V0KTsKKworICAgICAgc2VsZWN0X3ByaW50
ZiAoInBzZWxlY3QoJWQsICVwLCAlcCwgJXAsICVwLCAlcCkiLCBtYXhmZHMs
IHJlYWRmZHMsIHdyaXRlZmRzLCBleGNlcHRmZHMsIHRvLCBzZXQpOwogCi0g
ICAgICBpZiAodG8pCi0Jc2VsZWN0X3ByaW50ZiAoInRvLT50dl9zZWMgJWxk
LCB0by0+dHZfdXNlYyAlbGQsIG1zICVkIiwgdG8tPnR2X3NlYywgdG8tPnR2
X3VzZWMsIG1zKTsKKyAgICAgIHB0aHJlYWRfdGVzdGNhbmNlbCAoKTsKKyAg
ICAgIGludCByZXM7CisgICAgICBpZiAobWF4ZmRzIDwgMCkKKwl7CisJICBz
ZXRfZXJybm8gKEVJTlZBTCk7CisJICByZXMgPSAtMTsKKwl9CiAgICAgICBl
bHNlCi0Jc2VsZWN0X3ByaW50ZiAoInRvIE5VTEwsIG1zICV4IiwgbXMpOwor
CXsKKwkgIC8qIENvbnZlcnQgdG8gbWljcm9zZWNvbmRzIG9yIC0xIGlmIHRv
ID09IE5VTEwgKi8KKwkgIExPTkdMT05HIHVzID0gdG8gPyB0by0+dHZfc2Vj
ICogMTAwMDAwMExMICsgKHRvLT50dl9uc2VjICsgOTk5KSAvIDEwMDAgOiAt
MUxMOwogCi0gICAgICByZXMgPSBzZWxlY3QgKG1heGZkcywgcmVhZGZkcyA/
OiBhbGxvY2ZkX3NldCAobWF4ZmRzKSwKLQkJICAgIHdyaXRlZmRzID86IGFs
bG9jZmRfc2V0IChtYXhmZHMpLAotCQkgICAgZXhjZXB0ZmRzID86IGFsbG9j
ZmRfc2V0IChtYXhmZHMpLCBtcyk7CisJICBpZiAodG8pCisJICAgIHNlbGVj
dF9wcmludGYgKCJ0by0+dHZfc2VjICVsZCwgdG8tPnR2X25zZWMgJWxkLCB1
cyAlbGxkIiwgdG8tPnR2X3NlYywgdG8tPnR2X25zZWMsIHVzKTsKKwkgIGVs
c2UKKwkgICAgc2VsZWN0X3ByaW50ZiAoInRvIE5VTEwsIHVzICVsbGQiLCB1
cyk7CisKKwkgIHJlcyA9IHNlbGVjdCAobWF4ZmRzLCByZWFkZmRzID86IGFs
bG9jZmRfc2V0IChtYXhmZHMpLAorCQkJd3JpdGVmZHMgPzogYWxsb2NmZF9z
ZXQgKG1heGZkcyksCisJCQlleGNlcHRmZHMgPzogYWxsb2NmZF9zZXQgKG1h
eGZkcyksIHVzKTsKKwl9CisgICAgICBzeXNjYWxsX3ByaW50ZiAoIiVSID0g
c2VsZWN0KCVkLCAlcCwgJXAsICVwLCAlcCkiLCByZXMsIG1heGZkcywgcmVh
ZGZkcywKKwkJICAgICAgd3JpdGVmZHMsIGV4Y2VwdGZkcywgdG8pOworCisg
ICAgICBpZiAoc2V0KQorCXNldF9zaWduYWxfbWFzayAoX215X3Rscy5zaWdt
YXNrLCBvbGRzZXQpOworICAgICAgcmV0dXJuIHJlczsKICAgICB9Ci0gIHN5
c2NhbGxfcHJpbnRmICgiJVIgPSBzZWxlY3QoJWQsICVwLCAlcCwgJXAsICVw
KSIsIHJlcywgbWF4ZmRzLCByZWFkZmRzLAotCQkgIHdyaXRlZmRzLCBleGNl
cHRmZHMsIHRvKTsKLSAgcmV0dXJuIHJlczsKKyAgX19leGNlcHQgKEVGQVVM
VCkge30KKyAgX19lbmR0cnkKKyAgcmV0dXJuIC0xOworfQorCisvKiBzZWxl
Y3QoKSBpcyBqdXN0IGEgd3JhcHBlciBvbiBwc2VsZWN0KCkuICovCitleHRl
cm4gIkMiIGludAorY3lnd2luX3NlbGVjdCAoaW50IG1heGZkcywgZmRfc2V0
ICpyZWFkZmRzLCBmZF9zZXQgKndyaXRlZmRzLCBmZF9zZXQgKmV4Y2VwdGZk
cywKKwkgICAgICAgc3RydWN0IHRpbWV2YWwgKnRvKQoreworICBzdHJ1Y3Qg
dGltZXNwZWMgdHM7CisgIGlmICh0bykKKyAgICB7CisgICAgICB0cy50dl9z
ZWMgPSB0by0+dHZfc2VjOworICAgICAgdHMudHZfbnNlYyA9IHRvLT50dl91
c2VjICogMTAwMDsKKyAgICB9CisgIHJldHVybiBwc2VsZWN0IChtYXhmZHMs
IHJlYWRmZHMsIHdyaXRlZmRzLCBleGNlcHRmZHMsCisJCSAgdG8gPyAmdHMg
OiBOVUxMLCBOVUxMKTsKIH0KIAogLyogVGhpcyBmdW5jdGlvbiBpcyBhcmJp
dHJhcmlseSBzcGxpdCBvdXQgZnJvbSBjeWd3aW5fc2VsZWN0IHRvIGF2b2lk
IG9kZApAQCAtMTI3LDEzICsxNTMsMTMgQEAgY3lnd2luX3NlbGVjdCAoaW50
IG1heGZkcywgZmRfc2V0ICpyZWFkZmRzLCBmZF9zZXQgKndyaXRlZmRzLCBm
ZF9zZXQgKmV4Y2VwdGZkcywKICAgIGZvciB0aGUgc2VsIHZhcmlhYmxlLiAg
Ki8KIHN0YXRpYyBpbnQKIHNlbGVjdCAoaW50IG1heGZkcywgZmRfc2V0ICpy
ZWFkZmRzLCBmZF9zZXQgKndyaXRlZmRzLCBmZF9zZXQgKmV4Y2VwdGZkcywK
LQlEV09SRCBtcykKKwlMT05HTE9ORyB1cykKIHsKLSAgc2VsZWN0X3N0dWZm
Ojp3YWl0X3N0YXRlcyB3YWl0X3N0YXRlID0gc2VsZWN0X3N0dWZmOjpzZWxl
Y3RfbG9vcDsKKyAgc2VsZWN0X3N0dWZmOjp3YWl0X3N0YXRlcyB3YWl0X3N0
YXRlID0gc2VsZWN0X3N0dWZmOjpzZWxlY3Rfc2V0X3plcm87CiAgIGludCBy
ZXQgPSAwOwogCiAgIC8qIFJlY29yZCB0aGUgY3VycmVudCB0aW1lIGZvciBs
YXRlciB1c2UuICovCi0gIExPTkdMT05HIHN0YXJ0X3RpbWUgPSBndG9kLm1z
ZWNzICgpOworICBMT05HTE9ORyBzdGFydF90aW1lID0gZ3RvZC51c2VjcyAo
KTsKIAogICBzZWxlY3Rfc3R1ZmYgc2VsOwogICBzZWwucmV0dXJuX29uX3Np
Z25hbCA9IDA7CkBAIC0xNTUsNjUgKzE4MSwzNyBAQCBzZWxlY3QgKGludCBt
YXhmZHMsIGZkX3NldCAqcmVhZGZkcywgZmRfc2V0ICp3cml0ZWZkcywgZmRf
c2V0ICpleGNlcHRmZHMsCiAJICB9CiAgICAgICBzZWxlY3RfcHJpbnRmICgi
c2VsLmFsd2F5c19yZWFkeSAlZCIsIHNlbC5hbHdheXNfcmVhZHkpOwogCi0g
ICAgICAvKiBEZWdlbmVyYXRlIGNhc2UuICBObyBmZHMgdG8gd2FpdCBmb3Iu
ICBKdXN0IHdhaXQgZm9yIHRpbWUgdG8gcnVuIG91dAotCSBvciBzaWduYWwg
dG8gYXJyaXZlLiAqLwotICAgICAgaWYgKHNlbC5zdGFydC5uZXh0ID09IE5V
TEwpCi0Jc3dpdGNoIChjeWd3YWl0IChtcykpCi0JICB7Ci0JICBjYXNlIFdB
SVRfU0lHTkFMRUQ6Ci0JICAgIHNlbGVjdF9wcmludGYgKCJzaWduYWwgcmVj
ZWl2ZWQiKTsKLQkgICAgLyogc2VsZWN0KCkgaXMgYWx3YXlzIGludGVycnVw
dGVkIGJ5IGEgc2lnbmFsIHNvIHNldCBFSU5UUiwKLQkgICAgICAgdW5jb25k
aXRpb25hbGx5LCBpZ25vcmluZyBhbnkgU0FfUkVTVEFSVCBkZXRlY3Rpb24g
YnkKLQkgICAgICAgY2FsbF9zaWduYWxfaGFuZGxlcigpLiAgKi8KLQkgICAg
X215X3Rscy5jYWxsX3NpZ25hbF9oYW5kbGVyICgpOwotCSAgICBzZXRfc2ln
X2Vycm5vIChFSU5UUik7Ci0JICAgIHdhaXRfc3RhdGUgPSBzZWxlY3Rfc3R1
ZmY6OnNlbGVjdF9zaWduYWxsZWQ7Ci0JICAgIGJyZWFrOwotCSAgY2FzZSBX
QUlUX0NBTkNFTEVEOgotCSAgICBzZWwuZGVzdHJveSAoKTsKLQkgICAgcHRo
cmVhZDo6c3RhdGljX2NhbmNlbF9zZWxmICgpOwotCSAgICAvKk5PVFJFQUNI
RUQqLwotCSAgZGVmYXVsdDoKLQkgICAgLyogU2V0IHdhaXRfc3RhdGUgdG8g
emVybyBiZWxvdy4gKi8KLQkgICAgd2FpdF9zdGF0ZSA9IHNlbGVjdF9zdHVm
Zjo6c2VsZWN0X3NldF96ZXJvOwotCSAgICBicmVhazsKLQkgIH0KLSAgICAg
IGVsc2UgaWYgKHNlbC5hbHdheXNfcmVhZHkgfHwgbXMgPT0gMCkKKyAgICAg
IGlmIChzZWwuYWx3YXlzX3JlYWR5IHx8IHVzID09IDApCiAJLyogQ2F0Y2gg
YW55IGFjdGl2ZSBmZHMgdmlhIHNlbC5wb2xsKCkgYmVsb3cgKi8KIAl3YWl0
X3N0YXRlID0gc2VsZWN0X3N0dWZmOjpzZWxlY3Rfb2s7CiAgICAgICBlbHNl
CiAJLyogd2FpdCBmb3IgYW4gZmQgdG8gYmVjb21lIGFjdGl2ZSBvciB0aW1l
IG91dCAqLwotCXdhaXRfc3RhdGUgPSBzZWwud2FpdCAociwgdywgZSwgbXMp
OworCXdhaXRfc3RhdGUgPSBzZWwud2FpdCAociwgdywgZSwgdXMpOwogCiAg
ICAgICBzZWxlY3RfcHJpbnRmICgic2VsLndhaXQgcmV0dXJucyAlZCIsIHdh
aXRfc3RhdGUpOwogCi0gICAgICBpZiAod2FpdF9zdGF0ZSA+PSBzZWxlY3Rf
c3R1ZmY6OnNlbGVjdF9vaykKKyAgICAgIGlmICh3YWl0X3N0YXRlID09IHNl
bGVjdF9zdHVmZjo6c2VsZWN0X29rKQogCXsKIAkgIFVOSVhfRkRfWkVSTyAo
cmVhZGZkcywgbWF4ZmRzKTsKIAkgIFVOSVhfRkRfWkVSTyAod3JpdGVmZHMs
IG1heGZkcyk7CiAJICBVTklYX0ZEX1pFUk8gKGV4Y2VwdGZkcywgbWF4ZmRz
KTsKLQkgIGlmICh3YWl0X3N0YXRlID09IHNlbGVjdF9zdHVmZjo6c2VsZWN0
X3NldF96ZXJvKQotCSAgICByZXQgPSAwOwotCSAgZWxzZQotCSAgICB7Ci0J
ICAgICAgLyogU2V0IGJpdCBtYXNrIGZyb20gc2VsIHJlY29yZHMuICBUaGlz
IGFsc28gc2V0cyByZXQgdG8gdGhlCi0JCSByaWdodCB2YWx1ZSA+PSAwLCBt
YXRjaGluZyB0aGUgbnVtYmVyIG9mIGJpdHMgc2V0IGluIHRoZQotCQkgZmRz
IHJlY29yZHMuICBpZiByZXQgaXMgMCwgY29udGludWUgdG8gbG9vcC4gKi8K
LQkgICAgICByZXQgPSBzZWwucG9sbCAocmVhZGZkcywgd3JpdGVmZHMsIGV4
Y2VwdGZkcyk7Ci0JICAgICAgaWYgKCFyZXQpCi0JCXdhaXRfc3RhdGUgPSBz
ZWxlY3Rfc3R1ZmY6OnNlbGVjdF9sb29wOwotCSAgICB9CisJICAvKiBTZXQg
Yml0IG1hc2sgZnJvbSBzZWwgcmVjb3Jkcy4gIFRoaXMgYWxzbyBzZXRzIHJl
dCB0byB0aGUKKwkgICAgIHJpZ2h0IHZhbHVlID49IDAsIG1hdGNoaW5nIHRo
ZSBudW1iZXIgb2YgYml0cyBzZXQgaW4gdGhlCisJICAgICBmZHMgcmVjb3Jk
cy4gIGlmIHJldCBpcyAwLCBjb250aW51ZSB0byBsb29wLiAqLworCSAgcmV0
ID0gc2VsLnBvbGwgKHJlYWRmZHMsIHdyaXRlZmRzLCBleGNlcHRmZHMpOwor
CSAgaWYgKCFyZXQpCisJICAgIHdhaXRfc3RhdGUgPSBzZWxlY3Rfc3R1ZmY6
OnNlbGVjdF9zZXRfemVybzsKIAl9CiAgICAgICAvKiBBbHdheXMgY2xlYW4g
dXAgZXZlcnl0aGluZyBoZXJlLiAgSWYgd2UncmUgbG9vcGluZyB0aGVuIGJ1
aWxkIGl0CiAJIGFsbCB1cCBhZ2Fpbi4gICovCiAgICAgICBzZWwuY2xlYW51
cCAoKTsKICAgICAgIHNlbC5kZXN0cm95ICgpOwotICAgICAgLyogUmVjYWxj
dWxhdGUgdGltZSByZW1haW5pbmcgdG8gd2FpdCBpZiB3ZSBhcmUgZ29pbmcg
dG8gYmUgbG9vcGluZy4gKi8KLSAgICAgIGlmICh3YWl0X3N0YXRlID09IHNl
bGVjdF9zdHVmZjo6c2VsZWN0X2xvb3AgJiYgbXMgIT0gSU5GSU5JVEUpCisg
ICAgICAvKiBDaGVjayBhbmQgcmVjYWxjdWxhdGUgdGltZW91dC4gKi8KKyAg
ICAgIGlmICh1cyAhPSAtMUxMICYmIHdhaXRfc3RhdGUgPT0gc2VsZWN0X3N0
dWZmOjpzZWxlY3Rfc2V0X3plcm8pCiAJewotCSAgc2VsZWN0X3ByaW50ZiAo
InJlY2FsY3VsYXRpbmcgbXMiKTsKLQkgIExPTkdMT05HIG5vdyA9IGd0b2Qu
bXNlY3MgKCk7Ci0JICBpZiAobm93ID4gKHN0YXJ0X3RpbWUgKyBtcykpCisJ
ICBzZWxlY3RfcHJpbnRmICgicmVjYWxjdWxhdGluZyB1cyIpOworCSAgTE9O
R0xPTkcgbm93ID0gZ3RvZC51c2VjcyAoKTsKKwkgIGlmIChub3cgPiAoc3Rh
cnRfdGltZSArIHVzKSkKIAkgICAgewogCSAgICAgIHNlbGVjdF9wcmludGYg
KCJ0aW1lZCBvdXQgYWZ0ZXIgdmVyaWZpY2F0aW9uIik7CiAJICAgICAgLyog
U2V0IGRlc2NyaXB0b3IgYml0cyB0byB6ZXJvIHBlciBQT1NJWC4gKi8KQEAg
LTIyNSw0NiArMjIzLDE5IEBAIHNlbGVjdCAoaW50IG1heGZkcywgZmRfc2V0
ICpyZWFkZmRzLCBmZF9zZXQgKndyaXRlZmRzLCBmZF9zZXQgKmV4Y2VwdGZk
cywKIAkgICAgfQogCSAgZWxzZQogCSAgICB7Ci0JICAgICAgbXMgLT0gKG5v
dyAtIHN0YXJ0X3RpbWUpOworCSAgICAgIHVzIC09IChub3cgLSBzdGFydF90
aW1lKTsKIAkgICAgICBzdGFydF90aW1lID0gbm93OwotCSAgICAgIHNlbGVj
dF9wcmludGYgKCJtcyBub3cgJXUiLCBtcyk7CisJICAgICAgc2VsZWN0X3By
aW50ZiAoInVzIG5vdyAlbGxkIiwgdXMpOwogCSAgICB9CiAJfQogICAgIH0K
LSAgd2hpbGUgKHdhaXRfc3RhdGUgPT0gc2VsZWN0X3N0dWZmOjpzZWxlY3Rf
bG9vcCk7CisgIHdoaWxlICh3YWl0X3N0YXRlID09IHNlbGVjdF9zdHVmZjo6
c2VsZWN0X3NldF96ZXJvKTsKIAogICBpZiAod2FpdF9zdGF0ZSA8IHNlbGVj
dF9zdHVmZjo6c2VsZWN0X29rKQogICAgIHJldCA9IC0xOwogICByZXR1cm4g
cmV0OwogfQogCi1leHRlcm4gIkMiIGludAotcHNlbGVjdChpbnQgbWF4ZmRz
LCBmZF9zZXQgKnJlYWRmZHMsIGZkX3NldCAqd3JpdGVmZHMsIGZkX3NldCAq
ZXhjZXB0ZmRzLAotCWNvbnN0IHN0cnVjdCB0aW1lc3BlYyAqdHMsIGNvbnN0
IHNpZ3NldF90ICpzZXQpCi17Ci0gIHN0cnVjdCB0aW1ldmFsIHR2OwotICBz
aWdzZXRfdCBvbGRzZXQgPSBfbXlfdGxzLnNpZ21hc2s7Ci0KLSAgX190cnkK
LSAgICB7Ci0gICAgICBpZiAodHMpCi0JewotCSAgdHYudHZfc2VjID0gdHMt
PnR2X3NlYzsKLQkgIHR2LnR2X3VzZWMgPSB0cy0+dHZfbnNlYyAvIDEwMDA7
Ci0JfQotICAgICAgaWYgKHNldCkKLQlzZXRfc2lnbmFsX21hc2sgKF9teV90
bHMuc2lnbWFzaywgKnNldCk7Ci0gICAgICBpbnQgcmV0ID0gY3lnd2luX3Nl
bGVjdCAobWF4ZmRzLCByZWFkZmRzLCB3cml0ZWZkcywgZXhjZXB0ZmRzLAot
CQkJICAgICAgIHRzID8gJnR2IDogTlVMTCk7Ci0gICAgICBpZiAoc2V0KQot
CXNldF9zaWduYWxfbWFzayAoX215X3Rscy5zaWdtYXNrLCBvbGRzZXQpOwot
ICAgICAgcmV0dXJuIHJldDsKLSAgICB9Ci0gIF9fZXhjZXB0IChFRkFVTFQp
IHt9Ci0gIF9fZW5kdHJ5Ci0gIHJldHVybiAtMTsKLX0KLQogLyogQ2FsbCBj
bGVhbnVwIGZ1bmN0aW9ucyBmb3IgYWxsIGluc3BlY3RlZCBmZHMuICBHZXRz
IHJpZCBvZiBhbnkKICAgIGV4ZWN1dGluZyB0aHJlYWRzLiAqLwogdm9pZApA
QCAtMzYyLDEzICszMzMsNTAgQEAgZXJyOgogLyogVGhlIGhlYXJ0IG9mIHNl
bGVjdC4gIFdhaXRzIGZvciBhbiBmZCB0byBkbyBzb21ldGhpbmcgaW50ZXJl
c3RpbmcuICovCiBzZWxlY3Rfc3R1ZmY6OndhaXRfc3RhdGVzCiBzZWxlY3Rf
c3R1ZmY6OndhaXQgKGZkX3NldCAqcmVhZGZkcywgZmRfc2V0ICp3cml0ZWZk
cywgZmRfc2V0ICpleGNlcHRmZHMsCi0JCSAgICBEV09SRCBtcykKKwkJICAg
IExPTkdMT05HIHVzKQogewogICBIQU5ETEUgdzRbTUFYSU1VTV9XQUlUX09C
SkVDVFNdOwogICBzZWxlY3RfcmVjb3JkICpzID0gJnN0YXJ0OwogICBEV09S
RCBtID0gMDsKIAorICAvKiBBbHdheXMgd2FpdCBmb3Igc2lnbmFscy4gKi8K
ICAgd2FpdF9zaWduYWxfYXJyaXZlZCBoZXJlICh3NFttKytdKTsKKworICAv
KiBTZXQgYSB0aW1lb3V0LCBvciBub3QsIGZvciBXTUZPLiAqLworICBEV09S
RCBkVGltZW91dE1zOworICBpZiAodXMgPT0gMCkKKyAgICB7CisgICAgICBk
VGltZW91dE1zID0gMDsKKyAgICB9CisgIGVsc2UKKyAgICB7CisgICAgICBk
VGltZW91dE1zID0gSU5GSU5JVEU7CisgICAgfQorICAvKiBDcmVhdGUgYW5k
IHNldCBhIHdhaXRhYmxlIHRpbWVyLCBpZiBhIGZpbml0ZSB0aW1lb3V0IGhh
cyBiZWVuCisgICAgIHJlcXVlc3RlZC4gKi8KKyAgTEFSR0VfSU5URUdFUiBs
aVRpbWVvdXQ7CisgIEhBTkRMRSBoVGltZW91dDsKKyAgTlRTVEFUVVMgc3Rh
dHVzOworICBzdGF0dXMgPSBOdENyZWF0ZVRpbWVyKCZoVGltZW91dCwgVElN
RVJfQUxMX0FDQ0VTUywgTlVMTCwgTm90aWZpY2F0aW9uVGltZXIpOworICBp
ZiAoIU5UX1NVQ0NFU1MgKHN0YXR1cykpCisgICAgeworICAgICAgc2VsZWN0
X3ByaW50ZigiTnRDcmVhdGVUaW1lciBmYWlsZWQgKCVkKVxuIiwgR2V0TGFz
dEVycm9yKCkpOworICAgICAgcmV0dXJuIHNlbGVjdF9lcnJvcjsKKyAgICB9
CisgIHc0W20rK10gPSBoVGltZW91dDsKKyAgaWYgKHVzID49IDApCisgICAg
eworICAgICAgbGlUaW1lb3V0LlF1YWRQYXJ0ID0gLXVzICogMTA7CisgICAg
ICBpbnQgc2V0cmV0OworICAgICAgc3RhdHVzID0gTnRTZXRUaW1lciAoaFRp
bWVvdXQsICZsaVRpbWVvdXQsIE5VTEwsIE5VTEwsIEZBTFNFLCAwLCBOVUxM
KTsKKyAgICAgIGlmICghTlRfU1VDQ0VTUyhzdGF0dXMpKQorCXsKKwkgIHNl
bGVjdF9wcmludGYgKCJOdFNldFRpbWVyIGZhaWxlZDogJWQgKCUwOHgpXG4i
LCBzZXRyZXQsIEdldExhc3RFcnJvcigpKTsKKwkgIHJldHVybiBzZWxlY3Rf
ZXJyb3I7CisJfQorICAgIH0KKworICAvKiBPcHRpb25hbGx5IHdhaXQgZm9y
IHB0aHJlYWQgY2FuY2VsbGF0aW9uLiAqLwogICBpZiAoKHc0W21dID0gcHRo
cmVhZDo6Z2V0X2NhbmNlbF9ldmVudCAoKSkgIT0gTlVMTCkKICAgICBtKys7
CiAKQEAgLTM5NywyMSArNDA1LDI3IEBAIHNlbGVjdF9zdHVmZjo6d2FpdCAo
ZmRfc2V0ICpyZWFkZmRzLCBmZF9zZXQgKndyaXRlZmRzLCBmZF9zZXQgKmV4
Y2VwdGZkcywKIG5leHRfd2hpbGU6OwogICAgIH0KIAotICBkZWJ1Z19wcmlu
dGYgKCJtICVkLCBtcyAldSIsIG0sIG1zKTsKKyAgZGVidWdfcHJpbnRmICgi
bSAlZCwgdXMgJWxsdSwgZFRpbWVvdXRNcyAlZCIsIG0sIHVzLCBkVGltZW91
dE1zKTsKIAogICBEV09SRCB3YWl0X3JldDsKICAgaWYgKCF3aW5kb3dzX3Vz
ZWQpCi0gICAgd2FpdF9yZXQgPSBXYWl0Rm9yTXVsdGlwbGVPYmplY3RzICht
LCB3NCwgRkFMU0UsIG1zKTsKKyAgICB3YWl0X3JldCA9IFdhaXRGb3JNdWx0
aXBsZU9iamVjdHMgKG0sIHc0LCBGQUxTRSwgZFRpbWVvdXRNcyk7CiAgIGVs
c2UKICAgICAvKiBVc2luZyBNV01PX0lOUFVUQVZBSUxBQkxFIGlzIHRoZSBv
ZmZpY2lhbGx5IHN1cHBvcnRlZCBzb2x1dGlvbiBmb3IKICAgICAgICB0aGUg
cHJvYmxlbSB0aGF0IHRoZSBjYWxsIHRvIFBlZWtNZXNzYWdlIGRpc2FybXMg
dGhlIHF1ZXVlIHN0YXRlCiAgICAgICAgc28gdGhhdCBhIHN1YnNlcXVlbnQg
TVdGTU8gaGFuZ3MsIGV2ZW4gaWYgdGhlcmUgYXJlIHN0aWxsIG1lc3NhZ2Vz
CiAgICAgICAgaW4gdGhlIHF1ZXVlLiAqLwotICAgIHdhaXRfcmV0ID0gTXNn
V2FpdEZvck11bHRpcGxlT2JqZWN0c0V4IChtLCB3NCwgbXMsCisgICAgd2Fp
dF9yZXQgPSBNc2dXYWl0Rm9yTXVsdGlwbGVPYmplY3RzRXggKG0sIHc0LCBk
VGltZW91dE1zLAogCQkJCQkgICAgUVNfQUxMSU5QVVQgfCBRU19BTExQT1NU
TUVTU0FHRSwKIAkJCQkJICAgIE1XTU9fSU5QVVRBVkFJTEFCTEUpOwogICBz
ZWxlY3RfcHJpbnRmICgid2FpdF9yZXQgJWQsIG0gPSAlZC4gIHZlcmlmeWlu
ZyIsIHdhaXRfcmV0LCBtKTsKIAorICBpZiAoZFRpbWVvdXRNcyA9PSBJTkZJ
TklURSkKKyAgICB7CisgICAgICBDYW5jZWxXYWl0YWJsZVRpbWVyIChoVGlt
ZW91dCk7CisgICAgICBDbG9zZUhhbmRsZSAoaFRpbWVvdXQpOworICAgIH0K
KwogICB3YWl0X3N0YXRlcyByZXM7CiAgIHN3aXRjaCAod2FpdF9yZXQpCiAg
ICAgewpAQCAtNDM0LDEyICs0NDgsMTMgQEAgbmV4dF93aGlsZTo7CiAgICAg
ICBzLT5zZXRfc2VsZWN0X2Vycm5vICgpOwogICAgICAgcmVzID0gc2VsZWN0
X2Vycm9yOwogICAgICAgYnJlYWs7CisgICAgY2FzZSBXQUlUX09CSkVDVF8w
ICsgMToKICAgICBjYXNlIFdBSVRfVElNRU9VVDoKICAgICAgIHNlbGVjdF9w
cmludGYgKCJ0aW1lZCBvdXQiKTsKICAgICAgIHJlcyA9IHNlbGVjdF9zZXRf
emVybzsKICAgICAgIGJyZWFrOwotICAgIGNhc2UgV0FJVF9PQkpFQ1RfMCAr
IDE6Ci0gICAgICBpZiAoc3RhcnRmZHMgPiAxKQorICAgIGNhc2UgV0FJVF9P
QkpFQ1RfMCArIDI6CisgICAgICBpZiAoc3RhcnRmZHMgPiAyKQogCXsKIAkg
IGNsZWFudXAgKCk7CiAJICBkZXN0cm95ICgpOwpAQCAtNDUwLDcgKzQ2NSw3
IEBAIG5leHRfd2hpbGU6OwogCSB0byB3YWl0IGZvci4gICovCiAgICAgZGVm
YXVsdDoKICAgICAgIHMgPSAmc3RhcnQ7Ci0gICAgICBib29sIGdvdG9uZSA9
IGZhbHNlOworICAgICAgcmVzID0gc2VsZWN0X3NldF96ZXJvOwogICAgICAg
LyogU29tZSB0eXBlcyBvZiBvYmplY3RzIChlLmcuLCBjb25zb2xlcykgd2Fr
ZSB1cCBvbiAiaW5hcHByb3ByaWF0ZSIKIAkgZXZlbnRzIGxpa2UgbW91c2Ug
bW92ZW1lbnRzLiAgVGhlIHZlcmlmeSBmdW5jdGlvbiB3aWxsIGRldGVjdCB0
aGVzZQogCSBzaXR1YXRpb25zLiAgSWYgaXQgcmV0dXJucyBmYWxzZSwgdGhl
biB0aGlzIHdha2V1cCB3YXMgYSBmYWxzZSBhbGFybQpAQCAtNDY0LDEzICs0
NzksOSBAQCBuZXh0X3doaWxlOjsKIAkgIH0KIAllbHNlIGlmICgoKCh3YWl0
X3JldCA+PSBtICYmIHMtPndpbmRvd3NfaGFuZGxlKSB8fCBzLT5oID09IHc0
W3dhaXRfcmV0XSkpCiAJCSAmJiBzLT52ZXJpZnkgKHMsIHJlYWRmZHMsIHdy
aXRlZmRzLCBleGNlcHRmZHMpKQotCSAgZ290b25lID0gdHJ1ZTsKKwkgIHJl
cyA9IHNlbGVjdF9vazsKIAotICAgICAgaWYgKCFnb3RvbmUpCi0JcmVzID0g
c2VsZWN0X2xvb3A7Ci0gICAgICBlbHNlCi0JcmVzID0gc2VsZWN0X29rOwot
ICAgICAgc2VsZWN0X3ByaW50ZiAoImdvdG9uZSAlZCIsIGdvdG9uZSk7Cisg
ICAgICBzZWxlY3RfcHJpbnRmICgicmVzIGFmdGVyIHZlcmlmeSAlZCIsIHJl
cyk7CiAgICAgICBicmVhazsKICAgICB9CiBvdXQ6CkBAIC04MzksNyArODUw
LDYgQEAgZmhhbmRsZXJfZmlmbzo6c2VsZWN0X2V4Y2VwdCAoc2VsZWN0X3N0
dWZmICpzcykKIHN0YXRpYyBpbnQKIHBlZWtfY29uc29sZSAoc2VsZWN0X3Jl
Y29yZCAqbWUsIGJvb2wpCiB7Ci0gIGV4dGVybiBjb25zdCBjaGFyICogZ2V0
X25vbmFzY2lpX2tleSAoSU5QVVRfUkVDT1JEJiBpbnB1dF9yZWMsIGNoYXIg
Kik7CiAgIGZoYW5kbGVyX2NvbnNvbGUgKmZoID0gKGZoYW5kbGVyX2NvbnNv
bGUgKikgbWUtPmZoOwogCiAgIGlmICghbWUtPnJlYWRfc2VsZWN0ZWQpCkBA
IC04NzUsMTkgKzg4NSwyOSBAQCBwZWVrX2NvbnNvbGUgKHNlbGVjdF9yZWNv
cmQgKm1lLCBib29sKQogCSAgewogCSAgICBpZiAoaXJlYy5FdmVudC5LZXlF
dmVudC5iS2V5RG93bgogCQkmJiAoaXJlYy5FdmVudC5LZXlFdmVudC51Q2hh
ci5Bc2NpaUNoYXIKLQkJICAgIHx8IGdldF9ub25hc2NpaV9rZXkgKGlyZWMs
IHRtcGJ1ZikpKQotCSAgICAgIHJldHVybiBtZS0+cmVhZF9yZWFkeSA9IHRy
dWU7CisJCSAgICB8fCBmaGFuZGxlcl9jb25zb2xlOjpnZXRfbm9uYXNjaWlf
a2V5IChpcmVjLCB0bXBidWYpKSkKKwkgICAgICB7CisJCWRlYnVnX3ByaW50
ZigicGVla2VkIEtFWV9FVkVOVCIpOworCQlyZXR1cm4gbWUtPnJlYWRfcmVh
ZHkgPSB0cnVlOworCSAgICAgIH0KIAkgIH0KIAllbHNlCiAJICB7CiAJICAg
IGlmIChpcmVjLkV2ZW50VHlwZSA9PSBNT1VTRV9FVkVOVAogCQkmJiBmaC0+
bW91c2VfYXdhcmUgKGlyZWMuRXZlbnQuTW91c2VFdmVudCkpCisJICAgICAg
eworCQlkZWJ1Z19wcmludGYoInBlZWtlZCBNT1VTRV9FVkVOVCIpOwogCQly
ZXR1cm4gbWUtPnJlYWRfcmVhZHkgPSB0cnVlOworCSAgICAgIH0KIAkgICAg
aWYgKGlyZWMuRXZlbnRUeXBlID09IEZPQ1VTX0VWRU5UICYmIGZoLT5mb2N1
c19hd2FyZSAoKSkKKwkgICAgICB7CisJCWRlYnVnX3ByaW50ZigicGVla2Vk
IEZPQ1VTX0VWRU5UIik7CiAJCXJldHVybiBtZS0+cmVhZF9yZWFkeSA9IHRy
dWU7CisJICAgICAgfQogCSAgfQogCiAJLyogUmVhZCBhbmQgZGlzY2FyZCB0
aGUgZXZlbnQgKi8KKwlkZWJ1Z19wcmludGYoImRpc2NhcmRlZCBvdGhlciBl
dmVudCIpOwogCVJlYWRDb25zb2xlSW5wdXQgKGgsICZpcmVjLCAxLCAmZXZl
bnRzX3JlYWQpOwogICAgICAgfQogCmRpZmYgLS1naXQgYS93aW5zdXAvY3ln
d2luL3NlbGVjdC5oIGIvd2luc3VwL2N5Z3dpbi9zZWxlY3QuaAppbmRleCAw
MDM1ODIwLi4zYzc0OWFkIDEwMDY0NAotLS0gYS93aW5zdXAvY3lnd2luL3Nl
bGVjdC5oCisrKyBiL3dpbnN1cC9jeWd3aW4vc2VsZWN0LmgKQEAgLTc4LDcg
Kzc4LDYgQEAgcHVibGljOgogICBlbnVtIHdhaXRfc3RhdGVzCiAgIHsKICAg
ICBzZWxlY3Rfc2lnbmFsbGVkID0gLTMsCi0gICAgc2VsZWN0X2xvb3AgPSAt
MiwKICAgICBzZWxlY3RfZXJyb3IgPSAtMSwKICAgICBzZWxlY3Rfb2sgPSAw
LAogICAgIHNlbGVjdF9zZXRfemVybyA9IDEKQEAgLTk2LDcgKzk1LDcgQEAg
cHVibGljOgogCiAgIGJvb2wgdGVzdF9hbmRfc2V0IChpbnQsIGZkX3NldCAq
LCBmZF9zZXQgKiwgZmRfc2V0ICopOwogICBpbnQgcG9sbCAoZmRfc2V0ICos
IGZkX3NldCAqLCBmZF9zZXQgKik7Ci0gIHdhaXRfc3RhdGVzIHdhaXQgKGZk
X3NldCAqLCBmZF9zZXQgKiwgZmRfc2V0ICosIERXT1JEKTsKKyAgd2FpdF9z
dGF0ZXMgd2FpdCAoZmRfc2V0ICosIGZkX3NldCAqLCBmZF9zZXQgKiwgTE9O
R0xPTkcpOwogICB2b2lkIGNsZWFudXAgKCk7CiAgIHZvaWQgZGVzdHJveSAo
KTsKIApkaWZmIC0tZ2l0IGEvd2luc3VwL3Rlc3RzdWl0ZS9jb25maWd1cmUg
Yi93aW5zdXAvdGVzdHN1aXRlL2NvbmZpZ3VyZQpvbGQgbW9kZSAxMDA2NDQK
bmV3IG1vZGUgMTAwNzU1Ci0tIAoyLjcuMgoK

--------------060209090806070201090503--
